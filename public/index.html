<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ask Mo Anything - Islamic Knowledge AI Assistant">
    <title>Ask Mo Anything</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Stripe JavaScript SDK with defer to prevent blocking -->
    <script src="https://js.stripe.com/v3/" defer></script>
    <!-- Load buy-button.js only when needed, not on initial page load -->
    <script>
        // Function to check if we're in an iframe
        function isInIframe() {
            try {
                return window !== window.top;
            } catch (e) {
                return true; // If we can't access window.top, we're likely in an iframe
            }
        }
        
        // Safe localStorage access functions
        function safeGetItem(key) {
            try {
                if (!isInIframe()) {
                    return localStorage.getItem(key);
                }
                return null;
            } catch (error) {
                console.error('Error accessing localStorage (get):', error);
                return null;
            }
        }
        
        function safeSetItem(key, value) {
            try {
                if (!isInIframe()) {
                    localStorage.setItem(key, value);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error accessing localStorage (set):', error);
                return false;
            }
        }
        
        // Defer loading of buy-button.js until it's actually needed
        function loadBuyButton() {
            if (!document.querySelector('script[src="https://js.stripe.com/v3/buy-button.js"]')) {
                const script = document.createElement('script');
                script.src = 'https://js.stripe.com/v3/buy-button.js';
                script.async = true;
                script.onload = function() {
                    console.log('Stripe Buy Button loaded successfully');
                };
                script.onerror = function() {
                    console.error('Failed to load Stripe Buy Button');
                };
                document.head.appendChild(script);
            }
        }
        
        // We'll call this function when the user clicks on premium upgrade
    </script>
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            sendPasswordResetEmail,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDn_yz3eL1c4cxxaChd2YFx8TReFYSWI-Q",
            authDomain: "ask-mo-anything.firebaseapp.com",
            projectId: "ask-mo-anything",
            storageBucket: "ask-mo-anything.firebasestorage.app",
            messagingSenderId: "31573817503",
            appId: "1:31573817503:web:b8f5c3a066b3cb4243b69d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // Make Firebase services available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.googleProvider = googleProvider;
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            overflow-y: scroll;
        }

        :root {
            --primary-color: #1e6f5c;
            --secondary-color: #2a9d8f;
            --background-color: #f8f9fa;
            --text-color: #2c3e50;
            --arabic-font: 'Amiri', serif;
            --english-font: 'Roboto', sans-serif;
            --ramadan-gold: #d4af37;
            --ramadan-deep-blue: #1a365d;
            --ramadan-light-blue: #4a90e2;
            --ramadan-light-gold: rgba(212, 175, 55, 0.1);
        }

        body {
            background: var(--background-color);
            color: var(--text-color);
            font-family: var(--english-font);
            line-height: 1.6;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 100 100"><path d="M50 5 L52.5 15 L62.5 15 L54.5 21 L57.5 30 L50 24 L42.5 30 L45.5 21 L37.5 15 L47.5 15 Z" fill="rgba(212,175,55,0.03)" /></svg>');
            background-size: 100px 100px;
            background-repeat: repeat;
        }
        
        /* Ramadan Banner Styles */
        .ramadan-banner {
            background: linear-gradient(135deg, var(--primary-color), #1a4a3c);
            color: white;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
            border-bottom: 2px solid var(--ramadan-gold);
            z-index: 5;
        }
        
        .ramadan-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M50 0 L100 50 L50 100 L0 50 Z" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></svg>');
            background-size: 30px 30px;
            opacity: 0.3;
            z-index: 0;
        }
        
        .ramadan-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }
        
        .ramadan-greeting {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }
        
        .ramadan-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--ramadan-gold);
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
            background: rgba(30, 111, 92, 0.6);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--ramadan-gold);
        }
        
        .ramadan-greeting h2 {
            font-size: 1.8rem;
            margin: 0;
            background: linear-gradient(to right, #fff, var(--ramadan-gold), #fff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        
        .ramadan-dates {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .eid-countdown {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid rgba(212, 175, 55, 0.3);
            flex: 1;
            margin: 0 10px;
        }
        
        .countdown-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 3px;
            color: var(--ramadan-gold);
        }
        
        .countdown-timer {
            font-weight: 600;
            font-size: 1rem;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .prayer-times-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            backdrop-filter: blur(5px);
            border: 1px solid var(--ramadan-gold);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: rgba(30, 111, 92, 0.2);
            flex: 1;
            margin: 0 10px;
        }
        
        .prayer-times-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.25);
        }
        
        .prayer-times-header {
            text-align: center;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--ramadan-gold);
            font-size: 1.1rem;
        }
        
        .prayer-times {
            display: flex;
            justify-content: space-around;
            gap: 15px;
        }
        
        .prayer-time {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .prayer-name {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .prayer-time-value {
            font-size: 1.1rem;
            font-weight: 500;
            color: white;
        }
        
        .location-info {
            text-align: center;
            font-size: 0.8rem;
            margin-top: 10px;
            opacity: 0.7;
        }
        
        @media (max-width: 768px) {
            .ramadan-banner {
                padding: 20px 15px;
            }
            
            .ramadan-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .prayer-times-container {
                width: 100%;
            }
        }

        .related-topics {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .related-topics-header {
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            width: fit-content;
        }

        .related-topic-tile {
            align-self: flex-start;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 20px 12px 45px;
            cursor: pointer;
            transition: all 0.25s ease;
            color: var(--text-color);
            font-size: 0.95em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative;
            text-align: left;
            width: 100%;
            max-width: 600px;
            line-height: 1.4;
            margin: 0;
        }

        .related-topic-tile::before {
            content: 'â†’';
            position: absolute;
            left: 20px;
            color: var(--primary-color);
            font-weight: bold;
            opacity: 0.7;
            font-size: 1.2em;
            transition: all 0.25s ease;
        }

        .related-topic-tile:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateX(8px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .related-topic-tile:hover::before {
            color: white;
            opacity: 1;
            transform: translateX(3px);
        }

        .related-topic-tile:active {
            transform: translateX(8px) scale(0.98);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .arabic-text {
            font-family: var(--arabic-font);
            line-height: 2;
            direction: rtl;
            font-size: 1.1em;
            margin: 10px 0;
            text-align: right;
            background: rgba(30, 111, 92, 0.05);
            padding: 15px;
            border-radius: 8px;
            display: block;
            unicode-bidi: embed;
        }

        .arabic-inline {
            font-family: var(--arabic-font);
            font-size: 1em;
            display: inline-block !important;
            direction: rtl;
            padding: 0;
            margin: 0 0.15em;
            line-height: inherit;
            vertical-align: baseline;
            unicode-bidi: isolate;
        }

        .section-heading {
            color: var(--primary-color);
            font-weight: 500;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header-container {
            width: 100%;
            margin: 0;
            padding: 0;
            background: var(--primary-color);
            position: relative;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Ramadan Hadith Styles */
        .hadith-section {
            width: 100%;
            background: linear-gradient(135deg, #d4af37, #e6c566, #d4af37);
            padding: 30px 0;
            margin: 30px 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
            border-radius: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .ramadan-hadith-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
            color: #333;
        }
        
        .ramadan-hadith-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.12);
        }
        
        .ramadan-hadith-container::before {
            content: '\f658';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: -15px;
            bottom: -15px;
            font-size: 120px;
            color: rgba(212, 175, 55, 0.05);
            z-index: 0;
        }
        
        .hadith-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            color: #333;
        }
        
        .hadith-icon {
            width: 40px;
            height: 40px;
            background: #fff;
            color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .hadith-header h3 {
            color: var(--primary-color);
            font-weight: 600;
            margin: 0;
            font-size: 1.3rem;
        }
        
        .hadith-content {
            padding: 22px;
            background: white;
            border-radius: 12px;
            position: relative;
            z-index: 1;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .hadith-arabic {
            font-family: var(--arabic-font);
            font-size: 1.5rem;
            line-height: 1.8;
            text-align: right;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .hadith-english {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        .hadith-source {
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }
        
        .refresh-hadith-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            margin-top: 18px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            float: right;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }
        
        .refresh-hadith-btn i {
            margin-right: 5px;
        }
        
        .refresh-hadith-btn:hover {
            background: var(--ramadan-gold);
            color: var(--ramadan-deep-blue);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }
        
        @media (max-width: 768px) {
            .hadith-arabic {
                font-size: 1.3rem;
            }
            
            .hadith-english {
                font-size: 1rem;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header .arabic-title {
                font-size: 1.2em;
            }
            
            .logo-container {
                flex-direction: row;
                gap: 10px;
            }
            
            .header-text {
                align-items: flex-start;
            }
            
            .header-logo {
                width: 120px;
                height: auto;
                margin-bottom: 5px;
            }
            
            .ramadan-hadith-container {
                padding: 0 15px;
            }
        }

        .header {
            text-align: center;
            padding: 15px 20px;
            margin-bottom: 0;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            border-radius: 0;
            width: 100%;
            position: relative;
            overflow: hidden;
            gap: 20px;
            min-height: 80px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            z-index: 2;
            width: 150px;
        }
        
        .header-text-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: absolute;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 100%;
            pointer-events: none; /* Allow clicks to pass through to elements behind */
            z-index: 1;
        }
        
        .header-text-container h1 {
            margin: 0 0 5px 0;
            font-size: 1.8em;
        }
        
        .desktop-only {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .mobile-menu-button {
            display: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
            margin-right: 10px;
            background: rgba(255, 255, 255, 0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .mobile-menu-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        @media (max-width: 768px) {
            .desktop-only {
                display: none;
            }
            
            .header {
                justify-content: space-between;
                position: relative;
            }
            
            .logo-container {
                flex: 1;
            }
            
            .header-logo {
                width: 150px;
                height: auto;
            }
            
            /* Basic mobile menu styling */
            .mobile-menu-button {
                cursor: pointer;
                padding: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 44px;
                min-height: 44px;
                margin-right: 5px;
            }
            
            @media (max-width: 768px) {
                .auth-container {
                    display: none; /* Hidden by default */
                    position: fixed; /* Fixed position */
                    top: 60px; /* Position below header */
                    right: 0;
                    width: 200px;
                    background-color: #1e6f5c;
                    padding: 15px;
                    z-index: 1000;
                    flex-direction: column;
                    gap: 10px;
                    align-items: center;
                    border-left: 2px solid #f0c14b;
                    border-bottom: 2px solid #f0c14b;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                }
                
                .auth-button {
                    width: 100%;
                    margin: 5px 0;
                }
                
                .user-profile {
                    width: 100%;
                    flex-direction: column;
                    align-items: center;
                }
            }
            
            /* Desktop menu styling */
            @media (min-width: 769px) {
                .auth-container {
                    display: flex;
                    flex-direction: row;
                    gap: 10px;
                }
            }
            
            /* Class to show the menu */
            .auth-container.show-mobile-menu {
                display: flex !important;
                animation: slideDown 0.3s ease-out;
            }
            
            @keyframes slideDown {
                from { transform: translateY(-20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            .auth-container .auth-button {
                display: block;
                width: 90%;
                margin: 8px auto;
                text-align: center;
                padding: 10px !important;
                font-size: 15px !important;
                border-radius: 8px;
                background-color: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.3);
                transition: all 0.2s ease;
                white-space: nowrap;
            }
            
            .auth-container .auth-button:active {
                transform: scale(0.98);
                background-color: rgba(255, 255, 255, 0.3);
            }
            
            .auth-options {
                position: static;
                margin-top: 10px;
                box-shadow: none;
                padding: 5px 0;
                background: transparent;
            }
            
            .auth-container.mobile-visible {
                display: flex !important;
                animation: slideDown 0.3s ease-in-out;
            }
            
            /* Improve user profile display in mobile view */
            .auth-container #user-profile {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                padding: 10px 0;
            }
            
            .auth-container #user-profile i {
                margin-bottom: 10px;
                font-size: 28px !important;
                color: white;
            }
            
            .auth-container #user-profile button {
                margin: 5px 0;
                width: 90%;
                padding: 8px 12px !important;
                font-size: 14px !important;
                text-align: center;
            }
            
            @keyframes slideDown {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .mobile-menu-button {
                display: flex;
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
                padding: 12px;
                font-size: 24px;
                color: white;
                background-color: rgba(255, 255, 255, 0.1);
                border-radius: 5px;
                margin-right: 5px;
                transition: background-color 0.2s ease;
            }
            
            .mobile-menu-button:active {
                background-color: rgba(255, 255, 255, 0.2);
            }
        }
        
        .auth-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 0;
            z-index: 2;
            width: 150px;
            justify-content: flex-end;
        }
        
        .auth-button {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .auth-button:hover {
            background-color: white;
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .auth-toggle {
            padding: 10px 18px;
            font-size: 16px;
            font-weight: 500;
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .auth-options {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--primary-color);
            padding: 10px;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            padding: 6px 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        #user-email {
            font-size: 14px;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Authentication Modal Styles */
        .auth-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .auth-modal-content {
            background-color: white;
            margin: 8% auto;
            padding: 35px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            position: relative;
            border-top: 4px solid var(--primary-color);
            animation: slideDown 0.4s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .close-modal {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .close-modal:hover {
            color: var(--primary-color);
        }
        
        .auth-form {
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-group input {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 128, 128, 0.1);
        }
        
        .auth-submit-button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 128, 128, 0.2);
        }
        
        .auth-submit-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 128, 128, 0.25);
        }
        
        .auth-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #777;
        }
        
        .auth-divider::before,
        .auth-divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #ddd;
        }
        
        .auth-divider span {
            padding: 0 10px;
        }
        
        .google-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 14px;
            background-color: white;
            color: #444;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .google-button:hover {
            background-color: #f5f5f5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .google-button img {
            width: 18px;
            height: 18px;
            margin-right: 10px;
        }
        
        .auth-message {
            text-align: center;
            margin: 15px 0;
            color: #555;
        }
        
        .auth-message a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .auth-message a:hover {
            text-decoration: underline;
        }
        
        .premium-badge {
            background-color: #f39c12;
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 5px;
            display: inline-block;
        }
        
        .premium-message {
            background-color: rgba(243, 156, 18, 0.1);
            border-left: 3px solid #f39c12;
            padding: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .subscription-status {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .subscription-status h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .current-plan {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: 600;
            margin: 10px 0;
            background-color: #f1f1f1;
        }
        
        .current-plan.premium {
            background-color: #f39c12;
            color: white;
        }
        
        .api-key-section {
            margin-top: 20px;
        }
        
        .api-key-section h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .api-key-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .toggle-password-button {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            color: #777;
        }
        
        .toggle-password-button:hover {
            color: var(--primary-color);
        }
        
        .api-key-message {
            font-size: 0.9em;
            color: #777;
            margin-top: 10px;
        }
        
        .auth-error {
            color: #d9534f;
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .header-logo {
            width: 150px;
            height: auto;
            /* Removed filter to show logo in its original colors */
            margin: 0;
        }
        
        .header-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, transparent, var(--ramadan-gold), transparent);
            opacity: 0.8;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header .arabic-title {
            font-family: var(--arabic-font);
            font-size: 1.6em;
            margin-top: 5px;
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
        }

        .header-image-container {
            max-width: 700px;
            margin: 30px auto;
            position: relative;
        }

        .header-image {
            width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .header-image:hover {
            transform: scale(1.02);
        }

        .image-disclaimer {
            font-size: 0.9em;
            color: #666;
            margin-top: 12px;
            font-style: italic;
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
        }

        .disclaimer {
            background: #fff;
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .disclaimer ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .suggested-topics {
            margin-bottom: 30px;
        }

        .suggested-topics h2 {
            color: var(--text-color);
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: 500;
            text-align: center;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 0 auto;
            max-width: 1200px;
        }

        .topic-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .ramadan-card {
            background: linear-gradient(to bottom, #ffffff, #f8f4e5);
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }
        
        .ramadan-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--ramadan-gold) 0%, var(--ramadan-gold) 50%, transparent 50%);
            opacity: 0.7;
            border-radius: 0 12px 0 12px;
        }

        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .topic-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .topic-title {
            color: var(--text-color);
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .topic-description {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .related-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .related-topic-tile {
            background: white;
            color: var(--text-color);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            white-space: normal;
            line-height: 1.4;
        }

        .related-topic-tile:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }

        .disclaimer li {
            margin-bottom: 5px;
        }

        .chat-container {
            flex: 1;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            min-height: 200px;
            max-height: calc(100vh - 300px);
            display: flex;
            flex-direction: column;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: min-height;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            transition: height 0.3s ease;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px 20px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 1.1em;
            animation: messageAppear 0.5s ease forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background-color: var(--primary-color);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .bot-message {
            background-color: #f8f9fa;
            color: var(--text-color);
            align-self: flex-start;
            margin-right: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            position: relative;
        }

        .share-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .share-text {
            font-size: 0.9em;
            color: #1e6f5c;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .share-buttons {
            display: flex;
            gap: 12px;
            margin-top: 5px;
        }

        .share-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .share-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .x-icon {
            font-weight: bold;
            font-size: 16px;
            font-family: Arial, sans-serif;
        }
        
        .x-btn {
            font-weight: bold;
        }

        .share-button:hover {
            background: var(--secondary-color);
        }

        .share-options {
            position: absolute;
            top: 50px;
            right: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 8px 0;
            display: none;
            z-index: 3;
        }

        .share-options.active {
            display: block;
        }

        .share-option {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .share-option:hover {
            background: #f5f5f5;
        }

        .share-option i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* Share card styles */
        .share-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            max-width: 600px;
            margin: 20px auto;
            position: relative;
            display: none;
        }

        .share-card.active {
            display: block;
        }

        .share-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .share-card-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .share-card-title {
            font-size: 1.2em;
            font-weight: 500;
            color: var(--primary-color);
        }

        .share-card-content {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .share-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .share-card-qr {
            width: 80px;
            height: 80px;
        }

        .error-message {
            background-color: #ffebee;
            color: #c62828;
            margin: 10px auto;
            text-align: center;
        }

        .section-header {
            font-weight: bold;
            margin: 15px 0 10px 0;
            color: #1976d2;
            font-size: 1.1em;
        }

        .arabic-text {
            font-family: "Traditional Arabic", "Arabic Typesetting", Arial, sans-serif;
            font-size: 1.3em;
            line-height: 1.8;
            direction: rtl;
            margin: 15px 0;
            text-align: right;
            color: #444;
        }

        .arabic-symbol {
            font-family: "Traditional Arabic", "Arabic Typesetting", Arial, sans-serif;
            font-size: 1.2em;
            color: #444;
            margin: 0 3px;
        }

        .input-container {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            margin-top: auto;
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            resize: none;
            font-size: 1em;
            font-family: inherit;
            min-height: 45px;
            max-height: 150px;
            transition: all 0.2s ease;
            line-height: 1.4;
            overflow-y: hidden;
        }

        #user-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(30,111,92,0.1);
        }

        .send-button {
            padding: 8px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            width: 40px;
            height: 40px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            stroke: white;
        }

        .send-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .response-indicator {
            background-color: var(--primary-color);
            color: white;
            font-size: 0.9em;
            padding: 8px 15px;
            border-radius: 4px;
            display: none;
            text-align: center;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stop-button {
            display: none;
            padding: 8px;
            background: #dc3545;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            margin-left: 8px;
            width: 40px;
            height: 40px;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .stop-button svg {
            width: 16px;
            height: 16px;
            stroke: white;
        }

        .stop-button:hover {
            background: #c82333;
        }

        .thinking-message {
            text-align: center;
            padding: 10px;
        }

        .thinking-message .arabic-text {
            font-family: "Traditional Arabic", "Arabic Typesetting", Arial, sans-serif;
            font-size: 1.4em;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .thinking-message .english-text {
            color: #666;
            margin-bottom: 10px;
        }

        .thinking-message .loading-dots {
            display: flex;
            justify-content: center;
            gap: 4px;
        }

        .thinking-message .loading-dots span {
            font-size: 24px;
            line-height: 10px;
            color: var(--primary-color);
            opacity: 0.2;
            transition: opacity 0.3s ease;
        }

        @media (max-width: 1200px) {
            .topic-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .topic-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .ramadan-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .eid-countdown, .ramadan-greeting, .prayer-times-container {
                width: 100%;
                margin: 5px 0;
            }
        }

        @media (max-width: 600px) {
            .chat-container {
                padding: 10px;
            }

            .message {
                max-width: 90%;
            }

            .input-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header-container">
        <div class="header">
            <div class="logo-container">
                <img src="/images/updated-ask-mo-logo.png" alt="Ask Mo Anything Logo" class="header-logo">
            </div>
            <div class="header-text-container desktop-only">
                <h1>Ask Mo Anything</h1>
                <div class="arabic-title">Ø§Ø³Ø£Ù„ Ø¹Ù† Ø§Ù„Ù†Ø¨ÙŠ Ù…Ø­Ù…Ø¯ ï·º</div>
            </div>
            <div class="mobile-menu-button">
                <i class="fas fa-bars" style="font-size: 24px; width: 100%; text-align: center;"></i>
            </div>
            <div class="auth-container" id="auth-container" style="display: none;">
                <button id="login-button" class="auth-button">Sign In</button>
                <button id="signup-button" class="auth-button">Sign Up</button>
                <div id="user-profile" class="user-profile" style="display: none;">
                    <i class="fas fa-user-circle" style="font-size: 18px;"></i>
                    <button id="profile-button" class="auth-button" style="padding: 5px 12px; font-size: 12px;">My Account</button>
                    <button id="logout-button" class="auth-button" style="padding: 5px 12px; font-size: 12px;">Sign Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ramadan Banner -->
    <div class="ramadan-banner">
        <div class="ramadan-content">
            <div class="eid-countdown">
                <div class="countdown-label">Eid Al-Fitr Countdown:</div>
                <div class="countdown-timer" id="eid-countdown">Loading...</div>
            </div>
            
            <div class="ramadan-greeting">
                <div class="ramadan-icon">â˜ªï¸</div>
                <h2>Ramadan Mubarak!</h2>
                <div class="ramadan-dates">March 1 - March 29, 2025</div>
            </div>
            
            <div class="prayer-times-container">
                <div class="prayer-times-header">Today's Fasting Times</div>
                <div class="prayer-times">
                    <div class="prayer-time">
                        <span class="prayer-name">Suhoor Ends</span>
                        <span class="prayer-time-value" id="suhoor-time">Loading...</span>
                    </div>
                    <div class="prayer-time">
                        <span class="prayer-name">Iftar</span>
                        <span class="prayer-time-value" id="iftar-time">Loading...</span>
                    </div>
                </div>
                <div class="location-info" id="location-info">Based on your location</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header-image-container">
            <img src="/images/islamic-art.png" alt="Islamic Art - Artistic Illustration" class="header-image">
            <p class="image-disclaimer">Note: This is an artistic illustration and not a depiction of Prophet Muhammad (peace be upon him)</p>
        </div>
        
        <!-- Ramadan Daily Hadith -->
        <div class="hadith-section">
            <div class="ramadan-hadith-container">
                <div class="hadith-header">
                    <div class="hadith-icon"><i class="fas fa-book-open"></i></div>
                    <h3>Hadith of the Day</h3>
                </div>
                <div class="hadith-content" id="daily-hadith">
                    <div class="hadith-arabic" lang="ar">Ù…ÙŽÙ†Ù’ ØµÙŽØ§Ù…ÙŽ Ø±ÙŽÙ…ÙŽØ¶ÙŽØ§Ù†ÙŽ Ø¥ÙÙŠÙ…ÙŽØ§Ù†Ù‹Ø§ ÙˆÙŽØ§Ø­Ù’ØªÙØ³ÙŽØ§Ø¨Ù‹Ø§ ØºÙÙÙØ±ÙŽ Ù„ÙŽÙ‡Ù Ù…ÙŽØ§ ØªÙŽÙ‚ÙŽØ¯ÙŽÙ‘Ù…ÙŽ Ù…ÙÙ†Ù’ Ø°ÙŽÙ†Ù’Ø¨ÙÙ‡Ù</div>
                    <div class="hadith-english">"Whoever fasts during Ramadan out of sincere faith and hoping to attain Allah's rewards, then all his past sins will be forgiven."</div>
                    <div class="hadith-source">Sahih al-Bukhari 2014</div>
                </div>
                <button class="refresh-hadith-btn" id="refresh-hadith-btn"><i class="fas fa-sync-alt"></i> New Hadith</button>
            </div>
        </div>



        <div class="suggested-topics">
            <h2>Ramadan Special Topics</h2>
            <div class="topic-grid">
                <!-- Ramadan-specific Topics -->
                <div class="topic-card ramadan-card" data-topic="What is the significance of Ramadan in Islam?">
                    <div class="topic-icon">ðŸŒ™</div>
                    <div class="topic-title">Significance of Ramadan</div>
                    <div class="topic-description">Learn about the holy month and its importance in Islam</div>
                </div>
                <div class="topic-card ramadan-card" data-topic="What are the best practices during Ramadan?">
                    <div class="topic-icon">âœ¨</div>
                    <div class="topic-title">Ramadan Best Practices</div>
                    <div class="topic-description">Discover recommended acts of worship during the holy month</div>
                </div>
                <div class="topic-card ramadan-card" data-topic="What are the rules of fasting in Ramadan and who is exempt?">
                    <div class="topic-icon">ðŸ½ï¸</div>
                    <div class="topic-title">Fasting Guidelines</div>
                    <div class="topic-description">Learn about fasting rules, exemptions, and making up missed fasts</div>
                </div>
                <div class="topic-card ramadan-card" data-topic="What is Laylatul Qadr and how should we observe it?">
                    <div class="topic-icon">â­</div>
                    <div class="topic-title">Laylatul Qadr</div>
                    <div class="topic-description">Understand the Night of Power and its special significance</div>
                </div>
            </div>
            
            <h2 style="margin-top: 30px;">Explore Islamic Knowledge</h2>
            <div class="topic-grid">
                <!-- Original Topic Cards -->
                <div class="topic-card" data-topic="Tell me about the life and teachings of Prophet Muhammad ï·º">
                    <div class="topic-icon">ðŸ“š</div>
                    <div class="topic-title">Prophetic Biography</div>
                    <div class="topic-description">Discover the life and teachings of Prophet Muhammad ï·º</div>
                </div>
                <div class="topic-card" data-topic="What does the Quran teach us about morals and ethics?">
                    <div class="topic-icon">â¤ï¸</div>
                    <div class="topic-title">Islamic Ethics</div>
                    <div class="topic-description">Explore Islamic morals, values, and character building</div>
                </div>
                <div class="topic-card" data-topic="What are the five pillars of Islam?">
                    <div class="topic-icon">ðŸ•Œ</div>
                    <div class="topic-title">Five Pillars of Islam</div>
                    <div class="topic-description">Learn about the fundamental practices of the Islamic faith</div>
                </div>
                <div class="topic-card" data-topic="How did the Prophet Muhammad ï·º treat people of other faiths?">
                    <div class="topic-icon">ðŸ¤</div>
                    <div class="topic-title">Interfaith Relations</div>
                    <div class="topic-description">Explore the Prophet's approach to people of different beliefs</div>
                </div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message bot-message">
                    <div lang="ar">Ø§Ù„Ø³ÙŽÙ‘Ù„Ø§ÙŽÙ…Ù Ø¹ÙŽÙ„ÙŽÙŠÙ’ÙƒÙÙ…Ù’ ÙˆÙŽØ±ÙŽØ­Ù’Ù…ÙŽØ©Ù Ø§Ù„Ù„Ù‡Ù ÙˆÙŽØ¨ÙŽØ±ÙŽÙƒÙŽØ§ØªÙÙ‡Ù</div>
                    Welcome! I'm here to help answer your questions about Prophet Muhammad ï·º and Islamic teachings. What would you like to know?
                </div>
            </div>
            <div class="input-section">
                <div class="response-indicator" style="display: none;">Mo is responding...</div>
                <div class="input-container">
                    <textarea id="user-input" placeholder="Type your question here..." rows="1"></textarea>
                    <button id="send-button" class="send-button">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                    <button id="stop-button" onclick="stopGeneration()" class="stop-button" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="6" y="6" width="12" height="12" rx="1" ry="1"></rect>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="disclaimer">
            <strong>Important Notice:</strong>
            <p>This AI assistant provides information about Prophet Muhammad ï·º and Islamic teachings based on authentic sources. Please note:</p>
            <ul>
                <li>This is an AI tool and should not be considered a replacement for proper Islamic scholarship</li>
                <li>For religious rulings (fatawa), please consult qualified Islamic scholars</li>
                <li>Verify all information with authentic Islamic sources</li>
                <li>Treat all religious content with proper respect and adab (etiquette)</li>
            </ul>
        </div>

        <div class="empowering-section">
            <h2>Empowering Islamic Knowledge Through Technology</h2>
            <p>To ensure continuous and reliable access to this service, we offer two options: use your own OpenAI API key or subscribe to our premium plan where we cover the API costs for you.</p>
            <p>Using your own API key gives you unlimited access while helping us maintain this platform. You can get your API key at <a href="https://platform.openai.com" target="_blank">OpenAI's website</a>, or choose from our plans below:</p>
            <p><small><i>Note: Each question uses advanced AI technology that costs us approximately $0.10-$0.20 per response.</i></small></p>
            
            <!-- Supportive Mission Text -->
            <div class="mission-support-text">
                <p>Help support us and our mission to spread Islamic knowledge throughout the world, while learning and discovering Islam through technology with the greatest Islamic Knowledge GPT available.</p>
            </div>
            
            <!-- Pricing Section -->
            <div class="pricing-section">
                <h3>Choose the Right Plan for You</h3>
                <div class="ramadan-promo">
                    <div class="ramadan-badge">
                        <span class="ramadan-icon">â˜ª</span> RAMADAN SPECIAL
                    </div>
                    <p>Enjoy up to 50% off during the blessed month of Ramadan!</p>
                </div>
                
                <!-- Pricing Toggle -->
                <div class="pricing-toggle-container">
                    <button id="annual-toggle" class="pricing-toggle-btn active">Pay annually</button>
                    <button id="monthly-toggle" class="pricing-toggle-btn">Pay monthly</button>
                </div>
                <style>
                    /* Ramadan promo styles */
                    .ramadan-promo {
                        text-align: center;
                        margin: 15px auto 25px;
                        background-color: rgba(255, 255, 255, 0.15);
                        border-radius: 8px;
                        padding: 12px 20px;
                        max-width: 600px;
                    }
                    
                    .ramadan-badge {
                        display: inline-block;
                        background-color: rgba(255, 215, 0, 0.2);
                        color: gold;
                        font-weight: 700;
                        padding: 5px 15px;
                        border-radius: 20px;
                        margin-bottom: 10px;
                        font-size: 16px;
                        letter-spacing: 1px;
                    }
                    
                    .ramadan-icon {
                        margin-right: 5px;
                    }
                    
                    .ramadan-promo p {
                        color: white;
                        font-size: 18px;
                        margin: 0;
                    }
                    
                    /* Mission support text styles */
                    .mission-support-text {
                        text-align: center;
                        margin: 20px auto 30px;
                        max-width: 800px;
                        padding: 0 20px;
                    }
                    
                    .mission-support-text p {
                        font-size: 18px;
                        line-height: 1.5;
                        color: white;
                        font-weight: 500;
                    }
                    
                    /* Pricing toggle styles */
                    .pricing-toggle-container {
                        display: flex;
                        justify-content: center;
                        margin: 20px 0 30px;
                        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
                        width: fit-content;
                        margin-left: auto;
                        margin-right: auto;
                        background-color: rgba(255, 255, 255, 0.1);
                        border-radius: 8px 8px 0 0;
                        padding: 5px;
                    }
                    
                    .pricing-toggle-btn {
                        background: none;
                        border: none;
                        padding: 10px 20px;
                        font-size: 16px;
                        cursor: pointer;
                        color: rgba(255, 255, 255, 0.8);
                        position: relative;
                        transition: all 0.3s ease;
                        font-weight: 500;
                    }
                    
                    .pricing-toggle-btn.active {
                        color: white;
                        font-weight: 600;
                    }
                    
                    .pricing-toggle-btn.active::after {
                        content: '';
                        position: absolute;
                        bottom: -2px;
                        left: 0;
                        width: 100%;
                        height: 2px;
                        background-color: white;
                    }
                    
                    /* Pricing cost styles for Ramadan special */
                    .original-price {
                        font-size: 1.5rem;
                        text-decoration: line-through;
                        color: #888;
                        margin-right: 10px;
                        display: inline-block;
                        position: relative;
                        top: -5px;
                    }
                    
                    .discount-badge {
                        position: absolute;
                        top: 0;
                        left: 0;
                        background-color: #e63946;
                        color: white;
                        font-size: 12px;
                        font-weight: bold;
                        padding: 5px 15px;
                        border-bottom-right-radius: 10px;
                        z-index: 2;
                    }
                    
                    /* Hide monthly plan by default */
                    #monthly-plan {
                        display: none;
                    }
                    
                    .pricing-container {
                        display: flex;
                        flex-direction: row;
                        justify-content: center;
                        gap: 15px;
                        flex-wrap: wrap;
                        width: 100%;
                        margin: 0 auto;
                    }
                    .pricing-card {
                        flex: 0 0 31%;
                        min-width: 360px;
                        max-width: none;
                    }
                    /* Stripe button styling */
                    stripe-buy-button {
                        --button-height: 40px;
                        --button-font-size: 14px;
                        --button-radius: 4px;
                        --button-text-color: white;
                        --button-background-color: #1e6f5c;
                        --button-hover-background-color: #164e41;
                    }
                    .stripe-button-container {
                        margin-top: 15px;
                        width: 100%;
                        display: flex;
                        justify-content: center;
                    }
                    #monthly-stripe-container, #annual-stripe-container,
                    #modal-monthly-stripe-container, #modal-annual-stripe-container {
                        width: 100%;
                        display: flex;
                        justify-content: center;
                    }
                    stripe-buy-button {
                        display: inline-block;
                        width: auto !important;
                        max-width: 100%;
                    }
                    /* Ensure pricing cards have consistent layout */
                    .pricing-card {
                        display: flex;
                        flex-direction: column;
                    }
                    .pricing-features {
                        flex-grow: 1;
                    }
                    .pricing-footer {
                        margin-top: auto;
                    }
                    @media (max-width: 992px) {
                        .pricing-container {
                            flex-direction: column;
                            align-items: center;
                        }
                        .pricing-card {
                            width: 100%;
                            max-width: 450px;
                        }
                        .pricing-toggle-container {
                            width: 100%;
                            max-width: 300px;
                        }
                    }
                </style>
                <div class="pricing-container">
                    <!-- Free Plan -->
                    <div class="pricing-card" id="free-plan">
                        <div class="pricing-header">
                            <h4>Free</h4>
                            <div class="pricing-cost">$0<span>/month</span></div>
                        </div>
                        <div class="pricing-features">
                            <ul>
                                <li><i class="fas fa-check"></i> 7 questions per day (using our API key)</li>
                                <li><i class="fas fa-check"></i> <strong>Unlimited</strong> questions with your own API key</li>
                                <li><i class="fas fa-check"></i> Access to basic Islamic knowledge</li>
                                <li><i class="fas fa-check"></i> Ramadan special topics</li>
                                <li><i class="fas fa-check"></i> Daily Hadith</li>
                                <li><i class="fas fa-check"></i> Prayer times</li>
                                <li class="feature-disabled"><i class="fas fa-times"></i> Saved conversation history</li>
                                <li class="feature-disabled"><i class="fas fa-times"></i> Priority support</li>
                                <li class="feature-disabled"><i class="fas fa-times"></i> Downloadable responses</li>
                            </ul>
                        </div>
                        <div class="pricing-footer">
                            <div class="pricing-note">Perfect for occasional users or those with their own API key</div>
                            <button class="pricing-button free-button">Current Plan</button>
                        </div>
                    </div>
                    
                    <!-- Monthly Premium Plan -->
                    <div class="pricing-card premium-card" id="monthly-plan">
                        <div class="pricing-badge">GREAT VALUE</div>
                        <div class="discount-badge">50% OFF</div>
                        <div class="pricing-header">
                            <h4>Premium Monthly</h4>
                            <div class="pricing-cost">
                                <span class="original-price">$19.99</span>
                                $9.99<span>/month</span>
                            </div>
                        </div>
                        <div class="pricing-features">
                            <ul>
                                <li><i class="fas fa-check"></i> <strong>100 questions</strong> per month (using our API key)</li>
                                <li><i class="fas fa-check"></i> <strong>Unlimited</strong> questions with your own API key</li>
                                <li><i class="fas fa-check"></i> Full access to all Islamic knowledge</li>
                                <li><i class="fas fa-check"></i> Ramadan special topics</li>
                                <li><i class="fas fa-check"></i> Daily Hadith with commentary</li>
                                <li><i class="fas fa-check"></i> Personalized prayer times</li>
                                <li><i class="fas fa-check"></i> Save & access conversation history</li>
                                <li><i class="fas fa-check"></i> Priority support</li>
                                <li><i class="fas fa-check"></i> Downloadable responses (PDF)</li>
                                <li><i class="fas fa-check"></i> Coming soon: Scholarly references</li>
                            </ul>
                        </div>
                        <div class="pricing-footer">
                            <div class="pricing-note">Perfect for casual users and learning</div>
                            <div id="monthly-stripe-container">
                                <script async src="https://js.stripe.com/v3/buy-button.js"></script>
                                <stripe-buy-button
                                  buy-button-id="buy_btn_1R0TLxDLlIJ8KokgsghoABCt"
                                  publishable-key="pk_live_51R0QM7DLlIJ8KokgtJ1OMLsHza1s8HHQsUfUqP0sMCrPfFSyWxHn3i1wRpDyWvhrj70eitF5HEwXBUSVITCqojnM00YqzhQDPV"
                                >
                                </stripe-buy-button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Annual Premium Plan -->
                    <div class="pricing-card premium-card" id="annual-plan">
                        <div class="pricing-badge">RECOMMENDED</div>
                        <div class="discount-badge">50% OFF</div>
                        <div class="pricing-header">
                            <h4>Premium Annual</h4>
                            <div class="pricing-cost">
                                <span class="original-price">$199.99</span>
                                $99.99<span>/year</span>
                            </div>
                        </div>
                        <div class="pricing-features">
                            <ul>
                                <li><i class="fas fa-check"></i> <strong>Save 17%</strong> compared to monthly</li>
                                <li><i class="fas fa-check"></i> <strong>Unlimited</strong> questions with your own API key</li>
                                <li><i class="fas fa-check"></i> Full access to all Islamic knowledge</li>
                                <li><i class="fas fa-check"></i> Ramadan special topics</li>
                                <li><i class="fas fa-check"></i> Daily Hadith with commentary</li>
                                <li><i class="fas fa-check"></i> Personalized prayer times</li>
                                <li><i class="fas fa-check"></i> Save & access conversation history</li>
                                <li><i class="fas fa-check"></i> Priority support</li>
                                <li><i class="fas fa-check"></i> Downloadable responses (PDF)</li>
                                <li><i class="fas fa-check"></i> Coming soon: Scholarly references</li>
                            </ul>
                        </div>
                        <div class="pricing-footer">
                            <div class="pricing-note">Ideal for serious students and seekers of knowledge</div>
                            <div id="annual-stripe-container">
                                <script async src="https://js.stripe.com/v3/buy-button.js"></script>
                                <stripe-buy-button
                                  buy-button-id="buy_btn_1R0TTUDLlIJ8Kokg2epkfzAF"
                                  publishable-key="pk_live_51R0QM7DLlIJ8KokgtJ1OMLsHza1s8HHQsUfUqP0sMCrPfFSyWxHn3i1wRpDyWvhrj70eitF5HEwXBUSVITCqojnM00YqzhQDPV"
                                >
                                </stripe-buy-button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="pricing-alternative">
                    <div class="subscription-divider">OR</div>
                    <p>Support our work with a one-time contribution:</p>
                    <a href="https://buymeacoffee.com/samir.shah" target="_blank" class="buy-coffee-button">
                        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-white.png" alt="Buy Me A Coffee">
                    </a>
                </div>
            </div>
            
            <!-- Pricing Toggle JavaScript -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const annualToggle = document.getElementById('annual-toggle');
                    const monthlyToggle = document.getElementById('monthly-toggle');
                    const monthlyPlan = document.getElementById('monthly-plan');
                    const annualPlan = document.getElementById('annual-plan');
                    
                    // Initial state - show annual plan, hide monthly plan
                    monthlyPlan.style.display = 'none';
                    annualPlan.style.display = 'block';
                    
                    annualToggle.addEventListener('click', function() {
                        // Update toggle buttons
                        annualToggle.classList.add('active');
                        monthlyToggle.classList.remove('active');
                        
                        // Show annual plan, hide monthly plan
                        monthlyPlan.style.display = 'none';
                        annualPlan.style.display = 'block';
                    });
                    
                    monthlyToggle.addEventListener('click', function() {
                        // Update toggle buttons
                        monthlyToggle.classList.add('active');
                        annualToggle.classList.remove('active');
                        
                        // Show monthly plan, hide annual plan
                        annualPlan.style.display = 'none';
                        monthlyPlan.style.display = 'block';
                    });
                });
            </script>
        </div>

        <div class="about-section">
            <h2><span class="bismillah">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‡Ù Ø§Ù„Ø±ÙŽÙ‘Ø­Ù’Ù…Ù°Ù†Ù Ø§Ù„Ø±ÙŽÙ‘Ø­ÙÙŠÙ’Ù…Ù</span></h2>
            <h3>About Ask Mo Anything</h3>
            <p>Ask Mo Anything was built by Muslims, for Muslims, with the intention of serving our Ummah. In a world where accessing reliable Islamic knowledge can be challenging, we aim to bridge the gap between traditional wisdom and modern technology.</p>
            <p>Our goal is to make the teachings of Prophet Muhammad ï·º more accessible while maintaining the highest standards of authenticity and scholarly respect. We believe that technology, when used mindfully, can help revive Islamic scholarship in our modern era.</p>
            
            <div class="authenticity-section">
                <h4>Our Commitment to Authenticity</h4>
                <ul>
                    <li>âœ“ This AI assistant is trained on authentic Islamic sources including recognized translations of the Quran, verified Hadith collections, and respected scholarly works.</li>
                    <li>âœ“ While we strive for accuracy, this tool is not a substitute for qualified Islamic scholars or official religious rulings (fatwas).</li>
                    <li>âœ“ For critical matters of faith, worship, or Islamic law, please consult qualified scholars and verify information with authentic sources.</li>
                    <li>âœ“ Our responses are generated through AI interpretation of Islamic texts - always cross-reference with original sources.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Authentication Modals -->
    <div id="login-modal" class="auth-modal">
        <div class="auth-modal-content">
            <span class="close-modal">&times;</span>
            <h2>Sign In</h2>
            <div class="auth-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password" required>
                </div>
                <button id="login-submit" class="auth-submit-button">Sign In</button>
                <div class="auth-divider">
                    <span>OR</span>
                </div>
                <button id="google-signin" class="google-button">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
                    Sign in with Google
                </button>
                <p class="auth-message">Don't have an account? <a href="#" id="switch-to-signup">Sign Up</a></p>
                <p class="auth-message"><a href="#" id="forgot-password">Forgot Password?</a></p>
                <div id="login-error" class="auth-error"></div>
            </div>
        </div>
    </div>

    <div id="signup-modal" class="auth-modal">
        <div class="auth-modal-content">
            <span class="close-modal">&times;</span>
            <h2>Sign Up</h2>
            <div class="auth-form">
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" placeholder="Enter your password" required>
                </div>
                <div class="form-group">
                    <label for="signup-confirm-password">Confirm Password</label>
                    <input type="password" id="signup-confirm-password" placeholder="Confirm your password" required>
                </div>
                <button id="signup-submit" class="auth-submit-button">Sign Up</button>
                <div class="auth-divider">
                    <span>OR</span>
                </div>
                <button id="google-signup" class="google-button">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
                    Sign up with Google
                </button>
                <p class="auth-message">Already have an account? <a href="#" id="switch-to-login">Sign In</a></p>
                <div id="signup-error" class="auth-error"></div>
            </div>
        </div>
    </div>

    <div id="reset-password-modal" class="auth-modal">
        <div class="auth-modal-content">
            <span class="close-modal">&times;</span>
            <h2>Reset Password</h2>
            <div class="auth-form">
                <div class="form-group">
                    <label for="reset-email">Email</label>
                    <input type="email" id="reset-email" placeholder="Enter your email" required>
                </div>
                <button id="reset-submit" class="auth-submit-button">Send Reset Link</button>
                <p class="auth-message"><a href="#" id="back-to-login">Back to Sign In</a></p>
                <div id="reset-message" class="auth-message"></div>
                <div id="reset-error" class="auth-error"></div>
            </div>
        </div>
    </div>
    
    <!-- User Profile Modal -->
    <div id="profile-modal" class="auth-modal">
        <div class="auth-modal-content">
            <span class="close-modal">&times;</span>
            <h2>User Profile</h2>
            <div class="auth-form">
                <div id="subscription-status" class="subscription-status">
                    <h3>Subscription Status</h3>
                    <div id="current-plan" class="current-plan">Free Plan</div>
                    <p>Free plan users have a limit of 7 questions per day.</p>
                    <button id="upgrade-button" class="cta-button">Upgrade to Premium</button>
                </div>
                
                <div class="api-key-section">
                    <h3>Your OpenAI API Key</h3>
                    <p>Using your own API key gives you unlimited questions without counting against your daily limit.</p>
                    <div class="form-group">
                        <label for="api-key-input">API Key</label>
                        <div class="api-key-input-container">
                            <input type="password" id="api-key-input" placeholder="Enter your OpenAI API key">
                            <button id="toggle-api-key" class="toggle-password-button">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button id="save-api-key" class="auth-submit-button">Save API Key</button>
                    <p class="api-key-message">Your API key is stored securely in your browser and is only sent with your questions.</p>
                </div>
                
                <div id="profile-message" class="auth-message"></div>
                <div id="profile-error" class="auth-error"></div>
            </div>
        </div>
    </div>

    <style>
        .empowering-section {
            text-align: center;
            padding: 40px 20px;
            background: var(--primary-color);
            color: white;
            border-radius: 15px;
            margin: 40px auto;
            max-width: 1400px;
            width: 95%;
        }

        .empowering-section h2 {
            margin-bottom: 20px;
            font-size: 2em;
        }

        .empowering-section p {
            margin-bottom: 15px;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .empowering-section a {
            color: white;
            text-decoration: underline;
        }
        
        .empowering-section h3 {
            color: white;
            margin: 30px 0 20px;
            font-size: 1.6em;
        }
        
        /* Pricing Section Styles */
        .pricing-section {
            margin-top: 40px;
        }
        
        .pricing-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 30px auto;
            width: 100%;
        }
        
        .pricing-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 31%;
            min-width: 360px;
            overflow: hidden;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }
        
        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .pricing-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--ramadan-gold);
            color: var(--ramadan-deep-blue);
            padding: 5px 15px;
            font-size: 12px;
            font-weight: bold;
            border-bottom-left-radius: 10px;
        }
        
        .premium-card {
            border: 2px solid var(--ramadan-gold);
        }
        
        .pricing-header {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        .pricing-header h4 {
            margin: 0;
            font-size: 24px;
            color: #2c3e50;
        }
        
        .pricing-cost {
            font-size: 36px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 15px 0 5px;
        }
        
        .pricing-cost span {
            font-size: 16px;
            font-weight: normal;
            color: #7f8c8d;
        }
        
        .pricing-features {
            padding: 20px;
        }
        
        .pricing-features ul {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }
        
        .pricing-features li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            color: #34495e;
        }
        
        .pricing-features li:last-child {
            border-bottom: none;
        }
        
        .pricing-features i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .feature-disabled {
            color: #95a5a6 !important;
        }
        
        .feature-disabled i {
            color: #e74c3c;
        }
        
        .pricing-footer {
            padding: 20px;
            text-align: center;
            background-color: #f9f9f9;
            margin-top: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        
        /* Stripe button containers in pricing cards */
        #monthly-stripe-container, #annual-stripe-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 0 auto;
        }
        
        /* Ensure Stripe buttons are properly sized and centered */
        #monthly-stripe-container stripe-buy-button,
        #annual-stripe-container stripe-buy-button,
        #modal-monthly-stripe-container stripe-buy-button,
        #modal-annual-stripe-container stripe-buy-button {
            width: 100%;
            max-width: 320px;
            margin: 0 auto;
            display: block;
        }
        
        /* Media query for responsive pricing cards */
        @media (max-width: 1150px) {
            .pricing-container {
                flex-direction: column;
                flex-wrap: wrap;
                align-items: center;
            }
            
            .pricing-card {
                width: 100%;
                max-width: 400px;
                margin-bottom: 20px;
            }
        }
        
        /* Fix Stripe iframe sizing */
        stripe-buy-button iframe {
            min-width: unset !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        .pricing-note {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .pricing-button {
            display: inline-block;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 14px;
            width: 100%;
        }
        
        .free-button {
            background-color: #ecf0f1;
            color: #7f8c8d;
            cursor: default;
        }
        
        .premium-button {
            background-color: var(--primary-color);
            color: white;
        }
        
        .premium-button:hover {
            background-color: #174a3c;
        }
        
        .pricing-alternative {
            margin-top: 30px;
            text-align: center;
        }
        
        .subscription-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
            gap: 15px;
        }
        
        .subscription-divider {
            font-weight: 500;
            margin: 5px 0;
        }
        
        .cta-button {
            background-color: white;
            color: var(--primary-color);
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .buy-coffee-button img {
            height: 40px;
        }

        .about-section {
            background: #f8f9fa;
            padding: 40px;
            border-radius: 15px;
            margin: 40px 0;
        }

        .about-section h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .about-section h3 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .bismillah {
            font-family: var(--arabic-font);
            font-size: 1.5em;
            color: var(--primary-color);
            display: block;
            text-align: center;
            margin-bottom: 20px;
        }

        .authenticity-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .authenticity-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .authenticity-section ul {
            list-style: none;
            padding: 0;
        }

        .authenticity-section li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
    </style>

    <script>
        // Global variables
        let chatMessages;
        let userInput;
        let sendButton;

        // Sharing functions
        function showShareOptions(message) {
            const options = message.querySelector('.share-options');
            options.classList.toggle('active');
        }

        function generateShareCard(message) {
            const content = message.textContent;
            const card = document.createElement('div');
            card.className = 'share-card';
            card.innerHTML = `
                <div class="share-card-header">
                    <img src="/images/islamic-art.png" class="share-card-logo" alt="Ask Mo Logo">
                    <div class="share-card-title">Ask Mo Anything</div>
                </div>
                <div class="share-card-content">${content}</div>
                <div class="share-card-footer">
                    <div>ask-mo-anything.vercel.app</div>
                    <div class="share-card-qr"></div>
                </div>
            `;
            
            // Generate QR code
            new QRCode(card.querySelector('.share-card-qr'), {
                text: 'https://ask-mo-anything.vercel.app',
                width: 80,
                height: 80
            });

            return card;
        }

        async function shareToTwitter(message) {
            const text = encodeURIComponent(message.textContent.substring(0, 280));
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent('https://ask-mo-anything.vercel.app')}`);
        }

        async function shareToWhatsApp(message) {
            const text = encodeURIComponent(message.completeResponse || message.fullResponse || message.rawResponse || message.textContent);
            window.open(`https://wa.me/?text=${text}%20-%20via%20https://ask-mo-anything.vercel.app`);
        }

        async function shareToTelegram(message) {
            const text = encodeURIComponent(message.completeResponse || message.fullResponse || message.rawResponse || message.textContent);
            window.open(`https://t.me/share/url?url=${encodeURIComponent('https://ask-mo-anything.vercel.app')}&text=${text}`);
        }

        async function copyToClipboard(message) {
            try {
                await navigator.clipboard.writeText(message.completeResponse || message.fullResponse || message.rawResponse || message.textContent);
                alert('Content copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        }
        
        // Process message text
        function processMessageText(text) {
            if (!text) return '';
            
            let processedText = text;
            let relatedTopicsHtml = '';
            
            // Extract and process related topics
            const topicsMatch = processedText.match(/\[RELATED TOPICS\]([\s\S]*?)(?=\[|$)/i);
            if (topicsMatch) {
                const topicsSection = topicsMatch[1];
                processedText = processedText.replace(topicsMatch[0], '');
                
                // Split into lines and collect all questions
                const topics = [];
                const lines = topicsSection.split('\n');
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Handle numbered questions and their continuations
                    if (line.match(/^\d+\./)) {
                        let fullQuestion = line;
                        while (i + 1 < lines.length && !lines[i + 1].trim().match(/^\d+\.\s*|\[/)) {
                            i++;
                            fullQuestion += ' ' + lines[i].trim();
                        }
                        topics.push(fullQuestion.replace(/^\d+\.\s*/, ''));
                    }
                    // Handle standalone questions
                    else if (line.match(/^(What|How|Why|When|Where|Who|Which|Did|Is|Are|Can|Could|Should|Would|Tell)/i)) {
                        topics.push(line);
                    }
                }

                // Create quick-reply buttons for topics
                if (topics.length > 0) {
                    relatedTopicsHtml = `<div class="related-topics">
                        <div class="related-topics-header">Related Questions:</div>
                        ${topics.map(topic => {
                            // Clean up the topic text and add RTL marks
                            const clean = topic
                                .replace(/ï·º/g, '(PBUH)\u200F')
                                .replace(/(Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡|Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡Ø§)/g, '(RA)\u200F')
                                .replace(/\s+/g, ' ')
                                .trim();
                            
                            // Create quick-reply button
                            const escapedTopic = clean.replace(/["']/g, '\\$&');
                            return `<button class="related-topic-tile" onclick="selectTopic('${escapedTopic}')">${clean}</button>`;
                        }).join('')}
                    </div>`;
                }
            }

            // Add empty Arabic character for alignment
            const arblank = '&#1564;';
            
            // Process the main text
            processedText = processedText
                // Handle sections
                .replace(/\[(CONCLUSION|HADITH|SCHOLARLY OPINIONS|PRACTICAL GUIDANCE)\]([^\[]*)/gi, 
                    '<div class="section-heading">[$1]</div>$2')
                // Handle honorifics inline with proper spacing and RTL marks
                .replace(/(ï·º|Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡|Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡Ø§)/g, 
                    match => ` ${arblank}<span class="arabic-inline" style="display:inline" lang="ar">${match}</span>\u200F `)
                // Handle longer Arabic passages (excluding honorifics)
                .replace(/(?<!ï·º|Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡|Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡Ø§)([\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\u064B-\u0652][^\s]*(?:\s+[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\u064B-\u0652][^\s]*){2,})/g, 
                    (_, match) => `<div class="arabic-text" lang="ar">${match}</div>`)
                // Handle remaining single Arabic words (excluding honorifics)
                .replace(/(?<!ï·º|Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡|Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡Ø§)([\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\u064B-\u0652]+)/g, 
                    (_, match) => `<span class="arabic-inline" lang="ar">${match}</span>`)
                // Clean up any double spaces
                .replace(/\s+/g, ' ');
            
            // Add related topics back at the end
            return processedText + relatedTopicsHtml;
        }
        
        // Helper functions
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function appendErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message error-message';
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            scrollToBottom();
        }
        
        // Initialize after DOM is loaded
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        document.addEventListener('DOMContentLoaded', () => {
            chatMessages = document.getElementById('chat-messages');
            userInput = document.getElementById('user-input');
            sendButton = document.getElementById('send-button');

            // Handle Enter key
            // Auto-resize textarea on input
            userInput.addEventListener('input', function() {
                autoResizeTextarea(this);
            });

            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey && !isGenerating) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Handle button click
            sendButton.addEventListener('click', function() {
                if (!isGenerating) {
                    sendMessage();
                }
            });

            // Handle topic card clicks
            document.querySelectorAll('.topic-card').forEach(card => {
                card.addEventListener('click', function() {
                    const topic = this.getAttribute('data-topic');
                    if (topic) {
                        userInput.value = topic;
                        sendMessage();
                    }
                });
            });
        });

        // Make selectTopic globally available
        window.selectTopic = function(topic) {
            // Handle escaped quotes in the topic
            const unescapedTopic = topic
                .replace(/\\'/g, "'")
                .replace(/\\\"/g, '"');
            userInput.value = unescapedTopic;
            sendMessage(unescapedTopic);
        }

        let currentReader = null;
        let isGenerating = false;

        function stopGeneration() {
            if (currentReader) {
                currentReader.cancel();
                document.getElementById('stop-button').style.display = 'none';
                document.querySelector('.send-button').style.display = 'inline-flex';
                isGenerating = false;
            }
        }

        async function sendMessage(message) {
            if (isGenerating) return;

            // If no message provided, get it from the input
            if (!message) message = userInput.value;
            if (!message || !message.trim()) return;
            
            // Clear input and show user message
            userInput.value = '';
            document.querySelector('.response-indicator').style.display = 'block';
            document.querySelector('.send-button').style.display = 'none';
            document.getElementById('stop-button').style.display = 'inline-flex';
            const userMessage = document.createElement('div');
            userMessage.className = 'message user-message';
            userMessage.textContent = message;
            chatMessages.appendChild(userMessage);
            scrollToBottom();

            // Show thinking message with Islamic theme
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message bot-message';
            loadingMessage.innerHTML = `
                <div class="thinking-message">
                    <div class="english-text">Mo is responding...</div>
                    <div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>
                </div>
            `;
            chatMessages.appendChild(loadingMessage);
            scrollToBottom();

            // Add loading animation
            const dots = loadingMessage.querySelectorAll('.loading-dots span');
            let dotIndex = 0;
            const loadingInterval = setInterval(() => {
                dots.forEach(dot => dot.style.opacity = '0.2');
                dots[dotIndex].style.opacity = '1';
                dotIndex = (dotIndex + 1) % dots.length;
            }, 500);

            let currentMessage = document.createElement('div');
            currentMessage.className = 'message bot-message';
            currentMessage.fullResponse = '';  // Track full response text
            currentMessage.rawResponse = '';   // Track raw response before processing
            
            // Initialize or get the global completeResponse variable
            if (typeof window.completeResponse === 'undefined') {
                window.completeResponse = '';
            } else {
                // Clear previous response when starting a new one
                window.completeResponse = '';
            }
            
            let currentSection = '';
            
            try {
                isGenerating = true;
                document.querySelector('.send-button').style.display = 'none';
                document.getElementById('stop-button').style.display = 'inline-flex';

                console.log('Sending message:', message);
                // Get user's API key if available
                const userApiKey = localStorage.getItem('openai_api_key');
                
                // Get current user ID if logged in
                let userId = null;
                // Use the globally available Firebase auth
                if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                    userId = window.firebaseAuth.currentUser.uid;
                }
                
                // Determine if we're running locally or in production
                const apiUrl = window.location.hostname === 'localhost' ? 'http://localhost:3001/api/chat' : '/api/chat';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(userApiKey && { 'X-API-Key': userApiKey }),
                        ...(userId && { 'X-User-Id': userId })
                    },
                    body: JSON.stringify({ message }),
                });

                if (!response.ok) {
                    if (response.status === 429) {
                        const errorData = await response.json();
                        loadingMessage.remove();
                        const limitMessage = document.createElement('div');
                        limitMessage.className = 'message bot-message';
                        limitMessage.innerHTML = `
                            <div class="empowering-section" style="margin: 0; text-align: left;">
                                <h3 style="color: var(--primary-color); margin-bottom: 15px;">You've reached our API limit for today.</h3>
                                <p>To continue using our platform immediately:</p>
                                <ol style="margin: 15px 0; padding-left: 20px;">
                                    <li>Get your own OpenAI API key (preferred) - this gives you unlimited access right away</li>
                                </ol>
                                <p style="margin: 15px 0;">Want to support our mission? Consider buying us a coffee! ðŸ™‚</p>
                                <p>Your support helps us develop new features including:</p>
                                <ul style="margin: 10px 0 15px 20px; list-style-type: '- ';">
                                    <li>User accounts with saved conversations</li>
                                    <li>Premium membership with unlimited questions</li>
                                    <li>Advanced features for deeper Islamic learning</li>
                                </ul>
                                <p style="font-style: italic; font-size: 0.9em;">Note: Supporting through Buy Me a Coffee is currently just for development support. We're working on a proper membership system!</p>
                                <div class="buy-coffee-container" style="margin-top: 15px; text-align: center;">
                                    <a href="https://buymeacoffee.com/samir.shah" target="_blank" class="buy-coffee-button">
                                        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-white.png" alt="Buy Me A Coffee">
                                    </a>
                                </div>
                            </div>
                        `;
                        chatMessages.appendChild(limitMessage);
                        scrollToBottom();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Remove loading message
                loadingMessage.remove();

                // Show stop button and hide send button
                document.getElementById('stop-button').style.display = 'inline-flex';
                document.querySelector('.send-button').style.display = 'none';
                isGenerating = true;

                currentReader = response.body.getReader();
                const decoder = new TextDecoder();
                let responseComplete = false;
                let timeoutId;
                let lastChunkTime = Date.now();

                console.log('Starting stream processing');
                const resetTimeout = () => {
                    if (timeoutId) clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        if (!responseComplete) {
                            console.error('Client timeout - no response for 60 seconds');
                            appendErrorMessage("The response was incomplete. Please try asking your question again.");
                            currentReader.cancel();
                        }
                    }, 60000);
                };

                while (true) {
                    resetTimeout();
                    const { done, value } = await currentReader.read();

                    if (done) {
                        console.log('Stream complete');
                        clearTimeout(timeoutId);
                        document.getElementById('stop-button').style.display = 'none';
                        document.querySelector('.send-button').style.display = 'inline-flex';
                        isGenerating = false;
                        break;
                    }

                    const timeSinceLastChunk = Date.now() - lastChunkTime;
                    if (timeSinceLastChunk > 10000) {
                        console.log(`No chunks received for ${timeSinceLastChunk}ms`);
                    }

                    lastChunkTime = Date.now();
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.trim() === '') continue;

                        const message = line.replace(/^data: /, '');
                        if (message === '[DONE]') {
                            console.log('Received [DONE] message');
                            responseComplete = true;
                            clearTimeout(timeoutId);
                            break;
                        }

                        try {
                            // Only try to parse if it looks like valid JSON
                            if (message.trim().startsWith('{') && message.trim().endsWith('}')) {
                                const parsed = JSON.parse(message);
                                if (parsed.error) {
                                    console.error('Received error:', parsed.error);
                                    appendErrorMessage(parsed.error);
                                    clearTimeout(timeoutId);
                                    return;
                                }
                                if (parsed.status === 'complete') {
                                    console.log('Received complete status');
                                    responseComplete = true;
                                    clearTimeout(timeoutId);
                                    break;
                                }
                                if (parsed.chunk) {
                                    const chunk = parsed.chunk.trim();
                                    
                                    // Check for new section
                                    const sectionMatch = chunk.match(/^\[(.*?)\]/);
                                    if (sectionMatch) {
                                        const sectionName = sectionMatch[1];
                                        
                                        // If it's a RELATED TOPICS section
                                        if (sectionName === 'RELATED TOPICS') {
                                            // Only create new message and topics container if we don't already have one
                                            if (currentSection !== 'RELATED TOPICS') {
                                                // Append any existing message
                                                if (currentMessage && currentMessage.innerHTML.trim()) {
                                                    chatMessages.appendChild(currentMessage);
                                                }
                                                // Create a new message for topics
                                                currentMessage = document.createElement('div');
                                                currentMessage.className = 'message bot-message';
                                                currentSection = 'RELATED TOPICS';
                                                
                                                // Create topics container
                                                const topicsDiv = document.createElement('div');
                                                topicsDiv.className = 'related-topics';
                                                const header = document.createElement('div');
                                                header.className = 'related-topics-header';
                                                header.textContent = 'Related Topics:';
                                                topicsDiv.appendChild(header);
                                                currentMessage.appendChild(topicsDiv);
                                                chatMessages.appendChild(currentMessage);
                                                
                                                // Add related topics header to complete response
                                                window.completeResponse += '\n\nRelated Topics:\n';
                                            }
                                        } else {
                                            // For other sections
                                            if (currentMessage && currentMessage.innerHTML.trim()) {
                                                chatMessages.appendChild(currentMessage);
                                                requestAnimationFrame(scrollToBottom);
                                            }
                                            currentMessage = document.createElement('div');
                                            currentMessage.className = 'message bot-message';
                                            currentSection = sectionName;
                                            const header = document.createElement('div');
                                            header.className = 'section-header';
                                            header.textContent = chunk;
                                            currentMessage.appendChild(header);
                                            
                                            // Add section header to complete response
                                            window.completeResponse += '\n\n' + chunk + '\n';
                                        }
                                    } else {
                                        // Handle non-section content
                                        if (currentSection === 'RELATED TOPICS') {
                                            const topicsDiv = currentMessage.querySelector('.related-topics');
                                            if (topicsDiv) {
                                                // Initialize buffers if needed
                                                if (!topicsDiv.currentTopic) {
                                                    topicsDiv.currentTopic = '';
                                                    topicsDiv.honorificPending = false;
                                                }
                                                
                                                // Handle honorifics or normal text
                                                let processedChunk = chunk;
                                                if (chunk.includes('ï·º')) {  // Prophet Muhammad (PBUH)
                                                    processedChunk = processedChunk.replace(/ï·º/g, ' (PBUH) ');
                                                    topicsDiv.honorificPending = true;
                                                } else if (chunk.includes('Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡') || chunk.includes('Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡Ø§')) {  // RA
                                                    processedChunk = processedChunk.replace(/Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡|Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡Ø§/g, ' (RA) ');
                                                    topicsDiv.honorificPending = true;
                                                } else if (chunk.includes('Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…')) {  // AS
                                                    processedChunk = processedChunk.replace(/Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…/g, ' (AS) ');
                                                    topicsDiv.honorificPending = true;
                                                }
                                            
                                                if (topicsDiv.honorificPending && !processedChunk.trim().match(/[(.)]$/)) {
                                                    topicsDiv.currentTopic += processedChunk + ' ';
                                                    topicsDiv.honorificPending = false;
                                                } else {
                                                    topicsDiv.currentTopic += processedChunk;
                                                }
                                                
                                                // Check if we have any complete questions
                                                const questionMatches = topicsDiv.currentTopic.match(/\d+\.[^?]*\?/g);
                                                if (questionMatches && !topicsDiv.honorificPending) {
                                                    for (const question of questionMatches) {
                                                        // Clean up the question text
                                                        const cleanQuestion = question
                                                            .replace(/^\d+\.\s*/, '')  // Remove leading numbers
                                                            .replace(/\s+/g, ' ')       // Normalize whitespace
                                                            .trim();
                                                        
                                                        // Create button for the question
                                                        const button = document.createElement('button');
                                                        button.className = 'related-topic-tile';
                                                        button.textContent = cleanQuestion;
                                                        button.onclick = () => selectTopic(cleanQuestion);
                                                        topicsDiv.appendChild(button);
                                                    }
                                                    
                                                    // Keep any remaining partial question
                                                    const lastQuestionEnd = topicsDiv.currentTopic.lastIndexOf('?') + 1;
                                                    topicsDiv.currentTopic = topicsDiv.currentTopic.substring(lastQuestionEnd);
                                                }
                                            }
                                        } else {
                                            // Regular content
                                            if (!currentMessage) {
                                                currentMessage = document.createElement('div');
                                                currentMessage.className = 'message bot-message';
                                            }
                                            const content = document.createElement('span');
                                            content.innerHTML = processMessageText(chunk);
                                            currentMessage.appendChild(content);
                                            // Accumulate raw response text
                                            currentMessage.rawResponse = (currentMessage.rawResponse || '') + chunk;
                                            // Keep same text for full response
                                            currentMessage.fullResponse = (currentMessage.fullResponse || '') + chunk;
                                            // Add to global complete response
                                            window.completeResponse += chunk;
                                            if (!currentMessage.parentNode) {
                                                chatMessages.appendChild(currentMessage);
                                            }
                                        }
                                    }
                                }
                                scrollToBottom();
                            }
                        } catch (e) {
                            console.error("Error parsing message:", e, message);
                        }
                    }
                }
            } catch (error) {
                console.error('Error in sendMessage:', error);
                appendErrorMessage("An error occurred. Please try again.");
            } finally {
                isGenerating = false;
                document.querySelector('.send-button').style.display = 'inline-flex';
                document.getElementById('stop-button').style.display = 'none';
                document.querySelector('.response-indicator').style.display = 'none';
                if (loadingInterval) {
                    clearInterval(loadingInterval);
                }

                // Create a complete response container with all accumulated text
                const completeResponseContainer = document.createElement('div');
                completeResponseContainer.className = 'message bot-message complete-response-container';
                completeResponseContainer.style.marginTop = '20px';
                completeResponseContainer.style.backgroundColor = '#f0f7f4';
                completeResponseContainer.style.border = '1px solid #c8e6d7';
                completeResponseContainer.style.borderRadius = '8px';
                completeResponseContainer.style.padding = '15px';
                completeResponseContainer.style.marginTop = '20px';
                completeResponseContainer.style.boxShadow = '0 2px 5px rgba(0,0,0,0.05)';
                
                // Store the complete response text from the global variable
                completeResponseContainer.fullResponse = window.completeResponse;
                
                // Add a small indicator that this is for sharing
                const shareIndicator = document.createElement('div');
                shareIndicator.style.fontSize = '0.9em';
                shareIndicator.style.color = '#1e6f5c';
                shareIndicator.style.marginBottom = '10px';
                shareIndicator.style.fontWeight = '500';
                shareIndicator.textContent = 'Found this helpful? Spread the knowledge!';
                completeResponseContainer.appendChild(shareIndicator);
                
                // Add share section to the complete response container
                const shareSection = document.createElement('div');
                shareSection.className = 'share-section';
                shareSection.innerHTML = `
                    <div class="share-text">Continue the conversation:</div>
                    <div class="share-buttons">
                        <button class="share-btn x-btn" onclick="shareToTwitter(this.closest('.complete-response-container'))" title="Share on X">
                            <span class="x-icon">ð•</span>
                        </button>
                        <button class="share-btn" onclick="shareToWhatsApp(this.closest('.complete-response-container'))" title="Share on WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="share-btn" onclick="shareToTelegram(this.closest('.complete-response-container'))" title="Share on Telegram">
                            <i class="fab fa-telegram"></i>
                        </button>
                        <button class="share-btn" onclick="copyToClipboard(this.closest('.complete-response-container'))" title="Copy to clipboard">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                `;
                completeResponseContainer.appendChild(shareSection);
                chatMessages.appendChild(completeResponseContainer);
            }
        }

        function scrollToBottom() {
            const container = document.querySelector('.chat-container');
            const totalHeight = chatMessages.scrollHeight + 40; // 40px for padding
            const maxHeight = window.innerHeight - 300;
            
            // Set container height based on content
            container.style.minHeight = Math.min(totalHeight, maxHeight) + 'px';
            
            // Only scroll the chat messages container
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 10);
        }

        function appendErrorMessage(message) {
            const errorMessage = document.createElement('div');
            errorMessage.className = 'message error-message';
            errorMessage.textContent = message;
            chatMessages.appendChild(errorMessage);
            scrollToBottom();
        }

    </script>
    
    <!-- Ramadan Prayer Times & Hadith Script -->
    <script>
        // Ramadan Hadiths Collection
        const ramadanHadiths = [
            {
                arabic: "Ù…ÙŽÙ†Ù’ ØµÙŽØ§Ù…ÙŽ Ø±ÙŽÙ…ÙŽØ¶ÙŽØ§Ù†ÙŽ Ø¥ÙÙŠÙ…ÙŽØ§Ù†Ù‹Ø§ ÙˆÙŽØ§Ø­Ù’ØªÙØ³ÙŽØ§Ø¨Ù‹Ø§ ØºÙÙÙØ±ÙŽ Ù„ÙŽÙ‡Ù Ù…ÙŽØ§ ØªÙŽÙ‚ÙŽØ¯ÙŽÙ‘Ù…ÙŽ Ù…ÙÙ†Ù’ Ø°ÙŽÙ†Ù’Ø¨ÙÙ‡Ù",
                english: "Whoever fasts during Ramadan out of sincere faith and hoping to attain Allah's rewards, then all his past sins will be forgiven.",
                source: "Sahih al-Bukhari 2014"
            },
            {
                arabic: "Ø§Ù„ØµÙÙ‘ÙŠÙŽØ§Ù…Ù Ø¬ÙÙ†ÙŽÙ‘Ø©ÙŒ ÙÙŽÙ„Ø§ÙŽ ÙŠÙŽØ±Ù’ÙÙØ«Ù’ ÙˆÙŽÙ„Ø§ÙŽ ÙŠÙŽØ¬Ù’Ù‡ÙŽÙ„Ù’ØŒ ÙˆÙŽØ¥ÙÙ†Ù Ø§Ù…Ù’Ø±ÙØ¤ÙŒ Ù‚ÙŽØ§ØªÙŽÙ„ÙŽÙ‡Ù Ø£ÙŽÙˆÙ’ Ø´ÙŽØ§ØªÙŽÙ…ÙŽÙ‡Ù ÙÙŽÙ„Ù’ÙŠÙŽÙ‚ÙÙ„Ù’ Ø¥ÙÙ†ÙÙ‘ÙŠ ØµÙŽØ§Ø¦ÙÙ…ÙŒØŒ Ø¥ÙÙ†ÙÙ‘ÙŠ ØµÙŽØ§Ø¦ÙÙ…ÙŒ",
                english: "Fasting is a shield. So, the person observing fasting should avoid sexual relation with his wife and should not behave foolishly and impudently, and if somebody fights with him or abuses him, he should tell him twice, 'I am fasting.'",
                source: "Sahih al-Bukhari 1894"
            },
            {
                arabic: "Ø¥ÙØ°ÙŽØ§ Ø¬ÙŽØ§Ø¡ÙŽ Ø±ÙŽÙ…ÙŽØ¶ÙŽØ§Ù†Ù ÙÙØªÙØ­ÙŽØªÙ’ Ø£ÙŽØ¨Ù’ÙˆÙŽØ§Ø¨Ù Ø§Ù„Ù’Ø¬ÙŽÙ†ÙŽÙ‘Ø©ÙØŒ ÙˆÙŽØºÙÙ„ÙÙ‘Ù‚ÙŽØªÙ’ Ø£ÙŽØ¨Ù’ÙˆÙŽØ§Ø¨Ù Ø§Ù„Ù†ÙŽÙ‘Ø§Ø±ÙØŒ ÙˆÙŽØµÙÙÙÙ‘Ø¯ÙŽØªÙ Ø§Ù„Ø´ÙŽÙ‘ÙŠÙŽØ§Ø·ÙÙŠÙ†Ù",
                english: "When the month of Ramadan starts, the gates of heaven are opened and the gates of Hell are closed and the devils are chained.",
                source: "Sahih al-Bukhari 1899"
            },
            {
                arabic: "Ù…ÙŽÙ†Ù’ Ù‚ÙŽØ§Ù…ÙŽ Ø±ÙŽÙ…ÙŽØ¶ÙŽØ§Ù†ÙŽ Ø¥ÙÙŠÙ…ÙŽØ§Ù†Ù‹Ø§ ÙˆÙŽØ§Ø­Ù’ØªÙØ³ÙŽØ§Ø¨Ù‹Ø§ ØºÙÙÙØ±ÙŽ Ù„ÙŽÙ‡Ù Ù…ÙŽØ§ ØªÙŽÙ‚ÙŽØ¯ÙŽÙ‘Ù…ÙŽ Ù…ÙÙ†Ù’ Ø°ÙŽÙ†Ù’Ø¨ÙÙ‡Ù",
                english: "Whoever establishes prayers during the nights of Ramadan faithfully out of sincere faith and hoping to attain Allah's rewards, all his past sins will be forgiven.",
                source: "Sahih al-Bukhari 2008"
            },
            {
                arabic: "Ù…ÙŽÙ†Ù’ Ø£ÙŽÙÙ’Ø·ÙŽØ±ÙŽ ØµÙŽØ§Ø¦ÙÙ…Ù‹Ø§ØŒ ÙƒÙŽØ§Ù†ÙŽ Ù„ÙŽÙ‡Ù Ù…ÙØ«Ù’Ù„Ù Ø£ÙŽØ¬Ù’Ø±ÙÙ‡ÙØŒ ØºÙŽÙŠÙ’Ø±ÙŽ Ø£ÙŽÙ†ÙŽÙ‘Ù‡Ù Ù„Ø§ÙŽ ÙŠÙŽÙ†Ù’Ù‚ÙØµÙ Ù…ÙÙ†Ù’ Ø£ÙŽØ¬Ù’Ø±Ù Ø§Ù„ØµÙŽÙ‘Ø§Ø¦ÙÙ…Ù Ø´ÙŽÙŠÙ’Ø¦Ù‹Ø§",
                english: "Whoever provides food for breaking the fast of a fasting person receives the same reward as the one who was fasting, without decreasing the reward of the fasting person.",
                source: "Sunan al-Tirmidhi 807"
            },
            {
                arabic: "Ø¥ÙÙ†ÙŽÙ‘ ÙÙÙŠ Ø§Ù„Ù’Ø¬ÙŽÙ†ÙŽÙ‘Ø©Ù Ø¨ÙŽØ§Ø¨Ù‹Ø§ ÙŠÙÙ‚ÙŽØ§Ù„Ù Ù„ÙŽÙ‡Ù Ø§Ù„Ø±ÙŽÙ‘ÙŠÙŽÙ‘Ø§Ù†Ù ÙŠÙŽØ¯Ù’Ø®ÙÙ„Ù Ù…ÙÙ†Ù’Ù‡Ù Ø§Ù„ØµÙŽÙ‘Ø§Ø¦ÙÙ…ÙÙˆÙ†ÙŽ ÙŠÙŽÙˆÙ’Ù…ÙŽ Ø§Ù„Ù’Ù‚ÙÙŠÙŽØ§Ù…ÙŽØ©Ù Ù„Ø§ÙŽ ÙŠÙŽØ¯Ù’Ø®ÙÙ„Ù Ù…ÙÙ†Ù’Ù‡Ù Ø£ÙŽØ­ÙŽØ¯ÙŒ ØºÙŽÙŠÙ’Ø±ÙÙ‡ÙÙ…Ù’",
                english: "There is a gate in Paradise called Ar-Raiyan, through which those who observe fasting will enter on the Day of Resurrection, and none except them will enter through it.",
                source: "Sahih al-Bukhari 1896"
            },
            {
                arabic: "Ø§ÙŽÙ„ØµÙŽÙ‘ÙˆÙ’Ù…Ù Ù„ÙÙŠ ÙˆÙŽØ£ÙŽÙ†ÙŽØ§ Ø£ÙŽØ¬Ù’Ø²ÙÙŠ Ø¨ÙÙ‡Ù",
                english: "Allah says: 'Fasting is for Me and I will give the reward for it.'",
                source: "Sahih al-Bukhari 1904"
            }
        ];
        
        // Function to display a random hadith
        function displayRandomHadith() {
            const randomIndex = Math.floor(Math.random() * ramadanHadiths.length);
            const hadith = ramadanHadiths[randomIndex];
            
            document.querySelector('.hadith-arabic').textContent = hadith.arabic;
            document.querySelector('.hadith-english').textContent = hadith.english;
            document.querySelector('.hadith-source').textContent = hadith.source;
        }
        
        // Function to get user's location and fetch prayer times
        async function getPrayerTimes() {
            try {
                // First try to get user's location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Get location name using reverse geocoding
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                            const data = await response.json();
                            const city = data.address.city || data.address.town || data.address.village || 'your location';
                            document.getElementById('location-info').textContent = `Based on ${city}`;
                        } catch (error) {
                            console.error('Error getting location name:', error);
                        }
                        
                        // Fetch prayer times using coordinates
                        fetchPrayerTimes(lat, lng);
                    }, (error) => {
                        console.error('Error getting location:', error);
                        // Fallback to default location (Washington DC)
                        fetchPrayerTimes(38.9072, -77.0369);
                        document.getElementById('location-info').textContent = 'Based on Washington DC (default)';
                    });
                } else {
                    // Geolocation not supported
                    fetchPrayerTimes(38.9072, -77.0369); // Default to Washington DC
                    document.getElementById('location-info').textContent = 'Based on Washington DC (default)';
                }
            } catch (error) {
                console.error('Error in getPrayerTimes:', error);
            }
        }
        
        // Function to fetch prayer times from API
        async function fetchPrayerTimes(latitude, longitude) {
            try {
                const today = new Date();
                const date = today.getDate();
                const month = today.getMonth() + 1;
                const year = today.getFullYear();
                
                // Using AlAdhan API to get prayer times
                const url = `https://api.aladhan.com/v1/timings/${date}-${month}-${year}?latitude=${latitude}&longitude=${longitude}&method=2`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    // Set Suhoor time (Fajr time)
                    const fajrTime = data.data.timings.Fajr;
                    document.getElementById('suhoor-time').textContent = formatTime(fajrTime);
                    
                    // Set Iftar time (Maghrib time)
                    const maghribTime = data.data.timings.Maghrib;
                    document.getElementById('iftar-time').textContent = formatTime(maghribTime);
                }
            } catch (error) {
                console.error('Error fetching prayer times:', error);
                document.getElementById('suhoor-time').textContent = 'Error loading';
                document.getElementById('iftar-time').textContent = 'Error loading';
            }
        }
        
        // Function to format time from 24h to 12h format
        function formatTime(time24) {
            const [hours, minutes] = time24.split(':');
            let period = 'AM';
            let hour = parseInt(hours, 10);
            
            if (hour >= 12) {
                period = 'PM';
                if (hour > 12) hour -= 12;
            }
            if (hour === 0) hour = 12;
            
            return `${hour}:${minutes} ${period}`;
        }
        
        // Function to update Eid countdown timer
        function updateEidCountdown() {
            // Eid al-Fitr 2025 date (March 30, 2025)
            const eidDate = new Date('March 30, 2025 00:00:00').getTime();
            const now = new Date().getTime();
            const distance = eidDate - now;
            
            // Calculate days, hours, minutes and seconds
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            
            // Display the result
            const countdownElement = document.getElementById('eid-countdown');
            
            if (distance < 0) {
                countdownElement.innerHTML = 'Eid Mubarak! ðŸŽ‰';
            } else {
                countdownElement.innerHTML = `${days}d ${hours}h ${minutes}m`;
            }
        }
        
        // Initialize prayer times and countdown on page load
        document.addEventListener('DOMContentLoaded', () => {
            getPrayerTimes();
            updateEidCountdown();
            // Update countdown every minute
            setInterval(updateEidCountdown, 60000);
            
            // Set up hadith refresh button
            document.getElementById('refresh-hadith-btn').addEventListener('click', displayRandomHadith);
            // Display initial random hadith
            displayRandomHadith();
            
            // Initialize authentication UI
            initAuthUI();
        });
    </script>
    
    <!-- Authentication Script -->
    <script type="module">
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            sendPasswordResetEmail,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        
        // DOM Elements
        let loginButton, signupButton, userProfile, userEmail, logoutButton;
        let loginModal, signupModal, resetPasswordModal;
        let loginEmail, loginPassword, signupEmail, signupPassword, signupConfirmPassword, resetEmail;
        let loginSubmit, signupSubmit, resetSubmit, googleSignin, googleSignup;
        let loginError, signupError, resetError, resetMessage;
        let switchToSignup, switchToLogin, forgotPassword, backToLogin;
        let closeButtons, mobileMenuButton, authContainer;
        
        // Initialize the auth UI
        function initAuthUI() {
            // Get DOM elements
            loginButton = document.getElementById('login-button');
            signupButton = document.getElementById('signup-button');
            userProfile = document.getElementById('user-profile');
            userEmail = document.getElementById('user-email');
            logoutButton = document.getElementById('logout-button');
            const profileButton = document.getElementById('profile-button');
            mobileMenuButton = document.querySelector('.mobile-menu-button');
            authContainer = document.getElementById('auth-container');
            
            // Ensure auth container is hidden by default on mobile
            if (authContainer && window.innerWidth <= 768) {
                authContainer.style.display = 'none';
            } else if (authContainer && window.innerWidth > 768) {
                // On desktop, we want it visible
                authContainer.style.display = 'flex';
            }
            
            loginModal = document.getElementById('login-modal');
            signupModal = document.getElementById('signup-modal');
            resetPasswordModal = document.getElementById('reset-password-modal');
            profileModal = document.getElementById('profile-modal'); // Changed from const to global variable
            
            loginEmail = document.getElementById('login-email');
            loginPassword = document.getElementById('login-password');
            signupEmail = document.getElementById('signup-email');
            signupPassword = document.getElementById('signup-password');
            signupConfirmPassword = document.getElementById('signup-confirm-password');
            resetEmail = document.getElementById('reset-email');
            
            loginSubmit = document.getElementById('login-submit');
            signupSubmit = document.getElementById('signup-submit');
            resetSubmit = document.getElementById('reset-submit');
            googleSignin = document.getElementById('google-signin');
            googleSignup = document.getElementById('google-signup');
            
            loginError = document.getElementById('login-error');
            signupError = document.getElementById('signup-error');
            resetError = document.getElementById('reset-error');
            resetMessage = document.getElementById('reset-message');
            
            switchToSignup = document.getElementById('switch-to-signup');
            switchToLogin = document.getElementById('switch-to-login');
            forgotPassword = document.getElementById('forgot-password');
            backToLogin = document.getElementById('back-to-login');
            
            closeButtons = document.querySelectorAll('.close-modal');
            
            // Remove any existing handlers first to avoid duplicates
            if (loginButton) loginButton.onclick = null;
            if (signupButton) signupButton.onclick = null;
            
            // Add direct event handlers with robust error handling
            if (loginButton && loginModal) {
                loginButton.onclick = function(e) {
                    try {
                        e.preventDefault();
                        e.stopPropagation(); // Prevent event bubbling
                        loginModal.style.display = 'block';
                        console.log('Login modal displayed directly');
                        // Clear any previous errors
                        const loginError = document.getElementById('login-error');
                        if (loginError) loginError.textContent = '';
                    } catch (error) {
                        console.error('Error showing login modal:', error);
                    }
                    return false;
                };
                console.log('Login button handler attached in initAuthUI');
            }
            
            if (signupButton && signupModal) {
                signupButton.onclick = function(e) {
                    try {
                        e.preventDefault();
                        e.stopPropagation(); // Prevent event bubbling
                        signupModal.style.display = 'block';
                        console.log('Signup modal displayed directly');
                        // Clear any previous errors
                        const signupError = document.getElementById('signup-error');
                        if (signupError) signupError.textContent = '';
                    } catch (error) {
                        console.error('Error showing signup modal:', error);
                    }
                    return false;
                };
                console.log('Signup button handler attached in initAuthUI');
            }
            
            if (logoutButton) {
                logoutButton.onclick = function(e) {
                    e.preventDefault();
                    handleLogout();
                };
            }
            
            if (profileButton && profileModal) {
                profileButton.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation(); // Prevent event bubbling
                    
                    // Make sure the profile modal is visible
                    profileModal.style.display = 'block';
                    
                    // Load the user profile data
                    const auth = getAuth();
                    const user = auth.currentUser;
                    if (user) {
                        // Update user display name in the modal
                        const modalUserName = document.getElementById('profile-user-name');
                        if (modalUserName) {
                            modalUserName.textContent = user.displayName || user.email || 'User';
                        }
                        
                        // Load the user profile data
                        loadUserProfile();
                    }
                    
                    console.log('Profile modal displayed directly');
                    return false;
                };
            }
            
            // Use direct onclick handlers for form submissions
            if (loginSubmit) {
                loginSubmit.onclick = function(e) {
                    e.preventDefault();
                    const email = loginEmail?.value?.trim() || '';
                    const password = loginPassword?.value || '';
                    
                    if (!email || !password) {
                        if (loginError) loginError.textContent = 'Please enter both email and password';
                        return;
                    }
                    
                    const auth = getAuth();
                    signInWithEmailAndPassword(auth, email, password)
                        .then((userCredential) => {
                            // Hide the login modal
                            if (loginModal) loginModal.style.display = 'none';
                            if (loginEmail) loginEmail.value = '';
                            if (loginPassword) loginPassword.value = '';
                            console.log('Login successful');
                            
                            // Manually update UI elements to show authenticated state
                            const user = userCredential.user;
                            document.querySelectorAll('.authenticated').forEach(el => {
                                if (el) el.style.display = 'block';
                            });
                            document.querySelectorAll('.unauthenticated').forEach(el => {
                                if (el) el.style.display = 'none';
                            });
                            
                            // Update user display name
                            const userDisplayName = document.getElementById('user-display-name');
                            if (userDisplayName) {
                                userDisplayName.textContent = user.displayName || user.email || 'User';
                            }
                            
                            // Check if we need to show premium options after login
                            const premiumAfterLogin = safeGetItem('premium_after_login');
                            if (premiumAfterLogin === 'true') {
                                // Clear the flag
                                safeSetItem('premium_after_login', '');
                                // Show premium options with a slight delay
                                setTimeout(() => {
                                    try {
                                        showPremiumOptions(user);
                                    } catch (err) {
                                        console.error('Error showing premium options after login:', err);
                                    }
                                }, 500);
                            }
                        })
                        .catch((error) => {
                            console.error('Login error:', error);
                            if (loginError) {
                                if (error.code === 'auth/invalid-credential') {
                                    loginError.textContent = 'Invalid email or password';
                                } else {
                                    loginError.textContent = error.message;
                                }
                            }
                        });
                };
            }
            
            if (signupSubmit) {
                signupSubmit.onclick = function(e) {
                    e.preventDefault();
                    const email = signupEmail?.value?.trim() || '';
                    const password = signupPassword?.value || '';
                    const confirmPassword = signupConfirmPassword?.value || '';
                    
                    if (!email || !password || !confirmPassword) {
                        if (signupError) signupError.textContent = 'Please fill in all fields';
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        if (signupError) signupError.textContent = 'Passwords do not match';
                        return;
                    }
                    
                    if (password.length < 6) {
                        if (signupError) signupError.textContent = 'Password must be at least 6 characters';
                        return;
                    }
                    
                    const auth = getAuth();
                    const db = getFirestore();
                    
                    createUserWithEmailAndPassword(auth, email, password)
                        .then((userCredential) => {
                            return setDoc(doc(db, 'users', userCredential.user.uid), {
                                email: email,
                                createdAt: serverTimestamp(),
                                subscription: {
                                    type: 'free',
                                    questionsRemaining: 7
                                }
                            });
                        })
                        .then(() => {
                            if (signupModal) signupModal.style.display = 'none';
                            if (signupEmail) signupEmail.value = '';
                            if (signupPassword) signupPassword.value = '';
                            if (signupConfirmPassword) signupConfirmPassword.value = '';
                            console.log('Signup successful');
                        })
                        .catch((error) => {
                            console.error('Signup error:', error);
                            if (signupError) signupError.textContent = error.message;
                        });
                };
            }
            
            if (resetSubmit) {
                resetSubmit.onclick = function(e) {
                    e.preventDefault();
                    handlePasswordReset();
                };
            }
            
            if (googleSignin) {
                googleSignin.onclick = function(e) {
                    e.preventDefault();
                    handleGoogleAuth(true);
                };
            }
            
            if (googleSignup) {
                googleSignup.onclick = function(e) {
                    e.preventDefault();
                    handleGoogleAuth(false);
                };
            }
            
            // Use direct onclick handlers for modal switching
            if (switchToSignup) {
                switchToSignup.onclick = function(e) {
                    e.preventDefault();
                    if (loginModal) loginModal.style.display = 'none';
                    if (signupModal) signupModal.style.display = 'block';
                };
            }
            
            if (switchToLogin) {
                switchToLogin.onclick = function(e) {
                    e.preventDefault();
                    if (signupModal) signupModal.style.display = 'none';
                    if (loginModal) loginModal.style.display = 'block';
                };
            }
            
            if (forgotPassword) {
                forgotPassword.onclick = function(e) {
                    e.preventDefault();
                    if (loginModal) loginModal.style.display = 'none';
                    if (resetPasswordModal) resetPasswordModal.style.display = 'block';
                };
            }
            
            if (backToLogin) {
                backToLogin.onclick = function(e) {
                    e.preventDefault();
                    if (resetPasswordModal) resetPasswordModal.style.display = 'none';
                    if (loginModal) loginModal.style.display = 'block';
                };
            }
            
            // Use direct onclick handlers for close buttons
            document.querySelectorAll('.close-modal').forEach(button => {
                button.onclick = function() {
                    const modal = this.closest('.auth-modal');
                    if (modal) {
                        modal.style.display = 'none';
                        console.log('Modal closed via close button:', modal.id);
                    } else {
                        // Fallback to hiding all modals directly
                        if (loginModal) loginModal.style.display = 'none';
                        if (signupModal) signupModal.style.display = 'none';
                        if (resetPasswordModal) resetPasswordModal.style.display = 'none';
                        if (profileModal) profileModal.style.display = 'none';
                        console.log('All modals closed via close button');
                    }
                };
            });
            
            // Close modal when clicking outside using direct onclick
            window.onclick = function(event) {
                if (event.target === loginModal) loginModal.style.display = 'none';
                if (event.target === signupModal) signupModal.style.display = 'none';
                if (event.target === resetPasswordModal) resetPasswordModal.style.display = 'none';
                if (event.target === profileModal) profileModal.style.display = 'none';
            };
            
            // Premium signup button in empowering section with improved error handling
            const premiumSignupButton = document.getElementById('empowering-signup-button');
            if (premiumSignupButton) {
                premiumSignupButton.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation(); // Prevent event bubbling
                    console.log('Premium signup button clicked directly');
                    
                    try {
                        // Load the Stripe Buy Button script if needed
                        if (typeof loadBuyButton === 'function') {
                            loadBuyButton();
                        }
                        
                        const auth = getAuth();
                        const user = auth.currentUser;
                        
                        if (user) {
                            // User is signed in, show profile modal with subscription options
                            const profileModal = document.getElementById('profile-modal');
                            if (profileModal) {
                                try {
                                    profileModal.style.display = 'block';
                                    loadUserProfile();
                                    console.log('Profile modal displayed for premium user');
                                    
                                    // Mark that user clicked premium signup
                                    safeSetItem('premium_signup_clicked', 'true');
                                } catch (modalError) {
                                    console.error('Error displaying profile modal:', modalError);
                                }
                            } else {
                                console.error('Profile modal not found');
                            }
                        } else {
                            // User is not signed in, show signup modal with premium message
                            if (signupModal) {
                                try {
                                    signupModal.style.display = 'block';
                                    console.log('Signup modal displayed for premium signup');
                                    
                                    // Mark that user clicked premium signup
                                    safeSetItem('premium_signup_intent', 'true');
                                    
                                    // Add a note that they're signing up for premium
                                    const premiumMessage = document.createElement('div');
                                    premiumMessage.className = 'auth-message premium-message';
                                    premiumMessage.textContent = 'Complete signup to access premium subscription options';
                                    
                                    const signupForm = document.querySelector('#signup-modal .auth-form');
                                    // Only add the message if it doesn't already exist
                                    if (signupForm && !signupForm.querySelector('.premium-message')) {
                                        const errorElement = signupForm.querySelector('#signup-error');
                                        if (errorElement) {
                                            signupForm.insertBefore(premiumMessage, errorElement);
                                        } else {
                                            signupForm.appendChild(premiumMessage);
                                        }
                                    }
                                } catch (modalError) {
                                    console.error('Error displaying signup modal:', modalError);
                                }
                            } else {
                                console.error('Signup modal not found');
                            }
                        }
                    } catch (error) {
                        console.error('Error handling premium signup:', error);
                    }
                    
                    return false; // Prevent default and stop propagation
                };
                console.log('Premium signup button handler attached');
            }
            
            // API Key Management
            const apiKeyInput = document.getElementById('api-key-input');
            const toggleApiKeyButton = document.getElementById('toggle-api-key');
            const saveApiKeyButton = document.getElementById('save-api-key');
            const upgradeButton = document.getElementById('upgrade-button');
            
            // Load saved API key if exists - with iframe protection
            if (apiKeyInput) {
                const savedApiKey = safeGetItem('openai_api_key');
                if (savedApiKey) {
                    apiKeyInput.value = savedApiKey;
                }
            }
            
            // Toggle API key visibility - using direct onclick handler
            if (toggleApiKeyButton && apiKeyInput) {
                toggleApiKeyButton.onclick = function(e) {
                    e.preventDefault();
                    try {
                        if (apiKeyInput.type === 'password') {
                            apiKeyInput.type = 'text';
                            toggleApiKeyButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
                        } else {
                            apiKeyInput.type = 'password';
                            toggleApiKeyButton.innerHTML = '<i class="fas fa-eye"></i>';
                        }
                    } catch (error) {
                        console.error('Error toggling API key visibility:', error);
                    }
                };
            }
            
            // Save API key - using direct onclick handler
            if (saveApiKeyButton && apiKeyInput) {
                saveApiKeyButton.onclick = function(e) {
                    e.preventDefault();
                    try {
                        const apiKey = apiKeyInput.value.trim();
                        const profileMessage = document.getElementById('profile-message');
                        
                        if (apiKey) {
                            // Use our safe storage function
                            const saved = safeSetItem('openai_api_key', apiKey);
                            if (profileMessage) {
                                if (saved) {
                                    profileMessage.textContent = 'API key saved successfully!';
                                    profileMessage.style.color = 'green';
                                } else {
                                    profileMessage.textContent = 'Could not save API key (storage access error)';
                                    profileMessage.style.color = 'red';
                                }
                            }
                        } else {
                            try {
                                // Try to remove the item safely
                                if (!isInIframe()) {
                                    localStorage.removeItem('openai_api_key');
                                }
                                if (profileMessage) {
                                    profileMessage.textContent = 'API key removed.';
                                    profileMessage.style.color = 'orange';
                                }
                            } catch (error) {
                                console.error('Error removing API key:', error);
                                if (profileMessage) {
                                    profileMessage.textContent = 'Could not remove API key (storage access error)';
                                    profileMessage.style.color = 'red';
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error saving API key:', error);
                    }
                };
            }
            
            // Handle premium upgrade with iframe protection - using direct onclick handler
            if (upgradeButton) {
                upgradeButton.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation(); // Prevent event bubbling
                    console.log('Premium upgrade button clicked');
                    
                    // Load the Stripe Buy Button script if needed
                    if (typeof loadBuyButton === 'function') {
                        loadBuyButton();
                    }
                    
                    // Wait a moment for the script to load
                    setTimeout(() => {
                        handlePremiumUpgrade();
                    }, 500);
                    
                    return false;
                };
                console.log('Premium upgrade button handler attached');
            }
            
            // Simple mobile menu toggle - using direct onclick handler
            if (mobileMenuButton && authContainer) {
                mobileMenuButton.onclick = function(e) {
                    e.preventDefault();
                    try {
                        // Simple toggle
                        if (window.getComputedStyle(authContainer).display === 'flex') {
                            authContainer.style.display = 'none';
                            const icon = this.querySelector('i');
                            if (icon) icon.className = 'fas fa-bars';
                        } else {
                            authContainer.style.display = 'flex';
                            const icon = this.querySelector('i');
                            if (icon) icon.className = 'fas fa-times';
                        }
                    } catch (error) {
                        console.error('Error toggling mobile menu:', error);
                    }
                };
                
                // Close when clicking outside - only on mobile - using direct event handler
                document.onclick = function(e) {
                    try {
                        // Only apply this behavior on mobile screens
                        if (window.innerWidth <= 768) {
                            if (e.target !== mobileMenuButton && authContainer && !authContainer.contains(e.target) && 
                                window.getComputedStyle(authContainer).display === 'flex') {
                                authContainer.style.display = 'none';
                                const icon = mobileMenuButton.querySelector('i');
                                if (icon) icon.className = 'fas fa-bars';
                            }
                        }
                    } catch (error) {
                        console.error('Error handling document click for mobile menu:', error);
                    }
                };
                
                // Prevent closing when clicking inside menu - using direct onclick handler
                if (authContainer) {
                    authContainer.onclick = function(e) {
                        e.stopPropagation();
                    };
                }
            }
            
            // Auth toggle button functionality is now in initAuthUI
            
            // Listen for auth state changes
            // Make sure we're using the Firebase auth instance properly
            try {
                const auth = getAuth();
                if (auth) {
                    // Use a more robust auth state change handler
                    onAuthStateChanged(auth, function(user) {
                        console.log('Auth state changed:', user ? 'User logged in' : 'User logged out');
                        try {
                            // Update UI based on authentication state
                            if (user) {
                                // User is signed in
                                document.querySelectorAll('.authenticated').forEach(el => {
                                    if (el) el.style.display = 'block';
                                });
                                document.querySelectorAll('.unauthenticated').forEach(el => {
                                    if (el) el.style.display = 'none';
                                });
                                
                                // Explicitly update critical UI elements
                                const userProfile = document.getElementById('user-profile');
                                if (userProfile) {
                                    userProfile.style.display = 'flex';
                                }
                                
                                const loginButton = document.getElementById('login-button');
                                if (loginButton) {
                                    loginButton.style.display = 'none';
                                }
                                
                                const signupButton = document.getElementById('signup-button');
                                if (signupButton) {
                                    signupButton.style.display = 'none';
                                }
                                
                                // Update user display
                                const userDisplayName = document.getElementById('user-display-name');
                                if (userDisplayName) {
                                    userDisplayName.textContent = user.displayName || user.email || 'User';
                                }
                                
                                // Check if we need to show premium options after login
                                const premiumAfterLogin = safeGetItem('premium_after_login');
                                if (premiumAfterLogin === 'true') {
                                    // Clear the flag
                                    safeSetItem('premium_after_login', '');
                                    // Show premium options with a slight delay
                                    setTimeout(() => {
                                        try {
                                            showPremiumOptions(user);
                                        } catch (err) {
                                            console.error('Error showing premium options after login:', err);
                                        }
                                    }, 500);
                                }
                                
                                // Check if we need to verify a pending payment
                                const pendingUser = safeGetItem('pending_premium_user');
                                if (pendingUser === user.uid) {
                                    // Check if we have a payment verification from Stripe
                                    if (window.location.hash.includes('succeeded')) {
                                        console.log('Payment succeeded, verifying from URL hash...');
                                        setTimeout(() => {
                                            try {
                                                verifyPremiumPayment();
                                            } catch (err) {
                                                console.error('Error verifying payment after redirect:', err);
                                            }
                                        }, 1000);
                                    }
                                }
                                
                                // Load user profile data
                                loadUserProfile();
                            } else {
                                // User is signed out
                                document.querySelectorAll('.authenticated').forEach(el => {
                                    if (el) el.style.display = 'none';
                                });
                                document.querySelectorAll('.unauthenticated').forEach(el => {
                                    if (el) el.style.display = 'block';
                                });
                                
                                // Explicitly update critical UI elements
                                const userProfile = document.getElementById('user-profile');
                                if (userProfile) {
                                    userProfile.style.display = 'none';
                                }
                                
                                const loginButton = document.getElementById('login-button');
                                if (loginButton) {
                                    loginButton.style.display = 'block';
                                }
                                
                                const signupButton = document.getElementById('signup-button');
                                if (signupButton) {
                                    signupButton.style.display = 'block';
                                }
                            }
                        } catch (uiError) {
                            console.error('Error updating UI after auth state change:', uiError);
                        }
                    });
                    console.log('Robust auth state change listener initialized');
                } else {
                    console.error('Firebase auth not initialized properly');
                }
            } catch (error) {
                console.error('Error initializing auth state listener:', error);
            }
        }
        
        // Authentication functions
        async function handleLogin(event) {
            if (event) event.preventDefault();
            
            // Get elements directly to avoid potential reference issues
            const loginEmailInput = document.getElementById('login-email');
            const loginPasswordInput = document.getElementById('login-password');
            const loginErrorElement = document.getElementById('login-error');
            const loginModalElement = document.getElementById('login-modal');
            
            if (!loginEmailInput || !loginPasswordInput) {
                console.error('Login form elements not found');
                return;
            }
            
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            
            if (!email || !password) {
                showError(loginErrorElement, 'Please enter both email and password');
                return;
            }
            
            try {
                const auth = getAuth();
                console.log('Attempting login for:', email);
                await signInWithEmailAndPassword(auth, email, password);
                console.log('Login successful');
                hideModal(loginModalElement);
                clearInputs();
            } catch (error) {
                console.error('Login error:', error);
                handleAuthError(error, loginErrorElement);
            }
        }
        
        async function handleSignup(event) {
            if (event) event.preventDefault();
            
            // Get elements directly to avoid potential reference issues
            const signupEmailInput = document.getElementById('signup-email');
            const signupPasswordInput = document.getElementById('signup-password');
            const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
            const signupErrorElement = document.getElementById('signup-error');
            const signupModalElement = document.getElementById('signup-modal');
            
            if (!signupEmailInput || !signupPasswordInput || !signupConfirmPasswordInput) {
                console.error('Signup form elements not found');
                return;
            }
            
            const email = signupEmailInput.value.trim();
            const password = signupPasswordInput.value;
            const confirmPassword = signupConfirmPasswordInput.value;
            
            if (!email || !password || !confirmPassword) {
                showError(signupErrorElement, 'Please fill in all fields');
                return;
            }
            
            if (password !== confirmPassword) {
                showError(signupErrorElement, 'Passwords do not match');
                return;
            }
            
            if (password.length < 6) {
                showError(signupErrorElement, 'Password must be at least 6 characters');
                return;
            }
            
            try {
                const auth = getAuth();
                const db = getFirestore();
                console.log('Attempting signup for:', email);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log('Signup successful, creating user profile');
                await createUserProfile(userCredential.user, db);
                hideModal(signupModalElement);
                clearInputs();
            } catch (error) {
                console.error('Signup error:', error);
                handleAuthError(error, signupErrorElement);
            }
        }
        
        async function handleGoogleAuth(isSignIn) {
            try {
                const auth = getAuth();
                const db = getFirestore();
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Check if this is a new user
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists()) {
                    await createUserProfile(user, db);
                }
                
                hideModal(loginModal);
                hideModal(signupModal);
            } catch (error) {
                handleAuthError(error, isSignIn ? loginError : signupError);
            }
        }
        
        async function handleLogout() {
            try {
                const auth = getAuth();
                await signOut(auth);
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }
        
        async function handlePasswordReset(event) {
            event.preventDefault();
            
            const email = resetEmail.value.trim();
            
            if (!email) {
                showError(resetError, 'Please enter your email address');
                return;
            }
            
            try {
                const auth = getAuth();
                await sendPasswordResetEmail(auth, email);
                resetMessage.textContent = 'Password reset email sent! Check your inbox.';
                resetMessage.style.color = 'green';
                resetError.textContent = '';
            } catch (error) {
                handleAuthError(error, resetError);
                resetMessage.textContent = '';
            }
        }
        
        async function createUserProfile(user, db) {
            try {
                await setDoc(doc(db, 'users', user.uid), {
                    email: user.email,
                    createdAt: serverTimestamp(),
                    questionCount: 0,
                    lastQuestionDate: null,
                    subscription: {
                        type: 'free',
                        expiresAt: null
                    }
                });
            } catch (error) {
                console.error('Error creating user profile:', error);
            }
        }
        
        async function handleAuthStateChange(user) {
            if (user) {
                // User is signed in
                loginButton.style.display = 'none';
                signupButton.style.display = 'none';
                userProfile.style.display = 'flex';
                
                // Check if user has premium subscription
                try {
                    const db = getFirestore();
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.subscription && userData.subscription.type === 'premium') {
                            // User has premium subscription
                            console.log('User has premium subscription');
                            // Add premium badge to user email
                            if (!document.getElementById('premium-badge')) {
                                const premiumBadge = document.createElement('span');
                                premiumBadge.id = 'premium-badge';
                                premiumBadge.className = 'premium-badge';
                                premiumBadge.textContent = 'PREMIUM';
                                userEmail.appendChild(document.createTextNode(' '));
                                userEmail.appendChild(premiumBadge);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking subscription:', error);
                }
            } else {
                // User is signed out
                loginButton.style.display = 'block';
                signupButton.style.display = 'block';
                userProfile.style.display = 'none';
            }
        }
        
        // Function to load user profile data
        async function loadUserProfile() {
            const auth = getAuth();
            const user = auth.currentUser;
            
            if (!user) {
                return;
            }
            
            // Make sure profile UI elements are available
            const currentPlan = document.getElementById('current-plan');
            const upgradeButton = document.getElementById('upgrade-button');
            const profileError = document.getElementById('profile-error');
            const profileMessage = document.getElementById('profile-message');
            const profileModal = document.getElementById('profile-modal');
            
            // Clear any previous messages
            if (profileMessage) profileMessage.textContent = '';
            
            // Ensure the user profile section is visible
            const userProfile = document.getElementById('user-profile');
            if (userProfile) {
                userProfile.style.display = 'flex';
            }
            
            // Set default values first - this ensures the UI is always in a valid state
            // even if there are errors with Firestore
            if (currentPlan && upgradeButton) {
                currentPlan.textContent = 'Free Plan';
                currentPlan.classList.remove('premium');
                upgradeButton.textContent = 'Upgrade to Premium';
                
                // Set up the upgrade button click handler
                upgradeButton.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        // Close profile modal first
                        const profileModal = document.getElementById('profile-modal');
                        if (profileModal) profileModal.style.display = 'none';
                        
                        // Then handle premium upgrade with a slight delay
                        setTimeout(() => {
                            handlePremiumUpgrade();
                        }, 100);
                    } catch (err) {
                        console.log('Premium upgrade button clicked');
                    }
                };
            }
            
            // Clear any previous errors
            if (profileError) profileError.textContent = '';
            
            try {
                const db = getFirestore();
                // Use a timeout to prevent long-running Firestore operations
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firestore operation timed out')), 5000)
                );
                
                // Race between the Firestore operation and the timeout
                const userDocPromise = getDoc(doc(db, 'users', user.uid));
                const result = await Promise.race([userDocPromise, timeoutPromise])
                    .catch(error => {
                        // Silently handle timeout or permission errors
                        // We've already set default values above
                        return null;
                    });
                
                // If we got a valid result, update the UI
                if (result && result.exists()) {
                    const userData = result.data();
                    
                    if (currentPlan && upgradeButton && userData.subscription) {
                        if (userData.subscription.type === 'premium' && userData.subscription.active) {
                            // Check if subscription is still valid (not expired)
                            let isValid = true;
                            if (userData.subscription.endDate) {
                                const now = new Date();
                                const endDate = new Date(userData.subscription.endDate);
                                isValid = now <= endDate;
                            }
                            
                            if (isValid) {
                                currentPlan.textContent = 'Premium Plan';
                                currentPlan.classList.add('premium');
                                upgradeButton.textContent = 'Manage Subscription';
                                
                                // Show subscription details
                                if (profileMessage) {
                                    const planType = userData.subscription.plan || 'monthly';
                                    const endDate = userData.subscription.endDate ? new Date(userData.subscription.endDate).toLocaleDateString() : 'N/A';
                                    profileMessage.innerHTML = `<span style="color: green">Premium ${planType} plan active until: ${endDate}</span>`;
                                }
                            } else {
                                // Subscription expired
                                currentPlan.textContent = 'Free Plan (Premium Expired)';
                                currentPlan.classList.remove('premium');
                                upgradeButton.textContent = 'Renew Premium';
                                
                                // Reset the upgrade button to show premium options
                                upgradeButton.onclick = function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    try {
                                        handlePremiumUpgrade();
                                    } catch (err) {
                                        console.log('Premium upgrade button clicked');
                                    }
                                };
                                
                                if (profileMessage) {
                                    profileMessage.innerHTML = '<span style="color: #e53935">Your premium subscription has expired.</span>';
                                }
                            }
                        }
                    }
                } else if (result) {
                    // Document doesn't exist but we successfully connected to Firestore
                    // Try to create it, but don't worry if it fails
                    try {
                        await setDoc(doc(db, 'users', user.uid), {
                            email: user.email,
                            subscription: { type: 'free' },
                            createdAt: serverTimestamp()
                        }).catch(e => {
                            // Silently ignore permission errors
                            // We've already set default values above
                        });
                    } catch (createError) {
                        // Silently ignore errors
                        // We've already set default values above
                    }
                }
            } catch (error) {
                // Silently handle all errors - we've already set default values
                // No need to log to console or show error messages
            }
            
            // Don't automatically show the profile modal from loadUserProfile
            // This will be handled by the profile button click handler
        }
        
        // Function to handle premium upgrade with iframe protection and improved error handling
        async function handlePremiumUpgrade() {
            try {
                // First, close any open modals
                const profileModal = document.getElementById('profile-modal');
                if (profileModal) profileModal.style.display = 'none';
                
                const premiumModal = document.getElementById('premium-modal');
                if (premiumModal) premiumModal.style.display = 'none';
                
                const auth = getAuth();
                const user = auth.currentUser;
                
                if (!user) {
                    // Close all other modals first
                    const signupModal = document.getElementById('signup-modal');
                    if (signupModal) signupModal.style.display = 'none';
                    
                    const resetPasswordModal = document.getElementById('reset-password-modal');
                    if (resetPasswordModal) resetPasswordModal.style.display = 'none';
                    
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) {
                        try {
                            loginModal.style.display = 'block';
                            const loginError = document.getElementById('login-error');
                            if (loginError) {
                                loginError.textContent = 'Please sign in to upgrade to premium';
                                loginError.style.color = '#e53935';
                            }
                            console.log('Login modal displayed for premium upgrade');
                            
                            // Mark premium intent for after login
                            safeSetItem('premium_after_login', 'true');
                        } catch (modalError) {
                            // Silently handle error
                            console.log('Showing login modal for premium upgrade');
                        }
                    }
                    return;
                }
                
                // Check if user is already premium before showing upgrade options
                try {
                    const db = getFirestore();
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.subscription && 
                            userData.subscription.type === 'premium' && 
                            userData.subscription.active) {
                            
                            // Check if subscription is still valid (not expired)
                            let isValid = true;
                            if (userData.subscription.endDate) {
                                const now = new Date();
                                const endDate = new Date(userData.subscription.endDate);
                                isValid = now <= endDate;
                            }
                            
                            if (isValid) {
                                // User already has a valid premium subscription
                                // Just show the profile modal
                                const profileModal = document.getElementById('profile-modal');
                                if (profileModal) {
                                    profileModal.style.display = 'block';
                                    console.log('Profile modal displayed for premium user');
                                }
                                return;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking premium status:', error);
                    // Continue with premium upgrade flow
                }
                
                // Clear any premium intent flags
                safeSetItem('premium_after_login', '');
                
                // We no longer need to load the Stripe Buy Button script
                // since we're using direct links instead
                
                // Show premium options modal immediately
                try {
                    showPremiumOptions(user);
                } catch (modalError) {
                    // Silently handle error
                    console.log('Showing premium options');
                }
            } catch (error) {
                // Silently handle error
                console.log('Premium upgrade initiated');
                // Still show the premium options even if there was an error
                try {
                    const user = getAuth().currentUser;
                    if (user) {
                        showPremiumOptions(user);
                    }
                } catch (e) {
                    // Final fallback
                }
            }
        }
        
        function showPremiumOptions(user) {
            // Close any open modals first
            const profileModal = document.getElementById('profile-modal');
            if (profileModal && profileModal.style.display === 'block') {
                profileModal.style.display = 'none';
            }
            
            // Close any other auth modals that might be open
            const loginModal = document.getElementById('login-modal');
            if (loginModal) loginModal.style.display = 'none';
            
            const signupModal = document.getElementById('signup-modal');
            if (signupModal) signupModal.style.display = 'none';
            
            const resetPasswordModal = document.getElementById('reset-password-modal');
            if (resetPasswordModal) resetPasswordModal.style.display = 'none';
            
            // Remove existing premium modal if it exists
            let existingModal = document.getElementById('premium-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create new modal
            const premiumModal = document.createElement('div');
            premiumModal.id = 'premium-modal';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            const closeButton = document.createElement('span');
            closeButton.className = 'close-button';
            closeButton.innerHTML = '&times;';
            closeButton.onclick = function() {
                premiumModal.style.display = 'none';
            };
            
            const title = document.createElement('h2');
            title.textContent = 'Upgrade to Premium';
            title.style.color = '#1e6f5c';
            title.style.textAlign = 'center';
            
            // Add Ramadan special banner
            const ramadanBanner = document.createElement('div');
            ramadanBanner.className = 'ramadan-modal-promo';
            ramadanBanner.innerHTML = `
                <div class="ramadan-modal-badge">
                    <span class="ramadan-icon">â˜ª</span> RAMADAN SPECIAL
                </div>
                <p>Enjoy up to 50% off during the blessed month of Ramadan!</p>
            `;
            
            const description = document.createElement('p');
            description.textContent = 'Unlock unlimited questions, priority support, and advanced features.';
            description.style.textAlign = 'center';
            description.style.marginBottom = '20px';
            
            const priceContainer = document.createElement('div');
            priceContainer.className = 'price-container';
            
            // Monthly plan
            const monthlyPlan = document.createElement('div');
            monthlyPlan.className = 'price-option';
            monthlyPlan.innerHTML = `
                <div class="badge great-value-badge">GREAT VALUE</div>
                <div class="discount-badge">50% OFF</div>
                <h3>Premium Monthly</h3>
                <div class="price"><span class="original-price">$19.99</span> $9.99<span>/month</span></div>
                <ul>
                    <li>100 questions per month</li>
                    <li>Unlimited with your API key</li>
                    <li>Priority support</li>
                    <li>Cancel anytime</li>
                </ul>
                <div id="modal-monthly-stripe-container" class="stripe-button-container"></div>
            `;
            
            // Annual plan
            const annualPlan = document.createElement('div');
            annualPlan.className = 'price-option recommended';
            annualPlan.innerHTML = `
                <div class="badge">RECOMMENDED</div>
                <div class="discount-badge">50% OFF</div>
                <h3>Premium Annual</h3>
                <div class="price"><span class="original-price">$199.99</span> $99.99<span>/year</span></div>
                <div class="savings">Save 17%</div>
                <ul>
                    <li>100 questions per month</li>
                    <li>Unlimited with your API key</li>
                    <li>Priority support</li>
                    <li>All premium features</li>
                </ul>
                <div id="modal-annual-stripe-container" class="stripe-button-container"></div>
            `;
            
            priceContainer.appendChild(monthlyPlan);
            priceContainer.appendChild(annualPlan);
            
            modalContent.appendChild(closeButton);
            modalContent.appendChild(title);
            modalContent.appendChild(ramadanBanner);
            modalContent.appendChild(description);
            modalContent.appendChild(priceContainer);
            
            premiumModal.appendChild(modalContent);
            document.body.appendChild(premiumModal);
            
            // Use Stripe buy buttons like in the main page
            
            // Update the monthly subscription container with Stripe buy button
            const monthlyContainer = document.getElementById('modal-monthly-stripe-container');
            if (monthlyContainer) {
                monthlyContainer.innerHTML = ''; // Clear any existing content
                
                // Add Stripe script if not already present
                if (!document.querySelector('script[src="https://js.stripe.com/v3/buy-button.js"]')) {
                    const stripeScript = document.createElement('script');
                    stripeScript.src = 'https://js.stripe.com/v3/buy-button.js';
                    stripeScript.async = true;
                    document.head.appendChild(stripeScript);
                }
                
                // Create Stripe buy button for monthly subscription
                const monthlyBuyButton = document.createElement('stripe-buy-button');
                monthlyBuyButton.setAttribute('buy-button-id', 'buy_btn_1R0TLxDLlIJ8KokgsghoABCt');
                monthlyBuyButton.setAttribute('publishable-key', 'pk_live_51R0QM7DLlIJ8KokgtJ1OMLsHza1s8HHQsUfUqP0sMCrPfFSyWxHn3i1wRpDyWvhrj70eitF5HEwXBUSVITCqojnM00YqzhQDPV');
                
                // Store user info for verification before adding the button
                safeSetItem('pending_premium_user', user.uid);
                safeSetItem('premium_plan_selected', 'monthly');
                
                // Add event listener to detect Stripe checkout completion
                monthlyBuyButton.addEventListener('buyButtonStateChange', function(event) {
                    console.log('Monthly button state change:', event.detail.state);
                    if (event.detail.state === 'succeeded') {
                        console.log('Monthly payment succeeded, verifying...');
                        verifyPremiumPayment();
                        // Close the premium modal
                        const premiumModal = document.getElementById('premium-modal');
                        if (premiumModal) {
                            premiumModal.style.display = 'none';
                        }
                    }
                });
                
                monthlyContainer.appendChild(monthlyBuyButton);
            }
            
            // Create and add Annual subscription Stripe buy button
            const annualContainer = document.getElementById('modal-annual-stripe-container');
            if (annualContainer) {
                annualContainer.innerHTML = ''; // Clear any existing content
                
                // Create Stripe buy button for annual subscription
                const annualBuyButton = document.createElement('stripe-buy-button');
                annualBuyButton.setAttribute('buy-button-id', 'buy_btn_1R0TTUDLlIJ8Kokg2epkfzAF');
                annualBuyButton.setAttribute('publishable-key', 'pk_live_51R0QM7DLlIJ8KokgtJ1OMLsHza1s8HHQsUfUqP0sMCrPfFSyWxHn3i1wRpDyWvhrj70eitF5HEwXBUSVITCqojnM00YqzhQDPV');
                
                // Store user info for verification before adding the button
                safeSetItem('pending_premium_user', user.uid);
                safeSetItem('premium_plan_selected', 'annual');
                
                // Add event listener to detect Stripe checkout completion
                annualBuyButton.addEventListener('buyButtonStateChange', function(event) {
                    console.log('Annual button state change:', event.detail.state);
                    if (event.detail.state === 'succeeded') {
                        console.log('Annual payment succeeded, verifying...');
                        verifyPremiumPayment();
                        // Close the premium modal
                        const premiumModal = document.getElementById('premium-modal');
                        if (premiumModal) {
                            premiumModal.style.display = 'none';
                        }
                    }
                });
                
                annualContainer.appendChild(annualBuyButton);
            }
            
            // Store user info for verification - using safeSetItem instead of direct localStorage access
            // This is already handled in the button click handlers above
            
            // Add styles for the premium modal
            const style = document.createElement('style');
            style.textContent = `
                #premium-modal {
                    display: block; /* Show immediately */
                    position: fixed;
                    z-index: 9999;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(3px);
                }
                
                #premium-modal .modal-content {
                    background-color: #fefefe;
                    margin: 10% auto;
                    padding: 30px;
                    border: 1px solid #888;
                    border-radius: 15px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                    position: relative;
                    max-width: 800px;
                    width: 90%;
                    animation: modalFadeIn 0.3s ease-in-out;
                    box-sizing: border-box;
                    overflow: hidden;
                }
                
                /* Fix for mobile premium cards */
                .modal-content > * {
                    max-width: 100%;
                }
                
                /* Additional fixes for premium card alignment */
                #premium-modal .price-container {
                    width: 100%;
                    box-sizing: border-box;
                }
                
                /* Force premium cards to stay within container */
                .price-option {
                    max-width: 100%;
                    margin-left: auto;
                    margin-right: auto;
                }
                
                @keyframes modalFadeIn {
                    from {opacity: 0; transform: translateY(-20px);}
                    to {opacity: 1; transform: translateY(0);}
                }
                
                .close-button {
                    position: absolute;
                    right: 20px;
                    top: 15px;
                    font-size: 28px;
                    font-weight: bold;
                    color: #aaa;
                    cursor: pointer;
                    transition: color 0.2s ease;
                }
                
                .close-button:hover {
                    color: #333;
                }
                
                .price-container {
                    display: flex;
                    flex-direction: row;
                    justify-content: center;
                    gap: 20px;
                    margin-top: 20px;
                    flex-wrap: wrap;
                    max-width: 100%;
                    overflow: hidden;
                }
                .price-option {
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    padding: 20px;
                    min-width: 0;
                    flex: 1;
                    max-width: 350px;
                    position: relative;
                    background-color: white;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    display: flex;
                    flex-direction: column;
                    box-sizing: border-box;
                    width: 100%;
                }
                .price-option ul {
                    flex-grow: 1;
                }
                .price-option.recommended {
                    border: 2px solid #f0c14b;
                    transform: scale(1.05);
                }
                @media (max-width: 768px) {
                    .price-option.recommended {
                        transform: none;
                    }
                }
                /* Ensure stripe buttons are centered */
                .stripe-button-container,
                #modal-monthly-stripe-container,
                #modal-annual-stripe-container {
                    display: flex;
                    justify-content: center;
                    width: 100%;
                    margin-top: 10px;
                    overflow: hidden;
                }
                
                /* Fix Stripe button sizing in modal */
                #modal-monthly-stripe-container stripe-buy-button,
                #modal-annual-stripe-container stripe-buy-button {
                    width: 100%;
                    max-width: 320px;
                }
                
                /* Additional fixes for Stripe iframe in modal */
                #modal-monthly-stripe-container stripe-buy-button iframe,
                #modal-annual-stripe-container stripe-buy-button iframe {
                    min-width: unset !important;
                    width: 100% !important;
                    max-width: 100% !important;
                }
                @media (max-width: 1200px) {
                    .price-container {
                        flex-direction: column;
                        align-items: center;
                        width: 100%;
                    }
                    .price-option {
                        width: 100%;
                        max-width: 280px;
                        margin-bottom: 15px;
                    }
                    .price-option.recommended {
                        transform: none;
                        order: -1;
                    }
                }
                
                @media (max-width: 480px) {
                    #premium-modal .modal-content {
                        width: 95%;
                        padding: 15px 10px;
                        margin: 5% auto;
                    }
                    .price-option {
                        min-width: 0;
                        width: 90%;
                        max-width: 90%;
                        padding: 15px 10px;
                        margin: 0 auto;
                    }
                    .price-container {
                        padding: 0;
                        gap: 15px;
                        margin: 0;
                        width: 100%;
                    }
                    .price-option ul {
                        padding-left: 20px;
                    }
                    .price-option h3 {
                        font-size: 18px;
                    }
                    .price {
                        font-size: 20px;
                    }
                    /* Ensure no overflow */
                    .price-option.recommended {
                        transform: none;
                    }
                }
                .price-option h3 {
                    margin-top: 0;
                    color: #1e6f5c;
                }
                .price {
                    font-size: 24px;
                    font-weight: bold;
                    margin: 10px 0;
                }
                .price span {
                    font-size: 14px;
                    font-weight: normal;
                }
                .savings {
                    color: #e53935;
                    font-weight: bold;
                    margin-bottom: 10px;
                }
                .price-option ul {
                    list-style-type: none;
                    padding: 0;
                    margin: 15px 0;
                }
                .price-option li {
                    padding: 5px 0;
                    position: relative;
                    padding-left: 25px;
                }
                .price-option li:before {
                    content: 'âœ“';
                    color: #1e6f5c;
                    position: absolute;
                    left: 0;
                }
                .stripe-button, .premium-button {
                    background-color: #1e6f5c;
                    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                    color: white;
                    border: none;
                    border-radius: 30px;
                    padding: 12px 20px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    width: 100%;
                    margin-top: 10px;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                }
                .stripe-button:hover, .premium-button:hover {
                    background-color: #155043;
                    background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
                    transform: translateY(-2px);
                    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
                }
                .recommended-button {
                    background: linear-gradient(135deg, var(--ramadan-gold), #c4a046);
                }
                .recommended-button:hover {
                    background: linear-gradient(135deg, #c4a046, var(--ramadan-gold));
                }
                .badge {
                    position: absolute;
                    top: 0;
                    right: 0;
                    background: #f0c14b;
                    color: #1e6f5c;
                    padding: 5px 15px;
                    border-radius: 0 0 0 10px;
                    font-size: 12px;
                    font-weight: bold;
                }
                
                .great-value-badge {
                    background: var(--ramadan-gold);
                    color: var(--ramadan-deep-blue);
                }
                
                .discount-badge {
                    position: absolute;
                    top: 0;
                    left: 0;
                    background-color: #e63946;
                    color: white;
                    font-size: 12px;
                    font-weight: bold;
                    padding: 5px 15px;
                    border-radius: 0 0 10px 0;
                    z-index: 2;
                }
                
                .original-price {
                    font-size: 18px;
                    text-decoration: line-through;
                    color: #888;
                    margin-right: 5px;
                }
                
                .ramadan-modal-promo {
                    text-align: center;
                    margin: 10px auto 20px;
                    background-color: rgba(30, 111, 92, 0.1);
                    border-radius: 8px;
                    padding: 10px 15px;
                    max-width: 90%;
                }
                
                .ramadan-modal-badge {
                    display: inline-block;
                    background-color: rgba(255, 215, 0, 0.2);
                    color: #1e6f5c;
                    font-weight: 700;
                    padding: 5px 15px;
                    border-radius: 20px;
                    margin-bottom: 5px;
                    font-size: 14px;
                }
                
                .ramadan-icon {
                    margin-right: 5px;
                }
                
                .ramadan-modal-promo p {
                    color: #1e6f5c;
                    font-size: 16px;
                    margin: 5px 0 0;
                }
                @media (max-width: 600px) {
                    .price-container {
                        flex-direction: column;
                        align-items: center;
                    }
                    .price-option {
                        width: 100%;
                        max-width: 280px;
                        margin-bottom: 20px;
                    }
                    .price-option.recommended {
                        transform: none;
                    }
                }
                `;
            document.head.appendChild(style);
            
            // Show the modal with a slight delay to ensure everything is properly rendered
            setTimeout(() => {
                premiumModal.style.display = 'block';
            }, 100);
        }
        
        // Listen for Stripe checkout completion
        // This would normally be handled by a webhook, but for testing purposes
        // we'll add a verification button to the profile page after the modal is shown
        // Function to add verification button after Stripe checkout
        function addPaymentVerificationButton(user) {
            // Hide the premium modal
            const premiumModal = document.getElementById('premium-modal');
            if (premiumModal) {
                premiumModal.style.display = 'none';
            }
            
            // Show message to user
            const profileMessage = document.getElementById('profile-message');
            if (profileMessage) {
                profileMessage.textContent = 'After completing payment in the Stripe checkout, click the button below to verify your subscription.';
                profileMessage.style.color = '#1e6f5c';
                profileMessage.style.fontWeight = 'bold';
            }
            
            // Add verification button if it doesn't exist
            if (!document.getElementById('verify-payment-button')) {
                const verifyButton = document.createElement('button');
                verifyButton.textContent = 'Verify Premium Payment';
                verifyButton.className = 'auth-button';
                verifyButton.id = 'verify-payment-button';
                verifyButton.style.marginTop = '10px';
                verifyButton.style.backgroundColor = '#1e6f5c';
                verifyButton.style.color = 'white';
                verifyButton.style.border = 'none';
                verifyButton.style.padding = '10px 20px';
                verifyButton.style.borderRadius = '4px';
                verifyButton.style.cursor = 'pointer';
                verifyButton.addEventListener('click', verifyPremiumPayment);
                
                const profileMessageContainer = profileMessage?.parentNode;
                if (profileMessageContainer) {
                    profileMessageContainer.appendChild(verifyButton);
                }
            }
        }
        
        // Add a downgrade subscription function
        async function downgradeSubscription() {
            const auth = getAuth();
            const user = auth.currentUser;
            
            if (!user) {
                alert('You must be logged in to downgrade your subscription.');
                return;
            }
            
            try {
                const db = getFirestore();
                await setDoc(doc(db, 'users', user.uid), {
                    subscription: {
                        type: 'free',
                        plan: 'free',
                        active: false,
                        downgradeDate: new Date().toISOString(),
                        questionsRemaining: 7 // Reset to free tier question limit
                    }
                }, { merge: true });
                
                // Update UI
                loadUserProfile();
                
                // Show success message
                const profileMessage = document.getElementById('profile-message');
                if (profileMessage) {
                    profileMessage.innerHTML = '<span style="color: #e53935">Your subscription has been downgraded to the free plan.</span>';
                } else {
                    alert('Your subscription has been downgraded to the free plan.');
                }
                
                // Remove premium badge if present
                const premiumBadge = document.getElementById('premium-badge');
                if (premiumBadge) {
                    premiumBadge.remove();
                }
                
                // Reset the upgrade button to show premium options
                const upgradeButton = document.getElementById('upgrade-button');
                if (upgradeButton) {
                    upgradeButton.textContent = 'Upgrade to Premium';
                    upgradeButton.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        try {
                            // Close profile modal first
                            const profileModal = document.getElementById('profile-modal');
                            if (profileModal) profileModal.style.display = 'none';
                            
                            // Then handle premium upgrade
                            setTimeout(() => {
                                handlePremiumUpgrade();
                            }, 100);
                        } catch (err) {
                            console.log('Premium upgrade button clicked');
                        }
                    };
                }
            } catch (error) {
                console.error('Error downgrading subscription:', error);
                const profileError = document.getElementById('profile-error');
                if (profileError) {
                    profileError.textContent = 'Error downgrading subscription. Please try again later.';
                } else {
                    alert('Error downgrading subscription. Please try again later.');
                }
            }
        }
        
        // Function to verify premium payment
        async function verifyPremiumPayment() {
            const auth = getAuth();
            const user = auth.currentUser;
            
            if (!user) {
                const profileError = document.getElementById('profile-error');
                if (profileError) {
                    profileError.textContent = 'You must be logged in to verify payment.';
                }
                return;
            }
            
            // Check if the pending premium user matches the current user
            const pendingUser = safeGetItem('pending_premium_user');
            if (pendingUser && pendingUser !== user.uid) {
                console.error('User mismatch during payment verification');
                const profileError = document.getElementById('profile-error');
                if (profileError) {
                    profileError.textContent = 'User mismatch during payment verification.';
                }
                return;
            }
            
            try {
                // Get the plan type from localStorage using safe access
                const planType = safeGetItem('premium_plan_selected') || 'monthly';
                const isAnnual = planType === 'annual';
                
                // In a real implementation, this would check with your backend
                // which would verify the payment status with Stripe
                // For now, we'll simulate a successful payment verification
                
                // Calculate end date based on plan type
                const now = new Date();
                let endDate = new Date();
                if (isAnnual) {
                    endDate.setFullYear(endDate.getFullYear() + 1);
                } else {
                    endDate.setMonth(endDate.getMonth() + 1);
                }
                
                const db = getFirestore();
                await setDoc(doc(db, 'users', user.uid), {
                    subscription: {
                        type: 'premium',
                        plan: isAnnual ? 'annual' : 'monthly',
                        startDate: now.toISOString(),
                        endDate: endDate.toISOString(),
                        active: true,
                        paymentId: 'stripe_' + Math.random().toString(36).substring(2, 15), // Simulated payment ID
                        questionLimit: 100
                    }
                }, { merge: true });
                
                // Update UI
                loadUserProfile();
                
                // Show success message
                const profileMessage = document.getElementById('profile-message');
                if (profileMessage) {
                    profileMessage.innerHTML = `<span style="color: green">Premium ${isAnnual ? 'annual' : 'monthly'} subscription verified successfully!</span>`;
                }
                
                // Remove verification button
                const verifyButton = document.getElementById('verify-payment-button');
                if (verifyButton) {
                    verifyButton.remove();
                }
                
                // Add premium badge if not already there
                const userEmail = document.getElementById('user-email');
                if (userEmail && !document.getElementById('premium-badge')) {
                    const premiumBadge = document.createElement('span');
                    premiumBadge.id = 'premium-badge';
                    premiumBadge.className = 'premium-badge';
                    premiumBadge.textContent = 'PREMIUM';
                    userEmail.appendChild(document.createTextNode(' '));
                    userEmail.appendChild(premiumBadge);
                }
                
                // Clear the pending premium user and plan
                try {
                    if (!isInIframe()) {
                        localStorage.removeItem('pending_premium_user');
                        localStorage.removeItem('premium_plan_selected');
                        localStorage.removeItem('premium_after_login');
                    }
                } catch (storageError) {
                    console.error('Error clearing localStorage items:', storageError);
                }
            } catch (error) {
                console.error('Error verifying premium payment:', error);
                const profileError = document.getElementById('profile-error');
                if (profileError) {
                    profileError.textContent = 'Error verifying payment. Please contact support.';
                }
            }
        }
        
        // Helper functions - updated to avoid storage access errors
        function showModal(modal) {
            try {
                if (modal) {
                    modal.style.display = 'block';
                    console.log('Modal displayed:', modal.id || 'unnamed modal');
                    
                    // Check if this is a login modal and we have premium intent
                    if (modal.id === 'login-modal' && safeGetItem('premium_after_login') === 'true') {
                        const loginError = document.getElementById('login-error');
                        if (loginError) {
                            loginError.textContent = 'Please sign in to upgrade to premium';
                            loginError.style.color = '#e53935';
                        }
                    }
                } else {
                    console.error('Attempted to show a modal that does not exist');
                }
            } catch (error) {
                console.error('Error showing modal:', error);
            }
        }
        
        function hideModal(modal) {
            try {
                if (modal) {
                    modal.style.display = 'none';
                    console.log('Modal hidden:', modal.id || 'unnamed modal');
                    
                    // If this was a signup modal and we have premium intent, check if we need to show profile modal
                    if (modal.id === 'signup-modal' && safeGetItem('premium_signup_intent') === 'true') {
                        const auth = getAuth();
                        if (auth.currentUser) {
                            // User is now signed in, show profile modal
                            setTimeout(() => {
                                const profileModal = document.getElementById('profile-modal');
                                if (profileModal) {
                                    profileModal.style.display = 'block';
                                    loadUserProfile();
                                    console.log('Profile modal displayed after signup for premium');
                                }
                            }, 500);
                        }
                    }
                } else {
                    console.error('Attempted to hide a modal that does not exist');
                }
            } catch (error) {
                console.error('Error hiding modal:', error);
            }
        }
        
        function clearInputs() {
            loginEmail.value = '';
            loginPassword.value = '';
            signupEmail.value = '';
            signupPassword.value = '';
            signupConfirmPassword.value = '';
            resetEmail.value = '';
            
            loginError.textContent = '';
            signupError.textContent = '';
            resetError.textContent = '';
            resetMessage.textContent = '';
        }
        
        function showError(element, message) {
            if (element) element.textContent = message;
        }
        
        function handleAuthError(error, errorElement) {
            let errorMessage = 'An error occurred. Please try again.';
            
            switch (error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = 'This email is already in use. Please use a different email or sign in.';
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'Invalid email address. Please check your email.';
                    break;
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    errorMessage = 'Invalid email or password. Please try again.';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Password is too weak. Please use a stronger password.';
                    break;
                case 'auth/popup-closed-by-user':
                    errorMessage = 'Sign-in popup was closed before completing the sign in.';
                    break;
                case 'auth/cancelled-popup-request':
                    errorMessage = 'The sign-in popup was cancelled.';
                    break;
                case 'auth/popup-blocked':
                    errorMessage = 'Sign-in popup was blocked by the browser. Please allow popups for this site.';
                    break;
                default:
                    console.error('Auth error:', error);
            }
            
            showError(errorElement, errorMessage);
        }
        
        // Declare profileModal as a global variable
        let profileModal;
        
        // Expose initAuthUI and auth-related functions to global scope
        window.initAuthUI = initAuthUI;
        window.handleLogin = handleLogin;
        window.handleSignup = handleSignup;
        window.handleGoogleAuth = handleGoogleAuth;
        window.handleLogout = handleLogout;
        window.handlePasswordReset = handlePasswordReset;
        window.showModal = showModal;
        window.hideModal = hideModal;
        
        // Add debug functions to help troubleshoot auth issues
        window.debugAuth = function() {
            const auth = getAuth();
            console.log('Current auth state:', auth);
            console.log('Current user:', auth.currentUser);
            
            // Check if auth buttons exist and have handlers
            const loginBtn = document.getElementById('login-button');
            const signupBtn = document.getElementById('signup-button');
            console.log('Login button exists:', !!loginBtn);
            console.log('Login button has onclick handler:', !!loginBtn?.onclick);
            console.log('Signup button exists:', !!signupBtn);
            console.log('Signup button has onclick handler:', !!signupBtn?.onclick);
            
            // Check if modals exist
            const loginModal = document.getElementById('login-modal');
            const signupModal = document.getElementById('signup-modal');
            console.log('Login modal exists:', !!loginModal);
            console.log('Signup modal exists:', !!signupModal);
            
            return 'Auth debug info logged to console';
        };
        
        // Initialize auth UI when the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Wait a short time to ensure all elements are loaded
            setTimeout(() => {
                try {
                    // Remove any existing event handlers first
                    const loginBtn = document.getElementById('login-button');
                    const signupBtn = document.getElementById('signup-button');
                    const logoutBtn = document.getElementById('logout-button');
                    
                    if (loginBtn) loginBtn.onclick = null;
                    if (signupBtn) signupBtn.onclick = null;
                    if (logoutBtn) logoutBtn.onclick = null;
                    
                    // Now initialize the auth UI
                    initAuthUI();
                    console.log('Auth UI initialized with clean event handlers');
                    
                    // Ensure the auth buttons have direct inline event handlers
                    // This is critical to avoid storage access errors in iframes
                    const loginModal = document.getElementById('login-modal');
                    const signupModal = document.getElementById('signup-modal');
                    
                    if (loginBtn && loginModal) {
                        loginBtn.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation(); // Prevent event bubbling
                            if (loginModal) {
                                loginModal.style.display = 'block';
                                console.log('Login modal displayed via direct handler');
                            }
                            return false;
                        };
                        console.log('Login button handler attached directly');
                    }
                    
                    if (signupBtn && signupModal) {
                        signupBtn.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation(); // Prevent event bubbling
                            if (signupModal) {
                                signupModal.style.display = 'block';
                                console.log('Signup modal displayed via direct handler');
                            }
                            return false;
                        };
                        console.log('Signup button handler attached directly');
                    }
                    
                    if (logoutBtn) {
                        logoutBtn.onclick = function(e) {
                            e.preventDefault();
                            const auth = getAuth();
                            signOut(auth).then(() => {
                                console.log('User signed out');
                            }).catch((error) => {
                                console.error('Sign out error:', error);
                            });
                            return false;
                        };
                    }
                    
                    // Add direct event handlers to form submit buttons
                    const loginForm = document.getElementById('login-form');
                    const signupForm = document.getElementById('signup-form');
                    
                    if (loginForm) {
                        loginForm.onsubmit = function(e) {
                            e.preventDefault();
                            const email = document.getElementById('login-email').value.trim();
                            const password = document.getElementById('login-password').value;
                            const errorElement = document.getElementById('login-error');
                            
                            if (!email || !password) {
                                if (errorElement) errorElement.textContent = 'Please enter both email and password';
                                return false;
                            }
                            
                            const auth = getAuth();
                            signInWithEmailAndPassword(auth, email, password)
                                .then(() => {
                                    if (loginModal) loginModal.style.display = 'none';
                                    document.getElementById('login-email').value = '';
                                    document.getElementById('login-password').value = '';
                                })
                                .catch((error) => {
                                    console.error('Login error:', error);
                                    if (errorElement) {
                                        if (error.code === 'auth/invalid-credential') {
                                            errorElement.textContent = 'Invalid email or password';
                                        } else {
                                            errorElement.textContent = error.message;
                                        }
                                    }
                                });
                            return false;
                        };
                    }
                    
                    if (signupForm) {
                        signupForm.onsubmit = function(e) {
                            e.preventDefault();
                            const email = document.getElementById('signup-email').value.trim();
                            const password = document.getElementById('signup-password').value;
                            const confirmPassword = document.getElementById('signup-confirm-password').value;
                            const errorElement = document.getElementById('signup-error');
                            
                            if (!email || !password || !confirmPassword) {
                                if (errorElement) errorElement.textContent = 'Please fill in all fields';
                                return false;
                            }
                            
                            if (password !== confirmPassword) {
                                if (errorElement) errorElement.textContent = 'Passwords do not match';
                                return false;
                            }
                            
                            if (password.length < 6) {
                                if (errorElement) errorElement.textContent = 'Password must be at least 6 characters';
                                return false;
                            }
                            
                            const auth = getAuth();
                            const db = getFirestore();
                            
                            createUserWithEmailAndPassword(auth, email, password)
                                .then((userCredential) => {
                                    return setDoc(doc(db, 'users', userCredential.user.uid), {
                                        email: email,
                                        createdAt: serverTimestamp(),
                                        subscription: {
                                            type: 'free',
                                            questionsRemaining: 7
                                        }
                                    });
                                })
                                .then(() => {
                                    if (signupModal) signupModal.style.display = 'none';
                                    document.getElementById('signup-email').value = '';
                                    document.getElementById('signup-password').value = '';
                                    document.getElementById('signup-confirm-password').value = '';
                                })
                                .catch((error) => {
                                    console.error('Signup error:', error);
                                    if (errorElement) errorElement.textContent = error.message;
                                });
                            return false;
                        };
                    }
                    
                    console.log('Direct event handlers added to auth buttons and forms');
                } catch (error) {
                    console.error('Error during auth UI initialization:', error);
                }
            }, 500); // Increased timeout to ensure DOM is fully loaded
        });
    </script>
</body>
</html>
