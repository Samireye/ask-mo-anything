<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ask Mo Anything - Islamic Knowledge AI Assistant">
    <title>Ask Mo Anything</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            overflow-y: scroll;
        }

        :root {
            --primary-color: #1e6f5c;
            --secondary-color: #2a9d8f;
            --background-color: #f8f9fa;
            --text-color: #2c3e50;
            --arabic-font: 'Amiri', serif;
            --english-font: 'Roboto', sans-serif;
        }

        body {
            background: var(--background-color);
            color: var(--text-color);
            font-family: var(--english-font);
            line-height: 1.6;
        }

        .related-topics {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .related-topics-header {
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            width: fit-content;
        }

        .related-topic-tile {
            align-self: flex-start;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 20px 12px 45px;
            cursor: pointer;
            transition: all 0.25s ease;
            color: var(--text-color);
            font-size: 0.95em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative;
            text-align: left;
            width: 100%;
            max-width: 600px;
            line-height: 1.4;
            margin: 0;
        }

        .related-topic-tile::before {
            content: '‚Üí';
            position: absolute;
            left: 20px;
            color: var(--primary-color);
            font-weight: bold;
            opacity: 0.7;
            font-size: 1.2em;
            transition: all 0.25s ease;
        }

        .related-topic-tile:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateX(8px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .related-topic-tile:hover::before {
            color: white;
            opacity: 1;
            transform: translateX(3px);
        }

        .related-topic-tile:active {
            transform: translateX(8px) scale(0.98);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .arabic-text {
            font-family: var(--arabic-font);
            line-height: 2;
            direction: rtl;
            font-size: 1.1em;
            margin: 10px 0;
            text-align: right;
            background: rgba(30, 111, 92, 0.05);
            padding: 15px;
            border-radius: 8px;
            display: block;
            unicode-bidi: embed;
        }

        .arabic-inline {
            font-family: var(--arabic-font);
            font-size: 1em;
            display: inline-block !important;
            direction: rtl;
            padding: 0;
            margin: 0 0.15em;
            line-height: inherit;
            vertical-align: baseline;
            unicode-bidi: isolate;
        }

        .section-heading {
            color: var(--primary-color);
            font-weight: 500;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .arabic-title {
            font-family: var(--arabic-font);
            font-size: 1.8em;
            margin-top: 10px;
        }

        .header-image-container {
            max-width: 700px;
            margin: 30px auto;
            position: relative;
        }

        .header-image {
            width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .header-image:hover {
            transform: scale(1.02);
        }

        .image-disclaimer {
            font-size: 0.9em;
            color: #666;
            margin-top: 12px;
            font-style: italic;
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
        }

        .disclaimer {
            background: #fff;
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .disclaimer ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .suggested-topics {
            margin-bottom: 30px;
        }

        .suggested-topics h2 {
            color: var(--text-color);
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: 500;
            text-align: center;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 0 auto;
            max-width: 1000px;
        }

        .topic-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .topic-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .topic-title {
            color: var(--text-color);
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .topic-description {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .related-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .related-topic-tile {
            background: white;
            color: var(--text-color);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            white-space: normal;
            line-height: 1.4;
        }

        .related-topic-tile:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }

        .disclaimer li {
            margin-bottom: 5px;
        }

        .chat-container {
            flex: 1;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            min-height: 200px;
            max-height: calc(100vh - 300px);
            display: flex;
            flex-direction: column;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: min-height;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            transition: height 0.3s ease;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px 20px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 1.1em;
            animation: messageAppear 0.5s ease forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background-color: var(--primary-color);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .bot-message {
            background-color: #f8f9fa;
            color: var(--text-color);
            align-self: flex-start;
            margin-right: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }

        .error-message {
            background-color: #ffebee;
            color: #c62828;
            margin: 10px auto;
            text-align: center;
        }

        .section-header {
            font-weight: bold;
            margin: 15px 0 10px 0;
            color: #1976d2;
            font-size: 1.1em;
        }

        .arabic-text {
            font-family: "Traditional Arabic", "Arabic Typesetting", Arial, sans-serif;
            font-size: 1.3em;
            line-height: 1.8;
            direction: rtl;
            margin: 15px 0;
            text-align: right;
            color: #444;
        }

        .arabic-symbol {
            font-family: "Traditional Arabic", "Arabic Typesetting", Arial, sans-serif;
            font-size: 1.2em;
            color: #444;
            margin: 0 3px;
        }

        .input-container {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            margin-top: auto;
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            resize: none;
            font-size: 1em;
            font-family: inherit;
            min-height: 45px;
            max-height: 150px;
            transition: all 0.2s ease;
            line-height: 1.4;
            overflow-y: hidden;
        }

        #user-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(30,111,92,0.1);
        }

        .send-button {
            padding: 8px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            width: 40px;
            height: 40px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            stroke: white;
        }

        .send-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .response-indicator {
            background-color: var(--primary-color);
            color: white;
            font-size: 0.9em;
            padding: 8px 15px;
            border-radius: 4px;
            display: none;
            text-align: center;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stop-button {
            display: none;
            padding: 8px;
            background: #dc3545;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            margin-left: 8px;
            width: 40px;
            height: 40px;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .stop-button svg {
            width: 16px;
            height: 16px;
            stroke: white;
        }

        .stop-button:hover {
            background: #c82333;
        }

        .thinking-message {
            text-align: center;
            padding: 10px;
        }

        .thinking-message .arabic-text {
            font-family: "Traditional Arabic", "Arabic Typesetting", Arial, sans-serif;
            font-size: 1.4em;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .thinking-message .english-text {
            color: #666;
            margin-bottom: 10px;
        }

        .thinking-message .loading-dots {
            display: flex;
            justify-content: center;
            gap: 4px;
        }

        .thinking-message .loading-dots span {
            font-size: 24px;
            line-height: 10px;
            color: var(--primary-color);
            opacity: 0.2;
            transition: opacity 0.3s ease;
        }

        @media (max-width: 900px) {
            .topic-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .chat-container {
                padding: 10px;
            }

            .message {
                max-width: 90%;
            }

            .input-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ask Mo Anything</h1>
            <div class="arabic-title">ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ÿßŸÑŸÜÿ®Ÿä ŸÖÿ≠ŸÖÿØ Ô∑∫</div>
        </div>

        <div class="header-image-container">
            <img src="/images/islamic-art.png" alt="Islamic Art - Artistic Illustration" class="header-image">
            <p class="image-disclaimer">Note: This is an artistic illustration and not a depiction of Prophet Muhammad (peace be upon him)</p>
        </div>

        <div class="disclaimer">
            <strong>Important Notice:</strong>
            <p>This AI assistant provides information about Prophet Muhammad Ô∑∫ and Islamic teachings based on authentic sources. Please note:</p>
            <ul>
                <li>This is an AI tool and should not be considered a replacement for proper Islamic scholarship</li>
                <li>For religious rulings (fatawa), please consult qualified Islamic scholars</li>
                <li>Verify all information with authentic Islamic sources</li>
                <li>Treat all religious content with proper respect and adab (etiquette)</li>
            </ul>
        </div>

        <div class="suggested-topics">
            <h2>Explore Islamic Knowledge</h2>
            <div class="topic-grid">
                <div class="topic-card" data-topic="Tell me about the Islamic calendar and important dates">
                    <div class="topic-icon">üìÖ</div>
                    <div class="topic-title">Islamic Calendar</div>
                    <div class="topic-description">Learn about Hijri months, important dates, and their significance</div>
                </div>
                <div class="topic-card" data-topic="What are the Five Pillars of Islam?">
                    <div class="topic-icon">üïå</div>
                    <div class="topic-title">Five Pillars of Islam</div>
                    <div class="topic-description">Explore the fundamental practices of Islam</div>
                </div>
                <div class="topic-card" data-topic="Tell me about the life and teachings of Prophet Muhammad Ô∑∫">
                    <div class="topic-icon">üìö</div>
                    <div class="topic-title">Prophetic Biography</div>
                    <div class="topic-description">Discover the life and teachings of Prophet Muhammad Ô∑∫</div>
                </div>
                <div class="topic-card" data-topic="What are the prayer times and how do we perform salah correctly?">
                    <div class="topic-icon">üåü</div>
                    <div class="topic-title">Daily Prayers</div>
                    <div class="topic-description">Understanding Salah times and proper prayer methods</div>
                </div>
                <div class="topic-card" data-topic="Tell me about some important verses from the Quran">
                    <div class="topic-icon">üìñ</div>
                    <div class="topic-title">Quran Studies</div>
                    <div class="topic-description">Learn about Quranic verses, chapters, and their meanings</div>
                </div>
                <div class="topic-card" data-topic="What does the Quran teach us about morals and ethics?">
                    <div class="topic-icon">‚ù§Ô∏è</div>
                    <div class="topic-title">Islamic Ethics</div>
                    <div class="topic-description">Explore Islamic morals, values, and character building</div>
                </div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message bot-message">
                    <div lang="ar">ÿßŸÑÿ≥ŸéŸëŸÑÿßŸéŸÖŸè ÿπŸéŸÑŸéŸäŸíŸÉŸèŸÖŸí ŸàŸéÿ±Ÿéÿ≠ŸíŸÖŸéÿ©Ÿè ÿßŸÑŸÑŸáŸê ŸàŸéÿ®Ÿéÿ±ŸéŸÉŸéÿßÿ™ŸèŸáŸè</div>
                    Welcome! I'm here to help answer your questions about Prophet Muhammad Ô∑∫ and Islamic teachings. What would you like to know?
                </div>
            </div>
            <div class="input-section">
                <div class="response-indicator" style="display: none;">Mo is responding...</div>
                <div class="input-container">
                    <textarea id="user-input" placeholder="Type your question here..." rows="1"></textarea>
                    <button id="send-button" class="send-button">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                    <button id="stop-button" onclick="stopGeneration()" class="stop-button" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="6" y="6" width="12" height="12" rx="1" ry="1"></rect>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="empowering-section">
            <h2>Empowering Islamic Knowledge Through Technology</h2>
            <p>To ensure continuous and reliable access to this service, we encourage using your own OpenAI API key. This gives you unlimited access and helps support the infrastructure that makes this knowledge accessible to everyone.</p>
            <p>You can get your API key at <a href="https://platform.openai.com" target="_blank">OpenAI's website</a>, or to support our development efforts and continue accessing this platform:</p>
            <div class="buy-coffee-container">
                <a href="https://buymeacoffee.com/samir.shah" target="_blank" class="buy-coffee-button">
                    <img src="https://cdn.buymeacoffee.com/buttons/v2/default-white.png" alt="Buy Me A Coffee">
                </a>
            </div>
        </div>

        <div class="about-section">
            <h2><span class="bismillah">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸíŸÖŸê</span></h2>
            <h3>About Ask Mo Anything</h3>
            <p>Ask Mo Anything was built by Muslims, for Muslims, with the intention of serving our Ummah. In a world where accessing reliable Islamic knowledge can be challenging, we aim to bridge the gap between traditional wisdom and modern technology.</p>
            <p>Our goal is to make the teachings of Prophet Muhammad Ô∑∫ more accessible while maintaining the highest standards of authenticity and scholarly respect. We believe that technology, when used mindfully, can help revive Islamic scholarship in our modern era.</p>
            
            <div class="authenticity-section">
                <h4>Our Commitment to Authenticity</h4>
                <ul>
                    <li>‚úì This AI assistant is trained on authentic Islamic sources including recognized translations of the Quran, verified Hadith collections, and respected scholarly works.</li>
                    <li>‚úì While we strive for accuracy, this tool is not a substitute for qualified Islamic scholars or official religious rulings (fatwas).</li>
                    <li>‚úì For critical matters of faith, worship, or Islamic law, please consult qualified scholars and verify information with authentic sources.</li>
                    <li>‚úì Our responses are generated through AI interpretation of Islamic texts - always cross-reference with original sources.</li>
                </ul>
            </div>
        </div>
    </div>

    <style>
        .empowering-section {
            text-align: center;
            padding: 40px 20px;
            background: var(--primary-color);
            color: white;
            border-radius: 15px;
            margin: 40px 0;
        }

        .empowering-section h2 {
            margin-bottom: 20px;
            font-size: 2em;
        }

        .empowering-section p {
            margin-bottom: 15px;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .empowering-section a {
            color: white;
            text-decoration: underline;
        }

        .buy-coffee-container {
            margin-top: 30px;
        }

        .buy-coffee-button img {
            height: 40px;
        }

        .about-section {
            background: #f8f9fa;
            padding: 40px;
            border-radius: 15px;
            margin: 40px 0;
        }

        .about-section h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .about-section h3 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .bismillah {
            font-family: var(--arabic-font);
            font-size: 1.5em;
            color: var(--primary-color);
            display: block;
            text-align: center;
            margin-bottom: 20px;
        }

        .authenticity-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .authenticity-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .authenticity-section ul {
            list-style: none;
            padding: 0;
        }

        .authenticity-section li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
    </style>

    <script>
        // Global variables
        let chatMessages;
        let userInput;
        let sendButton;
        
        // Process message text
        function processMessageText(text) {
            if (!text) return '';
            
            let processedText = text;
            let relatedTopicsHtml = '';
            
            // Extract and process related topics
            const topicsMatch = processedText.match(/\[RELATED TOPICS\]([\s\S]*?)(?=\[|$)/i);
            if (topicsMatch) {
                const topicsSection = topicsMatch[1];
                processedText = processedText.replace(topicsMatch[0], '');
                
                // Split into lines and collect all questions
                const topics = [];
                const lines = topicsSection.split('\n');
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Handle numbered questions and their continuations
                    if (line.match(/^\d+\./)) {
                        let fullQuestion = line;
                        while (i + 1 < lines.length && !lines[i + 1].trim().match(/^\d+\.\s*|\[/)) {
                            i++;
                            fullQuestion += ' ' + lines[i].trim();
                        }
                        topics.push(fullQuestion.replace(/^\d+\.\s*/, ''));
                    }
                    // Handle standalone questions
                    else if (line.match(/^(What|How|Why|When|Where|Who|Which|Did|Is|Are|Can|Could|Should|Would|Tell)/i)) {
                        topics.push(line);
                    }
                }

                // Create quick-reply buttons for topics
                if (topics.length > 0) {
                    relatedTopicsHtml = `<div class="related-topics">
                        <div class="related-topics-header">Related Questions:</div>
                        ${topics.map(topic => {
                            // Clean up the topic text and add RTL marks
                            const clean = topic
                                .replace(/Ô∑∫/g, '(PBUH)\u200F')
                                .replace(/(ÿ±ÿ∂Ÿä ÿßŸÑŸÑŸá ÿπŸÜŸá|ÿ±ÿ∂Ÿä ÿßŸÑŸÑŸá ÿπŸÜŸáÿß)/g, '(RA)\u200F')
                                .replace(/\s+/g, ' ')
                                .trim();
                            
                            // Create quick-reply button
                            const escapedTopic = clean.replace(/["']/g, '\\$&');
                            return `<button class="related-topic-tile" onclick="selectTopic('${escapedTopic}')">${clean}</button>`;
                        }).join('')}
                    </div>`;
                }
            }

            // Add empty Arabic character for alignment
            const arblank = '&#1564;';
            
            // Process the main text
            processedText = processedText
                // Handle sections
                .replace(/\[(CONCLUSION|HADITH|SCHOLARLY OPINIONS|PRACTICAL GUIDANCE)\]([^\[]*)/gi, 
                    '<div class="section-heading">[$1]</div>$2')
                // Handle honorifics inline with proper spacing and RTL marks
                .replace(/(Ô∑∫|ÿ±ÿ∂Ÿä ÿßŸÑŸÑŸá ÿπŸÜŸá|ÿ±ÿ∂Ÿä ÿßŸÑŸÑŸá ÿπŸÜŸáÿß)/g, 
                    match => ` ${arblank}<span class="arabic-inline" style="display:inline" lang="ar">${match}</span>\u200F `)
                // Handle longer Arabic passages (excluding honorifics)
                .replace(/(?<!Ô∑∫|ÿ±ÿ∂Ÿä ÿßŸÑŸÑŸá ÿπŸÜŸá|ÿ±ÿ∂Ÿä ÿßŸÑŸÑŸá ÿπŸÜŸáÿß)([\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\u064B-\u0652][^\s]*(?:\s+[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\u064B-\u0652][^\s]*){2,})/g, 
                    (_, match) => `<div class="arabic-text" lang="ar">${match}</div>`)
                // Handle remaining single Arabic words (excluding honorifics)
                .replace(/(?<!Ô∑∫|ÿ±ÿ∂Ÿä ÿßŸÑŸÑŸá ÿπŸÜŸá|ÿ±ÿ∂Ÿä ÿßŸÑŸÑŸá ÿπŸÜŸáÿß)([\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\u064B-\u0652]+)/g, 
                    (_, match) => `<span class="arabic-inline" lang="ar">${match}</span>`)
                // Clean up any double spaces
                .replace(/\s+/g, ' ');
            
            // Add related topics back at the end
            return processedText + relatedTopicsHtml;
        }
        
        // Helper functions
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function appendErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message error-message';
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            scrollToBottom();
        }
        
        // Initialize after DOM is loaded
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        document.addEventListener('DOMContentLoaded', () => {
            chatMessages = document.getElementById('chat-messages');
            userInput = document.getElementById('user-input');
            sendButton = document.getElementById('send-button');

            // Handle Enter key
            // Auto-resize textarea on input
            userInput.addEventListener('input', function() {
                autoResizeTextarea(this);
            });

            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey && !isGenerating) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Handle button click
            sendButton.addEventListener('click', function() {
                if (!isGenerating) {
                    sendMessage();
                }
            });

            // Handle topic card clicks
            document.querySelectorAll('.topic-card').forEach(card => {
                card.addEventListener('click', function() {
                    const topic = this.getAttribute('data-topic');
                    if (topic) {
                        userInput.value = topic;
                        sendMessage();
                    }
                });
            });
        });

        function selectTopic(topic) {
            // Handle escaped quotes in the topic
            const unescapedTopic = topic
                .replace(/\\'/g, "'")
                .replace(/\\\"/g, '"');
            userInput.value = unescapedTopic;
            sendMessage(unescapedTopic);
        }

        let currentReader = null;
        let isGenerating = false;

        function stopGeneration() {
            if (currentReader) {
                currentReader.cancel();
                document.getElementById('stop-button').style.display = 'none';
                document.querySelector('.send-button').style.display = 'inline-flex';
                isGenerating = false;
            }
        }

        async function sendMessage(message) {
            if (isGenerating) return;

            // If no message provided, get it from the input
            if (!message) message = userInput.value;
            if (!message || !message.trim()) return;
            
            // Clear input and show user message
            userInput.value = '';
            document.querySelector('.response-indicator').style.display = 'block';
            document.querySelector('.send-button').style.display = 'none';
            document.getElementById('stop-button').style.display = 'inline-flex';
            const userMessage = document.createElement('div');
            userMessage.className = 'message user-message';
            userMessage.textContent = message;
            chatMessages.appendChild(userMessage);
            scrollToBottom();

            // Show thinking message with Islamic theme
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message bot-message';
            loadingMessage.innerHTML = `
                <div class="thinking-message">
                    <div class="english-text">Mo is responding...</div>
                    <div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>
                </div>
            `;
            chatMessages.appendChild(loadingMessage);
            scrollToBottom();

            // Add loading animation
            const dots = loadingMessage.querySelectorAll('.loading-dots span');
            let dotIndex = 0;
            const loadingInterval = setInterval(() => {
                dots.forEach(dot => dot.style.opacity = '0.2');
                dots[dotIndex].style.opacity = '1';
                dotIndex = (dotIndex + 1) % dots.length;
            }, 500);

            let currentMessage = document.createElement('div');
            currentMessage.className = 'message bot-message';
            let currentSection = '';
            
            try {
                isGenerating = true;
                document.querySelector('.send-button').style.display = 'none';
                document.getElementById('stop-button').style.display = 'inline-flex';

                console.log('Sending message:', message);
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message }),
                });

                if (!response.ok) {
                    if (response.status === 429) {
                        const errorData = await response.json();
                        loadingMessage.remove();
                        const limitMessage = document.createElement('div');
                        limitMessage.className = 'message bot-message';
                        limitMessage.innerHTML = `
                            <div class="empowering-section" style="margin: 0; text-align: left;">
                                <h3 style="color: var(--primary-color); margin-bottom: 15px;">You've reached our API limit for today.</h3>
                                <p>To continue using our platform immediately:</p>
                                <ol style="margin: 15px 0; padding-left: 20px;">
                                    <li>Get your own OpenAI API key (preferred) - this gives you unlimited access right away</li>
                                </ol>
                                <p style="margin: 15px 0;">Want to support our mission? Consider buying us a coffee! üôÇ</p>
                                <p>Your support helps us develop new features including:</p>
                                <ul style="margin: 10px 0 15px 20px; list-style-type: '- ';">
                                    <li>User accounts with saved conversations</li>
                                    <li>Premium membership with unlimited questions</li>
                                    <li>Advanced features for deeper Islamic learning</li>
                                </ul>
                                <p style="font-style: italic; font-size: 0.9em;">Note: Supporting through Buy Me a Coffee is currently just for development support. We're working on a proper membership system!</p>
                                <div class="buy-coffee-container" style="margin-top: 15px; text-align: center;">
                                    <a href="https://buymeacoffee.com/samir.shah" target="_blank" class="buy-coffee-button">
                                        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-white.png" alt="Buy Me A Coffee">
                                    </a>
                                </div>
                            </div>
                        `;
                        chatMessages.appendChild(limitMessage);
                        scrollToBottom();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Remove loading message
                loadingMessage.remove();

                // Show stop button and hide send button
                document.getElementById('stop-button').style.display = 'inline-flex';
                document.querySelector('.send-button').style.display = 'none';
                isGenerating = true;

                currentReader = response.body.getReader();
                const decoder = new TextDecoder();
                let responseComplete = false;
                let timeoutId;
                let lastChunkTime = Date.now();

                console.log('Starting stream processing');
                const resetTimeout = () => {
                    if (timeoutId) clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        if (!responseComplete) {
                            console.error('Client timeout - no response for 60 seconds');
                            appendErrorMessage("The response was incomplete. Please try asking your question again.");
                            currentReader.cancel();
                        }
                    }, 60000);
                };

                while (true) {
                    resetTimeout();
                    const { done, value } = await currentReader.read();

                    if (done) {
                        console.log('Stream complete');
                        clearTimeout(timeoutId);
                        document.getElementById('stop-button').style.display = 'none';
                        document.querySelector('.send-button').style.display = 'inline-flex';
                        isGenerating = false;
                        break;
                    }

                    const timeSinceLastChunk = Date.now() - lastChunkTime;
                    if (timeSinceLastChunk > 10000) {
                        console.log(`No chunks received for ${timeSinceLastChunk}ms`);
                    }

                    lastChunkTime = Date.now();
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.trim() === '') continue;

                        const message = line.replace(/^data: /, '');
                        if (message === '[DONE]') {
                            console.log('Received [DONE] message');
                            responseComplete = true;
                            clearTimeout(timeoutId);
                            break;
                        }

                        try {
                            const parsed = JSON.parse(message);
                            if (parsed.error) {
                                console.error('Received error:', parsed.error);
                                appendErrorMessage(parsed.error);
                                clearTimeout(timeoutId);
                                return;
                            }
                            if (parsed.status === 'complete') {
                                console.log('Received complete status');
                                responseComplete = true;
                                clearTimeout(timeoutId);
                                break;
                            }
                            if (parsed.chunk) {
                                const chunk = parsed.chunk.trim();
                                
                                // Check for new section
                                const sectionMatch = chunk.match(/^\[(.*?)\]/);
                                if (sectionMatch) {
                                    const sectionName = sectionMatch[1];
                                    
                                    // If it's a RELATED TOPICS section
                                    if (sectionName === 'RELATED TOPICS') {
                                        // Only create new message and topics container if we don't already have one
                                        if (currentSection !== 'RELATED TOPICS') {
                                            // Append any existing message
                                            if (currentMessage && currentMessage.innerHTML.trim()) {
                                                chatMessages.appendChild(currentMessage);
                                            }
                                            // Create a new message for topics
                                            currentMessage = document.createElement('div');
                                            currentMessage.className = 'message bot-message';
                                            currentSection = 'RELATED TOPICS';
                                            
                                            // Create topics container
                                            const topicsDiv = document.createElement('div');
                                            topicsDiv.className = 'related-topics';
                                            const header = document.createElement('div');
                                            header.className = 'related-topics-header';
                                            header.textContent = 'Related Questions:';
                                            topicsDiv.appendChild(header);
                                            currentMessage.appendChild(topicsDiv);
                                            chatMessages.appendChild(currentMessage);
                                        }
                                    } else {
                                        // For other sections
                                        if (currentMessage && currentMessage.innerHTML.trim()) {
                                            chatMessages.appendChild(currentMessage);
                                            requestAnimationFrame(scrollToBottom);
                                        }
                                        currentMessage = document.createElement('div');
                                        currentMessage.className = 'message bot-message';
                                        currentSection = sectionName;
                                        const header = document.createElement('div');
                                        header.className = 'section-header';
                                        header.textContent = chunk;
                                        currentMessage.appendChild(header);
                                    }
                                } else {
                                    // Handle non-section content
                                    if (currentSection === 'RELATED TOPICS') {
                                        const topicsDiv = currentMessage.querySelector('.related-topics');
                                        if (topicsDiv) {
                                            // Initialize buffers if needed
                                            if (!topicsDiv.currentTopic) {
                                                topicsDiv.currentTopic = '';
                                                topicsDiv.honorificPending = false;
                                            }
                                            
                                            // Handle honorifics or normal text
                                            if (chunk.includes('Ô∑∫')) {  // Prophet Muhammad (PBUH)
                                                topicsDiv.currentTopic += ' (PBUH) ';
                                                topicsDiv.honorificPending = true;
                                            } else if (chunk.includes('ÿ±ÿ∂Ÿä ÿßŸÑŸÑŸá ÿπŸÜŸá') || chunk.includes('ÿ±ÿ∂Ÿä ÿßŸÑŸÑŸá ÿπŸÜŸáÿß')) {  // RA
                                                topicsDiv.currentTopic += ' (RA) ';
                                                topicsDiv.honorificPending = true;
                                            } else if (chunk.includes('ÿπŸÑŸäŸá ÿßŸÑÿ≥ŸÑÿßŸÖ')) {  // AS
                                                topicsDiv.currentTopic += ' (AS) ';
                                                topicsDiv.honorificPending = true;
                                            } else {
                                                if (topicsDiv.honorificPending) {
                                                    topicsDiv.currentTopic += ' ' + chunk;
                                                    topicsDiv.honorificPending = false;
                                                } else {
                                                    topicsDiv.currentTopic += chunk;
                                                }
                                            }
                                            
                                            // Check if we have any complete questions
                                            const questionMatches = topicsDiv.currentTopic.match(/\d+\.[^?]*\?/g);
                                            if (questionMatches && !topicsDiv.honorificPending) {
                                                for (const question of questionMatches) {
                                                    // Clean up the question text
                                                    const cleanQuestion = question
                                                        .replace(/^\d+\.\s*/, '')  // Remove leading numbers
                                                        .replace(/\s+/g, ' ')       // Normalize whitespace
                                                        .trim();
                                                    
                                                    // Create button for the question
                                                    const button = document.createElement('button');
                                                    button.className = 'related-topic-tile';
                                                    button.textContent = cleanQuestion;
                                                    button.onclick = () => selectTopic(cleanQuestion);
                                                    topicsDiv.appendChild(button);
                                                }
                                                
                                                // Keep any remaining partial question
                                                const lastQuestionEnd = topicsDiv.currentTopic.lastIndexOf('?') + 1;
                                                topicsDiv.currentTopic = topicsDiv.currentTopic.substring(lastQuestionEnd);
                                            }
                                        }
                                    } else {
                                        // Regular content
                                        if (!currentMessage) {
                                            currentMessage = document.createElement('div');
                                            currentMessage.className = 'message bot-message';
                                        }
                                        const content = document.createElement('span');
                                        content.innerHTML = processMessageText(chunk);
                                        currentMessage.appendChild(content);
                                        if (!currentMessage.parentNode) {
                                            chatMessages.appendChild(currentMessage);
                                        }
                                    }
                                }
                                scrollToBottom();
                            }
                        } catch (e) {
                            console.error("Error parsing message:", e, message);
                        }
                    }
                }
            } catch (error) {
                console.error('Error in sendMessage:', error);
                appendErrorMessage("An error occurred. Please try again.");
            } finally {
                isGenerating = false;
                document.querySelector('.send-button').style.display = 'inline-flex';
                document.getElementById('stop-button').style.display = 'none';
                document.querySelector('.response-indicator').style.display = 'none';
                if (loadingInterval) {
                    clearInterval(loadingInterval);
                }
            }
        }

        function scrollToBottom() {
            const container = document.querySelector('.chat-container');
            const totalHeight = chatMessages.scrollHeight + 40; // 40px for padding
            const maxHeight = window.innerHeight - 300;
            
            // Set container height based on content
            container.style.minHeight = Math.min(totalHeight, maxHeight) + 'px';
            
            // Smooth scroll to bottom with a slight delay to ensure content is rendered
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
                // Also scroll the page if needed
                if (container.getBoundingClientRect().bottom > window.innerHeight) {
                    window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }, 10);
        }

        function appendErrorMessage(message) {
            const errorMessage = document.createElement('div');
            errorMessage.className = 'message error-message';
            errorMessage.textContent = message;
            chatMessages.appendChild(errorMessage);
            scrollToBottom();
        }

    </script>
</body>
</html>
