<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ask Mo Anything - Your AI Islamic Knowledge Assistant for questions about Quran, Hadith, Islamic history, and guidance. Get instant, accurate answers to your Islamic questions about prayer, fasting, zakat, and more.">
    <meta name="keywords" content="Islamic AI, Islamic knowledge, Quran explanation, Hadith interpretation, Islamic questions, salah prayer times, how to pray in Islam, fasting in Ramadan, zakat calculation, Islamic history, Prophet Muhammad PBUH, Islamic guidance, Islamic FAQ, Islamic teachings, Islamic scholars, Islamic jurisprudence, fiqh questions, Islamic ethics, Islamic practices, halal food guidelines, Islamic finance">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Ask Mo Anything - AI Islamic Knowledge Assistant">
    <meta property="og:description" content="Get instant, accurate answers to your Islamic questions about Quran, Hadith, and Islamic teachings from a reliable AI source.">
    <meta property="og:url" content="https://ask-mo-anything.vercel.app">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://ask-mo-anything.vercel.app/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta name="twitter:card" content="summary_large_image">
    <title>Ask Mo Anything</title>
    
    <!-- Google AdSense Code -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1689374513929530" crossorigin="anonymous"></script>
    
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="AskMo" />
    <link rel="manifest" href="/site.webmanifest" />
    <!-- SEO Optimization: Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://www.googletagmanager.com">
    <link rel="preconnect" href="https://pagead2.googlesyndication.com">
    
    <!-- Load fonts with display=swap for better performance -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'">
    <!-- SEO Optimization: Load non-critical scripts with defer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
    <!-- Stripe JavaScript SDK with defer to prevent blocking -->
    <script src="https://js.stripe.com/v3/" defer></script>
    <!-- Load buy-button.js only when needed, not on initial page load -->
    <script>
        // Function to check if we're in an iframe
        function isInIframe() {
            try {
                return window !== window.top;
            } catch (e) {
                return true; // If we can't access window.top, we're likely in an iframe
            }
        }
        
        // Safe localStorage access functions
        function safeGetItem(key) {
            try {
                if (!isInIframe()) {
                    return localStorage.getItem(key);
                }
                return null;
            } catch (error) {
                console.error('Error accessing localStorage (get):', error);
                return null;
            }
        }
        
        function safeSetItem(key, value) {
            try {
                if (!isInIframe()) {
                    localStorage.setItem(key, value);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error accessing localStorage (set):', error);
                return false;
            }
        }
        
        // Defer loading of buy-button.js until it's actually needed
        function loadBuyButton() {
            if (!document.querySelector('script[src="https://js.stripe.com/v3/buy-button.js"]')) {
                const script = document.createElement('script');
                script.src = 'https://js.stripe.com/v3/buy-button.js';
                script.async = true;
                script.onload = function() {
                    console.log('Stripe Buy Button loaded successfully');
                };
                script.onerror = function() {
                    console.error('Failed to load Stripe Buy Button');
                };
                document.head.appendChild(script);
            }
        }
        
        // We'll call this function when the user clicks on premium upgrade
    </script>
    <!-- Vercel Analytics (with badge disabled) -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
        window.va('config', { debug: false, badge: false });
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    
    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0PS7B8P3V6"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0PS7B8P3V6');
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            sendPasswordResetEmail,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            serverTimestamp,
            collection,
            addDoc,
            query,
            where,
            orderBy,
            limit,
            getDocs
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDn_yz3eL1c4cxxaChd2YFx8TReFYSWI-Q",
            authDomain: "ask-mo-anything.firebaseapp.com",
            projectId: "ask-mo-anything",
            storageBucket: "ask-mo-anything.firebasestorage.app",
            messagingSenderId: "31573817503",
            appId: "1:31573817503:web:b8f5c3a066b3cb4243b69d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // Make Firebase services available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.googleProvider = googleProvider;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            overflow-y: scroll;
        }

        :root {
            --primary-color: #1e6f5c;
            --secondary-color: #2a9d8f;
            --background-color: #f8f9fa;
            --text-color: #2c3e50;
            --arabic-font: 'Amiri', serif;
            --english-font: 'Roboto', sans-serif;
            --ramadan-gold: #d4af37;
            --ramadan-deep-blue: #1a365d;
            --ramadan-light-blue: #4a90e2;
            --ramadan-light-gold: rgba(212, 175, 55, 0.1);
        }

        body {
            background: var(--background-color);
            color: var(--text-color);
            font-family: var(--english-font);
            line-height: 1.6;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 100 100"><path d="M50 5 L52.5 15 L62.5 15 L54.5 21 L57.5 30 L50 24 L42.5 30 L45.5 21 L37.5 15 L47.5 15 Z" fill="rgba(212,175,55,0.03)" /></svg>');
            background-size: 100px 100px;
            background-repeat: repeat;
        }
        
        /* Ramadan Banner Styles */
        .ramadan-banner {
            background: linear-gradient(135deg, var(--primary-color), #1a4a3c);
            color: white;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
            border-bottom: 2px solid var(--ramadan-gold);
            z-index: 5;
        }
        
        .ramadan-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M50 0 L100 50 L50 100 L0 50 Z" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></svg>');
            background-size: 30px 30px;
            opacity: 0.3;
            z-index: 0;
        }
        
        .ramadan-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }
        
        .ramadan-greeting {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }
        
        .ramadan-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--ramadan-gold);
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
            background: rgba(30, 111, 92, 0.6);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--ramadan-gold);
        }
        
        .ramadan-greeting h2 {
            font-size: 1.8rem;
            margin: 0;
            background: linear-gradient(to right, #fff, var(--ramadan-gold), #fff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        
        .ramadan-dates {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .eid-countdown {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid rgba(212, 175, 55, 0.3);
            flex: 1;
            margin: 0 10px;
        }
        
        .countdown-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 3px;
            color: var(--ramadan-gold);
        }
        
        .countdown-timer {
            font-weight: 600;
            font-size: 1rem;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .shawwal-reminder {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 8px;
            font-style: italic;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.4;
        }
        
        .prayer-times-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            backdrop-filter: blur(5px);
            border: 1px solid var(--ramadan-gold);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: rgba(30, 111, 92, 0.2);
            flex: 1;
            margin: 0 10px;
        }
        
        .prayer-times-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.25);
        }
        
        .prayer-times-header {
            text-align: center;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--ramadan-gold);
            font-size: 1.1rem;
        }
        
        .prayer-times {
            display: flex;
            justify-content: space-around;
            gap: 15px;
        }
        
        .prayer-time {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .prayer-name {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .prayer-time-value {
            font-size: 1.1rem;
            font-weight: 500;
            color: white;
        }
        
        .location-info {
            text-align: center;
            font-size: 0.8rem;
            margin-top: 10px;
            opacity: 0.7;
        }
        
        @media (max-width: 768px) {
            .ramadan-banner {
                padding: 20px 15px;
            }
            
            .ramadan-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .prayer-times-container {
                width: 100%;
            }
        }

        .related-topics {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .related-topics-header {
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            width: fit-content;
        }

        .related-topic-tile {
            align-self: flex-start;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 20px 12px 45px;
            cursor: pointer;
            transition: all 0.25s ease;
            color: var(--text-color);
            font-size: 0.95em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative;
            text-align: left;
            width: 100%;
            max-width: 600px;
            line-height: 1.4;
            margin: 0;
        }

        .related-topic-tile::before {
            content: '→';
            position: absolute;
            left: 20px;
            color: var(--primary-color);
            font-weight: bold;
            opacity: 0.7;
            font-size: 1.2em;
            transition: all 0.25s ease;
        }

        .related-topic-tile:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateX(8px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .related-topic-tile:hover::before {
            color: white;
            opacity: 1;
            transform: translateX(3px);
        }

        .related-topic-tile:active {
            transform: translateX(8px) scale(0.98);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .arabic-text {
            font-family: var(--arabic-font);
            line-height: 2;
            direction: rtl;
            font-size: 1.1em;
            margin: 10px 0;
            text-align: right;
            background: rgba(30, 111, 92, 0.05);
            padding: 15px;
            border-radius: 8px;
            display: block;
            unicode-bidi: embed;
        }

        .arabic-inline {
            font-family: var(--arabic-font);
            font-size: 1em;
            display: inline-block !important;
            direction: rtl;
            padding: 0;
            margin: 0 0.15em;
            line-height: inherit;
            vertical-align: baseline;
            unicode-bidi: isolate;
        }

        .section-heading {
            color: var(--primary-color);
            font-weight: 500;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header-container {
            width: 100%;
            margin: 0;
            padding: 0;
            background: var(--primary-color);
            position: relative;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Ramadan Hadith Styles */
        .hadith-section {
            width: 100%;
            background: linear-gradient(135deg, #d4af37, #e6c566, #d4af37);
            padding: 30px 0;
            margin: 30px 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
            border-radius: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .daily-wisdom-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
            color: #333;
        }
        
        .daily-wisdom-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.12);
        }
        
        .daily-wisdom-container::before {
            content: '\f0eb';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: -15px;
            bottom: -15px;
            font-size: 120px;
            color: rgba(212, 175, 55, 0.05);
            z-index: 0;
        }
        
        .wisdom-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            color: #333;
        }
        
        .wisdom-icon {
            width: 40px;
            height: 40px;
            background: #fff;
            color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .wisdom-header h3 {
            color: var(--primary-color);
            font-weight: 600;
            margin: 0;
            font-size: 1.3rem;
        }
        
        .wisdom-content {
            padding: 22px;
            background: linear-gradient(135deg, #fff8e1, #fff);
            border-radius: 12px;
            position: relative;
            z-index: 1;
            border-left: 4px solid var(--gold-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .wisdom-arabic {
            font-family: var(--arabic-font);
            font-size: 1.5rem;
            line-height: 1.8;
            text-align: right;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .wisdom-english {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        .wisdom-source {
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }
        
        .refresh-wisdom-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 20px;
            margin-top: 18px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            float: right;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .refresh-wisdom-btn i {
            margin-right: 5px;
        }
        
        .refresh-wisdom-btn:hover {
            background: var(--gold-color);
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.5);
        }
        
        .share-wisdom {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            margin-bottom: 15px; /* Reduced spacing since we have a separate divider */
            clear: both;
        }
        
        .wisdom-divider-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0 40px;
            clear: both;
        }
        
        .wisdom-divider-line {
            height: 2px;
            flex-grow: 1;
            background: linear-gradient(to right, transparent, #d4af37, #d4af37);
            margin: 0 10px;
        }
        
        .wisdom-divider-line:last-child {
            background: linear-gradient(to left, transparent, #d4af37, #d4af37);
        }
        
        .wisdom-divider-icon {
            color: #d4af37;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            border: 2px solid #d4af37;
        }
        
        .share-wisdom-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.2s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }
        
        .share-wisdom-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
        }
        
        #share-wisdom-twitter {
            background: #000;
        }
        
        #share-wisdom-facebook {
            background: #1877f2;
        }
        
        #share-wisdom-instagram {
            background: #C13584;
            background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D);
        }
        
        #share-wisdom-whatsapp {
            background: #25D366;
        }
        
        /* Prayer Times Styles */
        .prayer-times-container {
            max-width: 1000px;
            margin: 15px auto;
            padding: 15px 20px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
            color: #333;
            background: linear-gradient(to bottom, #fff8e1, white);
            border-left: 4px solid gold;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .prayer-times-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.12);
        }
        
        .prayer-times-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .prayer-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
        }
        
        .prayer-times-header h3 {
            color: var(--primary-color);
            font-weight: 600;
            margin: 0;
            font-size: 1.3rem;
        }
        
        .prayer-times-content {
            position: relative;
            z-index: 1;
            padding: 10px 0;
        }
        
        .prayer-time {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .prayer-time:last-child {
            border-bottom: none;
        }
        
        .prayer-time.next-prayer {
            background-color: rgba(212, 175, 55, 0.1);
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .time-remaining {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .location-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
            font-style: italic;
        }
        
        .location-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        .location-button:hover {
            background-color: #005a8c;
        }
        
        /* Simple Prayer Times Styles */
        .simple-prayer-times {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px 15px;
            background: linear-gradient(to bottom, #fff8e1, white);
            border-radius: 4px;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .simple-prayer-times .prayer-icon {
            margin-right: 12px;
            width: 36px;
            height: 36px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }
        
        .next-prayer-info, .prayer-times-content {
            flex: 1;
            font-size: 0.95rem;
        }
        
        #header-current-prayer, #header-next-prayer {
            margin: 5px 0;
            font-size: 0.95em;
        }
        
        #header-current-prayer {
            font-weight: bold;
        }
        
        .next-prayer-name, .current-prayer-name {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .next-prayer-time, .current-prayer-time {
            margin-left: 5px;
            font-weight: 500;
        }
        
        .time-until, .time-since {
            font-size: 0.85rem;
            color: #666;
            margin-top: 2px;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .wisdom-arabic {
                font-size: 1.3rem;
            }
            
            .wisdom-english {
                font-size: 1rem;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header .arabic-title {
                font-size: 1.2em;
            }
            
            .logo-container {
                flex-direction: row;
                gap: 10px;
            }
            
            .header-text {
                align-items: flex-start;
            }
            
            .header-logo {
                width: 120px;
                height: auto;
                margin-bottom: 5px;
            }
            
            .ramadan-hadith-container {
                padding: 0 15px;
            }
        }

        .header {
            text-align: center;
            padding: 15px 20px;
            margin-bottom: 0;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            border-radius: 0;
            width: 100%;
            position: relative;
            overflow: hidden;
            gap: 20px;
            min-height: 80px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            z-index: 2;
            width: 150px;
        }
        
        .header-text-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: absolute;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 100%;
            pointer-events: none; /* Allow clicks to pass through to elements behind */
            z-index: 1;
        }
        
        .header-text-container h1 {
            margin: 0 0 5px 0;
            font-size: 1.8em;
        }
        
        .desktop-only {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .mobile-menu-button {
            display: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
            margin-right: 10px;
            background: rgba(255, 255, 255, 0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .mobile-menu-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        @media (max-width: 768px) {
            .desktop-only {
                display: none;
            }
            
            .header {
                justify-content: space-between;
                position: relative;
            }
            
            .logo-container {
                flex: 1;
            }
            
            .header-logo {
                width: 150px;
                height: auto;
            }
            
            /* Basic mobile menu styling */
            .mobile-menu-button {
                cursor: pointer;
                padding: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 44px;
                min-height: 44px;
                margin-right: 5px;
            }
            
            @media (max-width: 768px) {
                .auth-container {
                    display: none; /* Hidden by default */
                    position: fixed; /* Fixed position */
                    top: 60px; /* Position below header */
                    right: 0;
                    width: 200px;
                    background-color: #1e6f5c;
                    padding: 15px;
                    z-index: 1000;
                    flex-direction: column;
                    gap: 10px;
                    align-items: center;
                    border-left: 2px solid #f0c14b;
                    border-bottom: 2px solid #f0c14b;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                }
                
                .auth-button {
                    width: 100%;
                    margin: 5px 0;
                }
                
                .user-profile {
                    width: 100%;
                    flex-direction: column;
                    align-items: center;
                }
            }
            
            /* Desktop menu styling */
            @media (min-width: 769px) {
                .auth-container {
                    display: flex;
                    flex-direction: row;
                    gap: 10px;
                }
            }
            
            /* Class to show the menu */
            .auth-container.show-mobile-menu {
                display: flex !important;
                animation: slideDown 0.3s ease-out;
            }
            
            @keyframes slideDown {
                from { transform: translateY(-20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            .auth-container .auth-button {
                display: block;
                width: 90%;
                margin: 8px auto;
                text-align: center;
                padding: 10px !important;
                font-size: 15px !important;
                border-radius: 8px;
                background-color: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.3);
                transition: all 0.2s ease;
                white-space: nowrap;
            }
            
            .auth-container .auth-button:active {
                transform: scale(0.98);
                background-color: rgba(255, 255, 255, 0.3);
            }
            
            .auth-options {
                position: static;
                margin-top: 10px;
                box-shadow: none;
                padding: 5px 0;
                background: transparent;
            }
            
            .auth-container.mobile-visible {
                display: flex !important;
                animation: slideDown 0.3s ease-in-out;
            }
            
            /* Improve user profile display in mobile view */
            .auth-container #user-profile {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                padding: 10px 0;
            }
            
            .auth-container #user-profile i {
                margin-bottom: 10px;
                font-size: 28px !important;
                color: white;
            }
            
            .auth-container #user-profile button {
                margin: 5px 0;
                width: 90%;
                padding: 8px 12px !important;
                font-size: 14px !important;
                text-align: center;
            }
            
            @keyframes slideDown {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .mobile-menu-button {
                display: flex;
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
                padding: 12px;
                font-size: 24px;
                color: white;
                background-color: rgba(255, 255, 255, 0.1);
                border-radius: 5px;
                margin-right: 5px;
                transition: background-color 0.2s ease;
            }
            
            .mobile-menu-button:active {
                background-color: rgba(255, 255, 255, 0.2);
            }
        }
        
        .auth-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 0;
            z-index: 2;
            width: 150px;
            justify-content: flex-end;
        }
        
        .auth-button {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .auth-button:hover {
            background-color: white;
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .auth-toggle {
            padding: 10px 18px;
            font-size: 16px;
            font-weight: 500;
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .auth-options {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--primary-color);
            padding: 10px;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            padding: 6px 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        #user-email {
            font-size: 14px;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Authentication Modal Styles */
        .auth-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .auth-modal-content {
            background-color: white;
            margin: 8% auto;
            padding: 35px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            position: relative;
            border-top: 4px solid var(--primary-color);
            animation: slideDown 0.4s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .close-modal {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .close-modal:hover {
            color: var(--primary-color);
        }
        
        .auth-form {
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-group input {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 128, 128, 0.1);
        }
        
        .auth-submit-button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 128, 128, 0.2);
        }
        
        .auth-submit-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 128, 128, 0.25);
        }
        
        .auth-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #777;
        }
        
        .auth-divider::before,
        .auth-divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #ddd;
        }
        
        .auth-divider span {
            padding: 0 10px;
        }
        
        .google-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 14px;
            background-color: white;
            color: #444;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .google-button:hover {
            background-color: #f5f5f5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .google-button img {
            width: 18px;
            height: 18px;
            margin-right: 10px;
        }
        
        .auth-message {
            text-align: center;
            margin: 15px 0;
            color: #555;
        }
        
        .auth-message a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .auth-message a:hover {
            text-decoration: underline;
        }
        
        .premium-badge {
            background-color: #f39c12;
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 5px;
            display: inline-block;
        }
        
        .premium-message {
            background-color: rgba(243, 156, 18, 0.1);
            border-left: 3px solid #f39c12;
            padding: 10px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .subscription-status {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .subscription-status h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .current-plan {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: 600;
            margin: 10px 0;
            background-color: #f1f1f1;
        }
        
        .current-plan.premium {
            background-color: #f39c12;
            color: white;
        }
        
        .api-key-section {
            margin-top: 20px;
        }
        
        .api-key-section h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .api-key-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .toggle-password-button {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            color: #777;
        }
        
        .toggle-password-button:hover {
            color: var(--primary-color);
        }
        
        .api-key-message {
            font-size: 0.9em;
            color: #777;
            margin-top: 10px;
        }
        
        /* Profile Tabs Styles */
        .profile-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .profile-tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #555;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .profile-tab-btn:hover {
            color: var(--primary-color);
        }
        
        .profile-tab-btn.active {
            color: var(--primary-color);
        }
        
        .profile-tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }
        
        .profile-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .profile-tab-content.active {
            display: block;
        }
        
        /* Premium Feature Container Styles */
        .premium-feature-container {
            position: relative;
            min-height: 300px;
        }
        
        .premium-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 8px;
        }
        
        .premium-message {
            text-align: center;
            padding: 30px;
            max-width: 400px;
        }
        
        .premium-message i {
            font-size: 40px;
            color: gold;
            margin-bottom: 15px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .premium-message h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        /* Responses and History Containers */
        .responses-container, .history-container {
            padding: 20px 0;
        }
        
        .feature-description {
            color: #666;
            margin-bottom: 20px;
        }
        
        .responses-list, .history-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-icon {
            font-size: 40px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-description {
            font-size: 14px;
            margin-top: 10px;
            max-width: 250px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Response and History Items */
        .response-item, .history-item {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid var(--primary-color);
            transition: all 0.2s ease;
        }
        
        .response-item:hover, .history-item:hover {
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        
        .response-content, .history-title {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .response-date, .history-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
        }
        
        .response-actions, .history-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .action-button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .action-button:hover {
            color: var(--primary-color);
            background: rgba(30, 111, 92, 0.1);
        }
        
        .auth-error {
            color: #d9534f;
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .header-logo {
            width: 150px;
            height: auto;
            /* Removed filter to show logo in its original colors */
            margin: 0;
        }
        
        .header-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, transparent, var(--ramadan-gold), transparent);
            opacity: 0.8;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header .arabic-title {
            font-family: var(--arabic-font);
            font-size: 1.6em;
            margin-top: 5px;
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
        }

        .header-image-container {
            max-width: 700px;
            margin: 30px auto;
            position: relative;
        }

        .header-image {
            width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .header-image:hover {
            transform: scale(1.02);
        }

        .image-disclaimer {
            font-size: 0.9em;
            color: #666;
            margin-top: 12px;
            font-style: italic;
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
        }

        .disclaimer {
            background: #fff;
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .disclaimer ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .suggested-topics {
            margin-bottom: 30px;
        }

        .suggested-topics h2 {
            color: var(--text-color);
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: 500;
            text-align: center;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 0 auto;
            max-width: 1200px;
        }

        .topic-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .ramadan-card {
            background: linear-gradient(to bottom, #ffffff, #f8f4e5);
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }
        
        .ramadan-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--ramadan-gold) 0%, var(--ramadan-gold) 50%, transparent 50%);
            opacity: 0.7;
            border-radius: 0 12px 0 12px;
        }

        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .topic-card-active {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(30, 111, 92, 0.4);
            border: 2px solid var(--primary-color);
            animation: pulse-highlight 1s ease-in-out;
        }
        
        @keyframes pulse-highlight {
            0% { box-shadow: 0 0 0 0 rgba(30, 111, 92, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(30, 111, 92, 0); }
            100% { box-shadow: 0 0 0 0 rgba(30, 111, 92, 0); }
        }

        .topic-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .topic-title {
            color: var(--text-color);
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .topic-description {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .topics-instruction {
            text-align: center;
            margin-bottom: 15px;
            background: linear-gradient(135deg, rgba(30, 111, 92, 0.1), rgba(212, 175, 55, 0.1));
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px dashed rgba(30, 111, 92, 0.3);
        }
        
        .topics-instruction p {
            font-size: 1.1rem;
            color: var(--text-color);
            margin: 0;
            font-weight: 500;
        }

        .related-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .related-topic-tile {
            background: white;
            color: var(--text-color);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            white-space: normal;
            line-height: 1.4;
        }

        .related-topic-tile:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }

        .disclaimer li {
            margin-bottom: 5px;
        }

        .chat-container {
            flex: 1;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            padding: 25px;
            margin: 30px auto 40px;
            overflow-y: auto;
            min-height: 350px; /* Increased height */
            max-height: calc(100vh - 250px);
            display: flex;
            flex-direction: column;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: min-height;
            width: 90%; /* Control width */
            max-width: 1000px; /* Maximum width */
            border: 1px solid rgba(0, 128, 128, 0.2);
            position: relative;
        }
        
        /* Add a subtle highlight to make it stand out */
        .chat-container {
            flex: 1;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 0 30px rgba(212, 175, 55, 0.8);
            padding: 25px;
            margin: 30px auto 40px;
            overflow-y: auto;
            min-height: 350px;
            max-height: calc(100vh - 250px);
            display: flex;
            flex-direction: column;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: min-height;
            width: 90%;
            max-width: 1000px;
            border: 2px solid var(--ramadan-gold);
            position: relative;
            background: linear-gradient(to bottom, rgba(255, 248, 225, 0.3), rgba(255, 255, 255, 0.9));
        }
        
        .chat-container::before {
            content: '';
            position: absolute;
            top: -12px;
            left: -12px;
            right: -12px;
            bottom: -12px;
            background: linear-gradient(135deg, #d4af37, #f5e7b8);
            border-radius: 28px;
            z-index: -1;
            opacity: 0.85;
            box-shadow: 0 0 40px 5px rgba(212, 175, 55, 0.8);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            transition: height 0.3s ease;
            gap: 20px; /* Add space between messages */
        }

        .message {
            margin-bottom: 5px; /* Reduced since we added gap to container */
            padding: 18px 22px;
            border-radius: 18px;
            max-width: 90%;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 1.15em;
            animation: messageAppear 0.5s ease forwards;
            opacity: 0;
            transform: translateY(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: linear-gradient(135deg, var(--primary-color), #174a3c);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            background: linear-gradient(to bottom, #ffffff, #f8f9fa);
            color: var(--text-color);
            align-self: flex-start;
            margin-right: auto;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(0, 128, 128, 0.15);
            position: relative;
            border-bottom-left-radius: 4px;
        }
        
        .message-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .bot-message:hover .message-actions {
            opacity: 1;
        }
        
        .bookmark-button {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .bookmark-button:hover {
            background-color: rgba(30, 111, 92, 0.1);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
        }
        
        .success-toast {
            background-color: var(--primary-color);
        }
        
        .error-toast {
            background-color: #e74c3c;
        }
        
        /* Styling for the limit message */
        .limit-message {
            background-color: #f8f9fa;
            border-left: 3px solid #4caf50;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .limit-message p {
            margin: 0;
            color: #555;
        }
        
        .limit-message i {
            color: #4caf50;
            margin-right: 5px;
        }
        
        .limit-message a {
            color: #1a73e8;
            text-decoration: none;
            font-weight: 500;
        }
        
        .limit-message a:hover {
            text-decoration: underline;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .share-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .share-text {
            font-size: 0.9em;
            color: #1e6f5c;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .share-buttons {
            display: flex;
            gap: 12px;
            margin-top: 5px;
        }

        .share-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .share-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .x-icon {
            font-weight: bold;
            font-size: 16px;
            font-family: Arial, sans-serif;
        }
        
        .x-btn {
            font-weight: bold;
        }

        .share-button:hover {
            background: var(--secondary-color);
        }

        .share-options {
            position: absolute;
            top: 50px;
            right: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 8px 0;
            display: none;
            z-index: 3;
        }

        .share-options.active {
            display: block;
        }

        .share-option {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .share-option:hover {
            background: #f5f5f5;
        }

        .share-option i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* Share card styles */
        .share-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            max-width: 600px;
            margin: 20px auto;
            position: relative;
            display: none;
        }

        .share-card.active {
            display: block;
        }

        .share-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .share-card-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .share-card-title {
            font-size: 1.2em;
            font-weight: 500;
            color: var(--primary-color);
        }

        .share-card-content {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .share-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .share-card-qr {
            width: 80px;
            height: 80px;
        }

        .error-message {
            background-color: #ffebee;
            color: #c62828;
            margin: 10px auto;
            text-align: center;
        }

        .section-header {
            font-weight: bold;
            margin: 15px 0 10px 0;
            color: #1976d2;
            font-size: 1.1em;
        }

        .arabic-text {
            font-family: "Traditional Arabic", "Arabic Typesetting", Arial, sans-serif;
            font-size: 1.3em;
            line-height: 1.8;
            direction: rtl;
            margin: 15px 0;
            text-align: right;
            color: #444;
        }

        .arabic-symbol {
            font-family: "Traditional Arabic", "Arabic Typesetting", Arial, sans-serif;
            font-size: 1.2em;
            color: #444;
            margin: 0 3px;
        }

        .input-container {
            display: flex;
            gap: 15px;
            padding: 18px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: auto;
            border: 1px solid rgba(0, 128, 128, 0.15);
            transition: all 0.3s ease;
        }
        
        .input-container:focus-within {
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        #user-input {
            flex: 1;
            padding: 15px 18px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            resize: none;
            font-size: 1.1em;
            font-family: inherit;
            min-height: 55px;
            max-height: 150px;
            transition: all 0.3s ease;
            line-height: 1.5;
            overflow-y: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        #user-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30,111,92,0.15);
        }
        
        #user-input::placeholder {
            color: #888;
            font-size: 1.05em;
        }

        .send-button {
            padding: 10px;
            background: linear-gradient(135deg, var(--primary-color), #174a3c);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            width: 50px;
            height: 50px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .send-button svg {
            width: 24px;
            height: 24px;
            stroke: white;
            stroke-width: 2.5;
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
        }

        .send-button:hover {
            background: linear-gradient(135deg, #1e8f72, var(--primary-color));
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .response-indicator {
            background-color: var(--primary-color);
            color: white;
            font-size: 0.9em;
            padding: 8px 15px;
            border-radius: 4px;
            display: none;
            text-align: center;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stop-button {
            display: none;
            padding: 8px;
            background: #dc3545;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            margin-left: 8px;
            width: 40px;
            height: 40px;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .stop-button svg {
            width: 16px;
            height: 16px;
            stroke: white;
        }

        .stop-button:hover {
            background: #c82333;
        }

        .thinking-message {
            text-align: center;
            padding: 10px;
        }

        .thinking-message .arabic-text {
            font-family: "Traditional Arabic", "Arabic Typesetting", Arial, sans-serif;
            font-size: 1.4em;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .thinking-message .english-text {
            color: #666;
            margin-bottom: 10px;
        }

        .thinking-message .loading-dots {
            display: flex;
            justify-content: center;
            gap: 4px;
        }

        .thinking-message .loading-dots span {
            font-size: 24px;
            line-height: 10px;
            color: var(--primary-color);
            opacity: 0.2;
            transition: opacity 0.3s ease;
        }

        @media (max-width: 1200px) {
            .topic-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .topic-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .ramadan-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .eid-countdown, .ramadan-greeting, .prayer-times-container {
                width: 100%;
                margin: 5px 0;
            }
        }

        @media (max-width: 600px) {
            .chat-container {
                padding: 15px;
                width: 95%;
                min-height: 400px; /* Taller on mobile */
                margin: 20px auto 30px;
                overflow-x: hidden;
                max-height: 70vh; /* Limit height on mobile */
            }
            
            .chat-container::before {
                top: -6px;
                left: -6px;
                right: -6px;
                bottom: -6px;
                border-radius: 16px;
            }
            
            /* Improve message display on mobile */
            .message-content {
                max-width: 100%;
                overflow-wrap: break-word;
                word-wrap: break-word;
                hyphens: auto;
                font-size: 0.95rem;
            }
            
            /* Fix input area on mobile */
            .input-container {
                padding: 8px;
            }
            
            #user-input {
                padding: 10px 40px 10px 12px;
                font-size: 0.95rem;
            }
            
            /* Ensure messages don't overflow on mobile */
            .bot-message, .user-message {
                max-width: 100%;
                padding: 10px 12px;
            }
            
            .topics-instruction {
                padding: 10px 15px;
                margin-bottom: 10px;
            }
            
            .topics-instruction p {
                font-size: 1rem;
            }

            .chat-messages {
                padding: 15px;
                gap: 15px;
            }

            .message {
                max-width: 95%;
                padding: 16px 18px;
                font-size: 1.1em;
            }

            .input-container {
                padding: 14px;
            }

            #user-input {
                min-height: 50px;
                font-size: 1.05em;
                padding: 12px 15px;
            }

            .send-button {
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header-container">
        <div class="header">
            <div class="logo-container">
                <img src="/images/updated-ask-mo-logo.png" alt="Ask Mo Anything Logo" class="header-logo">
            </div>
            <div class="header-text-container desktop-only">
                <h1>Ask Mo Anything</h1>
                <div class="arabic-title">اسأل عن النبي محمد ﷺ</div>
            </div>
            <div class="mobile-menu-button">
                <i class="fas fa-bars" style="font-size: 24px; width: 100%; text-align: center;"></i>
            </div>
            <div class="auth-container" id="auth-container" style="display: none;">
                <button id="login-button" class="auth-button">Sign In</button>
                <button id="signup-button" class="auth-button">Sign Up</button>
                <div id="user-profile" class="user-profile" style="display: none;">
                    <i class="fas fa-user-circle" style="font-size: 18px;"></i>
                    <button id="profile-button" class="auth-button" style="padding: 5px 12px; font-size: 12px;">My Account</button>
                    <button id="logout-button" class="auth-button" style="padding: 5px 12px; font-size: 12px;">Sign Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ramadan Banner -->
    <div class="ramadan-banner">
        <div class="ramadan-content">
            <div class="eid-countdown">
                <div class="countdown-label">Shawwal Fasting Reminder</div>
                <div class="countdown-timer" id="shawwal-countdown">Loading...</div>
                <div class="shawwal-reminder">Fast 6 days in Shawwal to earn the reward of fasting the entire year</div>
            </div>
            
            <div class="ramadan-greeting">
                <div class="ramadan-icon">🌙</div>
                <h2>Eid Mubarak!</h2>
                <div class="ramadan-dates">Eid al-Fitr • March 30, 2025</div>
            </div>
            
            <div class="prayer-times-container" id="top-prayer-times-container">
                <div class="prayer-times-header">
                    <div class="prayer-icon"><i class="fas fa-mosque"></i></div>
                    <h3>Prayer Times</h3>
                </div>
                <div class="simple-prayer-times" id="header-simple-prayer-times">
                    <div class="prayer-times-content">
                        <div id="header-current-prayer">Loading current prayer...</div>
                        <div id="header-next-prayer">Loading next prayer...</div>
                        <button id="header-enable-location-btn" class="location-button">Enable Location</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Eid FAQ Banner -->
    <div class="ramadan-faq-banner">
        <div class="faq-banner-content">
            <div class="faq-icon"><i class="fas fa-question-circle"></i></div>
            <div class="faq-banner-text">
                <h3>Questions about Eid al-Fitr?</h3>
                <p>Get answers about Eid prayers, celebrations, traditions, and more</p>
            </div>
            <a href="/ramadan-faq.html" class="faq-banner-button">View Eid & Ramadan FAQ</a>
        </div>
    </div>

    <div class="container">
        <div class="header-image-container">
            <!-- SEO Optimization: Add loading="lazy" and explicit dimensions for better CLS metrics -->
            <img src="/images/islamic-art.png" alt="Islamic Art - Artistic Illustration" class="header-image" loading="lazy" width="800" height="400">
            <p class="image-disclaimer">Note: This is an artistic illustration and not a depiction of Prophet Muhammad (peace be upon him)</p>
        </div>
        
        <!-- Daily Islamic Wisdom -->
        <div class="wisdom-section">
            <div class="daily-wisdom-container">
                <div class="wisdom-header">
                    <div class="wisdom-icon"><i class="fas fa-lightbulb"></i></div>
                    <h3>Daily Wisdom</h3>
                </div>
                <div class="wisdom-content" id="daily-wisdom">
                    <div class="wisdom-arabic" lang="ar">خَيْرُ النَّاسِ أَنْفَعُهُمْ لِلنَّاسِ</div>
                    <div class="wisdom-english">"The best of people are those who are most beneficial to people."</div>
                    <div class="wisdom-source">Hadith - Daraqutni</div>
                </div>
                <button class="refresh-wisdom-btn" id="refresh-wisdom-btn"><i class="fas fa-sync-alt"></i> New Wisdom</button>
                <div class="share-wisdom">
                    <a href="#" id="share-wisdom-twitter" title="Share on X" class="share-wisdom-btn"><i class="fab fa-twitter"></i></a>
                    <a href="#" id="share-wisdom-facebook" title="Share on Facebook" class="share-wisdom-btn"><i class="fab fa-facebook"></i></a>
                    <a href="#" id="share-wisdom-instagram" title="Share on Instagram" class="share-wisdom-btn"><i class="fab fa-instagram"></i></a>
                    <a href="#" id="share-wisdom-whatsapp" title="Share on WhatsApp" class="share-wisdom-btn"><i class="fab fa-whatsapp"></i></a>
                </div>
                

                
                <div class="wisdom-divider-container">
                    <div class="wisdom-divider-line"></div>
                    <div class="wisdom-divider-icon"><i class="fas fa-star"></i></div>
                    <div class="wisdom-divider-line"></div>
                </div>
            </div>
            

        </div>



        <div class="suggested-topics">
            <div class="topics-instruction">
                <p>Choose one of these topics to start a chat or ask your own question in the chat box below!</p>
            </div>
            <h2>Eid & Ramadan Topics</h2>
            <div class="topic-grid">
                <!-- Ramadan-specific Topics -->
                <div class="topic-card ramadan-card" data-topic="What is the significance of Ramadan in Islam?">
                    <div class="topic-icon">🌙</div>
                    <div class="topic-title">Significance of Ramadan</div>
                    <div class="topic-description">Learn about the holy month and its importance in Islam</div>
                </div>
                <div class="topic-card ramadan-card" data-topic="What are the best practices during Ramadan?">
                    <div class="topic-icon">✨</div>
                    <div class="topic-title">Ramadan Best Practices</div>
                    <div class="topic-description">Discover recommended acts of worship during the holy month</div>
                </div>
                <div class="topic-card ramadan-card" data-topic="What are the rules of fasting in Ramadan and who is exempt?">
                    <div class="topic-icon">🍽️</div>
                    <div class="topic-title">Fasting Guidelines</div>
                    <div class="topic-description">Learn about fasting rules, exemptions, and making up missed fasts</div>
                </div>
                <div class="topic-card ramadan-card" data-topic="What is Eid al-Fitr and how should Muslims celebrate it?">
                    <div class="topic-icon">🎉</div>
                    <div class="topic-title">Eid al-Fitr</div>
                    <div class="topic-description">Learn about Eid celebrations, prayers, and traditions</div>
                </div>
            </div>
            
            <h2 style="margin-top: 30px;">Explore Islamic Knowledge</h2>
            <div class="topic-grid">
                <!-- Original Topic Cards -->
                <div class="topic-card" data-topic="Tell me about the life and teachings of Prophet Muhammad ﷺ">
                    <div class="topic-icon">📚</div>
                    <div class="topic-title">Prophetic Biography</div>
                    <div class="topic-description">Discover the life and teachings of Prophet Muhammad ﷺ</div>
                </div>
                <div class="topic-card" data-topic="What does the Quran teach us about morals and ethics?">
                    <div class="topic-icon">❤️</div>
                    <div class="topic-title">Islamic Ethics</div>
                    <div class="topic-description">Explore Islamic morals, values, and character building</div>
                </div>
                <div class="topic-card" data-topic="What are the five pillars of Islam?">
                    <div class="topic-icon">🕌</div>
                    <div class="topic-title">Five Pillars of Islam</div>
                    <div class="topic-description">Learn about the fundamental practices of the Islamic faith</div>
                </div>
                <div class="topic-card" data-topic="How did the Prophet Muhammad ﷺ treat people of other faiths?">
                    <div class="topic-icon">🤝</div>
                    <div class="topic-title">Interfaith Relations</div>
                    <div class="topic-description">Explore the Prophet's approach to people of different beliefs</div>
                </div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <!-- Ad Container - Below Header -->
                <div class="ad-container" style="margin-bottom: 20px; text-align: center;">
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-1689374513929530"
                         data-ad-slot="3854491429"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
                <div class="message bot-message">
                    <div class="message-content">
                        <div lang="ar">السَّلاَمُ عَلَيْكُمْ وَرَحْمَةُ اللهِ وَبَرَكَاتُهُ</div>
                        Welcome! I'm here to help answer your questions about Prophet Muhammad (PBUH) and Islamic teachings. What would you like to know?
                    </div>
                    <div class="message-actions">
                        <button class="bookmark-button" title="Save this response">
                            <i class="far fa-bookmark"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- SEO Enhancement: Internal Linking Section -->
            <div class="seo-internal-links" style="margin: 15px 0; padding: 15px; border-radius: 8px; background-color: #f8f9fa; display: none;">
                <h3 style="color: var(--primary-color); margin-bottom: 10px; font-size: 1.1em;">Explore Related Topics:</h3>
                <div class="internal-links-container" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
            </div>
            
            <!-- Ad Container - Above Input Section -->
            <div class="ad-container" style="margin: 20px 0; text-align: center;">
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-1689374513929530"
                     data-ad-slot="5167672761"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
            
            <div class="input-section">
                <div class="response-indicator" style="display: none;">Mo is responding...</div>
                <div class="input-container">
                    <textarea id="user-input" placeholder="Type your question here..." rows="1"></textarea>
                    <button id="send-button" class="send-button">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                    <button id="stop-button" onclick="stopGeneration()" class="stop-button" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="6" y="6" width="12" height="12" rx="1" ry="1"></rect>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="disclaimer">
            <strong>Important Notice:</strong>
            <p>This AI assistant provides information about Prophet Muhammad ﷺ and Islamic teachings based on authentic sources. Please note:</p>
            <ul>
                <li>This is an AI tool and should not be considered a replacement for proper Islamic scholarship</li>
                <li>For religious rulings (fatawa), please consult qualified Islamic scholars</li>
                <li>Verify all information with authentic Islamic sources</li>
                <li>Treat all religious content with proper respect and adab (etiquette)</li>
            </ul>
        </div>

        <div class="empowering-section">
            <h2>Empowering Islamic Knowledge Through Technology</h2>
            <p>To ensure continuous and reliable access to this service, we offer two options: use your own OpenAI API key or subscribe to our premium plan where we cover the API costs for you.</p>
            <p>Using your own API key gives you unlimited access while helping us maintain this platform. You can get your API key at <a href="https://platform.openai.com" target="_blank">OpenAI's website</a>, or choose from our plans below:</p>
            <p><small><i>Note: Each question uses advanced AI technology that costs us approximately $0.10-$0.20 per response.</i></small></p>
            
            <!-- Supportive Mission Text -->
            <div class="mission-support-text">
                <p>Help support us and our mission to spread Islamic knowledge throughout the world, while learning and discovering Islam through technology with the greatest Islamic Knowledge GPT available.</p>
            </div>
            
            <!-- Pricing Section -->
            <div class="pricing-section">
                <h3>Choose the Right Plan for You</h3>
                <div class="ramadan-promo">
                    <div class="ramadan-badge">
                        <span class="ramadan-icon">🎉</span> EID SPECIAL
                    </div>
                    <p>Enjoy up to 50% off as we celebrate Eid al-Fitr!</p>
                </div>
                
                <!-- Pricing Toggle -->
                <div class="pricing-toggle-container">
                    <button id="annual-toggle" class="pricing-toggle-btn active">Pay annually</button>
                    <button id="monthly-toggle" class="pricing-toggle-btn">Pay monthly</button>
                </div>
                <style>
                    /* Eid promo styles */
                    .ramadan-promo {
                        text-align: center;
                        margin: 15px auto 25px;
                        background-color: rgba(255, 255, 255, 0.15);
                        border-radius: 8px;
                        padding: 12px 20px;
                        max-width: 600px;
                    }
                    
                    .ramadan-badge {
                        display: inline-block;
                        background-color: rgba(255, 215, 0, 0.2);
                        color: gold;
                        font-weight: 700;
                        padding: 5px 15px;
                        border-radius: 20px;
                        margin-bottom: 10px;
                        font-size: 16px;
                        letter-spacing: 1px;
                    }
                    
                    .ramadan-icon {
                        margin-right: 5px;
                    }
                    
                    .ramadan-promo p {
                        color: white;
                        font-size: 18px;
                        margin: 0;
                    }
                    
                    /* Mission support text styles */
                    .mission-support-text {
                        text-align: center;
                        margin: 20px auto 30px;
                        max-width: 800px;
                        padding: 0 20px;
                    }
                    
                    .mission-support-text p {
                        font-size: 18px;
                        line-height: 1.5;
                        color: white;
                        font-weight: 500;
                    }
                    
                    /* Pricing toggle styles */
                    .pricing-toggle-container {
                        display: flex;
                        justify-content: center;
                        margin: 20px 0 30px;
                        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
                        width: fit-content;
                        margin-left: auto;
                        margin-right: auto;
                        background-color: rgba(255, 255, 255, 0.1);
                        border-radius: 8px 8px 0 0;
                        padding: 5px;
                    }
                    
                    .pricing-toggle-btn {
                        background: none;
                        border: none;
                        padding: 10px 20px;
                        font-size: 16px;
                        cursor: pointer;
                        color: rgba(255, 255, 255, 0.8);
                        position: relative;
                        transition: all 0.3s ease;
                        font-weight: 500;
                    }
                    
                    .pricing-toggle-btn.active {
                        color: white;
                        font-weight: 600;
                    }
                    
                    .pricing-toggle-btn.active::after {
                        content: '';
                        position: absolute;
                        bottom: -2px;
                        left: 0;
                        width: 100%;
                        height: 2px;
                        background-color: white;
                    }
                    
                    /* Pricing cost styles for Ramadan special */
                    .original-price {
                        font-size: 1.5rem;
                        text-decoration: line-through;
                        color: #888;
                        margin-right: 10px;
                        display: inline-block;
                        position: relative;
                        top: -5px;
                    }
                    
                    .discount-badge {
                        position: absolute;
                        top: 0;
                        left: 0;
                        background-color: #e63946;
                        color: white;
                        font-size: 12px;
                        font-weight: bold;
                        padding: 5px 15px;
                        border-bottom-right-radius: 10px;
                        z-index: 2;
                    }
                    
                    /* Hide monthly plan by default */
                    #monthly-plan {
                        display: none;
                    }
                    
                    .pricing-container {
                        display: flex;
                        flex-direction: row;
                        justify-content: center;
                        gap: 15px;
                        flex-wrap: wrap;
                        width: 100%;
                        margin: 0 auto;
                    }
                    .pricing-card {
                        flex: 0 0 31%;
                        min-width: 360px;
                        max-width: none;
                    }
                    /* Stripe button styling */
                    stripe-buy-button {
                        --button-height: 40px;
                        --button-font-size: 14px;
                        --button-radius: 4px;
                        --button-text-color: white;
                        --button-background-color: #1e6f5c;
                        --button-hover-background-color: #164e41;
                    }
                    .stripe-button-container {
                        margin-top: 15px;
                        width: 100%;
                        display: flex;
                        justify-content: center;
                    }
                    #monthly-stripe-container, #annual-stripe-container,
                    #modal-monthly-stripe-container, #modal-annual-stripe-container {
                        width: 100%;
                        display: flex;
                        justify-content: center;
                    }
                    stripe-buy-button {
                        display: inline-block;
                        width: auto !important;
                        max-width: 100%;
                    }
                    /* Ensure pricing cards have consistent layout */
                    .pricing-card {
                        display: flex;
                        flex-direction: column;
                    }
                    .pricing-features {
                        flex-grow: 1;
                    }
                    .pricing-footer {
                        margin-top: auto;
                    }
                    @media (max-width: 992px) {
                        .pricing-container {
                            flex-direction: column;
                            align-items: center;
                        }
                        .pricing-card {
                            width: 100%;
                            max-width: 450px;
                        }
                        .pricing-toggle-container {
                            width: 100%;
                            max-width: 300px;
                        }
                    }
                </style>
                <div class="pricing-container">
                    <!-- Free Plan -->
                    <div class="pricing-card" id="free-plan">
                        <div class="pricing-header">
                            <h4>Free</h4>
                            <div class="pricing-cost">$0<span>/month</span></div>
                        </div>
                        <div class="pricing-features">
                            <ul>
                                <li><i class="fas fa-check"></i> 7 questions per day (using our API key)</li>
                                <li><i class="fas fa-check"></i> <strong>Unlimited</strong> questions with your own API key</li>
                                <li><i class="fas fa-check"></i> Access to basic Islamic knowledge</li>
                                <li><i class="fas fa-check"></i> Ramadan special topics</li>
                                <li><i class="fas fa-check"></i> Daily Hadith</li>
                                <li><i class="fas fa-check"></i> Prayer times</li>
                                <li class="feature-disabled"><i class="fas fa-times"></i> Saved conversation history</li>
                                <li class="feature-disabled"><i class="fas fa-times"></i> Priority support</li>
                                <li class="feature-disabled"><i class="fas fa-times"></i> Downloadable responses</li>
                            </ul>
                        </div>
                        <div class="pricing-footer">
                            <div class="pricing-note">Perfect for occasional users or those with their own API key</div>
                            <button class="pricing-button free-button">Current Plan</button>
                        </div>
                    </div>
                    
                    <!-- Monthly Premium Plan -->
                    <div class="pricing-card premium-card" id="monthly-plan">
                        <div class="pricing-badge">GREAT VALUE</div>
                        <div class="discount-badge">50% OFF</div>
                        <div class="pricing-header">
                            <h4>Premium Monthly</h4>
                            <div class="pricing-cost">
                                <span class="original-price">$19.99</span>
                                $9.99<span>/month</span>
                            </div>
                        </div>
                        <div class="pricing-features">
                            <ul>
                                <li><i class="fas fa-check"></i> <strong>100 questions</strong> per month (using our API key)</li>
                                <li><i class="fas fa-check"></i> <strong>Unlimited</strong> questions with your own API key</li>
                                <li><i class="fas fa-check"></i> Full access to all Islamic knowledge</li>
                                <li><i class="fas fa-check"></i> Ramadan special topics</li>
                                <li><i class="fas fa-check"></i> Daily Hadith with commentary</li>
                                <li><i class="fas fa-check"></i> Personalized prayer times</li>
                                <li><i class="fas fa-check"></i> Save & access conversation history</li>
                                <li><i class="fas fa-check"></i> Priority support</li>
                                <li><i class="fas fa-check"></i> Downloadable responses (PDF)</li>
                                <li><i class="fas fa-check"></i> Coming soon: Scholarly references</li>
                            </ul>
                        </div>
                        <div class="pricing-footer">
                            <div class="pricing-note">Perfect for casual users and learning</div>
                            <div id="monthly-stripe-container">
                                <script async src="https://js.stripe.com/v3/buy-button.js"></script>
                                <stripe-buy-button
                                  buy-button-id="buy_btn_1R0TLxDLlIJ8KokgsghoABCt"
                                  publishable-key="pk_live_51R0QM7DLlIJ8KokgtJ1OMLsHza1s8HHQsUfUqP0sMCrPfFSyWxHn3i1wRpDyWvhrj70eitF5HEwXBUSVITCqojnM00YqzhQDPV"
                                >
                                </stripe-buy-button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Annual Premium Plan -->
                    <div class="pricing-card premium-card" id="annual-plan">
                        <div class="pricing-badge">RECOMMENDED</div>
                        <div class="discount-badge">50% OFF</div>
                        <div class="pricing-header">
                            <h4>Premium Annual</h4>
                            <div class="pricing-cost">
                                <span class="original-price">$16.67</span>
                                $8.33<span>/month</span>
                            </div>
                            <div class="pricing-subcost">Billed annually at $99.99</div>
                        </div>
                        <div class="pricing-features">
                            <ul>
                                <li><i class="fas fa-check"></i> <strong>Save 17%</strong> compared to monthly</li>
                                <li><i class="fas fa-check"></i> <strong>Unlimited</strong> questions with your own API key</li>
                                <li><i class="fas fa-check"></i> Full access to all Islamic knowledge</li>
                                <li><i class="fas fa-check"></i> Ramadan special topics</li>
                                <li><i class="fas fa-check"></i> Daily Hadith with commentary</li>
                                <li><i class="fas fa-check"></i> Personalized prayer times</li>
                                <li><i class="fas fa-check"></i> Save & access conversation history</li>
                                <li><i class="fas fa-check"></i> Priority support</li>
                                <li><i class="fas fa-check"></i> Downloadable responses (PDF)</li>
                                <li><i class="fas fa-check"></i> Coming soon: Scholarly references</li>
                            </ul>
                        </div>
                        <div class="pricing-footer">
                            <div class="pricing-note">Ideal for serious students and seekers of knowledge</div>
                            <div id="annual-stripe-container">
                                <script async src="https://js.stripe.com/v3/buy-button.js"></script>
                                <stripe-buy-button
                                  buy-button-id="buy_btn_1R0TTUDLlIJ8Kokg2epkfzAF"
                                  publishable-key="pk_live_51R0QM7DLlIJ8KokgtJ1OMLsHza1s8HHQsUfUqP0sMCrPfFSyWxHn3i1wRpDyWvhrj70eitF5HEwXBUSVITCqojnM00YqzhQDPV"
                                >
                                </stripe-buy-button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="pricing-alternative">
                    <div class="subscription-divider">OR</div>
                    <p>Support our work with a one-time contribution:</p>
                    <a href="https://buymeacoffee.com/samir.shah" target="_blank" class="buy-coffee-button">
                        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-white.png" alt="Buy Me A Coffee">
                    </a>
                </div>
            </div>
            
            <!-- Pricing Toggle JavaScript -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const annualToggle = document.getElementById('annual-toggle');
                    const monthlyToggle = document.getElementById('monthly-toggle');
                    const monthlyPlan = document.getElementById('monthly-plan');
                    const annualPlan = document.getElementById('annual-plan');
                    
                    // Initial state - show annual plan, hide monthly plan
                    monthlyPlan.style.display = 'none';
                    annualPlan.style.display = 'block';
                    
                    annualToggle.addEventListener('click', function() {
                        // Update toggle buttons
                        annualToggle.classList.add('active');
                        monthlyToggle.classList.remove('active');
                        
                        // Show annual plan, hide monthly plan
                        monthlyPlan.style.display = 'none';
                        annualPlan.style.display = 'block';
                    });
                    
                    monthlyToggle.addEventListener('click', function() {
                        // Update toggle buttons
                        monthlyToggle.classList.add('active');
                        annualToggle.classList.remove('active');
                        
                        // Show monthly plan, hide annual plan
                        annualPlan.style.display = 'none';
                        monthlyPlan.style.display = 'block';
                    });
                });
            </script>
        </div>

        <div class="about-section">
            <h2><span class="bismillah">بِسْمِ اللهِ الرَّحْمٰنِ الرَّحِيْمِ</span></h2>
            <h3>About Ask Mo Anything</h3>
            <p>Ask Mo Anything was built by Muslims, for Muslims, with the intention of serving our Ummah. In a world where accessing reliable Islamic knowledge can be challenging, we aim to bridge the gap between traditional wisdom and modern technology.</p>
            <p>Our goal is to make the teachings of Prophet Muhammad ﷺ more accessible while maintaining the highest standards of authenticity and scholarly respect. We believe that technology, when used mindfully, can help revive Islamic scholarship in our modern era.</p>
            
            <div class="authenticity-section">
                <h4>Our Commitment to Authenticity</h4>
                <ul>
                    <li>✓ This AI assistant is trained on authentic Islamic sources including recognized translations of the Quran, verified Hadith collections, and respected scholarly works.</li>
                    <li>✓ While we strive for accuracy, this tool is not a substitute for qualified Islamic scholars or official religious rulings (fatwas).</li>
                    <li>✓ For critical matters of faith, worship, or Islamic law, please consult qualified scholars and verify information with authentic sources.</li>
                    <li>✓ Our responses are generated through AI interpretation of Islamic texts - always cross-reference with original sources.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Authentication Modals -->
    <div id="login-modal" class="auth-modal">
        <div class="auth-modal-content">
            <span class="close-modal">&times;</span>
            <h2>Sign In</h2>
            <div class="auth-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password" required>
                </div>
                <button id="login-submit" class="auth-submit-button">Sign In</button>
                <div class="auth-divider">
                    <span>OR</span>
                </div>
                <button id="google-signin" class="google-button">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
                    Sign in with Google
                </button>
                <p class="auth-message">Don't have an account? <a href="#" id="switch-to-signup">Sign Up</a></p>
                <p class="auth-message"><a href="#" id="forgot-password">Forgot Password?</a></p>
                <div id="login-error" class="auth-error"></div>
            </div>
        </div>
    </div>

    <div id="signup-modal" class="auth-modal">
        <div class="auth-modal-content">
            <span class="close-modal">&times;</span>
            <h2>Sign Up</h2>
            <div class="auth-form">
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" placeholder="Enter your password" required>
                </div>
                <div class="form-group">
                    <label for="signup-confirm-password">Confirm Password</label>
                    <input type="password" id="signup-confirm-password" placeholder="Confirm your password" required>
                </div>
                <button id="signup-submit" class="auth-submit-button">Sign Up</button>
                <div class="auth-divider">
                    <span>OR</span>
                </div>
                <button id="google-signup" class="google-button">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
                    Sign up with Google
                </button>
                <p class="auth-message">Already have an account? <a href="#" id="switch-to-login">Sign In</a></p>
                <div id="signup-error" class="auth-error"></div>
            </div>
        </div>
    </div>

    <div id="reset-password-modal" class="auth-modal">
        <div class="auth-modal-content">
            <span class="close-modal">&times;</span>
            <h2>Reset Password</h2>
            <div class="auth-form">
                <div class="form-group">
                    <label for="reset-email">Email</label>
                    <input type="email" id="reset-email" placeholder="Enter your email" required>
                </div>
                <button id="reset-submit" class="auth-submit-button">Send Reset Link</button>
                <p class="auth-message"><a href="#" id="back-to-login">Back to Sign In</a></p>
                <div id="reset-message" class="auth-message"></div>
                <div id="reset-error" class="auth-error"></div>
            </div>
        </div>
    </div>
    
    <!-- User Profile Modal -->
    <div id="profile-modal" class="auth-modal">
        <div class="auth-modal-content">
            <span class="close-modal">&times;</span>
            <h2>User Profile</h2>
            
            <!-- Tab Navigation -->
            <div class="profile-tabs">
                <button class="profile-tab-btn active" data-tab="account-tab">Account</button>
                <button class="profile-tab-btn" data-tab="saved-responses-tab">Saved Responses</button>
                <button class="profile-tab-btn" data-tab="chat-history-tab">Chat History</button>
            </div>
            
            <!-- Account Tab Content -->
            <div id="account-tab" class="profile-tab-content active">
                <div class="auth-form">
                    <div id="subscription-status" class="subscription-status">
                        <h3>Subscription Status</h3>
                        <div id="current-plan" class="current-plan">Free Plan</div>
                        <p>Free plan users have a limit of 7 questions per day.</p>
                        <button id="upgrade-button" class="cta-button">Upgrade to Premium</button>
                    </div>
                    
                    <div class="api-key-section">
                        <h3>Your OpenAI API Key</h3>
                        <p>Using your own API key gives you unlimited questions without counting against your daily limit.</p>
                        <div class="form-group">
                            <label for="api-key-input">API Key</label>
                            <div class="api-key-input-container">
                                <input type="password" id="api-key-input" placeholder="Enter your OpenAI API key">
                                <button id="toggle-api-key" class="toggle-password-button">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <button id="save-api-key" class="auth-submit-button">Save API Key</button>
                        <p class="api-key-message">Your API key is stored securely in your browser and is only sent with your questions.</p>
                    </div>
                    
                    <div id="profile-message" class="auth-message"></div>
                    <div id="profile-error" class="auth-error"></div>
                </div>
            </div>
            
            <!-- Saved Responses Tab Content -->
            <div id="saved-responses-tab" class="profile-tab-content">
                <div class="premium-feature-container">
                    <div id="saved-responses-container" class="responses-container">
                        <h3>Saved Responses</h3>
                        <p class="feature-description">Save important responses for future reference.</p>
                        <div id="saved-responses-list" class="responses-list">
                            <div class="empty-state">
                                <i class="fas fa-bookmark empty-icon"></i>
                                <p>No saved responses yet</p>
                                <p class="empty-description">When you find a helpful response, click the bookmark icon to save it here.</p>
                            </div>
                        </div>
                    </div>
                    <div id="saved-responses-premium-overlay" class="premium-overlay">
                        <div class="premium-message">
                            <i class="fas fa-crown"></i>
                            <h3>Premium Feature</h3>
                            <p>Upgrade to premium to save and access your favorite responses anytime.</p>
                            <button id="saved-responses-upgrade" class="cta-button">Upgrade to Premium</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat History Tab Content -->
            <div id="chat-history-tab" class="profile-tab-content">
                <div class="premium-feature-container">
                    <div id="chat-history-container" class="history-container">
                        <h3>Chat History</h3>
                        <p class="feature-description">Access your previous conversations.</p>
                        <div id="chat-history-list" class="history-list">
                            <div class="empty-state">
                                <i class="fas fa-history empty-icon"></i>
                                <p>No chat history yet</p>
                                <p class="empty-description">Your conversation history will appear here.</p>
                            </div>
                        </div>
                    </div>
                    <div id="chat-history-premium-overlay" class="premium-overlay">
                        <div class="premium-message">
                            <i class="fas fa-crown"></i>
                            <h3>Premium Feature</h3>
                            <p>Upgrade to premium to access your complete conversation history.</p>
                            <button id="chat-history-upgrade" class="cta-button">Upgrade to Premium</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .empowering-section {
            text-align: center;
            padding: 40px 20px;
            background: var(--primary-color);
            color: white;
            border-radius: 15px;
            margin: 40px auto;
            max-width: 1400px;
            width: 95%;
        }

        .empowering-section h2 {
            margin-bottom: 20px;
            font-size: 2em;
        }

        .empowering-section p {
            margin-bottom: 15px;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .empowering-section a {
            color: white;
            text-decoration: underline;
        }
        
        .empowering-section h3 {
            color: white;
            margin: 30px 0 20px;
            font-size: 1.6em;
        }
        
        /* Pricing Section Styles */
        .pricing-section {
            margin-top: 40px;
        }
        
        .pricing-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 30px auto;
            width: 100%;
        }
        
        .pricing-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 31%;
            min-width: 360px;
            overflow: hidden;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }
        
        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .pricing-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--ramadan-gold);
            color: var(--ramadan-deep-blue);
            padding: 5px 15px;
            font-size: 12px;
            font-weight: bold;
            border-bottom-left-radius: 10px;
        }
        
        .premium-card {
            border: 2px solid var(--ramadan-gold);
        }
        
        .pricing-header {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        .pricing-header h4 {
            margin: 0;
            font-size: 24px;
            color: #2c3e50;
        }
        
        .pricing-cost {
            font-size: 36px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 15px 0 5px;
        }
        
        .pricing-subcost {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .pricing-cost span {
            font-size: 16px;
            font-weight: normal;
            color: #7f8c8d;
        }
        
        .pricing-features {
            padding: 20px;
        }
        
        .pricing-features ul {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }
        
        .pricing-features li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            color: #34495e;
        }
        
        .pricing-features li:last-child {
            border-bottom: none;
        }
        
        .pricing-features i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .feature-disabled {
            color: #95a5a6 !important;
        }
        
        .feature-disabled i {
            color: #e74c3c;
        }
        
        .pricing-footer {
            padding: 20px;
            text-align: center;
            background-color: #f9f9f9;
            margin-top: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        
        /* Stripe button containers in pricing cards */
        #monthly-stripe-container, #annual-stripe-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 0 auto;
        }
        
        /* Ensure Stripe buttons are properly sized and centered */
        #monthly-stripe-container stripe-buy-button,
        #annual-stripe-container stripe-buy-button,
        #modal-monthly-stripe-container stripe-buy-button,
        #modal-annual-stripe-container stripe-buy-button {
            width: 100%;
            max-width: 320px;
            margin: 0 auto;
            display: block;
        }
        
        /* Media query for responsive pricing cards */
        @media (max-width: 1150px) {
            .pricing-container {
                flex-direction: column;
                flex-wrap: wrap;
                align-items: center;
            }
            
            .pricing-card {
                width: 100%;
                max-width: 400px;
                margin-bottom: 20px;
            }
        }
        
        /* Fix Stripe iframe sizing */
        stripe-buy-button iframe {
            min-width: unset !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        .pricing-note {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .pricing-button {
            display: inline-block;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 14px;
            width: 100%;
        }
        
        .free-button {
            background-color: #ecf0f1;
            color: #7f8c8d;
            cursor: default;
        }
        
        .premium-button {
            background-color: var(--primary-color);
            color: white;
        }
        
        .premium-button:hover {
            background-color: #174a3c;
        }
        
        .pricing-alternative {
            margin-top: 30px;
            text-align: center;
        }
        
        .subscription-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
            gap: 15px;
        }
        
        .subscription-divider {
            font-weight: 500;
            margin: 5px 0;
        }
        
        .cta-button {
            background-color: white;
            color: var(--primary-color);
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .buy-coffee-button img {
            height: 40px;
        }

        .about-section {
            background: #f8f9fa;
            padding: 40px;
            border-radius: 15px;
            margin: 40px 0;
        }

        .about-section h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .about-section h3 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .bismillah {
            font-family: var(--arabic-font);
            font-size: 1.5em;
            color: var(--primary-color);
            display: block;
            text-align: center;
            margin-bottom: 20px;
        }

        .authenticity-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .authenticity-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .authenticity-section ul {
            list-style: none;
            padding: 0;
        }

        .authenticity-section li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        /* Ramadan FAQ Banner Styles */
        .ramadan-faq-banner {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            margin: 0 auto 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 1200px;
            position: relative;
        }
        
        .ramadan-faq-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 100 100"><path d="M50 5 L52.5 15 L62.5 15 L54.5 21 L57.5 30 L50 24 L42.5 30 L45.5 21 L37.5 15 L47.5 15 Z" fill="rgba(255,255,255,0.1)" /></svg>');
            background-size: 80px 80px;
            background-repeat: repeat;
            opacity: 0.5;
        }
        
        .faq-banner-content {
            display: flex;
            align-items: center;
            padding: 20px 30px;
            position: relative;
            z-index: 1;
        }
        
        .faq-icon {
            background-color: white;
            color: #f39c12;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 20px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        .faq-banner-text {
            flex: 1;
        }
        
        .faq-banner-text h3 {
            color: white;
            margin: 0 0 5px 0;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .faq-banner-text p {
            color: rgba(255,255,255,0.9);
            margin: 0;
            font-size: 1rem;
        }
        
        .faq-banner-button {
            background-color: white;
            color: #e67e22;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            white-space: nowrap;
            margin-left: 20px;
            flex-shrink: 0;
        }
        
        .faq-banner-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.15);
            background-color: #f8f8f8;
        }
        
        @media (max-width: 768px) {
            .faq-banner-content {
                flex-direction: column;
                text-align: center;
                padding: 20px 15px;
            }
            
            .faq-icon {
                margin-right: 0;
                margin-bottom: 15px;
            }
            
            .faq-banner-text {
                margin-bottom: 15px;
            }
            
            .faq-banner-button {
                margin-left: 0;
            }
        }
    </style>

    <script>
        // Global variables
        let chatMessages;
        let userInput;
        let sendButton;

        // Sharing functions
        function showShareOptions(message) {
            const options = message.querySelector('.share-options');
            options.classList.toggle('active');
        }

        function generateShareCard(message) {
            const content = message.textContent;
            const card = document.createElement('div');
            card.className = 'share-card';
            card.innerHTML = `
                <div class="share-card-header">
                    <img src="/images/islamic-art.png" class="share-card-logo" alt="Ask Mo Logo">
                    <div class="share-card-title">Ask Mo Anything</div>
                </div>
                <div class="share-card-content">${content}</div>
                <div class="share-card-footer">
                    <div>ask-mo-anything.vercel.app</div>
                    <div class="share-card-qr"></div>
                </div>
            `;
            
            // Generate QR code
            new QRCode(card.querySelector('.share-card-qr'), {
                text: 'https://ask-mo-anything.vercel.app',
                width: 80,
                height: 80
            });

            return card;
        }

        async function shareToTwitter(message) {
            // Get the full response text, with fallbacks for different formats
            let responseText = '';
            if (message.completeResponse) {
                responseText = message.completeResponse;
            } else if (message.fullResponse) {
                responseText = message.fullResponse;
            } else if (message.rawResponse) {
                responseText = message.rawResponse;
            } else if (message.querySelector('.response-text')) {
                responseText = message.querySelector('.response-text').textContent;
            } else {
                responseText = message.textContent;
            }
            
            // Trim to Twitter's character limit, leaving room for URL
            const trimmedText = responseText.substring(0, 250) + (responseText.length > 250 ? '...' : '');
            const text = encodeURIComponent(trimmedText);
            
            // Use the correct URL
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent('https://askmoanything.com')}`);
        }

        async function shareToWhatsApp(message) {
            // Get the full response text, with fallbacks for different formats
            let responseText = '';
            if (message.completeResponse) {
                responseText = message.completeResponse;
            } else if (message.fullResponse) {
                responseText = message.fullResponse;
            } else if (message.rawResponse) {
                responseText = message.rawResponse;
            } else if (message.querySelector('.response-text')) {
                responseText = message.querySelector('.response-text').textContent;
            } else {
                responseText = message.textContent;
            }
            
            // Append the correct URL
            const fullText = responseText + ' - via https://askmoanything.com';
            const text = encodeURIComponent(fullText);
            
            // Open WhatsApp sharing
            window.open(`https://wa.me/?text=${text}`);
        }

        async function shareToTelegram(message) {
            const text = encodeURIComponent(message.completeResponse || message.fullResponse || message.rawResponse || message.textContent);
            window.open(`https://t.me/share/url?url=${encodeURIComponent('https://ask-mo-anything.vercel.app')}&text=${text}`);
        }
        
        async function shareToReddit(message) {
            try {
                console.log('Starting Reddit share process');
                
                // Get the user's question
                let userQuestion = '';
                
                // First try to get the user question from the chat messages
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    const lastUserMessage = chatMessages.querySelector('.user-message:last-of-type');
                    if (lastUserMessage) {
                        userQuestion = lastUserMessage.textContent.trim();
                        console.log('Found user question from last user message:', userQuestion);
                    }
                }
                
                // If that didn't work, try from the container
                if (!userQuestion) {
                    const container = message.closest('.complete-response-container');
                    if (container) {
                        const userMsg = container.querySelector('.user-message');
                        if (userMsg) {
                            userQuestion = userMsg.textContent.trim();
                            console.log('Found user question from container:', userQuestion);
                        }
                    }
                }
                
                // Try to get from the most recent conversation
                if (!userQuestion) {
                    const allUserMessages = document.querySelectorAll('.user-message');
                    if (allUserMessages && allUserMessages.length > 0) {
                        userQuestion = allUserMessages[allUserMessages.length - 1].textContent.trim();
                        console.log('Found user question from all user messages:', userQuestion);
                    }
                }
                
                // Fallback if we couldn't get the data
                if (!userQuestion) {
                    userQuestion = 'Islamic Knowledge from AskMo';
                    console.log('Using default question');
                }
                
                // Create a title from the question (limited to 300 chars for Reddit)
                const title = userQuestion.substring(0, 300);
                console.log('Using title for Reddit:', title);
                
                // Create a modal with instructions
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; display:flex; justify-content:center; align-items:center;';
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = 'background:white; border-radius:8px; padding:25px; max-width:500px; width:90%; position:relative;';
                
                // Add close button
                const closeButton = document.createElement('button');
                closeButton.innerHTML = '&times;';
                closeButton.style.cssText = 'position:absolute; top:10px; right:15px; background:none; border:none; font-size:24px; cursor:pointer;';
                closeButton.onclick = () => document.body.removeChild(modal);
                
                // Add content
                modalContent.innerHTML += `
                    <h3 style="margin-top:0; margin-bottom:20px; font-size:18px;">Share to Reddit</h3>
                    <p style="margin-bottom:8px;">1. Use the <strong>"Copy to clipboard"</strong> button below the response to copy the formatted text</p>
                    <p style="margin-bottom:8px;">2. Click the button below to open Reddit</p>
                    <p style="margin-bottom:20px;">3. Paste the copied text into the Reddit post body</p>
                    <div style="text-align:center;">
                        <button id="redditOpenBtn" style="background:#ff4500; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-weight:bold;">Open Reddit</button>
                    </div>
                `;
                
                // Add close button to content
                modalContent.appendChild(closeButton);
                
                // Add content to modal
                modal.appendChild(modalContent);
                
                // Add modal to body
                document.body.appendChild(modal);
                
                // Add event listener for Reddit button
                document.getElementById('redditOpenBtn').addEventListener('click', function() {
                    window.open(`https://www.reddit.com/submit?selftext=true&title=${encodeURIComponent(title)}`, '_blank');
                    document.body.removeChild(modal);
                });
                
                console.log('Reddit share modal opened');
            } catch (error) {
                console.error('Error sharing to Reddit:', error);
                alert('Sorry, there was an error sharing to Reddit: ' + error.message);
            }
        }

        async function copyToClipboard(message) {
            try {
                await navigator.clipboard.writeText(message.completeResponse || message.fullResponse || message.rawResponse || message.textContent);
                alert('Content copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        }
        
        // Process message text
        function processMessageText(text) {
            if (!text) return '';
            
            let processedText = text;
            let relatedTopicsHtml = '';
            
            // Extract and process related topics
            const topicsMatch = processedText.match(/\[RELATED TOPICS\]([\s\S]*?)(?=\[|$)/i);
            if (topicsMatch) {
                const topicsSection = topicsMatch[1];
                processedText = processedText.replace(topicsMatch[0], '');
                
                // Split into lines and collect all questions
                const topics = [];
                const lines = topicsSection.split('\n');
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Handle numbered questions and their continuations
                    if (line.match(/^\d+\./)) {
                        let fullQuestion = line;
                        while (i + 1 < lines.length && !lines[i + 1].trim().match(/^\d+\.\s*|\[/)) {
                            i++;
                            fullQuestion += ' ' + lines[i].trim();
                        }
                        topics.push(fullQuestion.replace(/^\d+\.\s*/, ''));
                    }
                    // Handle standalone questions
                    else if (line.match(/^(What|How|Why|When|Where|Who|Which|Did|Is|Are|Can|Could|Should|Would|Tell)/i)) {
                        topics.push(line);
                    }
                }

                // Create quick-reply buttons for topics
                if (topics.length > 0) {
                    relatedTopicsHtml = `<div class="related-topics">
                        <div class="related-topics-header">Related Questions:</div>
                        ${topics.map(topic => {
                            // EMERGENCY FIX: Enhanced approach to handle Arabic honorifics
                            // First, convert any non-string to string and ensure we're working with a string
                            let clean = String(topic || '');
                            
                            // Pre-process any Unicode characters that might not be caught by standard regex
                            // Replace the specific PBUH Unicode character that's causing issues
                            clean = clean.replace(/\ufdfa/g, ' (PBUH) '); // Unicode for صلى الله عليه وسلم ligature
                            clean = clean.replace(/ﷺ/g, ' (PBUH) '); // Direct replacement of the symbol
                            
                            // Hard-coded replacements for specific Arabic honorifics
                            clean = clean.replace(/صلى الله عليه وسلم/g, ' (PBUH) ');
                            clean = clean.replace(/صلى الله عنه/g, ' (PBUH) ');
                            clean = clean.replace(/رضي الله عنه/g, ' (RA) ');
                            clean = clean.replace(/رضي الله عنها/g, ' (RA) ');
                            clean = clean.replace(/عليه السلام/g, ' (AS) ');
                            
                            // Handle any other potential Arabic honorific patterns
                            clean = clean.replace(/محمد\s*ﷺ/g, 'Muhammad (PBUH)');
                            clean = clean.replace(/Prophet\s*Muhammad\s*ﷺ/gi, 'Prophet Muhammad (PBUH)');
                            clean = clean.replace(/Muhammad\s*ﷺ/gi, 'Muhammad (PBUH)');
                            
                            // Brute force approach: Remove ALL remaining Arabic characters
                            // This regex covers the entire Arabic Unicode range
                            clean = clean.replace(/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]+/g, '');
                            
                            // Fix formatting issues
                            clean = clean.replace(/\s+/g, ' '); // Fix multiple spaces
                            clean = clean.replace(/\(\s*\)/g, ''); // Remove empty parentheses
                            clean = clean.replace(/\(PBUH\)\s*\(PBUH\)/g, ' (PBUH) '); // Fix duplicates
                            clean = clean.replace(/\(RA\)\s*\(RA\)/g, ' (RA) ');
                            clean = clean.replace(/\(AS\)\s*\(AS\)/g, ' (AS) ');
                            
                            // Final cleanup
                            clean = clean.trim();
                            
                            // If after all cleaning we have an empty string, use a fallback
                            if (!clean) {
                                clean = 'More about Prophet Muhammad (PBUH)';
                            }
                            
                            // Create quick-reply button with more reliable event handling
                            const escapedTopic = clean.replace(/["']/g, '\\$&');
                            return `<button class="related-topic-tile" data-topic="${escapedTopic}">${clean}</button>`;
                        }).join('')}
                    </div>`;
                }
            }

            // Add empty Arabic character for alignment
            const arblank = '&#1564;';
            
            // Process the main text
            processedText = processedText
                // Handle sections
                .replace(/\[(CONCLUSION|HADITH|SCHOLARLY OPINIONS|PRACTICAL GUIDANCE)\]([^\[]*)/gi, 
                    '<div class="section-heading">[$1]</div>$2')
                // Handle honorifics inline with proper spacing and RTL marks
                .replace(/(ﷺ|رضي الله عنه|رضي الله عنها)/g, 
                    match => ` ${arblank}<span class="arabic-inline" style="display:inline" lang="ar">${match}</span>\u200F `)
                // Handle longer Arabic passages (excluding honorifics)
                .replace(/(?<!ﷺ|رضي الله عنه|رضي الله عنها)([\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\u064B-\u0652][^\s]*(?:\s+[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\u064B-\u0652][^\s]*){2,})/g, 
                    (_, match) => `<div class="arabic-text" lang="ar">${match}</div>`)
                // Handle remaining single Arabic words (excluding honorifics)
                .replace(/(?<!ﷺ|رضي الله عنه|رضي الله عنها)([\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\u064B-\u0652]+)/g, 
                    (_, match) => `<span class="arabic-inline" lang="ar">${match}</span>`)
                // Clean up any double spaces
                .replace(/\s+/g, ' ');
            
            // Add related topics back at the end
            return processedText + relatedTopicsHtml;
        }
        
        // Helper functions
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function appendErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message error-message';
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            scrollToBottom();
        }
        
        // Initialize after DOM is loaded
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        document.addEventListener('DOMContentLoaded', () => {
            chatMessages = document.getElementById('chat-messages');
            userInput = document.getElementById('user-input');
            sendButton = document.getElementById('send-button');

            // Handle Enter key
            // Auto-resize textarea on input
            userInput.addEventListener('input', function() {
                autoResizeTextarea(this);
            });

            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey && !isGenerating) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Handle button click
            sendButton.addEventListener('click', function() {
                if (!isGenerating) {
                    sendMessage();
                }
            });

            // Handle topic card clicks
            document.querySelectorAll('.topic-card').forEach(card => {
                card.addEventListener('click', function() {
                    const topic = this.getAttribute('data-topic');
                    if (topic) {
                        // Highlight the clicked card
                        document.querySelectorAll('.topic-card').forEach(c => c.classList.remove('topic-card-active'));
                        this.classList.add('topic-card-active');
                        
                        // Set the input value
                        userInput.value = topic;
                        
                        // Scroll to the chat input with smooth animation
                        document.querySelector('.input-section').scrollIntoView({ behavior: 'smooth' });
                        
                        // Add a slight delay before sending the message to allow the scroll to complete
                        setTimeout(() => {
                            sendMessage();
                        }, 500);
                    }
                });
            });
            
            // Add event delegation for related topic tiles
            // This implements the functionality from commit b5dc634 that was missing
            document.addEventListener('click', function(event) {
                // Find if a related-topic-tile was clicked
                const tile = event.target.closest('.related-topic-tile');
                if (tile) {
                    // Get the topic from the data-topic attribute or from the text content
                    let topic = tile.getAttribute('data-topic');
                    if (!topic) {
                        // If data-topic isn't available, use the text content
                        topic = tile.textContent.trim();
                    }
                    
                    console.log('Related topic tile clicked:', topic);
                    
                    // Set the input value
                    userInput.value = topic;
                    
                    // Scroll to the chat input with smooth animation
                    document.querySelector('.input-section').scrollIntoView({ behavior: 'smooth' });
                    
                    // Focus the input
                    userInput.focus();
                    
                    // Add a slight delay before sending the message
                    setTimeout(() => {
                        sendMessage();
                    }, 500);
                }
            });
            
            // Add event listener for bookmark buttons
            document.addEventListener('click', function(event) {
                if (event.target.closest('.bookmark-button')) {
                    const button = event.target.closest('.bookmark-button');
                    const botMessage = button.closest('.bot-message');
                    
                    // Debug the message element
                    console.log('Bookmarking message element:', botMessage);
                    
                    // Try to get the full response if available
                    let messageContent = '';
                    
                    // First check if this is inside a complete response container
                    // Try multiple approaches to find the complete conversation
                    let completeResponseContainer = botMessage.closest('.complete-response-container');
                    
                    // Debug what we found
                    console.log('Initial container search result:', completeResponseContainer);
                    
                    // If not found directly, try to find the parent message container
                    if (!completeResponseContainer) {
                        // Try to find the parent message-container which might contain the full conversation
                        const messageContainer = botMessage.closest('.message-container');
                        console.log('Found message container:', messageContainer);
                        
                        if (messageContainer) {
                            // The parent of message-container might be the complete response container
                            const parentContainer = messageContainer.parentElement;
                            console.log('Parent container:', parentContainer);
                            
                            if (parentContainer && (parentContainer.classList.contains('chat-container') || 
                                                   parentContainer.classList.contains('chat-messages') ||
                                                   parentContainer.id === 'chat-messages')) {
                                completeResponseContainer = parentContainer;
                                console.log('Using parent container as complete response container');
                            }
                        }
                    }
                    
                    if (completeResponseContainer) {
                        console.log('Found complete response container, saving entire conversation');
                        
                        // Get all messages in the conversation
                        const allMessages = [];
                        
                        // Try different approaches to find the user question
                        // First, look for the most recent user message before this bot message
                        let userQuestion = '';
                        
                        // Method 1: Find the last user-message before this bot message
                        const allUserMessages = completeResponseContainer.querySelectorAll('.user-message, .message.user');
                        console.log('All user messages found:', allUserMessages.length);
                        
                        if (allUserMessages.length > 0) {
                            // Get the last user message
                            const lastUserMessage = allUserMessages[allUserMessages.length - 1];
                            console.log('Last user message:', lastUserMessage);
                            
                            // Extract content from the user message
                            const userContent = lastUserMessage.querySelector('.message-content') || lastUserMessage;
                            if (userContent) {
                                userQuestion = userContent.innerText || userContent.textContent;
                                console.log('Found user question:', userQuestion);
                            }
                        }
                        
                        // Method 2: If we couldn't find a user message, try to find the input field value
                        if (!userQuestion) {
                            const inputField = document.getElementById('question-input');
                            if (inputField && inputField.value) {
                                userQuestion = inputField.value;
                                console.log('Using input field value as user question:', userQuestion);
                            }
                        }
                        
                        // Add the user question to our messages array
                        if (userQuestion) {
                            allMessages.push({
                                role: 'user',
                                content: userQuestion
                            });
                        }
                        
                        // Get the current bot response
                        // First try to get the full response if it's a complete response
                        let botResponse = '';
                        
                        // Method 1: Try to get the content from the current message
                        const botContent = botMessage.querySelector('.message-content');
                        if (botContent) {
                            botResponse = botContent.innerText || botContent.textContent;
                            console.log('Found bot response from current message:', botResponse.substring(0, 50) + '...');
                        }
                        
                        // Method 2: If we're in a complete response container, try to get all sections
                        if (!botResponse || botResponse.trim() === '') {
                            // Try to find all message sections in the container
                            const sections = completeResponseContainer.querySelectorAll('.message-section, .bot-message');
                            console.log('Found message sections:', sections.length);
                            
                            if (sections.length > 0) {
                                const sectionContents = [];
                                sections.forEach(section => {
                                    const sectionContent = section.querySelector('.message-content');
                                    if (sectionContent) {
                                        sectionContents.push(sectionContent.innerText || sectionContent.textContent);
                                    }
                                });
                                
                                if (sectionContents.length > 0) {
                                    botResponse = sectionContents.join('\n\n');
                                    console.log('Combined bot response from sections:', botResponse.substring(0, 50) + '...');
                                }
                            }
                        }
                        
                        // Method 3: Last resort - try to find the full response in the page
                        if (!botResponse || botResponse.trim() === '') {
                            // Look for the response in the current view
                            const visibleResponse = document.querySelector('.complete-response-content');
                            if (visibleResponse) {
                                botResponse = visibleResponse.innerText || visibleResponse.textContent;
                                console.log('Found response from complete-response-content:', botResponse.substring(0, 50) + '...');
                            }
                        }
                        
                        // Method 4: Try to find the response in the current message's parent elements
                        if (!botResponse || botResponse.trim() === '') {
                            // Walk up the DOM tree to find the complete response
                            let currentElement = botMessage.parentElement;
                            while (currentElement && !botResponse) {
                                // Check if this element has substantial text content
                                const textContent = currentElement.innerText || currentElement.textContent;
                                if (textContent && textContent.length > 100) { // Assuming a meaningful response is at least 100 chars
                                    botResponse = textContent;
                                    console.log('Found response from parent element:', botResponse.substring(0, 50) + '...');
                                    break;
                                }
                                currentElement = currentElement.parentElement;
                            }
                        }
                        
                        // Add the bot response to our messages array
                        if (botResponse) {
                            allMessages.push({
                                role: 'assistant',
                                content: botResponse
                            });
                        }
                        
                        // Format the full conversation
                        if (allMessages.length > 0) {
                            messageContent = allMessages.map(msg => {
                                return `${msg.role === 'user' ? 'You' : 'Mo'}:\n${msg.content}`;
                            }).join('\n\n');
                            console.log('Formatted conversation to save:', messageContent.substring(0, 100) + '...');
                        }
                    }
                    // If not in a complete response container, try other methods
                    else if (botMessage.fullResponse) {
                        console.log('Using fullResponse property');
                        messageContent = botMessage.fullResponse;
                    } 
                    // Try to get content from the message-content div
                    else {
                        const contentDiv = botMessage.querySelector('.message-content');
                        if (contentDiv) {
                            console.log('Using message-content div');
                            // Prefer innerText as it gives the rendered text without HTML tags
                            messageContent = contentDiv.innerText || contentDiv.textContent;
                        }
                    }
                    
                    // Fallback if we still don't have content
                    if (!messageContent || messageContent.trim() === '') {
                        console.log('Using fallback content extraction');
                        // Get all text content from the message, excluding the bookmark button text
                        const buttonText = button.innerText || '';
                        const fullText = botMessage.innerText || botMessage.textContent || '';
                        messageContent = fullText.replace(buttonText, '').trim() || 'No content available';
                    }
                    
                    // Log the content we're about to save
                    console.log('Content to be saved:', messageContent);
                    
                    // Update the bookmark icon to filled
                    const bookmarkIcon = button.querySelector('i');
                    if (bookmarkIcon) {
                        bookmarkIcon.className = 'fas fa-bookmark';
                    }
                    
                    // Save the response
                    saveResponse(messageContent, button);
                }
            });
        });

        // Function to directly save the complete response stored in window.completeResponse
        window.saveDirectResponse = async function(button) {
            try {
                if (!window.completeResponse) {
                    console.error('No complete response available to save');
                    return;
                }
                
                console.log('Saving direct response from window.completeResponse');
                
                // Get the user question from the data attribute
                let userQuestion = '';
                const questionInput = document.getElementById('question-input');
                if (questionInput) {
                    userQuestion = questionInput.getAttribute('data-last-question') || '';
                }
                
                // Format the complete conversation
                let messageContent = '';
                if (userQuestion) {
                    messageContent = `You:\n${userQuestion}\n\nMo:\n${window.completeResponse}`;
                } else {
                    messageContent = window.completeResponse;
                }
                
                // Use the global related topics array that was populated during response generation
                let relatedTopics = window.relatedTopics || [];
                
                // If the global array is empty, try to get topics from the DOM as a fallback
                if (relatedTopics.length === 0) {
                    console.log('No related topics found in global array, trying DOM...');
                    const topicTiles = document.querySelectorAll('.related-topic-tile');
                    if (topicTiles && topicTiles.length > 0) {
                        topicTiles.forEach(topic => {
                            if (topic.textContent && topic.textContent.trim()) {
                                relatedTopics.push(topic.textContent.trim());
                            }
                        });
                    }
                }
                
                // If still no topics found, try to extract them from the complete response
                if (relatedTopics.length === 0) {
                    console.log('No related topics found in DOM, trying text extraction...');
                    
                    // First try to extract from the [RELATED TOPICS] section (most reliable)
                    const relatedTopicsSectionBrackets = window.completeResponse.match(/\[RELATED TOPICS\][\s\S]*?(\n\n|$)/i);
                    const relatedTopicsSectionHeader = window.completeResponse.match(/Related Topics:[\s\S]*$/i);
                    
                    let topicsText = '';
                    if (relatedTopicsSectionBrackets) {
                        topicsText = relatedTopicsSectionBrackets[0];
                        console.log('Found [RELATED TOPICS] section');
                    } else if (relatedTopicsSectionHeader) {
                        topicsText = relatedTopicsSectionHeader[0];
                        console.log('Found Related Topics: header');
                    }
                    
                    if (topicsText) {
                        console.log('Topics section text:', topicsText);
                        
                        // Try multiple regex patterns to ensure we capture all topics
                        // First try to match complete numbered topics with question marks or periods
                        const fullTopicRegex = /\d+\.\s*([^\n]+?(\?|\.))/g;
                        // Then try to match any numbered topics (for incomplete or malformed topics)
                        const partialTopicRegex = /\d+\.\s*([^\n]+)/g;
                        // Special case for topics that might span multiple lines
                        const multiLineTopicRegex = /\d+\.\s*([^\d\n][^\n]*)/g;
                        
                        // Try each regex in order of specificity
                        const topicMatches = topicsText.match(fullTopicRegex) || 
                                           topicsText.match(partialTopicRegex) || 
                                           topicsText.match(multiLineTopicRegex);
                        
                        if (topicMatches && topicMatches.length > 0) {
                            console.log('Raw matched topics:', topicMatches);
                            
                            relatedTopics = topicMatches.map(topic => {
                                // Clean up the topic text
                                let cleanTopic = topic
                                    .replace(/^\d+\.\s*/, '')  // Remove leading numbers
                                    .replace(/\s+/g, ' ')       // Normalize whitespace
                                    .trim();
                                
                                // Convert honorifics to English - Enhanced version
                                cleanTopic = cleanTopic
                                    // Handle direct honorific symbols
                                    .replace(/\ufdfa/g, ' (PBUH) ')
                                    .replace(/ﷺ/g, ' (PBUH) ')
                                    // Handle Arabic text for PBUH
                                    .replace(/صلى الله عليه وسلم/g, ' (PBUH) ')
                                    .replace(/صلى الله عنه/g, ' (PBUH) ')
                                    // Handle Arabic text for RA
                                    .replace(/\u0631\u0636\u064a \u0627\u0644\u0644\u0647 \u0639\u0646\u0647|\u0631\u0636\u064a \u0627\u0644\u0644\u0647 \u0639\u0646\u0647\u0627/g, ' (RA) ')
                                    .replace(/رضي الله عنه/g, ' (RA) ')
                                    .replace(/رضي الله عنها/g, ' (RA) ')
                                    // Handle Arabic text for AS
                                    .replace(/\u0639\u0644\u064a\u0647 \u0627\u0644\u0633\u0644\u0627\u0645/g, ' (AS) ')
                                    .replace(/عليه السلام/g, ' (AS) ')
                                    // Handle specific patterns
                                    .replace(/Prophet\s*Muhammad\s*ﷺ/gi, 'Prophet Muhammad (PBUH)')
                                    .replace(/Muhammad\s*ﷺ/gi, 'Muhammad (PBUH)');
                                    
                                // Remove any remaining Arabic characters
                                cleanTopic = cleanTopic.replace(/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]+/g, '');
                                
                                // Clean up formatting
                                cleanTopic = cleanTopic
                                    .replace(/\s+/g, ' ')  // Fix multiple spaces
                                    .replace(/\(\s*\)/g, '') // Remove empty parentheses
                                    .replace(/\(PBUH\)\s*\(PBUH\)/g, ' (PBUH) ') // Fix duplicates
                                    .replace(/\(RA\)\s*\(RA\)/g, ' (RA) ')
                                    .replace(/\(AS\)\s*\(AS\)/g, ' (AS) ')
                                    .trim();
                                
                                return cleanTopic;
                            }).filter(topic => topic && topic.length > 0);
                            
                            console.log('Extracted and cleaned topics:', relatedTopics);
                        } else {
                            console.log('No topic matches found in section');
                        }
                    } else {
                        console.log('No topics section found in text');
                    }
                }
                
                console.log('Found related topics:', relatedTopics);
                
                // Always add related topics to the content if they exist
                if (relatedTopics.length > 0) {
                    console.log('Adding related topics to saved content:', relatedTopics);
                    
                    // Remove any existing Related Topics section to avoid duplicates
                    // This ensures we have a clean, complete section
                    if (messageContent.includes('Related Topics:')) {
                        console.log('Removing existing Related Topics section');
                        messageContent = messageContent.replace(/\n\nRelated Topics:[\s\S]*$/, '');
                    }
                    
                    // Format topics with proper numbering and line breaks
                    const formattedTopics = relatedTopics.map((topic, index) => `${index + 1}. ${topic}`).join('\n');
                    
                    // Add a clear separator and the related topics
                    messageContent += '\n\nRelated Topics:\n' + formattedTopics;
                    console.log('Final formatted topics:', formattedTopics);
                } else {
                    console.log('No related topics to add');
                }
                
                console.log('Formatted direct response to save:', messageContent.substring(0, 100) + '...');
                
                // Update the bookmark icon
                if (button) {
                    const bookmarkIcon = button.querySelector('i');
                    if (bookmarkIcon) {
                        bookmarkIcon.className = 'fas fa-bookmark';
                    }
                }
                
                // Save the response
                await saveResponse(messageContent, button);
                
            } catch (error) {
                console.error('Error in saveDirectResponse:', error);
            }
        };
        
        // Function to save the full response from the complete response container
        window.saveFullResponse = async function(container) {
            try {
                if (!container) {
                    console.error('No container provided to saveFullResponse');
                    return;
                }
                
                console.log('Saving full response from container:', container);
                
                // First try to get the current question from the input field
                let userQuestion = '';
                const questionInput = document.getElementById('question-input');
                if (questionInput) {
                    userQuestion = questionInput.getAttribute('data-last-question') || '';
                    console.log('Found user question from data attribute:', userQuestion);
                }
                
                // If we couldn't get it from the data attribute, try other methods
                if (!userQuestion) {
                    // Try to get it from the user message in the container
                    const userMessage = container.querySelector('.user-message') || 
                                       document.querySelector('.user-message');
                    if (userMessage) {
                        const userContent = userMessage.querySelector('.message-content');
                        if (userContent) {
                            userQuestion = userContent.innerText || userContent.textContent;
                            console.log('Found user question from message:', userQuestion);
                        }
                    }
                }
                
                // Get the bot response content
                let botResponse = '';
                
                // First try to get it from the complete response container
                if (container.classList.contains('complete-response-container')) {
                    // Get only the message content divs, not the share section
                    const messageContents = container.querySelectorAll('.message-content');
                    if (messageContents && messageContents.length > 0) {
                        const contentTexts = [];
                        messageContents.forEach(content => {
                            contentTexts.push(content.innerText || content.textContent);
                        });
                        botResponse = contentTexts.join('\n\n');
                        console.log('Got response from message-content divs:', botResponse.substring(0, 50) + '...');
                    } else {
                        // If no message-content divs found, try to get the content but exclude the share section
                        const shareSection = container.querySelector('.share-section');
                        const shareIndicator = container.querySelector('div[style*="color: #1e6f5c"]'); // The "Found this helpful?" text
                        
                        // Clone the container to avoid modifying the original
                        const tempContainer = container.cloneNode(true);
                        
                        // Remove the share section and indicator if they exist
                        if (shareSection) {
                            const shareInContainer = tempContainer.querySelector('.share-section');
                            if (shareInContainer) shareInContainer.remove();
                        }
                        if (shareIndicator) {
                            const indicatorInContainer = tempContainer.querySelector('div[style*="color: #1e6f5c"]');
                            if (indicatorInContainer) indicatorInContainer.remove();
                        }
                        
                        // Now get the text content without the share section
                        botResponse = tempContainer.innerText || tempContainer.textContent;
                        console.log('Got response from container (excluding share section):', botResponse.substring(0, 50) + '...');
                    }
                } else {
                    // If not in a complete container, try to find all bot messages
                    const botMessages = document.querySelectorAll('.bot-message');
                    const responseTexts = [];
                    botMessages.forEach(msg => {
                        const content = msg.querySelector('.message-content');
                        if (content) {
                            responseTexts.push(content.innerText || content.textContent);
                        }
                    });
                    if (responseTexts.length > 0) {
                        botResponse = responseTexts.join('\n\n');
                        console.log('Combined response from bot messages:', botResponse.substring(0, 50) + '...');
                    }
                }
                
                // If we still don't have a response, try one more approach
                if (!botResponse || botResponse.trim() === '') {
                    // Try to get it from the window.completeResponse variable
                    if (window.completeResponse) {
                        botResponse = window.completeResponse;
                        console.log('Using window.completeResponse:', botResponse.substring(0, 50) + '...');
                    }
                }
                
                // Format the conversation
                let messageContent = '';
                if (userQuestion && botResponse) {
                    messageContent = `You:\n${userQuestion}\n\nMo:\n${botResponse}`;
                    console.log('Formatted conversation to save:', messageContent.substring(0, 100) + '...');
                } else if (botResponse) {
                    messageContent = botResponse;
                    console.log('Saving just the response:', messageContent.substring(0, 100) + '...');
                }
                
                // If we have content, save it
                if (messageContent && messageContent.trim() !== '') {
                    // Find the bookmark button and update its icon
                    const bookmarkButton = container.querySelector('.share-btn i.far.fa-bookmark');
                    if (bookmarkButton) {
                        bookmarkButton.className = 'fas fa-bookmark';
                    }
                    
                    // Save the response
                    await saveResponse(messageContent, container.querySelector('.share-btn:last-child'));
                } else {
                    console.error('No content found to save');
                }
            } catch (error) {
                console.error('Error in saveFullResponse:', error);
            }
        };
        
        // Make helper functions globally available
        window.showAuthModal = function(modalType) {
            try {
                if (modalType === 'login') {
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) {
                        loginModal.style.display = 'block';
                        console.log('Login modal displayed via global function');
                        // Clear any previous errors
                        const loginError = document.getElementById('login-error');
                        if (loginError) loginError.textContent = '';
                    }
                } else if (modalType === 'signup') {
                    const signupModal = document.getElementById('signup-modal');
                    if (signupModal) {
                        signupModal.style.display = 'block';
                        console.log('Signup modal displayed via global function');
                        // Clear any previous errors
                        const signupError = document.getElementById('signup-error');
                        if (signupError) signupError.textContent = '';
                    }
                }
            } catch (error) {
                console.error('Error showing auth modal:', error);
            }
        };
        
        // Make selectTopic globally available
        window.selectTopic = function(topic) {
            console.log('selectTopic called with:', topic);
            
            // Handle escaped quotes in the topic
            const unescapedTopic = topic
                .replace(/\\'/g, "'")
                .replace(/\\\"/g, '"');
                
            console.log('Unescaped topic:', unescapedTopic);
            
            // Find and highlight the matching topic card if it exists
            document.querySelectorAll('.topic-card').forEach(card => {
                const cardTopic = card.getAttribute('data-topic');
                if (cardTopic === topic) {
                    console.log('Found matching topic card, highlighting it');
                    document.querySelectorAll('.topic-card').forEach(c => c.classList.remove('topic-card-active'));
                    card.classList.add('topic-card-active');
                }
            });
            
            // Set the input value
            const inputElement = document.getElementById('user-input');
            if (inputElement) {
                console.log('Setting input value');
                inputElement.value = unescapedTopic;
                // Focus the input to ensure it's visible
                inputElement.focus();
            } else {
                console.error('Could not find user-input element');
            }
            
            // Scroll to the chat input with smooth animation
            const inputSection = document.querySelector('.input-section');
            if (inputSection) {
                console.log('Scrolling to input section');
                inputSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                console.error('Could not find input-section element');
            }
            
            // Add a slight delay before sending the message
            console.log('Setting timeout to send message');
            setTimeout(() => {
                console.log('Sending message:', unescapedTopic);
                sendMessage(unescapedTopic);
            }, 500);
        }

        let currentReader = null;
        let isGenerating = false;

        function stopGeneration() {
            if (currentReader) {
                currentReader.cancel();
                document.getElementById('stop-button').style.display = 'none';
                document.querySelector('.send-button').style.display = 'inline-flex';
                isGenerating = false;
            }
        }

        async function sendMessage(message) {
            if (isGenerating) return;

            // If no message provided, get it from the input
            if (!message) message = userInput.value;
            if (!message || !message.trim()) return;
            
            // Store the question for later reference (used in saving responses)
            userInput.setAttribute('data-last-question', message);
            
            // Clear input and show user message
            userInput.value = '';
            document.querySelector('.response-indicator').style.display = 'block';
            document.querySelector('.send-button').style.display = 'none';
            document.getElementById('stop-button').style.display = 'inline-flex';
            const userMessage = document.createElement('div');
            userMessage.className = 'message user-message';
            userMessage.textContent = message;
            chatMessages.appendChild(userMessage);
            scrollToBottom();
            
            // SEO Enhancement: Show related topics based on user query
            const relatedTopicsSection = document.querySelector('.seo-internal-links');
            const relatedTopicsContainer = document.querySelector('.internal-links-container');
            
            if (relatedTopicsSection && relatedTopicsContainer) {
                // Common Islamic topics for internal linking
                const commonTopics = [
                    { text: "Prayer in Islam", query: "How do Muslims pray?" },
                    { text: "Fasting in Ramadan", query: "What are the rules of fasting in Ramadan?" },
                    { text: "Zakat Guidelines", query: "How is zakat calculated?" },
                    { text: "Hajj Pilgrimage", query: "What are the rituals of Hajj?" },
                    { text: "Islamic Dietary Laws", query: "What foods are halal in Islam?" },
                    { text: "Prophet Muhammad's Life", query: "Tell me about Prophet Muhammad's life" },
                    { text: "Quran Interpretation", query: "How to understand the Quran?" },
                    { text: "Islamic Finance", query: "What is Islamic banking?" },
                    { text: "Marriage in Islam", query: "What are Islamic marriage customs?" },
                    { text: "Islamic Ethics", query: "What are the core values in Islam?" }
                ];
                
                // Keywords to match in the user query
                const keywords = ['prayer', 'salah', 'fasting', 'ramadan', 'zakat', 'hajj', 'halal', 'quran', 'prophet', 'muhammad', 
                                 'finance', 'marriage', 'ethics', 'values', 'pillars', 'islam', 'muslim', 'hadith', 'sunnah'];
                
                // Find matching topics based on keywords in the user query
                const lowerQuery = message.toLowerCase();
                const matchedTopics = [];
                
                keywords.forEach(keyword => {
                    if (lowerQuery.includes(keyword)) {
                        commonTopics.forEach(topic => {
                            // Only add unique topics that match the keyword
                            if (topic.text.toLowerCase().includes(keyword) && !matchedTopics.some(t => t.text === topic.text)) {
                                matchedTopics.push(topic);
                            }
                        });
                    }
                });
                
                // Get up to 3 related topics
                const relatedTopics = matchedTopics.slice(0, 3);
                
                // Clear previous links
                relatedTopicsContainer.innerHTML = '';
                
                // If we have related topics, display them
                if (relatedTopics.length > 0) {
                    relatedTopics.forEach(topic => {
                        const link = document.createElement('a');
                        link.href = '#';
                        link.className = 'internal-link';
                        link.textContent = topic.text;
                        link.style.padding = '6px 12px';
                        link.style.backgroundColor = 'var(--primary-color)';
                        link.style.color = 'white';
                        link.style.borderRadius = '20px';
                        link.style.fontSize = '0.9em';
                        link.style.textDecoration = 'none';
                        link.style.display = 'inline-block';
                        link.style.margin = '4px';
                        link.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                        
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            document.getElementById('user-input').value = topic.query;
                            document.getElementById('send-button').click();
                        });
                        
                        relatedTopicsContainer.appendChild(link);
                    });
                    
                    // Show the section
                    relatedTopicsSection.style.display = 'block';
                } else {
                    // Hide the section if no related topics
                    relatedTopicsSection.style.display = 'none';
                }
            }

            // Show thinking message with Islamic theme
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message bot-message';
            loadingMessage.innerHTML = `
                <div class="thinking-message">
                    <div class="english-text">Mo is responding...</div>
                    <div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>
                </div>
            `;
            chatMessages.appendChild(loadingMessage);
            scrollToBottom();

            // Add loading animation
            const dots = loadingMessage.querySelectorAll('.loading-dots span');
            let dotIndex = 0;
            const loadingInterval = setInterval(() => {
                dots.forEach(dot => dot.style.opacity = '0.2');
                dots[dotIndex].style.opacity = '1';
                dotIndex = (dotIndex + 1) % dots.length;
            }, 500);

            let currentMessage = document.createElement('div');
            currentMessage.className = 'message bot-message';
            currentMessage.fullResponse = '';  // Track full response text
            currentMessage.rawResponse = '';   // Track raw response before processing
            
            // Initialize or get the global completeResponse variable
            if (typeof window.completeResponse === 'undefined') {
                window.completeResponse = '';
            } else {
                // Clear previous response when starting a new one
                window.completeResponse = '';
            }
            
            // Initialize or clear the related topics array
            window.relatedTopics = [];
            
            let currentSection = '';
            
            try {
                isGenerating = true;
                document.querySelector('.send-button').style.display = 'none';
                document.getElementById('stop-button').style.display = 'inline-flex';

                console.log('Sending message:', message);
                // Get user's API key if available
                const userApiKey = localStorage.getItem('openai_api_key');
                
                // Get current user ID if logged in
                let userId = null;
                // Use the globally available Firebase auth
                if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                    userId = window.firebaseAuth.currentUser.uid;
                }
                
                // Determine if we're running locally or in production
                const apiUrl = window.location.hostname === 'localhost' ? 'http://localhost:3001/api/chat' : '/api/chat';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(userApiKey && { 'X-API-Key': userApiKey }),
                        ...(userId && { 'X-User-Id': userId })
                    },
                    body: JSON.stringify({ message }),
                });

                if (!response.ok) {
                    if (response.status === 429) {
                        const errorData = await response.json();
                        loadingMessage.remove();
                        const limitMessage = document.createElement('div');
                        limitMessage.className = 'message bot-message';
                        limitMessage.innerHTML = `
                            <div class="empowering-section" style="margin: 0; text-align: left;">
                                <h3 style="color: var(--primary-color); margin-bottom: 15px;">You've reached our API limit for today.</h3>
                                <p>To continue using our platform immediately:</p>
                                <ol style="margin: 15px 0; padding-left: 20px;">
                                    <li>Get your own OpenAI API key (preferred) - this gives you unlimited access right away</li>
                                </ol>
                                <p style="margin: 15px 0;">Want to support our mission? Consider buying us a coffee! 🙂</p>
                                <p>Your support helps us develop new features including:</p>
                                <ul style="margin: 10px 0 15px 20px; list-style-type: '- ';">
                                    <li>User accounts with saved conversations</li>
                                    <li>Premium membership with unlimited questions</li>
                                    <li>Advanced features for deeper Islamic learning</li>
                                </ul>
                                <p style="font-style: italic; font-size: 0.9em;">Note: Supporting through Buy Me a Coffee is currently just for development support. We're working on a proper membership system!</p>
                                <div class="buy-coffee-container" style="margin-top: 15px; text-align: center;">
                                    <a href="https://buymeacoffee.com/samir.shah" target="_blank" class="buy-coffee-button">
                                        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-white.png" alt="Buy Me A Coffee">
                                    </a>
                                </div>
                            </div>
                        `;
                        chatMessages.appendChild(limitMessage);
                        scrollToBottom();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Remove loading message
                loadingMessage.remove();

                // Show stop button and hide send button
                document.getElementById('stop-button').style.display = 'inline-flex';
                document.querySelector('.send-button').style.display = 'none';
                isGenerating = true;

                currentReader = response.body.getReader();
                const decoder = new TextDecoder();
                let responseComplete = false;
                let timeoutId;
                let lastChunkTime = Date.now();

                console.log('Starting stream processing');
                const resetTimeout = () => {
                    if (timeoutId) clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        if (!responseComplete) {
                            console.error('Client timeout - no response for 60 seconds');
                            appendErrorMessage("The response was incomplete. Please try asking your question again.");
                            currentReader.cancel();
                        }
                    }, 60000);
                };

                while (true) {
                    resetTimeout();
                    const { done, value } = await currentReader.read();

                    if (done) {
                        console.log('Stream complete');
                        clearTimeout(timeoutId);
                        document.getElementById('stop-button').style.display = 'none';
                        document.querySelector('.send-button').style.display = 'inline-flex';
                        isGenerating = false;
                        break;
                    }

                    const timeSinceLastChunk = Date.now() - lastChunkTime;
                    if (timeSinceLastChunk > 10000) {
                        console.log(`No chunks received for ${timeSinceLastChunk}ms`);
                    }

                    lastChunkTime = Date.now();
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.trim() === '') continue;

                        const message = line.replace(/^data: /, '');
                        if (message === '[DONE]') {
                            console.log('Received [DONE] message');
                            responseComplete = true;
                            clearTimeout(timeoutId);
                            break;
                        }

                        try {
                            // Only try to parse if it looks like valid JSON
                            if (message.trim().startsWith('{') && message.trim().endsWith('}')) {
                                const parsed = JSON.parse(message);
                                if (parsed.error) {
                                    console.error('Received error:', parsed.error);
                                    appendErrorMessage(parsed.error);
                                    clearTimeout(timeoutId);
                                    return;
                                }
                                if (parsed.status === 'complete') {
                                    console.log('Received complete status');
                                    responseComplete = true;
                                    clearTimeout(timeoutId);
                                    break;
                                }
                                if (parsed.chunk) {
                                    const chunk = parsed.chunk.trim();
                                    
                                    // Check for new section
                                    const sectionMatch = chunk.match(/^\[(.*?)\]/);
                                    if (sectionMatch) {
                                        const sectionName = sectionMatch[1];
                                        
                                        // If it's a RELATED TOPICS section
                                        if (sectionName === 'RELATED TOPICS') {
                                            // Only create new message and topics container if we don't already have one
                                            if (currentSection !== 'RELATED TOPICS') {
                                                // Append any existing message
                                                if (currentMessage && currentMessage.innerHTML.trim()) {
                                                    chatMessages.appendChild(currentMessage);
                                                }
                                                // Create a new message for topics
                                                currentMessage = document.createElement('div');
                                                currentMessage.className = 'message bot-message';
                                                
                                                // Create message content container
                                                const messageContent = document.createElement('div');
                                                messageContent.className = 'message-content';
                                                currentMessage.appendChild(messageContent);
                                                
                                                // Add bookmark button
                                                const messageActions = document.createElement('div');
                                                messageActions.className = 'message-actions';
                                                messageActions.innerHTML = `
                                                    <button class="bookmark-button" title="Save this response">
                                                        <i class="far fa-bookmark"></i>
                                                    </button>
                                                `;
                                                currentMessage.appendChild(messageActions);
                                                currentSection = 'RELATED TOPICS';
                                                
                                                // Create topics container
                                                const topicsDiv = document.createElement('div');
                                                topicsDiv.className = 'related-topics';
                                                const header = document.createElement('div');
                                                header.className = 'related-topics-header';
                                                header.textContent = 'Related Topics:';
                                                topicsDiv.appendChild(header);
                                                currentMessage.querySelector('.message-content').appendChild(topicsDiv);
                                                chatMessages.appendChild(currentMessage);
                                                
                                                // Add related topics header to complete response
                                                window.completeResponse += '\n\nRelated Topics:\n';
                                                
                                                // Initialize related topics array if needed
                                                if (!window.relatedTopics) {
                                                    window.relatedTopics = [];
                                                }
                                            }
                                        } else {
                                            // For other sections
                                            if (currentMessage && currentMessage.innerHTML.trim()) {
                                                chatMessages.appendChild(currentMessage);
                                                requestAnimationFrame(scrollToBottom);
                                            }
                                            currentMessage = document.createElement('div');
                                            currentMessage.className = 'message bot-message';
                                            
                                            // Create message content container
                                            const messageContent = document.createElement('div');
                                            messageContent.className = 'message-content';
                                            currentMessage.appendChild(messageContent);
                                            
                                            // Add bookmark button
                                            const messageActions = document.createElement('div');
                                            messageActions.className = 'message-actions';
                                            messageActions.innerHTML = `
                                                <button class="bookmark-button" title="Save this response">
                                                    <i class="far fa-bookmark"></i>
                                                </button>
                                            `;
                                            currentMessage.appendChild(messageActions);
                                            currentSection = sectionName;
                                            const header = document.createElement('div');
                                            header.className = 'section-header';
                                            header.textContent = chunk;
                                            currentMessage.querySelector('.message-content').appendChild(header);
                                            
                                            // Add section header to complete response
                                            window.completeResponse += '\n\n' + chunk + '\n';
                                        }
                                    } else {
                                        // Handle non-section content
                                        if (currentSection === 'RELATED TOPICS') {
                                            const topicsDiv = currentMessage.querySelector('.related-topics');
                                            if (topicsDiv) {
                                                // Initialize buffers if needed
                                                if (!topicsDiv.currentTopic) {
                                                    topicsDiv.currentTopic = '';
                                                    topicsDiv.honorificPending = false;
                                                }
                                                
                                                // Handle honorifics or normal text
                                                let processedChunk = chunk;
                                                
                                                // Process all honorifics regardless of whether they're in this chunk
                                                // This ensures we catch honorifics that might be split across chunks
                                                
                                                // Prophet Muhammad (PBUH)
                                                if (processedChunk.includes('ﷺ') || topicsDiv.currentTopic.includes('ﷺ')) {
                                                    processedChunk = processedChunk.replace(/ﷺ/g, ' (PBUH) ');
                                                    // Also check and fix the accumulated topic text
                                                    topicsDiv.currentTopic = topicsDiv.currentTopic.replace(/ﷺ/g, ' (PBUH) ');
                                                    topicsDiv.honorificPending = true;
                                                } 
                                                
                                                // Companions (RA)
                                                if (processedChunk.includes('رضي الله عنه') || processedChunk.includes('رضي الله عنها') ||
                                                    topicsDiv.currentTopic.includes('رضي الله عنه') || topicsDiv.currentTopic.includes('رضي الله عنها')) {
                                                    processedChunk = processedChunk.replace(/رضي الله عنه|رضي الله عنها/g, ' (RA) ');
                                                    // Also check and fix the accumulated topic text
                                                    topicsDiv.currentTopic = topicsDiv.currentTopic.replace(/رضي الله عنه|رضي الله عنها/g, ' (RA) ');
                                                    topicsDiv.honorificPending = true;
                                                } 
                                                
                                                // Prophets (AS)
                                                if (processedChunk.includes('عليه السلام') || topicsDiv.currentTopic.includes('عليه السلام')) {
                                                    processedChunk = processedChunk.replace(/عليه السلام/g, ' (AS) ');
                                                    // Also check and fix the accumulated topic text
                                                    topicsDiv.currentTopic = topicsDiv.currentTopic.replace(/عليه السلام/g, ' (AS) ');
                                                    topicsDiv.honorificPending = true;
                                                }
                                            
                                                if (topicsDiv.honorificPending && !processedChunk.trim().match(/[(.)]$/)) {
                                                    topicsDiv.currentTopic += processedChunk + ' ';
                                                    topicsDiv.honorificPending = false;
                                                } else {
                                                    topicsDiv.currentTopic += processedChunk;
                                                }
                                                
                                                // Check if we have any complete questions
                                                const questionMatches = topicsDiv.currentTopic.match(/\d+\.[^?]*\?/g);
                                                if (questionMatches && !topicsDiv.honorificPending) {
                                                    for (const question of questionMatches) {
                                                        // Clean up the question text
                                                        let cleanQuestion = question
                                                            .replace(/^\d+\.\s*/, '')  // Remove leading numbers
                                                            .replace(/\s+/g, ' ')       // Normalize whitespace
                                                            .trim();
                                                            
                                                        // Make sure all honorifics are properly converted to English
                                                        cleanQuestion = cleanQuestion
                                                            .replace(/\ufdfa/g, ' (PBUH) ')
                                                            .replace(/\u0631\u0636\u064a \u0627\u0644\u0644\u0647 \u0639\u0646\u0647|\u0631\u0636\u064a \u0627\u0644\u0644\u0647 \u0639\u0646\u0647\u0627/g, ' (RA) ')
                                                            .replace(/\u0639\u0644\u064a\u0647 \u0627\u0644\u0633\u0644\u0627\u0645/g, ' (AS) ')
                                                            .replace(/\s+/g, ' ')  // Normalize whitespace again after replacements
                                                            .trim();
                                                        
                                                        // Enhanced processing for clean question to ensure all honorifics are properly converted
                                                        let displayText = cleanQuestion;
                                                        
                                                        // First pass: Convert all known honorific patterns
                                                        displayText = displayText
                                                            // Handle direct honorific symbols
                                                            .replace(/\ufdfa/g, ' (PBUH) ')
                                                            .replace(/ﷺ/g, ' (PBUH) ')
                                                            // Handle Arabic text for PBUH
                                                            .replace(/صلى الله عليه وسلم/g, ' (PBUH) ')
                                                            .replace(/صلى الله عنه/g, ' (PBUH) ')
                                                            // Handle specific patterns with honorifics
                                                            .replace(/Prophet\s*Muhammad\s*ﷺ/gi, 'Prophet Muhammad (PBUH)')
                                                            .replace(/Muhammad\s*ﷺ/gi, 'Muhammad (PBUH)')
                                                            .replace(/Prophet\s*Muhammad/gi, 'Prophet Muhammad (PBUH)');
                                                            
                                                        // Second pass: Remove any remaining Arabic characters
                                                        displayText = displayText.replace(/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]+/g, '');
                                                        
                                                        // Third pass: Clean up formatting
                                                        displayText = displayText
                                                            .replace(/\s+/g, ' ')  // Fix multiple spaces
                                                            .replace(/\(\s*\)/g, '') // Remove empty parentheses
                                                            .replace(/\(PBUH\)\s*\(PBUH\)/g, ' (PBUH) ') // Fix duplicates
                                                            .replace(/\(RA\)\s*\(RA\)/g, ' (RA) ')
                                                            .replace(/\(AS\)\s*\(AS\)/g, ' (AS) ')
                                                            .trim();
                                                            
                                                        // Final check to ensure no Arabic characters remain
                                                        if (displayText.match(/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]+/)) {
                                                            console.log('Arabic characters still detected, applying final cleanup');
                                                            displayText = displayText.replace(/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]+/g, '');
                                                        }
                                                            
                                                        // Create button for the question
                                                        const button = document.createElement('button');
                                                        button.className = 'related-topic-tile';
                                                        button.textContent = displayText;
                                                        button.onclick = () => selectTopic(displayText);
                                                        topicsDiv.appendChild(button);
                                                        
                                                        // Store the topic in the global array with full text
                                                        // Make sure we don't add duplicates and the topic is complete
                                                        if (cleanQuestion && cleanQuestion.length > 0 && !window.relatedTopics.includes(cleanQuestion)) {
                                                            // Ensure honorifics are properly converted
                                                            let processedTopic = cleanQuestion
                                                                // Convert Unicode character for PBUH
                                                                .replace(/\ufdfa/g, ' (PBUH) ')
                                                                // Direct replacement of the PBUH symbol
                                                                .replace(/ﷺ/g, ' (PBUH) ')
                                                                // Arabic text for PBUH
                                                                .replace(/صلى الله عليه وسلم/g, ' (PBUH) ')
                                                                .replace(/صلى الله عنه/g, ' (PBUH) ')
                                                                // Arabic text for RA
                                                                .replace(/\u0631\u0636\u064a \u0627\u0644\u0644\u0647 \u0639\u0646\u0647|\u0631\u0636\u064a \u0627\u0644\u0644\u0647 \u0639\u0646\u0647\u0627/g, ' (RA) ')
                                                                .replace(/رضي الله عنه/g, ' (RA) ')
                                                                .replace(/رضي الله عنها/g, ' (RA) ')
                                                                // Arabic text for AS
                                                                .replace(/\u0639\u0644\u064a\u0647 \u0627\u0644\u0633\u0644\u0627\u0645/g, ' (AS) ')
                                                                .replace(/عليه السلام/g, ' (AS) ');
                                                                
                                                            // Remove any remaining Arabic characters
                                                            processedTopic = processedTopic.replace(/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]+/g, '');
                                                            
                                                            // Clean up formatting
                                                            processedTopic = processedTopic
                                                                .replace(/\s+/g, ' ')  // Fix multiple spaces
                                                                .replace(/\(\s*\)/g, '') // Remove empty parentheses
                                                                .replace(/\(PBUH\)\s*\(PBUH\)/g, ' (PBUH) ') // Fix duplicates
                                                                .replace(/\(RA\)\s*\(RA\)/g, ' (RA) ')
                                                                .replace(/\(AS\)\s*\(AS\)/g, ' (AS) ')
                                                                .trim();
                                                                
                                                            window.relatedTopics.push(processedTopic);
                                                            console.log('Added related topic:', processedTopic);
                                                        }
                                                    }
                                                    
                                                    // Keep any remaining partial question
                                                    const lastQuestionEnd = topicsDiv.currentTopic.lastIndexOf('?') + 1;
                                                    topicsDiv.currentTopic = topicsDiv.currentTopic.substring(lastQuestionEnd);
                                                }
                                            }
                                        } else {
                                            // Regular content
                                            if (!currentMessage) {
                                                currentMessage = document.createElement('div');
                                                currentMessage.className = 'message bot-message';
                                                
                                                // Create message content container
                                                const messageContent = document.createElement('div');
                                                messageContent.className = 'message-content';
                                                currentMessage.appendChild(messageContent);
                                                
                                                // Add bookmark button
                                                const messageActions = document.createElement('div');
                                                messageActions.className = 'message-actions';
                                                messageActions.innerHTML = `
                                                    <button class="bookmark-button" title="Save this response">
                                                        <i class="far fa-bookmark"></i>
                                                    </button>
                                                `;
                                                currentMessage.appendChild(messageActions);
                                            }
                                            const content = document.createElement('span');
                                            content.innerHTML = processMessageText(chunk);
                                            currentMessage.appendChild(content);
                                            // Accumulate raw response text
                                            currentMessage.rawResponse = (currentMessage.rawResponse || '') + chunk;
                                            // Keep same text for full response
                                            currentMessage.fullResponse = (currentMessage.fullResponse || '') + chunk;
                                            // Add to global complete response
                                            window.completeResponse += chunk;
                                            if (!currentMessage.parentNode) {
                                                chatMessages.appendChild(currentMessage);
                                            }
                                        }
                                    }
                                }
                                scrollToBottom();
                            }
                        } catch (e) {
                            console.error("Error parsing message:", e, message);
                        }
                    }
                }
            } catch (error) {
                console.error('Error in sendMessage:', error);
                appendErrorMessage("An error occurred. Please try again.");
            } finally {
                isGenerating = false;
                document.querySelector('.send-button').style.display = 'inline-flex';
                document.getElementById('stop-button').style.display = 'none';
                document.querySelector('.response-indicator').style.display = 'none';
                if (loadingInterval) {
                    clearInterval(loadingInterval);
                }

                // Create a complete response container with all accumulated text
                const completeResponseContainer = document.createElement('div');
                completeResponseContainer.className = 'message bot-message complete-response-container';
                completeResponseContainer.style.marginTop = '20px';
                completeResponseContainer.style.backgroundColor = '#f0f7f4';
                completeResponseContainer.style.border = '1px solid #c8e6d7';
                completeResponseContainer.style.borderRadius = '8px';
                completeResponseContainer.style.padding = '15px';
                completeResponseContainer.style.marginTop = '20px';
                completeResponseContainer.style.boxShadow = '0 2px 5px rgba(0,0,0,0.05)';
                
                // Store the complete response text from the global variable
                completeResponseContainer.fullResponse = window.completeResponse;
                
                // Add a small indicator that this is for sharing
                const shareIndicator = document.createElement('div');
                shareIndicator.style.fontSize = '0.9em';
                shareIndicator.style.color = '#1e6f5c';
                shareIndicator.style.marginBottom = '10px';
                shareIndicator.style.fontWeight = '500';
                shareIndicator.textContent = 'Found this helpful? Spread the knowledge!';
                completeResponseContainer.appendChild(shareIndicator);
                
                // Add share section to the complete response container
                const shareSection = document.createElement('div');
                shareSection.className = 'share-section';
                shareSection.innerHTML = `
                    <div class="share-text">Continue the conversation:</div>
                    <div class="share-buttons">
                        <button class="share-btn x-btn" onclick="shareToTwitter(this.closest('.complete-response-container'))" title="Share on X">
                            <span class="x-icon">𝕏</span>
                        </button>
                        <button class="share-btn" onclick="shareToWhatsApp(this.closest('.complete-response-container'))" title="Share on WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="share-btn" onclick="shareToReddit(this.closest('.complete-response-container'))" title="Share on Reddit">
                            <i class="fab fa-reddit"></i>
                        </button>
                        <button class="share-btn" onclick="copyToClipboard(this.closest('.complete-response-container'))" title="Copy to clipboard">
                            <i class="far fa-copy"></i>
                        </button>
                        <button class="share-btn" onclick="saveDirectResponse(this)" title="Save this response">
                            <i class="far fa-bookmark"></i>
                        </button>
                    </div>
                `;
                completeResponseContainer.appendChild(shareSection);
                chatMessages.appendChild(completeResponseContainer);
            }
        }

        function scrollToBottom() {
            const container = document.querySelector('.chat-container');
            const totalHeight = chatMessages.scrollHeight + 40; // 40px for padding
            const maxHeight = window.innerHeight - 300;
            
            // Set container height based on content
            container.style.minHeight = Math.min(totalHeight, maxHeight) + 'px';
            
            // Only scroll the chat messages container
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 10);
        }

        function appendErrorMessage(message) {
            const errorMessage = document.createElement('div');
            errorMessage.className = 'message error-message';
            errorMessage.textContent = message;
            chatMessages.appendChild(errorMessage);
            scrollToBottom();
        }

    </script>
    
    <!-- Prayer Times Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initSimplePrayerTimes();
        });
        
        function initSimplePrayerTimes() {
            // Add event listener to the header enable location button
            const headerEnableBtn = document.getElementById('header-enable-location-btn');
            if (headerEnableBtn) {
                headerEnableBtn.addEventListener('click', function() {
                    fetchPrayerTimesForHeader();
                    this.style.display = 'none';
                });
            }
            
            // Try to get prayer times automatically if geolocation is available
            if (navigator.geolocation) {
                fetchPrayerTimesForHeader();
                
                // Hide the enable location button if geolocation is available
                if (headerEnableBtn) headerEnableBtn.style.display = 'none';
            } else {
                document.getElementById('header-current-prayer').innerHTML = 
                    'Enable location to see prayer times';
                document.getElementById('header-next-prayer').innerHTML = '';
            }
        }
        
        async function fetchPrayerTimesForHeader() {
            const currentPrayerElement = document.getElementById('header-current-prayer');
            const nextPrayerElement = document.getElementById('header-next-prayer');
            const locationButton = document.getElementById('header-enable-location-btn');
            
            if (!currentPrayerElement || !nextPrayerElement) return;
            
            // Show loading state
            currentPrayerElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Getting prayer times...`;
            nextPrayerElement.innerHTML = '';
            
            // Hide the location button initially
            if (locationButton) locationButton.style.display = 'none';
            
            try {
                // Check if geolocation is supported
                if (!navigator.geolocation) {
                    throw new Error('Geolocation is not supported by your browser');
                }
                
                // Get user's position with a shorter timeout for mobile
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: false, // Less strict for mobile
                        timeout: 5000, // Shorter timeout
                        maximumAge: 60000 // Allow cached position for 1 minute
                    });
                });
                
                const { latitude, longitude } = position.coords;
                
                // Get city name from coordinates using reverse geocoding
                let locationName = "your location";
                try {
                    const geocodeResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                    const geocodeData = await geocodeResponse.json();
                    
                    if (geocodeData.address) {
                        const address = geocodeData.address;
                        locationName = address.city || address.town || address.village || address.county || "your location";
                    }
                } catch (error) {
                    console.error('Error getting location name:', error);
                }
                
                // Get prayer times from API
                const date = new Date();
                const formattedDate = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
                
                const response = await fetch(`https://api.aladhan.com/v1/timings/${formattedDate}?latitude=${latitude}&longitude=${longitude}&method=2`);
                const data = await response.json();
                
                if (data.code === 200 && data.data && data.data.timings) {
                    displayHeaderPrayerTimes(data.data.timings, locationName);
                } else {
                    throw new Error('Invalid response from prayer times API');
                }
                
            } catch (error) {
                console.error('Error getting prayer times:', error);
                
                // Show error message
                const currentPrayerElement = document.getElementById('header-current-prayer');
                const locationButton = document.getElementById('header-enable-location-btn');
                
                if (currentPrayerElement) {
                    // Different message based on error type
                    if (error.code === 1) { // Permission denied
                        currentPrayerElement.innerHTML = 
                            `<i class="fas fa-exclamation-circle"></i> Location permission denied`;
                    } else if (error.code === 2) { // Position unavailable
                        currentPrayerElement.innerHTML = 
                            `<i class="fas fa-exclamation-circle"></i> Location unavailable`;
                    } else if (error.code === 3) { // Timeout
                        currentPrayerElement.innerHTML = 
                            `<i class="fas fa-exclamation-circle"></i> Location request timed out`;
                    } else {
                        currentPrayerElement.innerHTML = 
                            `<i class="fas fa-exclamation-circle"></i> Could not get prayer times`;
                    }
                    
                    // Add retry link
                    currentPrayerElement.innerHTML += ` <a href="#" id="header-retry-prayer-times">Retry</a>`;
                    
                    // Add event listener to retry link
                    const retryLink = document.getElementById('header-retry-prayer-times');
                    if (retryLink) {
                        retryLink.addEventListener('click', function(e) {
                            e.preventDefault();
                            fetchPrayerTimesForHeader();
                        });
                    }
                }
                
                // Show the location button
                if (locationButton) {
                    locationButton.style.display = 'block';
                }
                
                const nextPrayerElement = document.getElementById('header-next-prayer');
                if (nextPrayerElement) {
                    nextPrayerElement.innerHTML = '';
                }
            }
        }
        
        function displayHeaderPrayerTimes(timings, locationName) {
            const currentPrayerElement = document.getElementById('header-current-prayer');
            const nextPrayerElement = document.getElementById('header-next-prayer');
            
            if (!currentPrayerElement || !nextPrayerElement) return;
            
            // Convert 24-hour format to 12-hour format
            function formatTime(time24) {
                const [hours, minutes] = time24.split(':');
                const period = hours >= 12 ? 'PM' : 'AM';
                const hours12 = hours % 12 || 12;
                return `${hours12}:${minutes} ${period}`;
            }
            
            // Get current time
            const now = new Date();
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            
            // Define prayer names and their order
            const prayers = [
                { name: 'Fajr', time: timings.Fajr },
                { name: 'Sunrise', time: timings.Sunrise },
                { name: 'Dhuhr', time: timings.Dhuhr },
                { name: 'Asr', time: timings.Asr },
                { name: 'Maghrib', time: timings.Maghrib },
                { name: 'Isha', time: timings.Isha }
            ];
            
            // Find the current prayer (the last one that has passed)
            let currentPrayer = null;
            let nextPrayer = null;
            
            // First, find the next prayer
            for (const prayer of prayers) {
                const [prayerHours, prayerMinutes] = prayer.time.split(':').map(Number);
                
                if (prayerHours > currentHours || 
                    (prayerHours === currentHours && prayerMinutes > currentMinutes)) {
                    nextPrayer = prayer;
                    break;
                }
                currentPrayer = prayer; // The last prayer that has passed
            }
            
            // If no next prayer found (all prayers for today have passed)
            if (!nextPrayer) {
                nextPrayer = prayers[0]; // Tomorrow's Fajr
                currentPrayer = prayers[prayers.length - 1]; // Last prayer of the day
            }
            
            // If we're before the first prayer of the day
            if (!currentPrayer) {
                currentPrayer = prayers[prayers.length - 1]; // Last prayer of yesterday
            }
            
            // Calculate time since current prayer
            let timeSinceCurrent = '';
            if (currentPrayer) {
                const [prayerHours, prayerMinutes] = currentPrayer.time.split(':').map(Number);
                
                // Calculate time elapsed
                let hoursElapsed = currentHours - prayerHours;
                let minutesElapsed = currentMinutes - prayerMinutes;
                
                if (minutesElapsed < 0) {
                    hoursElapsed--;
                    minutesElapsed += 60;
                }
                
                timeSinceCurrent = `${hoursElapsed}h ${minutesElapsed}m ago`;
                
                // If it's a very recent prayer (within 10 minutes), show 'just started'
                if (hoursElapsed === 0 && minutesElapsed < 10) {
                    timeSinceCurrent = 'just started';
                }
            }
            
            // Calculate time until next prayer
            let timeUntilNext = '';
            if (nextPrayer) {
                const [prayerHours, prayerMinutes] = nextPrayer.time.split(':').map(Number);
                
                // Calculate time remaining
                let hoursRemaining = prayerHours - currentHours;
                let minutesRemaining = prayerMinutes - currentMinutes;
                
                if (minutesRemaining < 0) {
                    hoursRemaining--;
                    minutesRemaining += 60;
                }
                
                if (nextPrayer === prayers[0] && currentPrayer === prayers[prayers.length - 1]) {
                    timeUntilNext = 'tomorrow';
                } else {
                    timeUntilNext = `in ${hoursRemaining}h ${minutesRemaining}m`;
                }
            }
            
            // Build the HTML for the current prayer status
            const currentPrayerHTML = `
                <span class="current-prayer-name">${currentPrayer.name}</span> 
                <span class="current-prayer-time">${formatTime(currentPrayer.time)}</span> 
                <span class="time-since">(${timeSinceCurrent})</span>
            `;
            
            // Build the HTML for the next prayer status
            const nextPrayerHTML = `
                <span class="next-prayer-name">Next: ${nextPrayer.name}</span> 
                <span class="next-prayer-time">${formatTime(nextPrayer.time)}</span> 
                <span class="time-until">(${timeUntilNext})</span> 
                <span class="location-info">for ${locationName}</span>
            `;
            
            // Update the content
            currentPrayerElement.innerHTML = currentPrayerHTML;
            nextPrayerElement.innerHTML = nextPrayerHTML;
            
            // Set up a timer to update the time remaining every minute
            setInterval(() => {
                updateHeaderPrayerTimes();
            }, 60000);
        }
        
        function updateHeaderPrayerTimes() {
            // Simply re-fetch the prayer times to update the display
            fetchPrayerTimesForHeader();
        }
        
        function updateTimeRemaining(contentId = 'prayer-times-content') {
            const container = document.getElementById(contentId);
            if (!container) return;
            
            const nextPrayer = container.querySelector('.prayer-time.next-prayer');
            if (!nextPrayer) return;
            
            const timeRemainingElement = nextPrayer.querySelector('.time-remaining');
            if (!timeRemainingElement || timeRemainingElement.textContent === 'Tomorrow') return;
            
            // Extract current remaining time
            const remainingText = timeRemainingElement.textContent;
            const match = remainingText.match(/(\d+)h (\d+)m/); 
            
            if (match) {
                let hours = parseInt(match[1]);
                let minutes = parseInt(match[2]) - 1;
                
                if (minutes < 0) {
                    hours--;
                    minutes = 59;
                }
                
                if (hours < 0) {
                    // Time has elapsed, need to recalculate next prayer
                    fetchDynamicPrayerTimes(contentId);
                    return;
                }
                
                timeRemainingElement.textContent = `${hours}h ${minutes}m remaining`;
            }
        }
    </script>
    
    <!-- Islamic Wisdom Collection Script -->
    <script>
        // Islamic Wisdom Collection
        const islamicWisdom = [
            // Hadith quotes
            {
                arabic: "خَيْرُ النَّاسِ أَنْفَعُهُمْ لِلنَّاسِ",
                english: "The best of people are those who are most beneficial to people.",
                source: "Hadith - Daraqutni"
            },
            {
                arabic: "إِنَّمَا الْأَعْمَالُ بِالنِّيَّاتِ",
                english: "Actions are judged by intentions.",
                source: "Sahih al-Bukhari 1"
            },
            {
                arabic: "الْمُسْلِمُ مَنْ سَلِمَ الْمُسْلِمُونَ مِنْ لِسَانِهِ وَيَدِهِ",
                english: "A Muslim is one from whose tongue and hand other Muslims are safe.",
                source: "Sahih al-Bukhari 10"
            },
            {
                arabic: "لَا يُؤْمِنُ أَحَدُكُمْ حَتَّى يُحِبَّ لِأَخِيهِ مَا يُحِبُّ لِنَفْسِهِ",
                english: "None of you truly believes until he loves for his brother what he loves for himself.",
                source: "Sahih al-Bukhari 13"
            },
            {
                arabic: "الدِّينُ النَّصِيحَةُ",
                english: "Religion is sincerity (sincere advice).",
                source: "Sahih Muslim 55"
            },
            {
                arabic: "طَلَبُ الْعِلْمِ فَرِيضَةٌ عَلَى كُلِّ مُسْلِمٍ",
                english: "Seeking knowledge is an obligation upon every Muslim.",
                source: "Sunan Ibn Majah 224"
            },
            {
                arabic: "الدُّنْيَا مَتَاعٌ وَخَيْرُ مَتَاعِهَا الْمَرْأَةُ الصَّالِحَةُ",
                english: "The world is a provision, and the best provision of the world is a righteous woman.",
                source: "Sahih Muslim 1467"
            },
            {
                arabic: "لاَ تَغْضَبْ",
                english: "Do not become angry.",
                source: "Sahih al-Bukhari 6116"
            },
            {
                arabic: "مَنْ كَانَ يُؤْمِنُ بِاللَّهِ وَالْيَوْمِ الآخِرِ فَلْيَقُلْ خَيْرًا أَوْ لِيَصْمُتْ، وَمَنْ كَانَ يُؤْمِنُ بِاللَّهِ وَالْيَوْمِ الآخِرِ فَلْيُكْرِمْ جَارَهُ، وَمَنْ كَانَ يُؤْمِنُ بِاللَّهِ وَالْيَوْمِ الآخِرِ فَلْيُكْرِمْ ضَيْفَهُ",
                english: "Whoever believes in Allah and the Last Day, let him speak good or remain silent. Whoever believes in Allah and the Last Day, let him honor his neighbor. Whoever believes in Allah and the Last Day, let him honor his guest.",
                source: "Sahih al-Bukhari 6018"
            },
            
            // Quran verses
            {
                arabic: "وَلَا تَقْفُ مَا لَيْسَ لَكَ بِهِ عِلْمٌ ۚ إِنَّ السَّمْعَ وَالْبَصَرَ وَالْفُؤَادَ كُلُّ أُولَٰئِكَ كَانَ عَنْهُ مَسْئُولًا",
                english: "And do not pursue that of which you have no knowledge. Indeed, the hearing, the sight and the heart - about all those [one] will be questioned.",
                source: "Quran 17:36"
            },
            {
                arabic: "إِنَّ اللَّهَ لَا يُغَيِّرُ مَا بِقَوْمٍ حَتَّىٰ يُغَيِّرُوا مَا بِأَنفُسِهِمْ",
                english: "Indeed, Allah will not change the condition of a people until they change what is in themselves.",
                source: "Quran 13:11"
            },
            {
                arabic: "وَإِن تَعُدُّوا نِعْمَةَ اللَّهِ لَا تُحْصُوهَا ۗ إِنَّ اللَّهَ لَغَفُورٌ رَّحِيمٌ",
                english: "And if you should count the favors of Allah, you could not enumerate them. Indeed, Allah is Forgiving and Merciful.",
                source: "Quran 16:18"
            },
            {
                arabic: "يَا أَيُّهَا الَّذِينَ آمَنُوا اتَّقُوا اللَّهَ وَكُونُوا مَعَ الصَّادِقِينَ",
                english: "O you who have believed, fear Allah and be with those who are true.",
                source: "Quran 9:119"
            },
            {
                arabic: "وَلَا تَهِنُوا وَلَا تَحْزَنُوا وَأَنتُمُ الْأَعْلَوْنَ إِن كُنتُم مُّؤْمِنِينَ",
                english: "So do not weaken and do not grieve, and you will be superior if you are [true] believers.",
                source: "Quran 3:139"
            },
            {
                arabic: "فَاصْبِرْ إِنَّ وَعْدَ اللَّهِ حَقٌّ ۖ وَاسْتَغْفِرْ لِذَنبِكَ وَسَبِّحْ بِحَمْدِ رَبِّكَ بِالْعَشِيِّ وَالْإِبْكَارِ",
                english: "So be patient. Indeed, the promise of Allah is truth. And ask forgiveness for your sin and exalt [Allah] with praise of your Lord in the evening and the morning.",
                source: "Quran 40:55"
            },
            {
                arabic: "إِنَّ مَعَ الْعُسْرِ يُسْرًا ۚ فَإِذَا فَرَغْتَ فَانصَبْ ۚ وَإِلَىٰ رَبِّكَ فَارْغَب",
                english: "Indeed, with hardship [will be] ease. So when you have finished [your duties], then stand up [for worship]. And to your Lord direct [your] longing.",
                source: "Quran 94:6-8"
            },
            {
                arabic: "يَا أَيُّهَا الَّذِينَ آمَنُوا اجْتَنِبُوا كَثِيرًا مِّنَ الظَّنِّ إِنَّ بَعْضَ الظَّنِّ إِثْمٌ ۖ وَلَا تَجَسَّسُوا وَلَا يَغْتَب بَّعْضُكُم بَعْضًا ۚ أَيُحِبُّ أَحَدُكُمْ أَن يَأْكُلَ لَحْمَ أَخِيهِ مَيْتًا فَكَرِهْتُمُوهُ ۚ وَاتَّقُوا اللَّهَ ۚ إِنَّ اللَّهَ تَوَّابٌ رَّحِيمٌ",
                english: "O you who have believed, avoid much [negative] assumption. Indeed, some assumption is sin. And do not spy or backbite each other. Would one of you like to eat the flesh of his brother when dead? You would detest it. And fear Allah; indeed, Allah is Accepting of repentance and Merciful.",
                source: "Quran 49:12"
            },
            {
                arabic: "مَنْ كَانَ يُؤْمِنُ بِاللَّهِ وَالْيَوْمِ الْآخِرِ فَلْيَقُلْ خَيْرًا أَوْ لِيَصْمُتْ",
                english: "Whoever believes in Allah and the Last Day, let him speak good or remain silent.",
                source: "Sahih al-Bukhari 6018"
            },
            {
                arabic: "الدُّنْيَا مَتَاعٌ وَخَيْرُ مَتَاعِهَا الْمَرْأَةُ الصَّالِحَةُ",
                english: "The world is a provision, and the best provision of the world is a righteous woman.",
                source: "Sahih Muslim 1467"
            },
            {
                arabic: "لَا تَغْضَبْ",
                english: "Do not become angry.",
                source: "Sahih al-Bukhari 6116"
            },
            {
                arabic: "الْكَلِمَةُ الطَّيِّبَةُ صَدَقَةٌ",
                english: "A kind word is charity.",
                source: "Sahih al-Bukhari 2989"
            },
            {
                arabic: "طَلَبُ الْعِلْمِ فَرِيضَةٌ عَلَى كُلِّ مُسْلِمٍ",
                english: "Seeking knowledge is an obligation upon every Muslim.",
                source: "Sunan Ibn Majah 224"
            },
            {
                arabic: "الدِّينُ النَّصِيحَةُ",
                english: "Religion is sincerity (sincere advice).",
                source: "Sahih Muslim 55"
            }
        ];
        
        // Function to display a random wisdom quote
        function displayRandomWisdom() {
            // Get a random wisdom quote that's different from the current one
            let currentArabic = document.querySelector('.wisdom-arabic').textContent;
            let randomIndex;
            let wisdom;
            
            // Make sure we get a different wisdom quote
            do {
                randomIndex = Math.floor(Math.random() * islamicWisdom.length);
                wisdom = islamicWisdom[randomIndex];
            } while (wisdom.arabic === currentArabic && islamicWisdom.length > 1);
            
            // Add a small animation effect
            const wisdomContent = document.getElementById('daily-wisdom');
            wisdomContent.style.opacity = '0';
            
            // Update the wisdom after a short delay for animation
            setTimeout(() => {
                // Update the wisdom text
                document.querySelector('.wisdom-arabic').textContent = wisdom.arabic;
                document.querySelector('.wisdom-english').textContent = wisdom.english;
                document.querySelector('.wisdom-source').textContent = wisdom.source;
                
                // Fade back in
                wisdomContent.style.opacity = '1';
                
                // Update share links
                updateSocialShareLinks(wisdom);
                
                // Log for debugging
                console.log('Displayed new wisdom:', wisdom.english.substring(0, 30) + '...');
            }, 300);
        }
        
        // Function to update social share links
        function updateSocialShareLinks(wisdom) {
            const twitterLink = document.getElementById('share-wisdom-twitter');
            const facebookLink = document.getElementById('share-wisdom-facebook');
            const instagramLink = document.getElementById('share-wisdom-instagram');
            const whatsappLink = document.getElementById('share-wisdom-whatsapp');
            
            const shareText = `"${wisdom.english}" - ${wisdom.source} | via @AskMoAnything`;
            const shareUrl = encodeURIComponent(window.location.href);
            
            // Update Twitter share link
            twitterLink.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${shareUrl}`;
            
            // Update Facebook share link
            facebookLink.href = `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}&quote=${encodeURIComponent(shareText)}`;
            
            // Update Instagram link
            // Note: Instagram doesn't have a direct web sharing API like Twitter
            // This will open Instagram app or website, but user will need to manually paste the content
            instagramLink.href = `https://www.instagram.com/`;
            instagramLink.setAttribute('target', '_blank');
            instagramLink.onclick = function() {
                // Copy text to clipboard for easier sharing
                navigator.clipboard.writeText(shareText + ' ' + window.location.href).then(() => {
                    alert('Wisdom copied to clipboard! Paste it in your Instagram post.');
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                });
                return true; // Continue with link navigation
            };
            
            // Update WhatsApp share link
            whatsappLink.href = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + window.location.href)}`;
        }
        
        // Function to get user's location and fetch prayer times
        // Function for Eid prayer information - no need to fetch prayer times
        function getPrayerTimes() {
            // No need to fetch prayer times for Eid
            // The prayer information is now static
            console.log('Eid Mubarak! No prayer times to fetch today.');
        }
        
        // Function to update Shawwal countdown timer
        function updateShawwalCountdown() {
            // Shawwal ends on April 28, 2025 (30 days after March 30)
            const shawwalEndDate = new Date('April 28, 2025 23:59:59').getTime();
            const now = new Date().getTime();
            const distance = shawwalEndDate - now;
            
            // Calculate days, hours, minutes
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            
            // Display the result
            const countdownElement = document.getElementById('shawwal-countdown');
            
            if (distance < 0) {
                countdownElement.innerHTML = 'Shawwal has ended';
            } else {
                countdownElement.innerHTML = `${days}d ${hours}h ${minutes}m remaining`;
            }
        }
        
        // Initialize prayer times and countdown on page load
        document.addEventListener('DOMContentLoaded', () => {
            getPrayerTimes();
            updateShawwalCountdown();
            // Update countdown every minute
            setInterval(updateShawwalCountdown, 60000);
            
            // Set up wisdom refresh button
            document.getElementById('refresh-wisdom-btn').addEventListener('click', displayRandomWisdom);
            // Display initial random wisdom
            displayRandomWisdom();
            
            // Initialize authentication UI
            initAuthUI();
        });
    </script>
    
    <!-- Authentication Script -->
    <script type="module">
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            sendPasswordResetEmail,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            serverTimestamp,
            collection,
            addDoc,
            query,
            where,
            orderBy,
            limit,
            getDocs
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        
        // DOM Elements
        let loginButton, signupButton, userProfile, userEmail, logoutButton;
        let loginModal, signupModal, resetPasswordModal;
        let loginEmail, loginPassword, signupEmail, signupPassword, signupConfirmPassword, resetEmail;
        let loginSubmit, signupSubmit, resetSubmit, googleSignin, googleSignup;
        let loginError, signupError, resetError, resetMessage;
        let switchToSignup, switchToLogin, forgotPassword, backToLogin;
        let closeButtons, mobileMenuButton, authContainer;
        
        // Initialize the auth UI
        function initAuthUI() {
            // Get DOM elements
            loginButton = document.getElementById('login-button');
            signupButton = document.getElementById('signup-button');
            userProfile = document.getElementById('user-profile');
            userEmail = document.getElementById('user-email');
            logoutButton = document.getElementById('logout-button');
            const profileButton = document.getElementById('profile-button');
            mobileMenuButton = document.querySelector('.mobile-menu-button');
            authContainer = document.getElementById('auth-container');
            
            // Ensure auth container is hidden by default on mobile
            if (authContainer && window.innerWidth <= 768) {
                authContainer.style.display = 'none';
            } else if (authContainer && window.innerWidth > 768) {
                // On desktop, we want it visible
                authContainer.style.display = 'flex';
            }
            
            loginModal = document.getElementById('login-modal');
            signupModal = document.getElementById('signup-modal');
            resetPasswordModal = document.getElementById('reset-password-modal');
            profileModal = document.getElementById('profile-modal'); // Changed from const to global variable
            
            loginEmail = document.getElementById('login-email');
            loginPassword = document.getElementById('login-password');
            signupEmail = document.getElementById('signup-email');
            signupPassword = document.getElementById('signup-password');
            signupConfirmPassword = document.getElementById('signup-confirm-password');
            resetEmail = document.getElementById('reset-email');
            
            loginSubmit = document.getElementById('login-submit');
            signupSubmit = document.getElementById('signup-submit');
            resetSubmit = document.getElementById('reset-submit');
            googleSignin = document.getElementById('google-signin');
            googleSignup = document.getElementById('google-signup');
            
            loginError = document.getElementById('login-error');
            signupError = document.getElementById('signup-error');
            resetError = document.getElementById('reset-error');
            resetMessage = document.getElementById('reset-message');
            
            switchToSignup = document.getElementById('switch-to-signup');
            switchToLogin = document.getElementById('switch-to-login');
            forgotPassword = document.getElementById('forgot-password');
            backToLogin = document.getElementById('back-to-login');
            
            closeButtons = document.querySelectorAll('.close-modal');
            
            // Remove any existing handlers first to avoid duplicates
            if (loginButton) loginButton.onclick = null;
            if (signupButton) signupButton.onclick = null;
            
            // Add direct event handlers with robust error handling
            if (loginButton && loginModal) {
                loginButton.onclick = function(e) {
                    try {
                        e.preventDefault();
                        e.stopPropagation(); // Prevent event bubbling
                        loginModal.style.display = 'block';
                        console.log('Login modal displayed directly');
                        // Clear any previous errors
                        const loginError = document.getElementById('login-error');
                        if (loginError) loginError.textContent = '';
                    } catch (error) {
                        console.error('Error showing login modal:', error);
                    }
                    return false;
                };
                console.log('Login button handler attached in initAuthUI');
            }
            
            if (signupButton && signupModal) {
                signupButton.onclick = function(e) {
                    try {
                        e.preventDefault();
                        e.stopPropagation(); // Prevent event bubbling
                        signupModal.style.display = 'block';
                        console.log('Signup modal displayed directly');
                        // Clear any previous errors
                        const signupError = document.getElementById('signup-error');
                        if (signupError) signupError.textContent = '';
                    } catch (error) {
                        console.error('Error showing signup modal:', error);
                    }
                    return false;
                };
                console.log('Signup button handler attached in initAuthUI');
            }
            
            if (logoutButton) {
                logoutButton.onclick = function(e) {
                    e.preventDefault();
                    handleLogout();
                };
            }
            
            if (profileButton && profileModal) {
                profileButton.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation(); // Prevent event bubbling
                    
                    // Make sure the profile modal is visible
                    profileModal.style.display = 'block';
                    
                    // Load the user profile data
                    const auth = getAuth();
                    const user = auth.currentUser;
                    if (user) {
                        // Update user display name in the modal
                        const modalUserName = document.getElementById('profile-user-name');
                        if (modalUserName) {
                            modalUserName.textContent = user.displayName || user.email || 'User';
                        }
                        
                        // Load the user profile data
                        loadUserProfile();
                    }
                    
                    console.log('Profile modal displayed directly');
                    return false;
                };
            }
            
            // Use direct onclick handlers for form submissions
            if (loginSubmit) {
                loginSubmit.onclick = function(e) {
                    e.preventDefault();
                    const email = loginEmail?.value?.trim() || '';
                    const password = loginPassword?.value || '';
                    
                    if (!email || !password) {
                        if (loginError) loginError.textContent = 'Please enter both email and password';
                        return;
                    }
                    
                    const auth = getAuth();
                    signInWithEmailAndPassword(auth, email, password)
                        .then((userCredential) => {
                            // Hide the login modal
                            if (loginModal) loginModal.style.display = 'none';
                            if (loginEmail) loginEmail.value = '';
                            if (loginPassword) loginPassword.value = '';
                            console.log('Login successful');
                            
                            // Manually update UI elements to show authenticated state
                            const user = userCredential.user;
                            document.querySelectorAll('.authenticated').forEach(el => {
                                if (el) el.style.display = 'block';
                            });
                            document.querySelectorAll('.unauthenticated').forEach(el => {
                                if (el) el.style.display = 'none';
                            });
                            
                            // Update user display name
                            const userDisplayName = document.getElementById('user-display-name');
                            if (userDisplayName) {
                                userDisplayName.textContent = user.displayName || user.email || 'User';
                            }
                            
                            // Check if we need to show premium options after login
                            const premiumAfterLogin = safeGetItem('premium_after_login');
                            if (premiumAfterLogin === 'true') {
                                // Clear the flag
                                safeSetItem('premium_after_login', '');
                                // Show premium options with a slight delay
                                setTimeout(() => {
                                    try {
                                        showPremiumOptions(user);
                                    } catch (err) {
                                        console.error('Error showing premium options after login:', err);
                                    }
                                }, 500);
                            }
                        })
                        .catch((error) => {
                            console.error('Login error:', error);
                            if (loginError) {
                                if (error.code === 'auth/invalid-credential') {
                                    loginError.textContent = 'Invalid email or password';
                                } else {
                                    loginError.textContent = error.message;
                                }
                            }
                        });
                };
            }
            
            if (signupSubmit) {
                signupSubmit.onclick = function(e) {
                    e.preventDefault();
                    const email = signupEmail?.value?.trim() || '';
                    const password = signupPassword?.value || '';
                    const confirmPassword = signupConfirmPassword?.value || '';
                    
                    if (!email || !password || !confirmPassword) {
                        if (signupError) signupError.textContent = 'Please fill in all fields';
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        if (signupError) signupError.textContent = 'Passwords do not match';
                        return;
                    }
                    
                    if (password.length < 6) {
                        if (signupError) signupError.textContent = 'Password must be at least 6 characters';
                        return;
                    }
                    
                    const auth = getAuth();
                    const db = getFirestore();
                    
                    createUserWithEmailAndPassword(auth, email, password)
                        .then((userCredential) => {
                            return setDoc(doc(db, 'users', userCredential.user.uid), {
                                email: email,
                                createdAt: serverTimestamp(),
                                subscription: {
                                    type: 'free',
                                    questionsRemaining: 7
                                }
                            });
                        })
                        .then(() => {
                            if (signupModal) signupModal.style.display = 'none';
                            if (signupEmail) signupEmail.value = '';
                            if (signupPassword) signupPassword.value = '';
                            if (signupConfirmPassword) signupConfirmPassword.value = '';
                            console.log('Signup successful');
                        })
                        .catch((error) => {
                            console.error('Signup error:', error);
                            if (signupError) signupError.textContent = error.message;
                        });
                };
            }
            
            if (resetSubmit) {
                resetSubmit.onclick = function(e) {
                    e.preventDefault();
                    handlePasswordReset();
                };
            }
            
            if (googleSignin) {
                googleSignin.onclick = function(e) {
                    e.preventDefault();
                    handleGoogleAuth(true);
                };
            }
            
            if (googleSignup) {
                googleSignup.onclick = function(e) {
                    e.preventDefault();
                    handleGoogleAuth(false);
                };
            }
            
            // Use direct onclick handlers for modal switching
            if (switchToSignup) {
                switchToSignup.onclick = function(e) {
                    e.preventDefault();
                    if (loginModal) loginModal.style.display = 'none';
                    if (signupModal) signupModal.style.display = 'block';
                };
            }
            
            if (switchToLogin) {
                switchToLogin.onclick = function(e) {
                    e.preventDefault();
                    if (signupModal) signupModal.style.display = 'none';
                    if (loginModal) loginModal.style.display = 'block';
                };
            }
            
            if (forgotPassword) {
                forgotPassword.onclick = function(e) {
                    e.preventDefault();
                    if (loginModal) loginModal.style.display = 'none';
                    if (resetPasswordModal) resetPasswordModal.style.display = 'block';
                };
            }
            
            if (backToLogin) {
                backToLogin.onclick = function(e) {
                    e.preventDefault();
                    if (resetPasswordModal) resetPasswordModal.style.display = 'none';
                    if (loginModal) loginModal.style.display = 'block';
                };
            }
            
            // Use direct onclick handlers for close buttons
            document.querySelectorAll('.close-modal').forEach(button => {
                button.onclick = function() {
                    const modal = this.closest('.auth-modal');
                    if (modal) {
                        modal.style.display = 'none';
                        console.log('Modal closed via close button:', modal.id);
                    } else {
                        // Fallback to hiding all modals directly
                        if (loginModal) loginModal.style.display = 'none';
                        if (signupModal) signupModal.style.display = 'none';
                        if (resetPasswordModal) resetPasswordModal.style.display = 'none';
                        if (profileModal) profileModal.style.display = 'none';
                        console.log('All modals closed via close button');
                    }
                };
            });
            
            // Close modal when clicking outside using direct onclick
            window.onclick = function(event) {
                if (event.target === loginModal) loginModal.style.display = 'none';
                if (event.target === signupModal) signupModal.style.display = 'none';
                if (event.target === resetPasswordModal) resetPasswordModal.style.display = 'none';
                if (event.target === profileModal) profileModal.style.display = 'none';
            };
            
            // Premium signup button in empowering section with improved error handling
            const premiumSignupButton = document.getElementById('empowering-signup-button');
            if (premiumSignupButton) {
                premiumSignupButton.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation(); // Prevent event bubbling
                    console.log('Premium signup button clicked directly');
                    
                    try {
                        // Load the Stripe Buy Button script if needed
                        if (typeof loadBuyButton === 'function') {
                            loadBuyButton();
                        }
                        
                        const auth = getAuth();
                        const user = auth.currentUser;
                        
                        if (user) {
                            // User is signed in, show profile modal with subscription options
                            const profileModal = document.getElementById('profile-modal');
                            if (profileModal) {
                                try {
                                    profileModal.style.display = 'block';
                                    loadUserProfile();
                                    console.log('Profile modal displayed for premium user');
                                    
                                    // Mark that user clicked premium signup
                                    safeSetItem('premium_signup_clicked', 'true');
                                } catch (modalError) {
                                    console.error('Error displaying profile modal:', modalError);
                                }
                            } else {
                                console.error('Profile modal not found');
                            }
                        } else {
                            // User is not signed in, show signup modal with premium message
                            if (signupModal) {
                                try {
                                    signupModal.style.display = 'block';
                                    console.log('Signup modal displayed for premium signup');
                                    
                                    // Mark that user clicked premium signup
                                    safeSetItem('premium_signup_intent', 'true');
                                    
                                    // Add a note that they're signing up for premium
                                    const premiumMessage = document.createElement('div');
                                    premiumMessage.className = 'auth-message premium-message';
                                    premiumMessage.textContent = 'Complete signup to access premium subscription options';
                                    
                                    const signupForm = document.querySelector('#signup-modal .auth-form');
                                    // Only add the message if it doesn't already exist
                                    if (signupForm && !signupForm.querySelector('.premium-message')) {
                                        const errorElement = signupForm.querySelector('#signup-error');
                                        if (errorElement) {
                                            signupForm.insertBefore(premiumMessage, errorElement);
                                        } else {
                                            signupForm.appendChild(premiumMessage);
                                        }
                                    }
                                } catch (modalError) {
                                    console.error('Error displaying signup modal:', modalError);
                                }
                            } else {
                                console.error('Signup modal not found');
                            }
                        }
                    } catch (error) {
                        console.error('Error handling premium signup:', error);
                    }
                    
                    return false; // Prevent default and stop propagation
                };
                console.log('Premium signup button handler attached');
            }
            
            // API Key Management
            const apiKeyInput = document.getElementById('api-key-input');
            const toggleApiKeyButton = document.getElementById('toggle-api-key');
            const saveApiKeyButton = document.getElementById('save-api-key');
            const upgradeButton = document.getElementById('upgrade-button');
            
            // Load saved API key if exists - with iframe protection
            if (apiKeyInput) {
                const savedApiKey = safeGetItem('openai_api_key');
                if (savedApiKey) {
                    apiKeyInput.value = savedApiKey;
                }
            }
            
            // Toggle API key visibility - using direct onclick handler
            if (toggleApiKeyButton && apiKeyInput) {
                toggleApiKeyButton.onclick = function(e) {
                    e.preventDefault();
                    try {
                        if (apiKeyInput.type === 'password') {
                            apiKeyInput.type = 'text';
                            toggleApiKeyButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
                        } else {
                            apiKeyInput.type = 'password';
                            toggleApiKeyButton.innerHTML = '<i class="fas fa-eye"></i>';
                        }
                    } catch (error) {
                        console.error('Error toggling API key visibility:', error);
                    }
                };
            }
            
            // Save API key - using direct onclick handler
            if (saveApiKeyButton && apiKeyInput) {
                saveApiKeyButton.onclick = function(e) {
                    e.preventDefault();
                    try {
                        const apiKey = apiKeyInput.value.trim();
                        const profileMessage = document.getElementById('profile-message');
                        
                        if (apiKey) {
                            // Use our safe storage function
                            const saved = safeSetItem('openai_api_key', apiKey);
                            if (profileMessage) {
                                if (saved) {
                                    profileMessage.textContent = 'API key saved successfully!';
                                    profileMessage.style.color = 'green';
                                } else {
                                    profileMessage.textContent = 'Could not save API key (storage access error)';
                                    profileMessage.style.color = 'red';
                                }
                            }
                        } else {
                            try {
                                // Try to remove the item safely
                                if (!isInIframe()) {
                                    localStorage.removeItem('openai_api_key');
                                }
                                if (profileMessage) {
                                    profileMessage.textContent = 'API key removed.';
                                    profileMessage.style.color = 'orange';
                                }
                            } catch (error) {
                                console.error('Error removing API key:', error);
                                if (profileMessage) {
                                    profileMessage.textContent = 'Could not remove API key (storage access error)';
                                    profileMessage.style.color = 'red';
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error saving API key:', error);
                    }
                };
            }
            
            // Handle premium upgrade with iframe protection - using direct onclick handler
            if (upgradeButton) {
                upgradeButton.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation(); // Prevent event bubbling
                    console.log('Premium upgrade button clicked');
                    
                    // Load the Stripe Buy Button script if needed
                    if (typeof loadBuyButton === 'function') {
                        loadBuyButton();
                    }
                    
                    // Wait a moment for the script to load
                    setTimeout(() => {
                        handlePremiumUpgrade();
                    }, 500);
                    
                    return false;
                };
                console.log('Premium upgrade button handler attached');
            }
            
            // Simple mobile menu toggle - using direct onclick handler
            if (mobileMenuButton && authContainer) {
                mobileMenuButton.onclick = function(e) {
                    e.preventDefault();
                    try {
                        // Simple toggle
                        if (window.getComputedStyle(authContainer).display === 'flex') {
                            authContainer.style.display = 'none';
                            const icon = this.querySelector('i');
                            if (icon) icon.className = 'fas fa-bars';
                        } else {
                            authContainer.style.display = 'flex';
                            const icon = this.querySelector('i');
                            if (icon) icon.className = 'fas fa-times';
                        }
                    } catch (error) {
                        console.error('Error toggling mobile menu:', error);
                    }
                };
                
                // Close when clicking outside - only on mobile - using direct event handler
                document.onclick = function(e) {
                    try {
                        // Only apply this behavior on mobile screens
                        if (window.innerWidth <= 768) {
                            if (e.target !== mobileMenuButton && authContainer && !authContainer.contains(e.target) && 
                                window.getComputedStyle(authContainer).display === 'flex') {
                                authContainer.style.display = 'none';
                                const icon = mobileMenuButton.querySelector('i');
                                if (icon) icon.className = 'fas fa-bars';
                            }
                        }
                    } catch (error) {
                        console.error('Error handling document click for mobile menu:', error);
                    }
                };
                
                // Prevent closing when clicking inside menu - using direct onclick handler
                if (authContainer) {
                    authContainer.onclick = function(e) {
                        e.stopPropagation();
                    };
                }
            }
            
            // Auth toggle button functionality is now in initAuthUI
            
            // Listen for auth state changes
            // Make sure we're using the Firebase auth instance properly
            try {
                const auth = getAuth();
                if (auth) {
                    // Use a more robust auth state change handler
                    onAuthStateChanged(auth, function(user) {
                        console.log('Auth state changed:', user ? 'User logged in' : 'User logged out');
                        try {
                            // Update UI based on authentication state
                            if (user) {
                                // User is signed in
                                document.querySelectorAll('.authenticated').forEach(el => {
                                    if (el) el.style.display = 'block';
                                });
                                document.querySelectorAll('.unauthenticated').forEach(el => {
                                    if (el) el.style.display = 'none';
                                });
                                
                                // Explicitly update critical UI elements
                                const userProfile = document.getElementById('user-profile');
                                if (userProfile) {
                                    userProfile.style.display = 'flex';
                                }
                                
                                const loginButton = document.getElementById('login-button');
                                if (loginButton) {
                                    loginButton.style.display = 'none';
                                }
                                
                                const signupButton = document.getElementById('signup-button');
                                if (signupButton) {
                                    signupButton.style.display = 'none';
                                }
                                
                                // Update user display
                                const userDisplayName = document.getElementById('user-display-name');
                                if (userDisplayName) {
                                    userDisplayName.textContent = user.displayName || user.email || 'User';
                                }
                                
                                // Check if we need to show premium options after login
                                const premiumAfterLogin = safeGetItem('premium_after_login');
                                if (premiumAfterLogin === 'true') {
                                    // Clear the flag
                                    safeSetItem('premium_after_login', '');
                                    // Show premium options with a slight delay
                                    setTimeout(() => {
                                        try {
                                            showPremiumOptions(user);
                                        } catch (err) {
                                            console.error('Error showing premium options after login:', err);
                                        }
                                    }, 500);
                                }
                                
                                // Check if we need to verify a pending payment
                                const pendingUser = safeGetItem('pending_premium_user');
                                if (pendingUser === user.uid) {
                                    // Check if we have a payment verification from Stripe
                                    if (window.location.hash.includes('succeeded')) {
                                        console.log('Payment succeeded, verifying from URL hash...');
                                        setTimeout(() => {
                                            try {
                                                verifyPremiumPayment();
                                            } catch (err) {
                                                console.error('Error verifying payment after redirect:', err);
                                            }
                                        }, 1000);
                                    }
                                }
                                
                                // Load user profile data
                                loadUserProfile();
                            } else {
                                // User is signed out
                                document.querySelectorAll('.authenticated').forEach(el => {
                                    if (el) el.style.display = 'none';
                                });
                                document.querySelectorAll('.unauthenticated').forEach(el => {
                                    if (el) el.style.display = 'block';
                                });
                                
                                // Explicitly update critical UI elements
                                const userProfile = document.getElementById('user-profile');
                                if (userProfile) {
                                    userProfile.style.display = 'none';
                                }
                                
                                const loginButton = document.getElementById('login-button');
                                if (loginButton) {
                                    loginButton.style.display = 'block';
                                }
                                
                                const signupButton = document.getElementById('signup-button');
                                if (signupButton) {
                                    signupButton.style.display = 'block';
                                }
                            }
                        } catch (uiError) {
                            console.error('Error updating UI after auth state change:', uiError);
                        }
                    });
                    console.log('Robust auth state change listener initialized');
                } else {
                    console.error('Firebase auth not initialized properly');
                }
            } catch (error) {
                console.error('Error initializing auth state listener:', error);
            }
        }
        
        // Authentication functions
        async function handleLogin(event) {
            if (event) event.preventDefault();
            
            // Get elements directly to avoid potential reference issues
            const loginEmailInput = document.getElementById('login-email');
            const loginPasswordInput = document.getElementById('login-password');
            const loginErrorElement = document.getElementById('login-error');
            const loginModalElement = document.getElementById('login-modal');
            
            if (!loginEmailInput || !loginPasswordInput) {
                console.error('Login form elements not found');
                return;
            }
            
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            
            if (!email || !password) {
                showError(loginErrorElement, 'Please enter both email and password');
                return;
            }
            
            try {
                const auth = getAuth();
                console.log('Attempting login for:', email);
                await signInWithEmailAndPassword(auth, email, password);
                console.log('Login successful');
                hideModal(loginModalElement);
                clearInputs();
            } catch (error) {
                console.error('Login error:', error);
                handleAuthError(error, loginErrorElement);
            }
        }
        
        async function handleSignup(event) {
            if (event) event.preventDefault();
            
            // Get elements directly to avoid potential reference issues
            const signupEmailInput = document.getElementById('signup-email');
            const signupPasswordInput = document.getElementById('signup-password');
            const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
            const signupErrorElement = document.getElementById('signup-error');
            const signupModalElement = document.getElementById('signup-modal');
            
            if (!signupEmailInput || !signupPasswordInput || !signupConfirmPasswordInput) {
                console.error('Signup form elements not found');
                return;
            }
            
            const email = signupEmailInput.value.trim();
            const password = signupPasswordInput.value;
            const confirmPassword = signupConfirmPasswordInput.value;
            
            if (!email || !password || !confirmPassword) {
                showError(signupErrorElement, 'Please fill in all fields');
                return;
            }
            
            if (password !== confirmPassword) {
                showError(signupErrorElement, 'Passwords do not match');
                return;
            }
            
            if (password.length < 6) {
                showError(signupErrorElement, 'Password must be at least 6 characters');
                return;
            }
            
            try {
                const auth = getAuth();
                const db = getFirestore();
                console.log('Attempting signup for:', email);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log('Signup successful, creating user profile');
                await createUserProfile(userCredential.user, db);
                hideModal(signupModalElement);
                clearInputs();
            } catch (error) {
                console.error('Signup error:', error);
                handleAuthError(error, signupErrorElement);
            }
        }
        
        async function handleGoogleAuth(isSignIn) {
            try {
                const auth = getAuth();
                const db = getFirestore();
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Check if this is a new user
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists()) {
                    await createUserProfile(user, db);
                }
                
                hideModal(loginModal);
                hideModal(signupModal);
            } catch (error) {
                handleAuthError(error, isSignIn ? loginError : signupError);
            }
        }
        
        async function handleLogout() {
            try {
                const auth = getAuth();
                await signOut(auth);
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }
        
        async function handlePasswordReset(event) {
            event.preventDefault();
            
            const email = resetEmail.value.trim();
            
            if (!email) {
                showError(resetError, 'Please enter your email address');
                return;
            }
            
            try {
                const auth = getAuth();
                await sendPasswordResetEmail(auth, email);
                resetMessage.textContent = 'Password reset email sent! Check your inbox.';
                resetMessage.style.color = 'green';
                resetError.textContent = '';
            } catch (error) {
                handleAuthError(error, resetError);
                resetMessage.textContent = '';
            }
        }
        
        async function createUserProfile(user, db) {
            try {
                await setDoc(doc(db, 'users', user.uid), {
                    email: user.email,
                    createdAt: serverTimestamp(),
                    questionCount: 0,
                    lastQuestionDate: null,
                    subscription: {
                        type: 'free',
                        expiresAt: null
                    }
                });
            } catch (error) {
                console.error('Error creating user profile:', error);
            }
        }
        
        async function handleAuthStateChange(user) {
            if (user) {
                // User is signed in
                loginButton.style.display = 'none';
                signupButton.style.display = 'none';
                userProfile.style.display = 'flex';
                
                // Check if user has premium subscription
                try {
                    const db = getFirestore();
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.subscription && userData.subscription.type === 'premium') {
                            // User has premium subscription
                            console.log('User has premium subscription');
                            // Add premium badge to user email
                            if (!document.getElementById('premium-badge')) {
                                const premiumBadge = document.createElement('span');
                                premiumBadge.id = 'premium-badge';
                                premiumBadge.className = 'premium-badge';
                                premiumBadge.textContent = 'PREMIUM';
                                userEmail.appendChild(document.createTextNode(' '));
                                userEmail.appendChild(premiumBadge);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking subscription:', error);
                }
            } else {
                // User is signed out
                loginButton.style.display = 'block';
                signupButton.style.display = 'block';
                userProfile.style.display = 'none';
            }
        }
        
        // Function to handle profile tab switching
        function initProfileTabs() {
            const tabButtons = document.querySelectorAll('.profile-tab-btn');
            const tabContents = document.querySelectorAll('.profile-tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to current button and content
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    // If this is the saved responses or chat history tab, load the data
                    if (tabId === 'saved-responses-tab') {
                        loadSavedResponses();
                    } else if (tabId === 'chat-history-tab') {
                        loadChatHistory();
                    }
                });
            });
        }
        
        // Function to load saved responses
        async function loadSavedResponses() {
            console.log('Loading saved responses...');
            const auth = getAuth();
            const user = auth.currentUser;
            
            if (!user) {
                console.log('No user logged in');
                return;
            }
            
            console.log('User ID:', user.uid);
            
            const savedResponsesList = document.getElementById('saved-responses-list');
            if (!savedResponsesList) {
                console.error('savedResponsesList element not found');
                return;
            }
            
            const savedResponsesOverlay = document.getElementById('saved-responses-premium-overlay');
            
            // Check if user is premium
            const isPremium = await checkUserIsPremium(user.uid);
            console.log('User is premium:', isPremium);
            
            // For free users, we'll still show their most recent responses up to the limit
            let limitQuery = false;
            let freeUserResponseCount = 0;
            
            // Initially hide the premium overlay for everyone
            if (savedResponsesOverlay) {
                savedResponsesOverlay.style.display = 'none';
            }
            
            // If not premium, we'll limit the query
            if (!isPremium) {
                try {
                    // Check how many saved responses they have
                    const db = getFirestore();
                    const savedResponsesRef = collection(db, 'savedResponses');
                    const q = query(savedResponsesRef, where('userId', '==', user.uid));
                    const querySnapshot = await getDocs(q);
                    
                    freeUserResponseCount = querySnapshot.size;
                    console.log(`Free user has ${freeUserResponseCount} saved responses`);
                    
                    // Always limit the query for free users
                    limitQuery = true;
                    
                    // Set up upgrade button for when they need more
                    const upgradeButton = document.getElementById('saved-responses-upgrade');
                    if (upgradeButton) {
                        upgradeButton.onclick = function() {
                            // Close profile modal first
                            const profileModal = document.getElementById('profile-modal');
                            if (profileModal) profileModal.style.display = 'none';
                            
                            // Show premium options with slight delay
                            setTimeout(() => {
                                handlePremiumUpgrade();
                            }, 100);
                        };
                    }
                } catch (error) {
                    console.error('Error checking saved responses count:', error);
                }
            }
            
            // User is premium, load saved responses
            try {
                console.log('Starting Firestore query for saved responses');
                const db = getFirestore();
                const savedResponsesRef = collection(db, 'savedResponses');
                
                // Log the collection path
                console.log('Collection path:', savedResponsesRef.path);
                
                // Create a query - for free users, limit to FREE_USER_SAVE_LIMIT items
                let q;
                if (limitQuery) {
                    q = query(
                        savedResponsesRef,
                        where('userId', '==', user.uid),
                        orderBy('timestamp', 'desc'),
                        limit(FREE_USER_SAVE_LIMIT) // Limit to 3 most recent items for free users
                    );
                    console.log(`Limited saved responses query to ${FREE_USER_SAVE_LIMIT} items for free user`);
                } else {
                    q = query(
                        savedResponsesRef,
                        where('userId', '==', user.uid),
                        orderBy('timestamp', 'desc')
                    );
                    console.log('No limit for premium user');
                }
                
                console.log('Executing query...');
                const querySnapshot = await getDocs(q);
                console.log('Query complete. Empty?', querySnapshot.empty);
                console.log('Number of documents:', querySnapshot.size);
                
                // Clear previous content
                if (savedResponsesList) {
                    savedResponsesList.innerHTML = '';
                    
                    // For free users, add a message about the limit
                    if (limitQuery && freeUserResponseCount > FREE_USER_SAVE_LIMIT) {
                        const limitMessage = document.createElement('div');
                        limitMessage.className = 'limit-message';
                        limitMessage.innerHTML = `
                            <p><i class="fas fa-info-circle"></i> Showing your ${FREE_USER_SAVE_LIMIT} most recent saved responses. 
                            <a href="#" id="saved-responses-upgrade-link">Upgrade to premium</a> for all ${freeUserResponseCount} responses.</p>
                        `;
                        savedResponsesList.appendChild(limitMessage);
                        
                        // Add event listener to the upgrade link
                        setTimeout(() => {
                            const upgradeLink = document.getElementById('saved-responses-upgrade-link');
                            if (upgradeLink) {
                                upgradeLink.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    // Close profile modal
                                    const profileModal = document.getElementById('profile-modal');
                                    if (profileModal) profileModal.style.display = 'none';
                                    // Show premium options
                                    setTimeout(() => handlePremiumUpgrade(), 100);
                                });
                            }
                        }, 100);
                    }
                }
                
                if (querySnapshot.empty) {
                    console.log('No saved responses found');
                    // Show empty state
                    savedResponsesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-bookmark empty-icon"></i>
                            <p>No saved responses yet</p>
                            <p class="empty-description">When you find a helpful response, click the bookmark icon to save it here.</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('Found saved responses, processing...');
                
                // Limit to the 5 most recent saved responses
                const savedResponseItems = [];
                querySnapshot.forEach((doc) => {
                    savedResponseItems.push({
                        id: doc.id,
                        data: doc.data()
                    });
                });
                
                // Sort by timestamp (newest first) and take only the 5 most recent
                savedResponseItems.sort((a, b) => {
                    const timestampA = a.data.timestamp || 0;
                    const timestampB = b.data.timestamp || 0;
                    return timestampB - timestampA;
                });
                
                const recentSavedResponses = savedResponseItems.slice(0, 5);
                console.log(`Displaying ${recentSavedResponses.length} most recent saved responses`);
                
                // Display saved responses
                recentSavedResponses.forEach((item) => {
                    const docId = item.id;
                    const data = item.data;
                    
                    // Debug log to see what's in the data
                    console.log('Saved response data:', data);
                    console.log('Content type:', typeof data.content);
                    
                    // Handle Firestore special object format
                    // This is critical - Firestore sometimes returns data in a special format
                    // where the actual value is nested inside an object with type-specific properties
                    if (data.content && typeof data.content === 'object') {
                        // Check if this is a Firestore special object format
                        const specialKeys = ['stringValue', 'integerValue', 'doubleValue', 'booleanValue', 'arrayValue', 'mapValue', 'timestampValue', 'geoPointValue', 'bytesValue', 'referenceValue', 'nullValue'];
                        const hasSpecialKey = specialKeys.some(key => key in data.content);
                        
                        if (hasSpecialKey) {
                            console.log('Detected Firestore special object format');
                            // Extract the actual value based on its type
                            if ('stringValue' in data.content) {
                                data.content = data.content.stringValue;
                                console.log('Extracted stringValue:', data.content);
                            } else if ('mapValue' in data.content && data.content.mapValue.fields) {
                                data.content = data.content.mapValue.fields;
                                console.log('Extracted mapValue fields');
                            }
                            // Add more type conversions as needed
                        } else {
                            console.log('Regular object with keys:', Object.keys(data.content));
                            for (const key in data.content) {
                                console.log(`Content.${key}:`, data.content[key]);
                            }
                        }
                    }
                    
                    // Handle content with fallbacks
                    let contentText = 'No content available';
                    try {
                        // Check for answer property first (used in this app)
                        if (data.answer) {
                            // If answer is a string, use it directly
                            if (typeof data.answer === 'string') {
                                contentText = data.answer;
                                console.log('Using answer property as content');
                            } 
                            // If answer is an object with special format
                            else if (typeof data.answer === 'object') {
                                if ('stringValue' in data.answer) {
                                    contentText = data.answer.stringValue;
                                    console.log('Using answer.stringValue');
                                } else {
                                    // Try to stringify the object
                                    contentText = JSON.stringify(data.answer);
                                    console.log('Stringified answer object');
                                }
                            }
                        }
                        // Fall back to content property if answer doesn't exist
                        else if (data.content) {
                            // If content is a string, use it directly
                            if (typeof data.content === 'string') {
                                contentText = data.content;
                                console.log('Using content property');
                            } 
                            // If content is an object with a text property (legacy format)
                            else if (typeof data.content === 'object') {
                                if (data.content.text) {
                                    contentText = data.content.text;
                                } else if (data.content.stringValue) {
                                    // Handle Firestore encoded values
                                    contentText = data.content.stringValue;
                                } else if (data.content.value) {
                                    contentText = data.content.value;
                                } else {
                                    // Try to stringify the object
                                    contentText = JSON.stringify(data.content);
                                }
                            }
                        }
                        
                        // Add question to the display if available
                        if (data.question && typeof data.question === 'string') {
                            contentText = data.question + ': ' + contentText;
                            console.log('Added question to content text');
                        }
                        
                        // Clean up any HTML tags for display in the list
                        contentText = contentText.replace(/<[^>]*>/g, ' ');
                        
                        // Truncate for display in list
                        contentText = contentText.substring(0, 100) + (contentText.length > 100 ? '...' : '');
                        
                        console.log('Final content text:', contentText);
                    } catch (e) {
                        console.error('Error processing content:', e);
                    }
                    
                    // Safely handle timestamp
                    let dateStr = 'Date not available';
                    try {
                        dateStr = formatTimestamp(data.timestamp);
                    } catch (e) {
                        console.error('Error formatting date:', e);
                    }
                    
                    // Create a better display title from the question if available
                    let displayText = contentText;
                    if (data.question && typeof data.question === 'string') {
                        displayText = data.question;
                        console.log('Using question for display text:', displayText);
                    }
                    
                    const responseItem = document.createElement('div');
                    responseItem.className = 'response-item';
                    responseItem.innerHTML = `
                        <div class="response-content">${displayText}</div>
                        <div class="response-date">${dateStr}</div>
                        <div class="response-actions">
                            <button class="action-button view-response" data-id="${docId}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="action-button delete-response" data-id="${docId}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    savedResponsesList.appendChild(responseItem);
                });
                
                // Add event listeners for view and delete buttons
                document.querySelectorAll('.view-response').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const responseId = e.currentTarget.getAttribute('data-id');
                        // View the full response
                        await viewSavedResponse(responseId);
                    });
                });
                
                document.querySelectorAll('.delete-response').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const responseId = e.currentTarget.getAttribute('data-id');
                        // Delete the response
                        await deleteSavedResponse(responseId);
                        // Reload the list
                        loadSavedResponses();
                    });
                });
                
            } catch (error) {
                console.error('Error loading saved responses:', error);
                if (savedResponsesList) {
                    savedResponsesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-circle empty-icon"></i>
                            <p>Error loading saved responses</p>
                            <p class="empty-description">Please try again later.</p>
                        </div>
                    `;
                }
            }
        }
        
        // Helper function to format timestamps safely
        function formatTimestamp(timestamp) {
            try {
                if (timestamp && typeof timestamp.toDate === 'function') {
                    return new Date(timestamp.toDate()).toLocaleString();
                } else if (timestamp && timestamp.seconds) {
                    return new Date(timestamp.seconds * 1000).toLocaleString();
                } else if (timestamp) {
                    return new Date(timestamp).toLocaleString();
                }
                return 'Date not available';
            } catch (e) {
                console.log('Error formatting timestamp:', e);
                return 'Date not available';
            }
        }
        
        // Function to view a saved response
        async function viewSavedResponse(responseId) {
            try {
                const db = getFirestore();
                const responseDoc = await getDoc(doc(db, 'savedResponses', responseId));
                
                if (responseDoc.exists()) {
                    const data = responseDoc.data();
                    console.log('Viewing saved response data:', data);
                    
                    // Create a modal to show the full response
                    const viewModal = document.createElement('div');
                    viewModal.className = 'auth-modal';
                    viewModal.style.display = 'block';
                    viewModal.style.zIndex = '1001'; // Higher than profile modal
                    
                    // Extract content with fallbacks
                    let content = 'No content available';
                    let question = '';
                    
                    // Log the data structure to understand what we're working with
                    console.log('Saved response data structure:', Object.keys(data));
                    
                    // Check for answer property first (used in this app)
                    if (data.answer) {
                        console.log('Answer type in viewSavedResponse:', typeof data.answer);
                        
                        // If answer is a string, use it directly
                        if (typeof data.answer === 'string') {
                            content = data.answer;
                            console.log('Using answer as content:', content.substring(0, 50));
                        } 
                        // If answer is an object with special format
                        else if (typeof data.answer === 'object') {
                            console.log('Answer is an object with keys:', Object.keys(data.answer));
                            
                            if ('stringValue' in data.answer) {
                                content = data.answer.stringValue;
                                console.log('Using answer.stringValue');
                            } else {
                                // Try to stringify the object
                                try {
                                    content = JSON.stringify(data.answer);
                                    console.log('Using stringified answer');
                                } catch (e) {
                                    console.error('Error stringifying answer:', e);
                                }
                            }
                        }
                    }
                    // Fall back to content property if answer doesn't exist
                    else if (data.content) {
                        console.log('Content type in viewSavedResponse:', typeof data.content);
                        
                        // If content is a string, use it directly
                        if (typeof data.content === 'string') {
                            content = data.content;
                            console.log('Using string content:', content.substring(0, 50));
                        } 
                        // If content is an object, try to extract the actual content
                        else if (typeof data.content === 'object') {
                            console.log('Content is an object with keys:', Object.keys(data.content));
                            
                            if (data.content.text) {
                                content = data.content.text;
                                console.log('Using content.text');
                            } else if (data.content.stringValue) {
                                // Handle Firestore encoded values
                                content = data.content.stringValue;
                                console.log('Using content.stringValue');
                            } else if (data.content.value) {
                                content = data.content.value;
                                console.log('Using content.value');
                            } else {
                                // Try to stringify the object
                                try {
                                    content = JSON.stringify(data.content);
                                    console.log('Using stringified content');
                                } catch (e) {
                                    console.error('Error stringifying content:', e);
                                }
                            }
                        }
                    }
                    
                    // Get the question if available
                    if (data.question) {
                        if (typeof data.question === 'string') {
                            question = data.question;
                            console.log('Found question:', question);
                        } else if (typeof data.question === 'object' && 'stringValue' in data.question) {
                            question = data.question.stringValue;
                            console.log('Found question from stringValue:', question);
                        }
                    }
                    
                    // Format content for better display
                    console.log('Content before formatting:', content);
                    
                    // Clean up any null or undefined content
                    if (!content || content === 'undefined' || content === 'null') {
                        content = 'No content available';
                    }
                    
                    // If content is plain text (no HTML tags), add proper formatting
                    if (content && typeof content === 'string' && !content.includes('<') && !content.includes('>')) {
                        // Convert plain text to formatted HTML with paragraphs
                        content = content.split('\n\n').map(paragraph => `<p>${paragraph}</p>`).join('');
                        // Handle single line breaks
                        content = content.replace(/\n/g, '<br>');
                    } else if (typeof content === 'object') {
                        // If content is still an object, stringify it for display
                        try {
                            content = '<pre>' + JSON.stringify(content, null, 2) + '</pre>';
                        } catch (e) {
                            console.error('Error stringifying content for display:', e);
                            content = 'Error displaying content';
                        }
                    }
                    
                    console.log('Content after formatting:', content.substring(0, 100) + '...');
                    
                    // Add styling for better readability
                    const formattedContent = `
                        <div style="font-family: 'Roboto', sans-serif; line-height: 1.6;">
                            ${content}
                        </div>
                    `;
                    
                    // Add question section if available
                    const questionSection = question ? `
                        <div class="saved-question" style="margin-bottom: 15px; padding: 10px 15px; background: #e8f4ff; border-left: 4px solid #4a90e2; border-radius: 4px;">
                            <strong>Question:</strong> ${question}
                        </div>
                    ` : '';
                    
                    viewModal.innerHTML = `
                        <div class="auth-modal-content" style="max-width: 700px;">
                            <span class="close-modal">&times;</span>
                            <h3>Saved Response</h3>
                            ${questionSection}
                            <div class="saved-response-content" style="margin: 20px 0; max-height: 500px; overflow-y: auto; padding: 20px; background: #f9f9f9; border-radius: 8px; box-shadow: inset 0 0 5px rgba(0,0,0,0.05);">
                                ${formattedContent}
                            </div>
                            <div style="text-align: right;">
                                <button class="auth-submit-button close-view-button">Close</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(viewModal);
                    
                    // Add event listeners to close the modal
                    const closeButton = viewModal.querySelector('.close-modal');
                    const closeViewButton = viewModal.querySelector('.close-view-button');
                    
                    closeButton.addEventListener('click', () => {
                        document.body.removeChild(viewModal);
                    });
                    
                    closeViewButton.addEventListener('click', () => {
                        document.body.removeChild(viewModal);
                    });
                }
            } catch (error) {
                console.error('Error viewing saved response:', error);
            }
        }
        
        // Function to delete a saved response
        async function deleteSavedResponse(responseId) {
            try {
                const db = getFirestore();
                await deleteDoc(doc(db, 'savedResponses', responseId));
            } catch (error) {
                console.error('Error deleting saved response:', error);
            }
        }
        
        // Function to load chat history
        async function loadChatHistory() {
            console.log('Loading chat history...');
            const auth = getAuth();
            const user = auth.currentUser;
            
            if (!user) {
                console.log('No user logged in');
                return;
            }
            
            console.log('User ID:', user.uid);
            
            const chatHistoryList = document.getElementById('chat-history-list');
            if (!chatHistoryList) {
                console.error('chatHistoryList element not found');
                return;
            }
            
            const chatHistoryOverlay = document.getElementById('chat-history-premium-overlay');
            
            // Debug: Log all DOM elements
            console.log('Chat history list element:', chatHistoryList);
            console.log('Chat history overlay element:', chatHistoryOverlay);
            
            // Check if user is premium
            const isPremium = await checkUserIsPremium(user.uid);
            console.log('User is premium:', isPremium);
            
            // For free users, we'll still show their most recent chat history up to the limit
            let limitQuery = false;
            
            // Initially hide the premium overlay for everyone
            if (chatHistoryOverlay) {
                chatHistoryOverlay.style.display = 'none';
            }
            
            // If not premium, we'll limit the query
            if (!isPremium) {
                console.log(`Free user will see up to ${FREE_USER_SAVE_LIMIT} recent chat history items`);
                limitQuery = true;
                
                // Set up upgrade button for when they scroll down
                const upgradeButton = document.getElementById('chat-history-upgrade');
                if (upgradeButton) {
                    upgradeButton.onclick = function() {
                        // Close profile modal first
                        const profileModal = document.getElementById('profile-modal');
                        if (profileModal) profileModal.style.display = 'none';
                        
                        // Show premium options with slight delay
                        setTimeout(() => {
                            handlePremiumUpgrade();
                        }, 100);
                    };
                }
            }
            
            // User is premium, load chat history
            try {
                console.log('Starting Firestore query for chat history');
                const db = getFirestore();
                const chatHistoryRef = collection(db, 'chatHistory');
                
                // Log the collection path
                console.log('Collection path:', chatHistoryRef.path);
                
                // Create a query - for free users, limit to FREE_USER_SAVE_LIMIT items
                let q;
                if (limitQuery) {
                    q = query(
                        chatHistoryRef,
                        where('userId', '==', user.uid),
                        orderBy('timestamp', 'desc'),
                        limit(FREE_USER_SAVE_LIMIT) // Limit to 3 most recent items for free users
                    );
                    console.log(`Limited query to ${FREE_USER_SAVE_LIMIT} items for free user`);
                } else {
                    q = query(
                        chatHistoryRef,
                        where('userId', '==', user.uid),
                        orderBy('timestamp', 'desc')
                    );
                    console.log('No limit for premium user');
                }
                
                console.log('Executing chat history query...');
                const querySnapshot = await getDocs(q);
                console.log('Chat history query complete. Empty?', querySnapshot.empty);
                console.log('Number of chat history documents:', querySnapshot.size);
                
                // Clear previous content
                if (chatHistoryList) {
                    chatHistoryList.innerHTML = '';
                    
                    // For free users, add a message about the limit
                    if (limitQuery) {
                        const limitMessage = document.createElement('div');
                        limitMessage.className = 'limit-message';
                        limitMessage.innerHTML = `
                            <p><i class="fas fa-info-circle"></i> Showing your ${FREE_USER_SAVE_LIMIT} most recent conversations. 
                            <a href="#" id="chat-history-upgrade-link">Upgrade to premium</a> for full history.</p>
                        `;
                        chatHistoryList.appendChild(limitMessage);
                        
                        // Add event listener to the upgrade link
                        setTimeout(() => {
                            const upgradeLink = document.getElementById('chat-history-upgrade-link');
                            if (upgradeLink) {
                                upgradeLink.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    // Close profile modal
                                    const profileModal = document.getElementById('profile-modal');
                                    if (profileModal) profileModal.style.display = 'none';
                                    // Show premium options
                                    setTimeout(() => handlePremiumUpgrade(), 100);
                                });
                            }
                        }, 100);
                    }
                }
                
                if (querySnapshot.empty) {
                    console.log('No chat history found');
                    // Show empty state
                    chatHistoryList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-history empty-icon"></i>
                            <p>No chat history yet</p>
                            <p class="empty-description">Your conversation history will appear here.</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('Found chat history, processing...');
                
                // Limit to the 5 most recent conversations
                const chatHistoryItems = [];
                querySnapshot.forEach((doc) => {
                    chatHistoryItems.push({
                        id: doc.id,
                        data: doc.data()
                    });
                });
                
                // Sort by timestamp (newest first)
                chatHistoryItems.sort((a, b) => {
                    const timestampA = a.data.timestamp || 0;
                    const timestampB = b.data.timestamp || 0;
                    return timestampB - timestampA;
                });
                
                console.log('Chat history items before deduplication:', chatHistoryItems.length);
                
                // For free users, we want to show exactly FREE_USER_SAVE_LIMIT items if available
                // For premium users, we'll deduplicate but still show more items
                let processedItems = [];
                
                if (limitQuery) {
                    // For free users, just use the items directly without deduplication
                    // since the query is already limited to FREE_USER_SAVE_LIMIT
                    processedItems = chatHistoryItems;
                    console.log(`Using ${processedItems.length} chat history items for free user without deduplication`);
                } else {
                    // For premium users, deduplicate to avoid showing the same conversation multiple times
                    const uniqueHistoryItems = [];
                    const seenContentHashes = new Set();
                    
                    chatHistoryItems.forEach(item => {
                        // Create a content hash based on the first message or content
                        let contentHash = '';
                        
                        try {
                            // Try to get content from messages array
                            if (item.data.messages && item.data.messages.length > 0) {
                                const firstMessage = item.data.messages[0];
                                if (firstMessage.content) {
                                    if (typeof firstMessage.content === 'string') {
                                        contentHash = firstMessage.content.substring(0, 100);
                                    } else if (typeof firstMessage.content === 'object') {
                                        if ('stringValue' in firstMessage.content) {
                                            contentHash = firstMessage.content.stringValue.substring(0, 100);
                                        } else {
                                            contentHash = JSON.stringify(firstMessage.content).substring(0, 100);
                                        }
                                    }
                                }
                            }
                            // If no messages, try the content field
                            else if (item.data.content) {
                                if (typeof item.data.content === 'string') {
                                    contentHash = item.data.content.substring(0, 100);
                                } else if (typeof item.data.content === 'object') {
                                    if ('stringValue' in item.data.content) {
                                        contentHash = item.data.content.stringValue.substring(0, 100);
                                    } else {
                                        contentHash = JSON.stringify(item.data.content).substring(0, 100);
                                    }
                                }
                            }
                            
                            // If we couldn't get a content hash, use the document ID
                            if (!contentHash) {
                                contentHash = item.id;
                            }
                            
                            // Log the content hash for debugging
                            console.log(`Content hash for item ${item.id}: ${contentHash}`);
                            
                            // Only add the item if we haven't seen this content before
                            if (!seenContentHashes.has(contentHash)) {
                                seenContentHashes.add(contentHash);
                                uniqueHistoryItems.push(item);
                            } else {
                                console.log(`Skipping duplicate item ${item.id} with hash ${contentHash}`);
                            }
                        } catch (e) {
                            console.error('Error creating content hash:', e);
                            // If there's an error, include the item to be safe
                            uniqueHistoryItems.push(item);
                        }
                    });
                    
                    processedItems = uniqueHistoryItems;
                    console.log(`Using ${processedItems.length} deduplicated chat history items for premium user`);
                }
                
                // Take only the most recent conversations (up to 5 for premium users, FREE_USER_SAVE_LIMIT for free users)
                const maxItems = limitQuery ? FREE_USER_SAVE_LIMIT : 5;
                const recentChatHistory = processedItems.slice(0, maxItems);
                console.log(`Displaying ${recentChatHistory.length} most recent chat history items`);
                
                // Display chat history
                recentChatHistory.forEach((item) => {
                    const data = item.data;
                    const docId = item.id;
                    console.log('Processing chat history item:', docId);
                    
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    let title = 'Conversation';
                    let dateStr = 'Date not available';
                    
                    // Process messages to handle Firestore special object format
                    try {
                        if (data.messages && data.messages.length > 0) {
                            // Process each message to handle Firestore special format
                            data.messages = data.messages.map(msg => {
                                // Handle content if it's an object (Firestore special format)
                                if (msg.content && typeof msg.content === 'object') {
                                    const specialKeys = ['stringValue', 'integerValue', 'doubleValue', 'booleanValue', 'arrayValue', 'mapValue', 'timestampValue', 'geoPointValue', 'bytesValue', 'referenceValue', 'nullValue'];
                                    const hasSpecialKey = specialKeys.some(key => key in msg.content);
                                    
                                    if (hasSpecialKey) {
                                        console.log('Detected Firestore special format in list item message');
                                        if ('stringValue' in msg.content) {
                                            msg.content = msg.content.stringValue;
                                        } else if ('mapValue' in msg.content && msg.content.mapValue.fields) {
                                            msg.content = msg.content.mapValue.fields;
                                        }
                                    }
                                }
                                
                                // Also handle role if it's in special format
                                if (msg.role && typeof msg.role === 'object' && 'stringValue' in msg.role) {
                                    msg.role = msg.role.stringValue;
                                }
                                
                                return msg;
                            });
                            
                            // Now create the title from the processed message
                            if (data.messages[0].content) {
                                let contentForTitle = data.messages[0].content;
                                
                                // If content is still an object after processing, try to stringify it
                                if (typeof contentForTitle === 'object') {
                                    try {
                                        contentForTitle = JSON.stringify(contentForTitle);
                                    } catch (e) {
                                        console.error('Error stringifying content for title:', e);
                                        contentForTitle = 'Conversation';
                                    }
                                }
                                
                                // Create the title from the content
                                title = contentForTitle.substring(0, 50) + 
                                      (contentForTitle.length > 50 ? '...' : '');
                            }
                        }
                    } catch (e) {
                        console.log('Error creating title:', e);
                    }
                    
                    // Try to extract a meaningful title from the conversation
                    // First check if we have a user message to use as title
                    if (data.messages && data.messages.length > 0) {
                        console.log('Tryin act title from messages array');
                        // Look for the first user message to use as title
                        const userMessage = data.messages.find(msg => {
                            if (typeof msg === 'object') {
                                // Check if role is 'user' (handling Firestore special format)
                                if (msg.role === 'user') {
                                    return true;
                                } else if (typeof msg.role === 'object' && msg.role.stringValue === 'user') {
                                    return true;
                                }
                            }
                            return false;
                        });
                        
                        if (userMessage) {
                            console.log('Found user message for title');
                            let contentForTitle = '';
                            
                            // Extract content from user message
                            if (typeof userMessage.content === 'string') {
                                contentForTitle = userMessage.content;
                            } else if (typeof userMessage.content === 'object') {
                                if ('stringValue' in userMessage.content) {
                                    contentForTitle = userMessage.content.stringValue;
                                } else {
                                    try {
                                        contentForTitle = JSON.stringify(userMessage.content);
                                    } catch (e) {
                                        contentForTitle = '';
                                    }
                                }
                            }
                            
                            if (contentForTitle) {
                                // Use the first line or first 50 characters
                                const firstLine = contentForTitle.split('\n')[0];
                                title = firstLine.substring(0, 50) + (firstLine.length > 50 ? '...' : '');
                                // Add a unique identifier from the document ID to ensure uniqueness
                                title = `${title} (${docId.substring(0, 4)})`;
                                console.log('Using user message for title with ID:', title);
                            }
                        }
                    }
                    
                    // If no title from messages, try single message format
                    if (title === 'Conversation' && data.content) {
                        console.log('Using content for title in single message format');
                        let contentForTitle = '';
                        
                        if (typeof data.content === 'string') {
                            contentForTitle = data.content;
                        } else if (typeof data.content === 'object') {
                            if ('stringValue' in data.content) {
                                contentForTitle = data.content.stringValue;
                            } else {
                                try {
                                    contentForTitle = JSON.stringify(data.content);
                                } catch (e) {
                                    contentForTitle = 'Conversation';
                                }
                            }
                        }
                        
                        if (contentForTitle) {
                            // Use the first line or first 50 characters
                            const firstLine = contentForTitle.split('\n')[0];
                            title = firstLine.substring(0, 50) + (firstLine.length > 50 ? '...' : '');
                            // Add a unique identifier from the document ID to ensure uniqueness
                            title = `${title} (${docId.substring(0, 4)})`;
                            console.log('Using content for title with ID:', title);
                        }
                    }
                    
                    // Add document ID to make titles more unique
                    if (title === 'Conversation') {
                        title = `Conversation ${docId.substring(0, 4)}`;
                        console.log('Using document ID in title:', title);
                    }
                    
                    // Safely handle timestamp
                    try {
                        console.log('Timestamp type:', typeof data.timestamp);
                        console.log('Timestamp value:', data.timestamp);
                        
                        if (data.timestamp && typeof data.timestamp.toDate === 'function') {
                            console.log('Using Firestore timestamp with toDate()');
                            dateStr = new Date(data.timestamp.toDate()).toLocaleString();
                        } else if (data.timestamp && data.timestamp.seconds) {
                            // Handle timestamp stored as seconds
                            console.log('Using timestamp with seconds property');
                            dateStr = new Date(data.timestamp.seconds * 1000).toLocaleString();
                        } else if (data.timestamp && typeof data.timestamp === 'number') {
                            // Handle numeric timestamp (milliseconds since epoch)
                            console.log('Using numeric timestamp');
                            dateStr = new Date(data.timestamp).toLocaleString();
                        } else if (data.timestamp) {
                            // Try to convert directly if it's a date string or timestamp
                            console.log('Using timestamp as is');
                            dateStr = new Date(data.timestamp).toLocaleString();
                        }
                        
                        console.log('Formatted date:', dateStr);
                        
                        // If title is still just 'Conversation', add date to make it unique
                        if (title === 'Conversation') {
                            title = 'Conversation ' + dateStr.split(',')[0];
                        }
                    } catch (e) {
                        console.log('Error formatting date:', e);
                    }
                    
                    historyItem.innerHTML = `
                        <div class="history-title">${title}</div>
                        <div class="history-date">${dateStr}</div>
                        <div class="history-actions">
                            <button class="action-button view-history" data-id="${docId}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="action-button delete-history" data-id="${docId}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    chatHistoryList.appendChild(historyItem);
                });
                
                // Add event listeners for view and delete buttons
                document.querySelectorAll('.view-history').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const historyId = e.currentTarget.getAttribute('data-id');
                        // View the full conversation
                        await viewChatHistory(historyId);
                    });
                });
                
                document.querySelectorAll('.delete-history').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const historyId = e.currentTarget.getAttribute('data-id');
                        // Delete the conversation
                        await deleteChatHistory(historyId);
                        // Reload the list
                        loadChatHistory();
                    });
                });
                
            } catch (error) {
                console.error('Error loading chat history:', error);
                if (chatHistoryList) {
                    chatHistoryList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-circle empty-icon"></i>
                            <p>Error loading chat history</p>
                            <p class="empty-description">Please try again later.</p>
                        </div>
                    `;
                }
            }
        }
        
        // Function to view chat history
        async function viewChatHistory(historyId) {
            try {
                console.log('Viewing chat history for ID:', historyId);
                const db = getFirestore();
                
                // Check if we're online before attempting to fetch
                if (!navigator.onLine) {
                    throw new Error('You are currently offline. Please check your internet connection and try again.');
                }
                
                // Attempt to get the document with timeout
                const historyDocPromise = getDoc(doc(db, 'chatHistory', historyId));
                
                // Create a timeout promise
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Request timed out. Please try again.')), 10000);
                });
                
                // Race the document fetch against the timeout
                const historyDoc = await Promise.race([historyDocPromise, timeoutPromise]);
                
                if (historyDoc.exists()) {
                    const data = historyDoc.data();
                    console.log('Chat history data for ID ' + historyId + ':', data);
                    
                    // Create a modal to show the full conversation
                    const viewModal = document.createElement('div');
                    viewModal.className = 'auth-modal';
                    viewModal.style.display = 'block';
                    viewModal.style.zIndex = '1001'; // Higher than profile modal
                    
                    // Add a unique ID to the modal for easier debugging
                    viewModal.id = 'chat-history-modal-' + historyId.substring(0, 8);
                    
                    // Initialize messages array
                    let processedMessages = [];
                    
                    // Process messages if they exist
                    if (data.messages && Array.isArray(data.messages) && data.messages.length > 0) {
                        console.log('Processing messages array with length:', data.messages.length);
                        
                        // Skip empty messages or messages with no content
                        const validMessages = data.messages.filter(msg => {
                            // Check if message has content
                            if (!msg || !msg.content) return false;
                            
                            // If content is a string, check if it's empty after trimming
                            if (typeof msg.content === 'string' && msg.content.trim() === '') return false;
                            
                            return true;
                        });
                        
                        if (validMessages.length === 0) {
                            console.log('No valid messages found after filtering');
                            // Create a placeholder message
                            processedMessages = [];
                        } else {
                            console.log('Valid messages after filtering:', validMessages.length);
                        }
                        
                        // Process each message to handle Firestore special object format
                        processedMessages = validMessages.map(msg => {
                            let processedMsg = { ...msg }; // Create a copy to avoid modifying the original
                            
                            // Process message content if it's an object
                            if (processedMsg.content && typeof processedMsg.content === 'object') {
                                // Check if this is a Firestore special object format
                                const specialKeys = ['stringValue', 'integerValue', 'doubleValue', 'booleanValue', 'arrayValue', 'mapValue', 'timestampValue', 'geoPointValue', 'bytesValue', 'referenceValue', 'nullValue'];
                                const hasSpecialKey = specialKeys.some(key => key in processedMsg.content);
                                
                                if (hasSpecialKey) {
                                    console.log('Detected Firestore special object format in message');
                                    // Extract the actual value based on its type
                                    if ('stringValue' in processedMsg.content) {
                                        processedMsg.content = processedMsg.content.stringValue;
                                    } else if ('mapValue' in processedMsg.content && processedMsg.content.mapValue.fields) {
                                        processedMsg.content = processedMsg.content.mapValue.fields;
                                    }
                                    // Add more type conversions as needed
                                }
                            }
                            
                            // Also check if role is in special format
                            if (processedMsg.role && typeof processedMsg.role === 'object' && 'stringValue' in processedMsg.role) {
                                processedMsg.role = processedMsg.role.stringValue;
                            }
                            
                            return processedMsg;
                        });
                        
                        if (processedMessages.length > 0) {
                            console.log('First processed message:', processedMessages[0]);
                            console.log('First message content type:', typeof processedMessages[0].content);
                            
                            // Check if we only have a bismillah message and no other content
                            if (processedMessages.length === 1 && 
                                processedMessages[0].role === 'assistant' && 
                                processedMessages[0].content && 
                                processedMessages[0].content.includes('بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ') && 
                                processedMessages[0].content.trim().split('\n').length <= 2) {
                                
                                console.log('Found only bismillah message, attempting to load more content');
                                
                                // Try to find a related conversation with more content
                                try {
                                    const chatHistoryRef = collection(db, 'chatHistory');
                                    const q = query(
                                        chatHistoryRef,
                                        where('userId', '==', data.userId),
                                        orderBy('timestamp', 'desc')
                                    );
                                    
                                    const querySnapshot = await getDocs(q);
                                    
                                    // Look for a conversation with similar timestamp (within 5 minutes)
                                    const currentTimestamp = data.timestamp instanceof Date ? data.timestamp.getTime() : 
                                                           (data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().getTime() : 
                                                           (typeof data.timestamp === 'number' ? data.timestamp : Date.now()));
                                    
                                    let fullConversation = null;
                                    
                                    querySnapshot.forEach(doc => {
                                        if (doc.id !== historyId) { // Skip the current document
                                            const docData = doc.data();
                                            const docTimestamp = docData.timestamp instanceof Date ? docData.timestamp.getTime() : 
                                                              (docData.timestamp && docData.timestamp.toDate ? docData.timestamp.toDate().getTime() : 
                                                              (typeof docData.timestamp === 'number' ? docData.timestamp : 0));
                                            
                                            // Check if timestamps are within 5 minutes (300000 ms) of each other
                                            const timeDiff = Math.abs(currentTimestamp - docTimestamp);
                                            if (timeDiff < 300000) { // 5 minutes
                                                // Check if this document has more messages
                                                if (docData.messages && docData.messages.length > 1) {
                                                    fullConversation = docData;
                                                    console.log('Found more complete conversation:', doc.id);
                                                }
                                            }
                                        }
                                    });
                                    
                                    // If we found a more complete conversation, use its messages
                                    if (fullConversation && fullConversation.messages && fullConversation.messages.length > 0) {
                                        console.log('Using messages from more complete conversation');
                                        
                                        // Process these messages as well
                                        processedMessages = fullConversation.messages.map(msg => {
                                            let processedMsg = { ...msg };
                                            
                                            // Process message content if it's an object
                                            if (processedMsg.content && typeof processedMsg.content === 'object') {
                                                const specialKeys = ['stringValue', 'integerValue', 'doubleValue', 'booleanValue', 'arrayValue', 'mapValue', 'timestampValue', 'geoPointValue', 'bytesValue', 'referenceValue', 'nullValue'];
                                                const hasSpecialKey = specialKeys.some(key => key in processedMsg.content);
                                                
                                                if (hasSpecialKey) {
                                                    if ('stringValue' in processedMsg.content) {
                                                        processedMsg.content = processedMsg.content.stringValue;
                                                    } else if ('mapValue' in processedMsg.content && processedMsg.content.mapValue.fields) {
                                                        processedMsg.content = processedMsg.content.mapValue.fields;
                                                    }
                                                }
                                            }
                                            
                                            // Also check if role is in special format
                                            if (processedMsg.role && typeof processedMsg.role === 'object' && 'stringValue' in processedMsg.role) {
                                                processedMsg.role = processedMsg.role.stringValue;
                                            }
                                            
                                            return processedMsg;
                                        });
                                    }
                                } catch (e) {
                                    console.error('Error finding related conversation:', e);
                                }
                            }
                        }
                    } 
                    // Handle single message format (older format)
                    else if (data.content) {
                        console.log('Converting single message format to messages array');
                        // Create a messages array from the single content
                        let content = data.content;
                        
                        // Handle Firestore special format for content
                        if (typeof content === 'object') {
                            if ('stringValue' in content) {
                                content = content.stringValue;
                            } else {
                                try {
                                    content = JSON.stringify(content);
                                } catch (e) {
                                    console.error('Error stringifying content:', e);
                                    content = 'Error displaying content';
                                }
                            }
                        }
                        
                        // Check if we only have a user question with no response
                        if (data.type === 'user' || (content && content.toLowerCase().includes('what') && content.includes('?'))) {
                            console.log('Found only user question, attempting to find response');
                            
                            try {
                                const chatHistoryRef = collection(db, 'chatHistory');
                                const q = query(
                                    chatHistoryRef,
                                    where('userId', '==', data.userId),
                                    orderBy('timestamp', 'desc')
                                );
                                
                                const querySnapshot = await getDocs(q);
                                
                                // Look for a conversation with similar timestamp (within 5 minutes)
                                const currentTimestamp = data.timestamp instanceof Date ? data.timestamp.getTime() : 
                                                       (data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().getTime() : 
                                                       (typeof data.timestamp === 'number' ? data.timestamp : Date.now()));
                                
                                let responseMessage = null;
                                
                                querySnapshot.forEach(doc => {
                                    if (doc.id !== historyId) { // Skip the current document
                                        const docData = doc.data();
                                        const docTimestamp = docData.timestamp instanceof Date ? docData.timestamp.getTime() : 
                                                          (docData.timestamp && docData.timestamp.toDate ? docData.timestamp.toDate().getTime() : 
                                                          (typeof docData.timestamp === 'number' ? docData.timestamp : 0));
                                        
                                        // Check if timestamps are within 5 minutes (300000 ms) of each other
                                        const timeDiff = Math.abs(currentTimestamp - docTimestamp);
                                        if (timeDiff < 300000) { // 5 minutes
                                            // Check if this document has an assistant response
                                            if (docData.type === 'assistant' || 
                                                (docData.messages && docData.messages.some(m => m.role === 'assistant'))) {
                                                responseMessage = docData;
                                                console.log('Found assistant response:', doc.id);
                                            }
                                        }
                                    }
                                });
                                
                                // If we found a response, combine it with the user question
                                if (responseMessage) {
                                    console.log('Adding assistant response to user question');
                                    
                                    // Create a combined conversation
                                    processedMessages = [
                                        {
                                            role: 'user',
                                            content: content
                                        }
                                    ];
                                    
                                    // Add the assistant response
                                    if (responseMessage.messages && responseMessage.messages.length > 0) {
                                        // Find the first assistant message
                                        const assistantMsg = responseMessage.messages.find(m => 
                                            m.role === 'assistant' || 
                                            (m.role && typeof m.role === 'object' && m.role.stringValue === 'assistant')
                                        );
                                        
                                        if (assistantMsg) {
                                            let assistantContent = assistantMsg.content;
                                            
                                            // Process the content if needed
                                            if (typeof assistantContent === 'object') {
                                                if ('stringValue' in assistantContent) {
                                                    assistantContent = assistantContent.stringValue;
                                                } else {
                                                    try {
                                                        assistantContent = JSON.stringify(assistantContent);
                                                    } catch (e) {
                                                        assistantContent = 'Error displaying content';
                                                    }
                                                }
                                            }
                                            
                                            processedMessages.push({
                                                role: 'assistant',
                                                content: assistantContent
                                            });
                                        }
                                    } else if (responseMessage.content) {
                                        // Handle single message format
                                        let assistantContent = responseMessage.content;
                                        
                                        // Process the content if needed
                                        if (typeof assistantContent === 'object') {
                                            if ('stringValue' in assistantContent) {
                                                assistantContent = assistantContent.stringValue;
                                            } else {
                                                try {
                                                    assistantContent = JSON.stringify(assistantContent);
                                                } catch (e) {
                                                    assistantContent = 'Error displaying content';
                                                }
                                            }
                                        }
                                        
                                        processedMessages.push({
                                            role: 'assistant',
                                            content: assistantContent
                                        });
                                    }
                                } else {
                                    // If no response found, just use the user question
                                    processedMessages = [
                                        {
                                            role: 'user',
                                            content: content
                                        }
                                    ];
                                }
                            } catch (e) {
                                console.error('Error finding response message:', e);
                                // Fallback to just the user message
                                processedMessages = [
                                    {
                                        role: 'user',
                                        content: content
                                    }
                                ];
                            }
                        } else {
                            // Regular single message format
                            processedMessages = [
                                {
                                    role: data.type || 'assistant',
                                    content: content
                                }
                            ];
                        }
                    }
                    
                    // If we still have no messages, create a placeholder
                    if (processedMessages.length === 0) {
                        console.log('No messages found in chat history, creating placeholder');
                        processedMessages = [
                            {
                                role: 'assistant',
                                content: 'No messages found in this conversation.'
                            }
                        ];
                    }
                    
                    // Generate HTML for messages
                    let messagesHtml = '';
                    if (processedMessages.length > 0) {
                        // Only show warning for very specific incomplete cases
                        let incompleteNote = '';
                        
                        // Case 1: Only bismillah and nothing else
                        if (processedMessages.length === 1 && 
                            processedMessages[0].role === 'assistant' && 
                            processedMessages[0].content && 
                            typeof processedMessages[0].content === 'string' &&
                            processedMessages[0].content.includes('بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ') && 
                            processedMessages[0].content.trim().length < 100) {
                                
                            incompleteNote = `
                                <div style="padding: 10px; margin-bottom: 15px; background: #fff8e1; border-left: 3px solid #ffc107; border-radius: 4px;">
                                    <p style="color: #333; margin: 0; font-size: 14px;">
                                        <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                                        This only shows the beginning of a response. The full answer may be in another chat history entry.
                                    </p>
                                </div>
                            `;
                        }
                        
                        // Case 2: Only user question with no response
                        else if (processedMessages.length === 1 && 
                                 processedMessages[0].role === 'user') {
                                
                            incompleteNote = `
                                <div style="padding: 10px; margin-bottom: 15px; background: #fff8e1; border-left: 3px solid #ffc107; border-radius: 4px;">
                                    <p style="color: #333; margin: 0; font-size: 14px;">
                                        <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                                        This only shows your question. The response may be in another chat history entry.
                                    </p>
                                </div>
                            `;
                        }
                        
                        // Case 3: User question + only bismillah response
                        else if (processedMessages.length === 2 && 
                                 processedMessages.some(msg => msg.role === 'user') &&
                                 processedMessages.some(msg => {
                                     return msg.role === 'assistant' && 
                                            msg.content && 
                                            typeof msg.content === 'string' &&
                                            msg.content.includes('بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ') && 
                                            msg.content.trim().length < 100;
                                 })) {
                                
                            incompleteNote = `
                                <div style="padding: 10px; margin-bottom: 15px; background: #fff8e1; border-left: 3px solid #ffc107; border-radius: 4px;">
                                    <p style="color: #333; margin: 0; font-size: 14px;">
                                        <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                                        This appears to be an incomplete conversation. The full response may be in another chat history entry.
                                    </p>
                                </div>
                            `;
                        }
                        
                        messagesHtml = incompleteNote + processedMessages.map(msg => {
                            const isUser = msg.role === 'user';
                            
                            // Process message content with fallbacks
                            let content = 'No content available';
                            
                            try {
                                // Handle different content formats
                                if (msg.content) {
                                    console.log(`Message content type for ${msg.role}:`, typeof msg.content);
                                    
                                    // If content is a string, use it directly
                                    if (typeof msg.content === 'string') {
                                        content = msg.content;
                                        console.log('Using string content for message display');
                                    } 
                                    // If content is an object, try to extract the actual content
                                    else if (typeof msg.content === 'object') {
                                        console.log('Content is an object with keys:', Object.keys(msg.content));
                                        
                                        if (msg.content.text) {
                                            content = msg.content.text;
                                            console.log('Using content.text');
                                        } else if (msg.content.stringValue) {
                                            // Handle Firestore encoded values
                                            content = msg.content.stringValue;
                                            console.log('Using content.stringValue');
                                        } else if (msg.content.value) {
                                            content = msg.content.value;
                                            console.log('Using content.value');
                                        } else {
                                            // Try to stringify the object
                                            try {
                                                content = JSON.stringify(msg.content);
                                                console.log('Using stringified content');
                                            } catch (e) {
                                                console.error('Error stringifying content:', e);
                                            }
                                        }
                                    }
                                }
                                
                                // Clean up any null or undefined content
                                if (!content || content === 'undefined' || content === 'null') {
                                    content = 'No content available';
                                }
                                
                                // If content is plain text (no HTML tags), add proper formatting
                                if (content && typeof content === 'string' && !content.includes('<') && !content.includes('>')) {
                                    // Convert plain text to formatted HTML with paragraphs
                                    content = content.split('\n\n').map(paragraph => `<p>${paragraph}</p>`).join('');
                                    // Handle single line breaks
                                    content = content.replace(/\n/g, '<br>');
                                } else if (typeof content === 'object') {
                                    // If content is still an object, stringify it for display
                                    try {
                                        content = '<pre>' + JSON.stringify(content, null, 2) + '</pre>';
                                    } catch (e) {
                                        console.error('Error stringifying content for display:', e);
                                        content = 'Error displaying content';
                                    }
                                }
                            } catch (e) {
                                console.error('Error processing message content:', e);
                            }
                            
                            return `
                                <div class="${isUser ? 'user-message' : 'bot-message'}" style="padding: 15px; margin: 15px 0; border-radius: 8px; background: ${isUser ? '#f0f0f0' : '#e6f7f2'}; border-left: 3px solid ${isUser ? '#999' : 'var(--primary-color)'}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <div style="font-weight: ${isUser ? 'normal' : 'bold'}; margin-bottom: 8px; color: #333;">${isUser ? 'You' : 'Mo'}</div>
                                    <div style="font-family: 'Roboto', sans-serif; line-height: 1.6; color: #333;">${content}</div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        messagesHtml = '<div style="padding: 20px; text-align: center; color: #666;"><i class="fas fa-comment-slash" style="font-size: 24px; margin-bottom: 10px;"></i><p>No messages in this conversation.</p></div>';
                    }
                    
                    viewModal.innerHTML = `
                        <div class="auth-modal-content" style="max-width: 700px;">
                            <span class="close-modal">&times;</span>
                            <h3>Conversation History</h3>
                            <div class="conversation-date" style="color: #666; margin-bottom: 15px;">
                                ${formatTimestamp(data.timestamp)}
                            </div>
                            <div class="conversation-content" style="margin: 20px 0; max-height: 500px; overflow-y: auto; padding: 15px; background: #f9f9f9; border-radius: 8px; color: #333;">
                                ${messagesHtml}
                            </div>
                            <div style="text-align: right;">
                                <button class="auth-submit-button close-view-button">Close</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(viewModal);
                    
                    // Add event listeners to close the modal
                    const closeButton = viewModal.querySelector('.close-modal');
                    const closeViewButton = viewModal.querySelector('.close-view-button');
                    
                    closeButton.addEventListener('click', () => {
                        document.body.removeChild(viewModal);
                    });
                    
                    closeViewButton.addEventListener('click', () => {
                        document.body.removeChild(viewModal);
                    });
                }
            } catch (error) {
                console.error('Error viewing chat history:', error);
                
                // Create an error modal
                const errorModal = document.createElement('div');
                errorModal.className = 'auth-modal';
                errorModal.style.display = 'block';
                errorModal.style.zIndex = '1001';
                
                // Determine error message
                let errorMessage = 'An error occurred while loading the conversation.';
                
                if (error.message.includes('offline') || error.code === 'failed-precondition' || error.message.includes('client is offline')) {
                    errorMessage = 'You appear to be offline. Please check your internet connection and try again.';
                } else if (error.message.includes('timed out')) {
                    errorMessage = 'The request timed out. Please try again later.';
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'You do not have permission to view this conversation.';
                }
                
                errorModal.innerHTML = `
                    <div class="auth-modal-content" style="max-width: 500px;">
                        <span class="close-modal">&times;</span>
                        <h3>Unable to Load Conversation</h3>
                        <div style="margin: 20px 0; padding: 15px; background: #fff4f4; border-left: 3px solid #ff6b6b; border-radius: 4px;">
                            <p style="color: #333; margin: 0;">${errorMessage}</p>
                        </div>
                        <div style="text-align: right;">
                            <button class="auth-submit-button close-error-button">Close</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(errorModal);
                
                // Add event listeners to close the modal
                const closeButton = errorModal.querySelector('.close-modal');
                const closeErrorButton = errorModal.querySelector('.close-error-button');
                
                closeButton.addEventListener('click', () => {
                    document.body.removeChild(errorModal);
                });
                
                closeErrorButton.addEventListener('click', () => {
                    document.body.removeChild(errorModal);
                });
            }
        }
        
        // Function to delete chat history
        async function deleteChatHistory(historyId) {
            try {
                const db = getFirestore();
                await deleteDoc(doc(db, 'chatHistory', historyId));
            } catch (error) {
                console.error('Error deleting chat history:', error);
            }
        }
        
        // Development mode flag - set to true to enable premium features for testing
        const DEV_MODE_PREMIUM = false; // Set to true to test premium features without subscription
        
        // Function to check if user is premium
        // Expose checkUserIsPremium to the global scope
        window.checkUserIsPremium = async function(userId) {
            // If in development mode, return true to enable premium features
            if (DEV_MODE_PREMIUM) return true;
            
            try {
                const db = getFirestore();
                const userDoc = await getDoc(doc(db, 'users', userId));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (userData.subscription && userData.subscription.type === 'premium' && userData.subscription.active) {
                        // Check if subscription is still valid (not expired)
                        if (userData.subscription.endDate) {
                            const now = new Date();
                            const endDate = new Date(userData.subscription.endDate);
                            return now <= endDate;
                        }
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Error checking premium status:', error);
                return false;
            }
        }
        
        // Function to load user profile data
        async function loadUserProfile() {
            const auth = getAuth();
            const user = auth.currentUser;
            
            if (!user) {
                return;
            }
            
            // Make sure profile UI elements are available
            const currentPlan = document.getElementById('current-plan');
            const upgradeButton = document.getElementById('upgrade-button');
            const profileError = document.getElementById('profile-error');
            const profileMessage = document.getElementById('profile-message');
            const profileModal = document.getElementById('profile-modal');
            
            // Clear any previous messages
            if (profileMessage) profileMessage.textContent = '';
            
            // Ensure the user profile section is visible
            const userProfile = document.getElementById('user-profile');
            if (userProfile) {
                userProfile.style.display = 'flex';
            }
            
            // Set default values first - this ensures the UI is always in a valid state
            // even if there are errors with Firestore
            if (currentPlan && upgradeButton) {
                currentPlan.textContent = 'Free Plan';
                currentPlan.classList.remove('premium');
                upgradeButton.textContent = 'Upgrade to Premium';
                
                // Set up the upgrade button click handler
                upgradeButton.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        // Close profile modal first
                        const profileModal = document.getElementById('profile-modal');
                        if (profileModal) profileModal.style.display = 'none';
                        
                        // Then handle premium upgrade with a slight delay
                        setTimeout(() => {
                            handlePremiumUpgrade();
                        }, 100);
                    } catch (err) {
                        console.log('Premium upgrade button clicked');
                    }
                };
            }
            
            // Clear any previous errors
            if (profileError) profileError.textContent = '';
            
            try {
                const db = getFirestore();
                // Use a timeout to prevent long-running Firestore operations
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firestore operation timed out')), 5000)
                );
                
                // Race between the Firestore operation and the timeout
                const userDocPromise = getDoc(doc(db, 'users', user.uid));
                const result = await Promise.race([userDocPromise, timeoutPromise])
                    .catch(error => {
                        // Silently handle timeout or permission errors
                        // We've already set default values above
                        return null;
                    });
                
                // If we got a valid result, update the UI
                if (result && result.exists()) {
                    const userData = result.data();
                    
                    if (currentPlan && upgradeButton && userData.subscription) {
                        if (userData.subscription.type === 'premium' && userData.subscription.active) {
                            // Check if subscription is still valid (not expired)
                            let isValid = true;
                            if (userData.subscription.endDate) {
                                const now = new Date();
                                const endDate = new Date(userData.subscription.endDate);
                                isValid = now <= endDate;
                            }
                            
                            if (isValid) {
                                currentPlan.textContent = 'Premium Plan';
                                currentPlan.classList.add('premium');
                                upgradeButton.textContent = 'Manage Subscription';
                                
                                // Show subscription details
                                if (profileMessage) {
                                    const planType = userData.subscription.plan || 'monthly';
                                    const endDate = userData.subscription.endDate ? new Date(userData.subscription.endDate).toLocaleDateString() : 'N/A';
                                    profileMessage.innerHTML = `<span style="color: green">Premium ${planType} plan active until: ${endDate}</span>`;
                                }
                            } else {
                                // Subscription expired
                                currentPlan.textContent = 'Free Plan (Premium Expired)';
                                currentPlan.classList.remove('premium');
                                upgradeButton.textContent = 'Renew Premium';
                                
                                // Reset the upgrade button to show premium options
                                upgradeButton.onclick = function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    try {
                                        handlePremiumUpgrade();
                                    } catch (err) {
                                        console.log('Premium upgrade button clicked');
                                    }
                                };
                                
                                if (profileMessage) {
                                    profileMessage.innerHTML = '<span style="color: #e53935">Your premium subscription has expired.</span>';
                                }
                            }
                        }
                    }
                } else if (result) {
                    // Document doesn't exist but we successfully connected to Firestore
                    // Try to create it, but don't worry if it fails
                    try {
                        await setDoc(doc(db, 'users', user.uid), {
                            email: user.email,
                            subscription: { type: 'free' },
                            createdAt: serverTimestamp()
                        }).catch(e => {
                            // Silently ignore permission errors
                            // We've already set default values above
                        });
                    } catch (createError) {
                        // Silently ignore errors
                        // We've already set default values above
                    }
                }
            } catch (error) {
                // Silently handle all errors - we've already set default values
                // No need to log to console or show error messages
            }
            
            // Don't automatically show the profile modal from loadUserProfile
            // This will be handled by the profile button click handler
            
            // Initialize profile tabs
            initProfileTabs();
            
            // Check if we should show the premium features or premium overlay
            const isPremium = await checkUserIsPremium(user.uid);
            
            // Update UI based on premium status
            const savedResponsesOverlay = document.getElementById('saved-responses-premium-overlay');
            const chatHistoryOverlay = document.getElementById('chat-history-premium-overlay');
            
            if (savedResponsesOverlay) {
                savedResponsesOverlay.style.display = isPremium ? 'none' : 'flex';
            }
            
            if (chatHistoryOverlay) {
                chatHistoryOverlay.style.display = isPremium ? 'none' : 'flex';
            }
        }
        
        // Expose the saveResponse function to the global scope
        // Constants for free user limits
        const FREE_USER_SAVE_LIMIT = 3;
        
        window.saveResponse = async function(content, buttonElement = null) {
            const auth = getAuth();
            const user = auth.currentUser;
            
            if (!user) {
                // User is not logged in, show login modal
                showAuthModal('login');
                return;
            }
            
            // Check if user is premium
            const isPremium = await checkUserIsPremium(user.uid);
            
            if (!isPremium) {
                // For free users, check how many responses they've already saved
                try {
                    const db = getFirestore();
                    const savedResponsesRef = collection(db, 'savedResponses');
                    const q = query(savedResponsesRef, where('userId', '==', user.uid));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.size >= FREE_USER_SAVE_LIMIT) {
                        // User has reached their limit, show premium upgrade modal
                        const limitToast = document.createElement('div');
                        limitToast.className = 'toast warning-toast';
                        limitToast.innerHTML = `
                            <i class="fas fa-exclamation-circle"></i>
                            <span>You've reached your limit of ${FREE_USER_SAVE_LIMIT} saved responses. Upgrade to premium for unlimited saves!</span>
                        `;
                        document.body.appendChild(limitToast);
                        
                        // Remove the toast after 5 seconds
                        setTimeout(() => {
                            document.body.removeChild(limitToast);
                            // Show premium upgrade modal
                            handlePremiumUpgrade();
                        }, 5000);
                        return;
                    }
                } catch (error) {
                    console.error('Error checking saved responses count:', error);
                }
            }
            
            try {
                const db = getFirestore();
                const savedResponsesRef = collection(db, 'savedResponses');
                
                // Clean and prepare the content for saving
                let cleanContent = content;
                
                if (typeof cleanContent === 'string') {
                    // First, remove any script tags for security
                    cleanContent = cleanContent.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
                    
                    // If the content contains HTML, try to extract just the text
                    if (cleanContent.includes('<') && cleanContent.includes('>')) {
                        // Create a temporary div to parse HTML and extract text
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = cleanContent;
                        
                        // Get the text content
                        const textContent = tempDiv.textContent || tempDiv.innerText || '';
                        
                        // Only use the extracted text if it's not empty
                        if (textContent.trim()) {
                            cleanContent = textContent;
                        }
                    }
                } else {
                    cleanContent = 'No content available';
                }
                
                // Debug the content before saving
                console.log('Saving content to Firestore:', cleanContent);
                
                // Add the response to Firestore with consistent format
                await addDoc(savedResponsesRef, {
                    userId: user.uid,
                    content: cleanContent, // Store as plain text
                    contentType: 'text', // Add content type for future flexibility
                    timestamp: serverTimestamp()
                });
                
                // Show success message
                const successToast = document.createElement('div');
                successToast.className = 'toast success-toast';
                successToast.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span>Response saved successfully!</span>
                `;
                document.body.appendChild(successToast);
                
                // Remove the toast after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(successToast);
                }, 3000);
                
            } catch (error) {
                console.error('Error saving response:', error);
                
                // Show error message
                const errorToast = document.createElement('div');
                errorToast.className = 'toast error-toast';
                errorToast.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Error saving response. Please try again.</span>
                `;
                document.body.appendChild(errorToast);
                
                // Remove the toast after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(errorToast);
                }, 3000);
            }
        }
        
        // Function to handle premium upgrade with iframe protection and improved error handling
        async function handlePremiumUpgrade() {
            try {
                // First, close any open modals
                const profileModal = document.getElementById('profile-modal');
                if (profileModal) profileModal.style.display = 'none';
                
                const premiumModal = document.getElementById('premium-modal');
                if (premiumModal) premiumModal.style.display = 'none';
                
                const auth = getAuth();
                const user = auth.currentUser;
                
                if (!user) {
                    // Close all other modals first
                    const signupModal = document.getElementById('signup-modal');
                    if (signupModal) signupModal.style.display = 'none';
                    
                    const resetPasswordModal = document.getElementById('reset-password-modal');
                    if (resetPasswordModal) resetPasswordModal.style.display = 'none';
                    
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) {
                        try {
                            loginModal.style.display = 'block';
                            const loginError = document.getElementById('login-error');
                            if (loginError) {
                                loginError.textContent = 'Please sign in to upgrade to premium';
                                loginError.style.color = '#e53935';
                            }
                            console.log('Login modal displayed for premium upgrade');
                            
                            // Mark premium intent for after login
                            safeSetItem('premium_after_login', 'true');
                        } catch (modalError) {
                            // Silently handle error
                            console.log('Showing login modal for premium upgrade');
                        }
                    }
                    return;
                }
                
                // Check if user is already premium before showing upgrade options
                try {
                    const db = getFirestore();
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.subscription && 
                            userData.subscription.type === 'premium' && 
                            userData.subscription.active) {
                            
                            // Check if subscription is still valid (not expired)
                            let isValid = true;
                            if (userData.subscription.endDate) {
                                const now = new Date();
                                const endDate = new Date(userData.subscription.endDate);
                                isValid = now <= endDate;
                            }
                            
                            if (isValid) {
                                // User already has a valid premium subscription
                                // Just show the profile modal
                                const profileModal = document.getElementById('profile-modal');
                                if (profileModal) {
                                    profileModal.style.display = 'block';
                                    console.log('Profile modal displayed for premium user');
                                }
                                return;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking premium status:', error);
                    // Continue with premium upgrade flow
                }
                
                // Clear any premium intent flags
                safeSetItem('premium_after_login', '');
                
                // We no longer need to load the Stripe Buy Button script
                // since we're using direct links instead
                
                // Show premium options modal immediately
                try {
                    showPremiumOptions(user);
                } catch (modalError) {
                    // Silently handle error
                    console.log('Showing premium options');
                }
            } catch (error) {
                // Silently handle error
                console.log('Premium upgrade initiated');
                // Still show the premium options even if there was an error
                try {
                    const user = getAuth().currentUser;
                    if (user) {
                        showPremiumOptions(user);
                    }
                } catch (e) {
                    // Final fallback
                }
            }
        }
        
        function showPremiumOptions(user) {
            // Close any open modals first
            const profileModal = document.getElementById('profile-modal');
            if (profileModal && profileModal.style.display === 'block') {
                profileModal.style.display = 'none';
            }
            
            // Close any other auth modals that might be open
            const loginModal = document.getElementById('login-modal');
            if (loginModal) loginModal.style.display = 'none';
            
            const signupModal = document.getElementById('signup-modal');
            if (signupModal) signupModal.style.display = 'none';
            
            const resetPasswordModal = document.getElementById('reset-password-modal');
            if (resetPasswordModal) resetPasswordModal.style.display = 'none';
            
            // Remove existing premium modal if it exists
            let existingModal = document.getElementById('premium-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create new modal
            const premiumModal = document.createElement('div');
            premiumModal.id = 'premium-modal';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            const closeButton = document.createElement('span');
            closeButton.className = 'close-button';
            closeButton.innerHTML = '&times;';
            closeButton.onclick = function() {
                premiumModal.style.display = 'none';
            };
            
            const title = document.createElement('h2');
            title.textContent = 'Upgrade to Premium';
            title.style.color = '#1e6f5c';
            title.style.textAlign = 'center';
            
            // Add Ramadan special banner
            const ramadanBanner = document.createElement('div');
            ramadanBanner.className = 'ramadan-modal-promo';
            ramadanBanner.innerHTML = `
                <div class="ramadan-modal-badge">
                    <span class="ramadan-icon">☪</span> RAMADAN SPECIAL
                </div>
                <p>Enjoy up to 50% off during the blessed month of Ramadan!</p>
            `;
            
            const description = document.createElement('p');
            description.textContent = 'Unlock unlimited questions, priority support, and advanced features.';
            description.style.textAlign = 'center';
            description.style.marginBottom = '20px';
            
            const priceContainer = document.createElement('div');
            priceContainer.className = 'price-container';
            
            // Monthly plan
            const monthlyPlan = document.createElement('div');
            monthlyPlan.className = 'price-option';
            monthlyPlan.innerHTML = `
                <div class="badge great-value-badge">GREAT VALUE</div>
                <div class="discount-badge">50% OFF</div>
                <h3>Premium Monthly</h3>
                <div class="price"><span class="original-price">$19.99</span> $9.99<span>/month</span></div>
                <ul>
                    <li>100 questions per month</li>
                    <li>Unlimited with your API key</li>
                    <li>Priority support</li>
                    <li>Cancel anytime</li>
                </ul>
                <div id="modal-monthly-stripe-container" class="stripe-button-container"></div>
            `;
            
            // Annual plan
            const annualPlan = document.createElement('div');
            annualPlan.className = 'price-option recommended';
            annualPlan.innerHTML = `
                <div class="badge">RECOMMENDED</div>
                <div class="discount-badge">50% OFF</div>
                <h3>Premium Annual</h3>
                <div class="price"><span class="original-price">$199.99</span> $99.99<span>/year</span></div>
                <div class="savings">Save 17%</div>
                <ul>
                    <li>100 questions per month</li>
                    <li>Unlimited with your API key</li>
                    <li>Priority support</li>
                    <li>All premium features</li>
                </ul>
                <div id="modal-annual-stripe-container" class="stripe-button-container"></div>
            `;
            
            priceContainer.appendChild(monthlyPlan);
            priceContainer.appendChild(annualPlan);
            
            modalContent.appendChild(closeButton);
            modalContent.appendChild(title);
            modalContent.appendChild(ramadanBanner);
            modalContent.appendChild(description);
            modalContent.appendChild(priceContainer);
            
            premiumModal.appendChild(modalContent);
            document.body.appendChild(premiumModal);
            
            // Use Stripe buy buttons like in the main page
            
            // Update the monthly subscription container with Stripe buy button
            const monthlyContainer = document.getElementById('modal-monthly-stripe-container');
            if (monthlyContainer) {
                monthlyContainer.innerHTML = ''; // Clear any existing content
                
                // Add Stripe script if not already present
                if (!document.querySelector('script[src="https://js.stripe.com/v3/buy-button.js"]')) {
                    const stripeScript = document.createElement('script');
                    stripeScript.src = 'https://js.stripe.com/v3/buy-button.js';
                    stripeScript.async = true;
                    document.head.appendChild(stripeScript);
                }
                
                // Create Stripe buy button for monthly subscription
                const monthlyBuyButton = document.createElement('stripe-buy-button');
                monthlyBuyButton.setAttribute('buy-button-id', 'buy_btn_1R0TLxDLlIJ8KokgsghoABCt');
                monthlyBuyButton.setAttribute('publishable-key', 'pk_live_51R0QM7DLlIJ8KokgtJ1OMLsHza1s8HHQsUfUqP0sMCrPfFSyWxHn3i1wRpDyWvhrj70eitF5HEwXBUSVITCqojnM00YqzhQDPV');
                
                // Store user info for verification before adding the button
                safeSetItem('pending_premium_user', user.uid);
                safeSetItem('premium_plan_selected', 'monthly');
                
                // Add event listener to detect Stripe checkout completion
                monthlyBuyButton.addEventListener('buyButtonStateChange', function(event) {
                    console.log('Monthly button state change:', event.detail.state);
                    if (event.detail.state === 'succeeded') {
                        console.log('Monthly payment succeeded, verifying...');
                        verifyPremiumPayment();
                        // Close the premium modal
                        const premiumModal = document.getElementById('premium-modal');
                        if (premiumModal) {
                            premiumModal.style.display = 'none';
                        }
                    }
                });
                
                monthlyContainer.appendChild(monthlyBuyButton);
            }
            
            // Create and add Annual subscription Stripe buy button
            const annualContainer = document.getElementById('modal-annual-stripe-container');
            if (annualContainer) {
                annualContainer.innerHTML = ''; // Clear any existing content
                
                // Create Stripe buy button for annual subscription
                const annualBuyButton = document.createElement('stripe-buy-button');
                annualBuyButton.setAttribute('buy-button-id', 'buy_btn_1R0TTUDLlIJ8Kokg2epkfzAF');
                annualBuyButton.setAttribute('publishable-key', 'pk_live_51R0QM7DLlIJ8KokgtJ1OMLsHza1s8HHQsUfUqP0sMCrPfFSyWxHn3i1wRpDyWvhrj70eitF5HEwXBUSVITCqojnM00YqzhQDPV');
                
                // Store user info for verification before adding the button
                safeSetItem('pending_premium_user', user.uid);
                safeSetItem('premium_plan_selected', 'annual');
                
                // Add event listener to detect Stripe checkout completion
                annualBuyButton.addEventListener('buyButtonStateChange', function(event) {
                    console.log('Annual button state change:', event.detail.state);
                    if (event.detail.state === 'succeeded') {
                        console.log('Annual payment succeeded, verifying...');
                        verifyPremiumPayment();
                        // Close the premium modal
                        const premiumModal = document.getElementById('premium-modal');
                        if (premiumModal) {
                            premiumModal.style.display = 'none';
                        }
                    }
                });
                
                annualContainer.appendChild(annualBuyButton);
            }
            
            // Store user info for verification - using safeSetItem instead of direct localStorage access
            // This is already handled in the button click handlers above
            
            // Add styles for the premium modal
            const style = document.createElement('style');
            style.textContent = `
                #premium-modal {
                    display: block; /* Show immediately */
                    position: fixed;
                    z-index: 9999;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(3px);
                }
                
                #premium-modal .modal-content {
                    background-color: #fefefe;
                    margin: 10% auto;
                    padding: 30px;
                    border: 1px solid #888;
                    border-radius: 15px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                    position: relative;
                    max-width: 800px;
                    width: 90%;
                    animation: modalFadeIn 0.3s ease-in-out;
                    box-sizing: border-box;
                    overflow: hidden;
                }
                
                /* Fix for mobile premium cards */
                .modal-content > * {
                    max-width: 100%;
                }
                
                /* Additional fixes for premium card alignment */
                #premium-modal .price-container {
                    width: 100%;
                    box-sizing: border-box;
                }
                
                /* Force premium cards to stay within container */
                .price-option {
                    max-width: 100%;
                    margin-left: auto;
                    margin-right: auto;
                }
                
                @keyframes modalFadeIn {
                    from {opacity: 0; transform: translateY(-20px);}
                    to {opacity: 1; transform: translateY(0);}
                }
                
                .close-button {
                    position: absolute;
                    right: 20px;
                    top: 15px;
                    font-size: 28px;
                    font-weight: bold;
                    color: #aaa;
                    cursor: pointer;
                    transition: color 0.2s ease;
                }
                
                .close-button:hover {
                    color: #333;
                }
                
                .price-container {
                    display: flex;
                    flex-direction: row;
                    justify-content: center;
                    gap: 20px;
                    margin-top: 20px;
                    flex-wrap: wrap;
                    max-width: 100%;
                    overflow: hidden;
                }
                .price-option {
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    padding: 20px;
                    min-width: 0;
                    flex: 1;
                    max-width: 350px;
                    position: relative;
                    background-color: white;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    display: flex;
                    flex-direction: column;
                    box-sizing: border-box;
                    width: 100%;
                }
                .price-option ul {
                    flex-grow: 1;
                }
                .price-option.recommended {
                    border: 2px solid #f0c14b;
                    transform: scale(1.05);
                }
                @media (max-width: 768px) {
                    .price-option.recommended {
                        transform: none;
                    }
                }
                /* Ensure stripe buttons are centered */
                .stripe-button-container,
                #modal-monthly-stripe-container,
                #modal-annual-stripe-container {
                    display: flex;
                    justify-content: center;
                    width: 100%;
                    margin-top: 10px;
                    overflow: hidden;
                }
                
                /* Fix Stripe button sizing in modal */
                #modal-monthly-stripe-container stripe-buy-button,
                #modal-annual-stripe-container stripe-buy-button {
                    width: 100%;
                    max-width: 320px;
                }
                
                /* Additional fixes for Stripe iframe in modal */
                #modal-monthly-stripe-container stripe-buy-button iframe,
                #modal-annual-stripe-container stripe-buy-button iframe {
                    min-width: unset !important;
                    width: 100% !important;
                    max-width: 100% !important;
                }
                @media (max-width: 1200px) {
                    .price-container {
                        flex-direction: column;
                        align-items: center;
                        width: 100%;
                    }
                    .price-option {
                        width: 100%;
                        max-width: 280px;
                        margin-bottom: 15px;
                    }
                    .price-option.recommended {
                        transform: none;
                        order: -1;
                    }
                }
                
                @media (max-width: 480px) {
                    #premium-modal .modal-content {
                        width: 95%;
                        padding: 15px 10px;
                        margin: 5% auto;
                    }
                    .price-option {
                        min-width: 0;
                        width: 90%;
                        max-width: 90%;
                        padding: 15px 10px;
                        margin: 0 auto;
                    }
                    .price-container {
                        padding: 0;
                        gap: 15px;
                        margin: 0;
                        width: 100%;
                    }
                    .price-option ul {
                        padding-left: 20px;
                    }
                    .price-option h3 {
                        font-size: 18px;
                    }
                    .price {
                        font-size: 20px;
                    }
                    /* Ensure no overflow */
                    .price-option.recommended {
                        transform: none;
                    }
                }
                .price-option h3 {
                    margin-top: 0;
                    color: #1e6f5c;
                }
                .price {
                    font-size: 24px;
                    font-weight: bold;
                    margin: 10px 0;
                }
                .price span {
                    font-size: 14px;
                    font-weight: normal;
                }
                .savings {
                    color: #e53935;
                    font-weight: bold;
                    margin-bottom: 10px;
                }
                .price-option ul {
                    list-style-type: none;
                    padding: 0;
                    margin: 15px 0;
                }
                .price-option li {
                    padding: 5px 0;
                    position: relative;
                    padding-left: 25px;
                }
                .price-option li:before {
                    content: '✓';
                    color: #1e6f5c;
                    position: absolute;
                    left: 0;
                }
                .stripe-button, .premium-button {
                    background-color: #1e6f5c;
                    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                    color: white;
                    border: none;
                    border-radius: 30px;
                    padding: 12px 20px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    width: 100%;
                    margin-top: 10px;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                }
                .stripe-button:hover, .premium-button:hover {
                    background-color: #155043;
                    background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
                    transform: translateY(-2px);
                    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
                }
                .recommended-button {
                    background: linear-gradient(135deg, var(--ramadan-gold), #c4a046);
                }
                .recommended-button:hover {
                    background: linear-gradient(135deg, #c4a046, var(--ramadan-gold));
                }
                .badge {
                    position: absolute;
                    top: 0;
                    right: 0;
                    background: #f0c14b;
                    color: #1e6f5c;
                    padding: 5px 15px;
                    border-radius: 0 0 0 10px;
                    font-size: 12px;
                    font-weight: bold;
                }
                
                .great-value-badge {
                    background: var(--ramadan-gold);
                    color: var(--ramadan-deep-blue);
                }
                
                .discount-badge {
                    position: absolute;
                    top: 0;
                    left: 0;
                    background-color: #e63946;
                    color: white;
                    font-size: 12px;
                    font-weight: bold;
                    padding: 5px 15px;
                    border-radius: 0 0 10px 0;
                    z-index: 2;
                }
                
                .original-price {
                    font-size: 18px;
                    text-decoration: line-through;
                    color: #888;
                    margin-right: 5px;
                }
                
                .ramadan-modal-promo {
                    text-align: center;
                    margin: 10px auto 20px;
                    background-color: rgba(30, 111, 92, 0.1);
                    border-radius: 8px;
                    padding: 10px 15px;
                    max-width: 90%;
                }
                
                .ramadan-modal-badge {
                    display: inline-block;
                    background-color: rgba(255, 215, 0, 0.2);
                    color: #1e6f5c;
                    font-weight: 700;
                    padding: 5px 15px;
                    border-radius: 20px;
                    margin-bottom: 5px;
                    font-size: 14px;
                }
                
                .ramadan-icon {
                    margin-right: 5px;
                }
                
                .ramadan-modal-promo p {
                    color: #1e6f5c;
                    font-size: 16px;
                    margin: 5px 0 0;
                }
                @media (max-width: 600px) {
                    .price-container {
                        flex-direction: column;
                        align-items: center;
                    }
                    .price-option {
                        width: 100%;
                        max-width: 280px;
                        margin-bottom: 20px;
                    }
                    .price-option.recommended {
                        transform: none;
                    }
                }
                `;
            document.head.appendChild(style);
            
            // Show the modal with a slight delay to ensure everything is properly rendered
            setTimeout(() => {
                premiumModal.style.display = 'block';
            }, 100);
        }
        
        // Listen for Stripe checkout completion
        // This would normally be handled by a webhook, but for testing purposes
        // we'll add a verification button to the profile page after the modal is shown
        // Function to add verification button after Stripe checkout
        function addPaymentVerificationButton(user) {
            // Hide the premium modal
            const premiumModal = document.getElementById('premium-modal');
            if (premiumModal) {
                premiumModal.style.display = 'none';
            }
            
            // Show message to user
            const profileMessage = document.getElementById('profile-message');
            if (profileMessage) {
                profileMessage.textContent = 'After completing payment in the Stripe checkout, click the button below to verify your subscription.';
                profileMessage.style.color = '#1e6f5c';
                profileMessage.style.fontWeight = 'bold';
            }
            
            // Add verification button if it doesn't exist
            if (!document.getElementById('verify-payment-button')) {
                const verifyButton = document.createElement('button');
                verifyButton.textContent = 'Verify Premium Payment';
                verifyButton.className = 'auth-button';
                verifyButton.id = 'verify-payment-button';
                verifyButton.style.marginTop = '10px';
                verifyButton.style.backgroundColor = '#1e6f5c';
                verifyButton.style.color = 'white';
                verifyButton.style.border = 'none';
                verifyButton.style.padding = '10px 20px';
                verifyButton.style.borderRadius = '4px';
                verifyButton.style.cursor = 'pointer';
                verifyButton.addEventListener('click', verifyPremiumPayment);
                
                const profileMessageContainer = profileMessage?.parentNode;
                if (profileMessageContainer) {
                    profileMessageContainer.appendChild(verifyButton);
                }
            }
        }
        
        // Add a downgrade subscription function
        async function downgradeSubscription() {
            const auth = getAuth();
            const user = auth.currentUser;
            
            if (!user) {
                alert('You must be logged in to downgrade your subscription.');
                return;
            }
            
            try {
                const db = getFirestore();
                await setDoc(doc(db, 'users', user.uid), {
                    subscription: {
                        type: 'free',
                        plan: 'free',
                        active: false,
                        downgradeDate: new Date().toISOString(),
                        questionsRemaining: 7 // Reset to free tier question limit
                    }
                }, { merge: true });
                
                // Update UI
                loadUserProfile();
                
                // Show success message
                const profileMessage = document.getElementById('profile-message');
                if (profileMessage) {
                    profileMessage.innerHTML = '<span style="color: #e53935">Your subscription has been downgraded to the free plan.</span>';
                } else {
                    alert('Your subscription has been downgraded to the free plan.');
                }
                
                // Remove premium badge if present
                const premiumBadge = document.getElementById('premium-badge');
                if (premiumBadge) {
                    premiumBadge.remove();
                }
                
                // Reset the upgrade button to show premium options
                const upgradeButton = document.getElementById('upgrade-button');
                if (upgradeButton) {
                    upgradeButton.textContent = 'Upgrade to Premium';
                    upgradeButton.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        try {
                            // Close profile modal first
                            const profileModal = document.getElementById('profile-modal');
                            if (profileModal) profileModal.style.display = 'none';
                            
                            // Then handle premium upgrade
                            setTimeout(() => {
                                handlePremiumUpgrade();
                            }, 100);
                        } catch (err) {
                            console.log('Premium upgrade button clicked');
                        }
                    };
                }
            } catch (error) {
                console.error('Error downgrading subscription:', error);
                const profileError = document.getElementById('profile-error');
                if (profileError) {
                    profileError.textContent = 'Error downgrading subscription. Please try again later.';
                } else {
                    alert('Error downgrading subscription. Please try again later.');
                }
            }
        }
        
        // Function to verify premium payment
        async function verifyPremiumPayment() {
            const auth = getAuth();
            const user = auth.currentUser;
            
            if (!user) {
                const profileError = document.getElementById('profile-error');
                if (profileError) {
                    profileError.textContent = 'You must be logged in to verify payment.';
                }
                return;
            }
            
            // Check if the pending premium user matches the current user
            const pendingUser = safeGetItem('pending_premium_user');
            if (pendingUser && pendingUser !== user.uid) {
                console.error('User mismatch during payment verification');
                const profileError = document.getElementById('profile-error');
                if (profileError) {
                    profileError.textContent = 'User mismatch during payment verification.';
                }
                return;
            }
            
            try {
                // Get the plan type from localStorage using safe access
                const planType = safeGetItem('premium_plan_selected') || 'monthly';
                const isAnnual = planType === 'annual';
                
                // In a real implementation, this would check with your backend
                // which would verify the payment status with Stripe
                // For now, we'll simulate a successful payment verification
                
                // Calculate end date based on plan type
                const now = new Date();
                let endDate = new Date();
                if (isAnnual) {
                    endDate.setFullYear(endDate.getFullYear() + 1);
                } else {
                    endDate.setMonth(endDate.getMonth() + 1);
                }
                
                const db = getFirestore();
                await setDoc(doc(db, 'users', user.uid), {
                    subscription: {
                        type: 'premium',
                        plan: isAnnual ? 'annual' : 'monthly',
                        startDate: now.toISOString(),
                        endDate: endDate.toISOString(),
                        active: true,
                        paymentId: 'stripe_' + Math.random().toString(36).substring(2, 15), // Simulated payment ID
                        questionLimit: 100
                    }
                }, { merge: true });
                
                // Update UI
                loadUserProfile();
                
                // Show success message
                const profileMessage = document.getElementById('profile-message');
                if (profileMessage) {
                    profileMessage.innerHTML = `<span style="color: green">Premium ${isAnnual ? 'annual' : 'monthly'} subscription verified successfully!</span>`;
                }
                
                // Remove verification button
                const verifyButton = document.getElementById('verify-payment-button');
                if (verifyButton) {
                    verifyButton.remove();
                }
                
                // Add premium badge if not already there
                const userEmail = document.getElementById('user-email');
                if (userEmail && !document.getElementById('premium-badge')) {
                    const premiumBadge = document.createElement('span');
                    premiumBadge.id = 'premium-badge';
                    premiumBadge.className = 'premium-badge';
                    premiumBadge.textContent = 'PREMIUM';
                    userEmail.appendChild(document.createTextNode(' '));
                    userEmail.appendChild(premiumBadge);
                }
                
                // Clear the pending premium user and plan
                try {
                    if (!isInIframe()) {
                        localStorage.removeItem('pending_premium_user');
                        localStorage.removeItem('premium_plan_selected');
                        localStorage.removeItem('premium_after_login');
                    }
                } catch (storageError) {
                    console.error('Error clearing localStorage items:', storageError);
                }
            } catch (error) {
                console.error('Error verifying premium payment:', error);
                const profileError = document.getElementById('profile-error');
                if (profileError) {
                    profileError.textContent = 'Error verifying payment. Please contact support.';
                }
            }
        }
        
        // Helper functions - updated to avoid storage access errors
        function showModal(modal) {
            try {
                if (modal) {
                    modal.style.display = 'block';
                    console.log('Modal displayed:', modal.id || 'unnamed modal');
                    
                    // Check if this is a login modal and we have premium intent
                    if (modal.id === 'login-modal' && safeGetItem('premium_after_login') === 'true') {
                        const loginError = document.getElementById('login-error');
                        if (loginError) {
                            loginError.textContent = 'Please sign in to upgrade to premium';
                            loginError.style.color = '#e53935';
                        }
                    }
                } else {
                    console.error('Attempted to show a modal that does not exist');
                }
            } catch (error) {
                console.error('Error showing modal:', error);
            }
        }
        
        function hideModal(modal) {
            try {
                if (modal) {
                    modal.style.display = 'none';
                    console.log('Modal hidden:', modal.id || 'unnamed modal');
                    
                    // If this was a signup modal and we have premium intent, check if we need to show profile modal
                    if (modal.id === 'signup-modal' && safeGetItem('premium_signup_intent') === 'true') {
                        const auth = getAuth();
                        if (auth.currentUser) {
                            // User is now signed in, show profile modal
                            setTimeout(() => {
                                const profileModal = document.getElementById('profile-modal');
                                if (profileModal) {
                                    profileModal.style.display = 'block';
                                    loadUserProfile();
                                    console.log('Profile modal displayed after signup for premium');
                                }
                            }, 500);
                        }
                    }
                } else {
                    console.error('Attempted to hide a modal that does not exist');
                }
            } catch (error) {
                console.error('Error hiding modal:', error);
            }
        }
        
        function clearInputs() {
            loginEmail.value = '';
            loginPassword.value = '';
            signupEmail.value = '';
            signupPassword.value = '';
            signupConfirmPassword.value = '';
            resetEmail.value = '';
            
            loginError.textContent = '';
            signupError.textContent = '';
            resetError.textContent = '';
            resetMessage.textContent = '';
        }
        
        function showError(element, message) {
            if (element) element.textContent = message;
        }
        
        function handleAuthError(error, errorElement) {
            let errorMessage = 'An error occurred. Please try again.';
            
            switch (error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = 'This email is already in use. Please use a different email or sign in.';
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'Invalid email address. Please check your email.';
                    break;
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    errorMessage = 'Invalid email or password. Please try again.';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Password is too weak. Please use a stronger password.';
                    break;
                case 'auth/popup-closed-by-user':
                    errorMessage = 'Sign-in popup was closed before completing the sign in.';
                    break;
                case 'auth/cancelled-popup-request':
                    errorMessage = 'The sign-in popup was cancelled.';
                    break;
                case 'auth/popup-blocked':
                    errorMessage = 'Sign-in popup was blocked by the browser. Please allow popups for this site.';
                    break;
                default:
                    console.error('Auth error:', error);
            }
            
            showError(errorElement, errorMessage);
        }
        
        // Declare profileModal as a global variable
        let profileModal;
        
        // Expose initAuthUI and auth-related functions to global scope
        window.initAuthUI = initAuthUI;
        window.handleLogin = handleLogin;
        window.handleSignup = handleSignup;
        window.handleGoogleAuth = handleGoogleAuth;
        window.handleLogout = handleLogout;
        window.handlePasswordReset = handlePasswordReset;
        window.showModal = showModal;
        window.hideModal = hideModal;
        
        // Add debug functions to help troubleshoot auth issues
        window.debugAuth = function() {
            const auth = getAuth();
            console.log('Current auth state:', auth);
            console.log('Current user:', auth.currentUser);
            
            // Check if auth buttons exist and have handlers
            const loginBtn = document.getElementById('login-button');
            const signupBtn = document.getElementById('signup-button');
            console.log('Login button exists:', !!loginBtn);
            console.log('Login button has onclick handler:', !!loginBtn?.onclick);
            console.log('Signup button exists:', !!signupBtn);
            console.log('Signup button has onclick handler:', !!signupBtn?.onclick);
            
            // Check if modals exist
            const loginModal = document.getElementById('login-modal');
            const signupModal = document.getElementById('signup-modal');
            console.log('Login modal exists:', !!loginModal);
            console.log('Signup modal exists:', !!signupModal);
            
            return 'Auth debug info logged to console';
        };
        
        // Initialize auth UI when the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Wait a short time to ensure all elements are loaded
            setTimeout(() => {
                try {
                    // Remove any existing event handlers first
                    const loginBtn = document.getElementById('login-button');
                    const signupBtn = document.getElementById('signup-button');
                    const logoutBtn = document.getElementById('logout-button');
                    
                    if (loginBtn) loginBtn.onclick = null;
                    if (signupBtn) signupBtn.onclick = null;
                    if (logoutBtn) logoutBtn.onclick = null;
                    
                    // Now initialize the auth UI
                    initAuthUI();
                    console.log('Auth UI initialized with clean event handlers');
                    
                    // Ensure the auth buttons have direct inline event handlers
                    // This is critical to avoid storage access errors in iframes
                    const loginModal = document.getElementById('login-modal');
                    const signupModal = document.getElementById('signup-modal');
                    
                    if (loginBtn && loginModal) {
                        loginBtn.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation(); // Prevent event bubbling
                            if (loginModal) {
                                loginModal.style.display = 'block';
                                console.log('Login modal displayed via direct handler');
                            }
                            return false;
                        };
                        console.log('Login button handler attached directly');
                    }
                    
                    if (signupBtn && signupModal) {
                        signupBtn.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation(); // Prevent event bubbling
                            if (signupModal) {
                                signupModal.style.display = 'block';
                                console.log('Signup modal displayed via direct handler');
                            }
                            return false;
                        };
                        console.log('Signup button handler attached directly');
                    }
                    
                    if (logoutBtn) {
                        logoutBtn.onclick = function(e) {
                            e.preventDefault();
                            const auth = getAuth();
                            signOut(auth).then(() => {
                                console.log('User signed out');
                            }).catch((error) => {
                                console.error('Sign out error:', error);
                            });
                            return false;
                        };
                    }
                    
                    // Add direct event handlers to form submit buttons
                    const loginForm = document.getElementById('login-form');
                    const signupForm = document.getElementById('signup-form');
                    
                    if (loginForm) {
                        loginForm.onsubmit = function(e) {
                            e.preventDefault();
                            const email = document.getElementById('login-email').value.trim();
                            const password = document.getElementById('login-password').value;
                            const errorElement = document.getElementById('login-error');
                            
                            if (!email || !password) {
                                if (errorElement) errorElement.textContent = 'Please enter both email and password';
                                return false;
                            }
                            
                            const auth = getAuth();
                            signInWithEmailAndPassword(auth, email, password)
                                .then(() => {
                                    if (loginModal) loginModal.style.display = 'none';
                                    document.getElementById('login-email').value = '';
                                    document.getElementById('login-password').value = '';
                                })
                                .catch((error) => {
                                    console.error('Login error:', error);
                                    if (errorElement) {
                                        if (error.code === 'auth/invalid-credential') {
                                            errorElement.textContent = 'Invalid email or password';
                                        } else {
                                            errorElement.textContent = error.message;
                                        }
                                    }
                                });
                            return false;
                        };
                    }
                    
                    if (signupForm) {
                        signupForm.onsubmit = function(e) {
                            e.preventDefault();
                            const email = document.getElementById('signup-email').value.trim();
                            const password = document.getElementById('signup-password').value;
                            const confirmPassword = document.getElementById('signup-confirm-password').value;
                            const errorElement = document.getElementById('signup-error');
                            
                            if (!email || !password || !confirmPassword) {
                                if (errorElement) errorElement.textContent = 'Please fill in all fields';
                                return false;
                            }
                            
                            if (password !== confirmPassword) {
                                if (errorElement) errorElement.textContent = 'Passwords do not match';
                                return false;
                            }
                            
                            if (password.length < 6) {
                                if (errorElement) errorElement.textContent = 'Password must be at least 6 characters';
                                return false;
                            }
                            
                            const auth = getAuth();
                            const db = getFirestore();
                            
                            createUserWithEmailAndPassword(auth, email, password)
                                .then((userCredential) => {
                                    return setDoc(doc(db, 'users', userCredential.user.uid), {
                                        email: email,
                                        createdAt: serverTimestamp(),
                                        subscription: {
                                            type: 'free',
                                            questionsRemaining: 7
                                        }
                                    });
                                })
                                .then(() => {
                                    if (signupModal) signupModal.style.display = 'none';
                                    document.getElementById('signup-email').value = '';
                                    document.getElementById('signup-password').value = '';
                                    document.getElementById('signup-confirm-password').value = '';
                                })
                                .catch((error) => {
                                    console.error('Signup error:', error);
                                    if (errorElement) errorElement.textContent = error.message;
                                });
                            return false;
                        };
                    }
                    
                    console.log('Direct event handlers added to auth buttons and forms');
                } catch (error) {
                    console.error('Error during auth UI initialization:', error);
                }
            }, 500); // Increased timeout to ensure DOM is fully loaded
        });
    </script>
    <!-- Footer Section -->
    <footer class="site-footer">
        <div class="footer-container">
            <div class="footer-section mobile-app-section">
                <h3><i class="fas fa-mobile-alt"></i> Mobile App Coming Soon</h3>
                <p>We're working hard to create a mobile app to make Islamic knowledge more accessible for everyone. Sign up to be the first users notified when our mobile app launches!</p>
                <form id="mobile-waitlist-form" class="footer-form">
                    <div class="form-group">
                        <input type="email" id="waitlist-email" placeholder="Your email address" required>
                        <button type="submit" class="primary-button">Join Waitlist</button>
                    </div>
                    <div id="waitlist-message" class="form-message"></div>
                </form>
            </div>
            
            <div class="footer-section contact-section">
                <h3><i class="fas fa-envelope"></i> Contact Us</h3>
                <p>Have questions or feedback? We'd love to hear from you!</p>
                <form id="contact-form" class="footer-form" action="https://formspree.io/f/mblgjvgy" method="POST">
                    <div class="form-group">
                        <input type="text" name="name" placeholder="Your name" required>
                    </div>
                    <div class="form-group">
                        <input type="email" name="email" placeholder="Your email address" required>
                    </div>
                    <div class="form-group">
                        <textarea name="message" placeholder="Your message" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="primary-button">Send Message</button>
                    <div id="contact-message" class="form-message"></div>
                </form>
            </div>
            
            <div class="footer-section social-section">
                <h3><i class="fas fa-share-alt"></i> Connect With Us</h3>
                <p>Follow us on social media for updates and Islamic knowledge.</p>
                <div class="social-icons">
                    <div class="social-icon-container instagram-container">
                        <a href="https://www.instagram.com/askmoanything/" class="social-icon instagram-icon" title="Instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <span class="social-label">Follow us on Instagram</span>
                    </div>
                    <div class="social-icon-container">
                        <a href="https://x.com/AskMoAnything" class="social-icon twitter-icon" title="Follow us on X (Twitter)">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <span class="social-label">Follow us on X</span>
                    </div>
                    <div class="social-icon-container">
                        <a href="https://www.reddit.com/r/askmoanything/" class="social-icon reddit-icon" title="Reddit">
                            <i class="fab fa-reddit"></i>
                        </a>
                        <span class="social-label">Reddit Community</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 AskMoAnything. All rights reserved. | <a href="/ramadan-faq.html" class="footer-link">Ramadan FAQ</a> | <a href="/terms.html" class="footer-link">Terms of Service</a> | <a href="/privacy.html" class="footer-link">Privacy Policy</a></p>
        </div>
    </footer>

    <!-- Footer Styles -->
    <style>
        .site-footer {
            background-color: var(--primary-color);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 3rem 0 1rem;
            margin-top: 3rem;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        .footer-section {
            flex: 1;
            min-width: 250px;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }
        
        .footer-section h3 {
            background: linear-gradient(to right, #ffd700, #f9f295, #e6c200);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            font-weight: 700;
            text-shadow: 0px 0px 1px rgba(150, 150, 150, 0.2);
        }
        
        .footer-section h3 i {
            margin-right: 0.5rem;
        }
        
        .footer-section p {
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .contact-email a {
            background: linear-gradient(to right, #ffd700, #f9f295, #e6c200);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none;
            font-weight: 600;
            text-shadow: 0px 0px 1px rgba(150, 150, 150, 0.2);
        }
        
        .contact-email a:hover {
            text-decoration: underline;
        }
        
        .footer-form .form-group {
            margin-bottom: 1rem;
        }
        
        .footer-form input,
        .footer-form textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .footer-form input::placeholder,
        .footer-form textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .footer-form textarea {
            resize: vertical;
        }
        
        #mobile-waitlist-form .form-group {
            display: flex;
        }
        
        #mobile-waitlist-form input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            flex: 1;
        }
        
        #mobile-waitlist-form button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            white-space: nowrap;
        }
        
        .primary-button {
            background-color: white;
            color: var(--primary-color);
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .primary-button:hover {
            background: linear-gradient(to right, #ffd700, #f9f295, #e6c200);
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .form-message {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        .form-message.success {
            background: linear-gradient(to right, #ffd700, #f9f295, #e6c200);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
            text-shadow: 0px 0px 1px rgba(150, 150, 150, 0.2);
        }
        
        .form-message.error {
            color: #ffcccc;
            font-weight: 500;
        }
        
        .social-icons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .social-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .social-icon:hover {
            background: linear-gradient(to right, #ffd700, #f9f295, #e6c200);
            color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .social-icon.coming-soon {
            opacity: 0.6;
            cursor: default;
            position: relative;
        }
        
        .social-icon.coming-soon:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .social-icon.coming-soon::after {
            content: 'Coming Soon';
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .social-icon.coming-soon:hover::after {
            opacity: 1;
        }
        
        /* Social media icon styling */
        .instagram-icon {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }
        
        .twitter-icon {
            background-color: #000;
            color: white;
        }
        
        .reddit-icon {
            background-color: #FF4500;
        }
        
        .social-icon-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 1rem;
            min-width: 40px;
        }
        
        .instagram-container {
            position: relative;
        }
        
        .instagram-icon {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            color: white;
            transform: scale(1.15);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .instagram-icon:hover {
            transform: scale(1.25);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .social-label {
            font-size: 0.7rem;
            margin-top: 0.5rem;
            color: #e6c200;
            font-weight: 600;
            white-space: nowrap;
            text-align: center;
        }
        
        .coming-soon-label {
            opacity: 0.6;
        }
        
        .reddit-icon {
            background: #FF4500;
            color: white;
        }
        
        .reddit-icon:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 1rem;
            margin-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .footer-link {
            color: var(--secondary-color);
            text-decoration: none;
            transition: color 0.2s;
            margin: 0 5px;
        }
        
        .footer-link:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .footer-container {
                flex-direction: column;
            }
            
            .footer-section {
                width: 100%;
                padding: 0;
            }
        }
    </style>
    
    <!-- Footer Scripts -->    
    <!-- Firebase SDK for Client Side -->    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        
        // Initialize Firebase for client-side use
        try {
            // Firebase configuration for v8 SDK
            const firebaseConfig = {
                apiKey: "AIzaSyDn_yz3eL1c4cxxaChd2YFx8TReFYSWI-Q",
                authDomain: "ask-mo-anything.firebaseapp.com",
                projectId: "ask-mo-anything",
                storageBucket: "ask-mo-anything.appspot.com",
                messagingSenderId: "31573817503",
                appId: "1:31573817503:web:b8f5c3a066b3cb4243b69d"
            };
            
            // Initialize Firebase for client-side use (v8 syntax)
            firebase.initializeApp(firebaseConfig);
            window.firebaseDb = firebase.firestore();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase client initialization error:', error);
        }
        
        // Helper function to show messages
        function showMessage(element, message, type) {
            if (element) {
                element.textContent = message;
                element.className = 'form-message';
                if (type) {
                    element.classList.add(type);
                }
                
                // Clear message after 5 seconds
                setTimeout(() => {
                    element.textContent = '';
                    element.className = 'form-message';
                }, 5000);
            }
        }
        
        // Form Handling for Footer Forms
        document.addEventListener('DOMContentLoaded', function() {
            const waitlistForm = document.getElementById('mobile-waitlist-form');
            const waitlistMessage = document.getElementById('waitlist-message');
            const contactForm = document.getElementById('contact-form');
            const contactMessage = document.getElementById('contact-message');
            
            // Handle Mobile App Waitlist Form (hybrid approach)
            if (waitlistForm) {
                waitlistForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const emailInput = document.getElementById('waitlist-email');
                    const email = emailInput.value.trim();
                    
                    if (!email) {
                        showMessage(waitlistMessage, 'Please enter a valid email address.', 'error');
                        return;
                    }
                    
                    // Show loading state
                    const submitButton = waitlistForm.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.textContent = 'Sending...';
                    }
                    
                    // Show a loading message
                    showMessage(waitlistMessage, 'Adding you to the waitlist...', '');
                    
                    try {
                        let success = false;
                        
                        // 1. Try Firebase first (primary storage)
                        if (window.firebaseDb) {
                            try {
                                const db = firebase.firestore();
                                await db.collection('mobileAppWaitlist').add({
                                    email: email,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                    created: new Date().toISOString(),
                                    source: 'website_footer'
                                });
                                success = true;
                                console.log('Email added to Firebase waitlist:', email);
                            } catch (firebaseError) {
                                console.error('Firebase error:', firebaseError);
                                // Will fall back to Formspree
                            }
                        }
                        
                        // 2. Use Formspree as backup if Firebase fails
                        if (!success) {
                            try {
                                const formData = new FormData();
                                formData.append('email', email);
                                formData.append('form-type', 'mobile-app-waitlist');
                                
                                const response = await fetch('https://formspree.io/f/mblgjvgy', {
                                    method: 'POST',
                                    body: formData,
                                    headers: {
                                        'Accept': 'application/json'
                                    }
                                });
                                
                                if (response.ok) {
                                    success = true;
                                    console.log('Email sent to Formspree as backup:', email);
                                } else {
                                    throw new Error('Formspree submission failed');
                                }
                            } catch (formspreeError) {
                                console.error('Formspree error:', formspreeError);
                            }
                        }
                        
                        // 3. Always store in localStorage as a backup
                        const waitlist = JSON.parse(localStorage.getItem('mobileAppWaitlist') || '[]');
                        const entry = { 
                            email, 
                            timestamp: new Date().toISOString(), 
                            source: 'website_footer'
                        };
                        
                        // Check if email already exists in localStorage
                        const emailExists = waitlist.some(item => item.email === email);
                        if (!emailExists) {
                            waitlist.push(entry);
                            localStorage.setItem('mobileAppWaitlist', JSON.stringify(waitlist));
                        }
                        
                        // Show success message and reset form
                        showMessage(waitlistMessage, 'Thank you! You\'ve been added to our waitlist.', 'success');
                        emailInput.value = '';
                        
                        // Reset button state
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.textContent = 'Join Waitlist';
                        }
                        
                        // Add admin export function (only visible to admins)
                        if (!window.exportWaitlist) {
                            window.exportWaitlist = function() {
                                const waitlist = JSON.parse(localStorage.getItem('mobileAppWaitlist') || '[]');
                                console.log('Waitlist entries:', waitlist);
                                
                                // Create CSV for download
                                let csv = 'Email,Timestamp,Source\n';
                                waitlist.forEach(entry => {
                                    csv += `${entry.email},${entry.timestamp},${entry.source}\n`;
                                });
                                
                                const blob = new Blob([csv], { type: 'text/csv' });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.setAttribute('hidden', '');
                                a.setAttribute('href', url);
                                a.setAttribute('download', 'mobile_app_waitlist.csv');
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                            };
                            console.log('Admin: Use window.exportWaitlist() to download the waitlist data');
                        }
                    } catch (error) {
                        console.error('Error adding to waitlist:', error);
                        showMessage(waitlistMessage, 'Something went wrong. Please try again later.', 'error');
                    } finally {
                        // Reset button state
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.textContent = 'Join Waitlist';
                        }
                    }
                });
            }
            
            // Handle Contact Form (Formspree with their recommended AJAX implementation)
            if (contactForm) {
                async function handleContactSubmit(event) {
                    event.preventDefault();
                    
                    // Show loading state
                    const submitButton = contactForm.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.textContent = 'Sending...';
                    }
                    
                    // Show a loading message
                    showMessage(contactMessage, 'Sending your message...', '');
                    
                    // Submit using Formspree's recommended approach
                    const formData = new FormData(event.target);
                    try {
                        const response = await fetch(event.target.action, {
                            method: contactForm.method,
                            body: formData,
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            // Success
                            contactForm.reset();
                            showMessage(contactMessage, 'Thank you! Your message has been sent.', 'success');
                        } else {
                            // Server error
                            const data = await response.json();
                            let errorMessage = 'Oops! There was a problem submitting your form';
                            
                            if (Object.hasOwn(data, 'errors')) {
                                errorMessage = data.errors.map(error => error.message).join(", ");
                            }
                            
                            showMessage(contactMessage, errorMessage, 'error');
                        }
                    } catch (error) {
                        // Network error
                        console.error('Error:', error);
                        showMessage(contactMessage, 'Oops! There was a problem submitting your form', 'error');
                    } finally {
                        // Reset button state
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.textContent = 'Send Message';
                        }
                    }
                }
                
                contactForm.addEventListener('submit', handleContactSubmit);
                
                // Check for Formspree success in URL
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('success') === 'true') {
                    contactForm.reset();
                    showMessage(contactMessage, 'Thank you! Your message has been sent.', 'success');
                }
                
                // Listen for the formspree:submit event as a backup
                window.addEventListener('formspree:submit', function() {
                    const submitButton = contactForm.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Send Message';
                    }
                    
                    // Reset the form on success
                    contactForm.reset();
                    showMessage(contactMessage, 'Thank you! Your message has been sent.', 'success');
                });
            }
        });
    </script>
</body>
</html>
